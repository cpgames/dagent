---
phase: 07-polish-integration
plan: 01
type: execute
---

<objective>
Implement authentication priority chain for Claude API access.

Purpose: Enable API calls to Claude for agent operations with automatic credential detection.
Output: AuthManager with priority chain per DAGENT_SPEC 10.1-10.3.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-ui-views/06-05-SUMMARY.md
@src/main/index.ts
@src/preload/index.ts

**From DAGENT_SPEC 10.1 - Priority Order:**
| Priority | Method | Source |
|----------|--------|--------|
| 1 | Claude CLI auto-detect | `~/.config/claude/` or equivalent |
| 2 | OAuth Token (env) | `CLAUDE_CODE_OAUTH_TOKEN` |
| 3 | OAuth Token (stored) | `~/.dagent/credentials.json` |
| 4 | API Key (stored) | `~/.dagent/credentials.json` |
| 5 | API Key (env) | `ANTHROPIC_API_KEY` |
| 6 | Manual entry | UI prompt |

**From DAGENT_SPEC 10.3 - Credential Storage:**
```json
// ~/.dagent/credentials.json
{
  "type": "oauth" | "api_key",
  "token": "...",  // or "key" for api_key type
  "storedAt": "2024-01-15T10:30:00Z"
}
```

**Tech stack:** Electron main process, Node.js fs, @anthropic-ai/sdk
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth types and paths</name>
  <files>src/main/auth/types.ts, src/main/auth/paths.ts</files>
  <action>
Create auth module structure:

**types.ts:**
```typescript
export type AuthType = 'claude_cli' | 'oauth_env' | 'oauth_stored' | 'api_key_stored' | 'api_key_env' | 'manual';

export interface AuthCredentials {
  type: AuthType;
  value: string;  // token or API key
  source: string; // human-readable source description
}

export interface StoredCredentials {
  type: 'oauth' | 'api_key';
  token?: string;
  key?: string;
  storedAt: string;
}

export interface AuthState {
  authenticated: boolean;
  credentials: AuthCredentials | null;
  error: string | null;
}
```

**paths.ts:**
```typescript
import { homedir } from 'os';
import { join } from 'path';

// Cross-platform Claude CLI config location
export function getClaudeCliConfigPath(): string {
  const home = homedir();
  if (process.platform === 'win32') {
    return join(home, '.config', 'claude');
  }
  return join(home, '.config', 'claude');
}

export function getDagentCredentialsPath(): string {
  return join(homedir(), '.dagent', 'credentials.json');
}
```
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Auth types and path utilities defined</done>
</task>

<task type="auto">
  <name>Task 2: Create AuthManager with priority chain</name>
  <files>src/main/auth/auth-manager.ts</files>
  <action>
Create AuthManager class that checks credentials in priority order:

```typescript
import { existsSync, readFileSync, mkdirSync, writeFileSync } from 'fs';
import { dirname } from 'path';
import type { AuthCredentials, AuthState, StoredCredentials } from './types';
import { getClaudeCliConfigPath, getDagentCredentialsPath } from './paths';

export class AuthManager {
  private state: AuthState = {
    authenticated: false,
    credentials: null,
    error: null
  };

  async initialize(): Promise<AuthState> {
    // Check priority chain in order
    const methods = [
      this.checkClaudeCli.bind(this),
      this.checkOAuthEnv.bind(this),
      this.checkOAuthStored.bind(this),
      this.checkApiKeyStored.bind(this),
      this.checkApiKeyEnv.bind(this)
    ];

    for (const method of methods) {
      const credentials = await method();
      if (credentials) {
        this.state = {
          authenticated: true,
          credentials,
          error: null
        };
        return this.state;
      }
    }

    // No credentials found - needs manual entry
    this.state = {
      authenticated: false,
      credentials: null,
      error: 'No credentials found. Please configure authentication.'
    };
    return this.state;
  }

  // Priority 1: Claude CLI auto-detect
  private async checkClaudeCli(): Promise<AuthCredentials | null> {
    // Claude CLI stores credentials in ~/.config/claude/
    // Look for session files or config
    const configPath = getClaudeCliConfigPath();
    // Implementation: check for session.json or similar
    // For now return null - Claude CLI detection is complex
    return null;
  }

  // Priority 2: OAuth env var
  private async checkOAuthEnv(): Promise<AuthCredentials | null> {
    const token = process.env.CLAUDE_CODE_OAUTH_TOKEN;
    if (token) {
      return {
        type: 'oauth_env',
        value: token,
        source: 'Environment variable CLAUDE_CODE_OAUTH_TOKEN'
      };
    }
    return null;
  }

  // Priority 3: OAuth stored
  private async checkOAuthStored(): Promise<AuthCredentials | null> {
    const stored = this.loadStoredCredentials();
    if (stored?.type === 'oauth' && stored.token) {
      return {
        type: 'oauth_stored',
        value: stored.token,
        source: 'Stored OAuth token (~/.dagent/credentials.json)'
      };
    }
    return null;
  }

  // Priority 4: API key stored
  private async checkApiKeyStored(): Promise<AuthCredentials | null> {
    const stored = this.loadStoredCredentials();
    if (stored?.type === 'api_key' && stored.key) {
      return {
        type: 'api_key_stored',
        value: stored.key,
        source: 'Stored API key (~/.dagent/credentials.json)'
      };
    }
    return null;
  }

  // Priority 5: API key env
  private async checkApiKeyEnv(): Promise<AuthCredentials | null> {
    const key = process.env.ANTHROPIC_API_KEY;
    if (key) {
      return {
        type: 'api_key_env',
        value: key,
        source: 'Environment variable ANTHROPIC_API_KEY'
      };
    }
    return null;
  }

  private loadStoredCredentials(): StoredCredentials | null {
    const path = getDagentCredentialsPath();
    if (!existsSync(path)) return null;
    try {
      const content = readFileSync(path, 'utf-8');
      return JSON.parse(content);
    } catch {
      return null;
    }
  }

  // Manual credential entry
  setManualCredentials(type: 'oauth' | 'api_key', value: string): void {
    this.state = {
      authenticated: true,
      credentials: {
        type: 'manual',
        value,
        source: type === 'oauth' ? 'Manual OAuth token' : 'Manual API key'
      },
      error: null
    };

    // Store for future use
    this.storeCredentials(type, value);
  }

  private storeCredentials(type: 'oauth' | 'api_key', value: string): void {
    const path = getDagentCredentialsPath();
    const dir = dirname(path);
    if (!existsSync(dir)) {
      mkdirSync(dir, { recursive: true });
    }

    const stored: StoredCredentials = {
      type,
      ...(type === 'oauth' ? { token: value } : { key: value }),
      storedAt: new Date().toISOString()
    };

    writeFileSync(path, JSON.stringify(stored, null, 2));
  }

  getState(): AuthState {
    return { ...this.state };
  }

  getApiKey(): string | null {
    return this.state.credentials?.value || null;
  }

  isAuthenticated(): boolean {
    return this.state.authenticated;
  }

  clearCredentials(): void {
    this.state = {
      authenticated: false,
      credentials: null,
      error: null
    };
  }
}

// Singleton
let authManagerInstance: AuthManager | null = null;

export function getAuthManager(): AuthManager {
  if (!authManagerInstance) {
    authManagerInstance = new AuthManager();
  }
  return authManagerInstance;
}
```
  </action>
  <verify>npm run typecheck passes</verify>
  <done>AuthManager with full priority chain implementation</done>
</task>

<task type="auto">
  <name>Task 3: Create auth IPC handlers</name>
  <files>src/main/auth/index.ts, src/main/ipc/auth-handlers.ts, src/main/ipc/handlers.ts</files>
  <action>
Create IPC handlers for auth operations:

**src/main/auth/index.ts:**
```typescript
export * from './types';
export * from './paths';
export * from './auth-manager';
```

**src/main/ipc/auth-handlers.ts:**
```typescript
import { ipcMain } from 'electron';
import { getAuthManager } from '../auth';

export function registerAuthHandlers(): void {
  const auth = getAuthManager();

  // Initialize and check credentials
  ipcMain.handle('auth:initialize', async () => {
    return auth.initialize();
  });

  // Get current auth state
  ipcMain.handle('auth:getState', () => {
    return auth.getState();
  });

  // Set manual credentials
  ipcMain.handle('auth:setCredentials', (_event, type: 'oauth' | 'api_key', value: string) => {
    auth.setManualCredentials(type, value);
    return auth.getState();
  });

  // Clear credentials
  ipcMain.handle('auth:clearCredentials', () => {
    auth.clearCredentials();
    return auth.getState();
  });

  // Check if authenticated
  ipcMain.handle('auth:isAuthenticated', () => {
    return auth.isAuthenticated();
  });
}
```

Update **src/main/ipc/handlers.ts** to include auth handlers:
Import and call `registerAuthHandlers()` in the `registerAllHandlers` function.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Auth IPC handlers registered</done>
</task>

<task type="auto">
  <name>Task 4: Expose auth API in preload</name>
  <files>src/preload/index.ts, src/shared/types/index.ts</files>
  <action>
Add auth methods to the preload bridge:

**Add to src/preload/index.ts contextBridge.exposeInMainWorld:**
```typescript
auth: {
  initialize: () => ipcRenderer.invoke('auth:initialize'),
  getState: () => ipcRenderer.invoke('auth:getState'),
  setCredentials: (type: 'oauth' | 'api_key', value: string) =>
    ipcRenderer.invoke('auth:setCredentials', type, value),
  clearCredentials: () => ipcRenderer.invoke('auth:clearCredentials'),
  isAuthenticated: () => ipcRenderer.invoke('auth:isAuthenticated')
}
```

**Add auth types to src/shared/types/index.ts** (or create separate auth types file):
```typescript
export type AuthType = 'claude_cli' | 'oauth_env' | 'oauth_stored' | 'api_key_stored' | 'api_key_env' | 'manual';

export interface AuthCredentials {
  type: AuthType;
  value: string;
  source: string;
}

export interface AuthState {
  authenticated: boolean;
  credentials: AuthCredentials | null;
  error: string | null;
}
```
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Auth API exposed to renderer</done>
</task>

<task type="auto">
  <name>Task 5: Create auth store for renderer</name>
  <files>src/renderer/src/stores/auth-store.ts, src/renderer/src/stores/index.ts</files>
  <action>
Create Zustand store for auth state:

```typescript
import { create } from 'zustand';
import type { AuthState, AuthCredentials } from '@shared/types';

interface AuthStoreState {
  state: AuthState;
  isLoading: boolean;

  // Actions
  initialize: () => Promise<void>;
  setCredentials: (type: 'oauth' | 'api_key', value: string) => Promise<void>;
  clearCredentials: () => Promise<void>;
}

export const useAuthStore = create<AuthStoreState>((set) => ({
  state: {
    authenticated: false,
    credentials: null,
    error: null
  },
  isLoading: true,

  initialize: async () => {
    set({ isLoading: true });
    try {
      const state = await window.electronAPI.auth.initialize();
      set({ state, isLoading: false });
    } catch (error) {
      set({
        state: {
          authenticated: false,
          credentials: null,
          error: String(error)
        },
        isLoading: false
      });
    }
  },

  setCredentials: async (type, value) => {
    set({ isLoading: true });
    try {
      const state = await window.electronAPI.auth.setCredentials(type, value);
      set({ state, isLoading: false });
    } catch (error) {
      set({ isLoading: false });
    }
  },

  clearCredentials: async () => {
    const state = await window.electronAPI.auth.clearCredentials();
    set({ state });
  }
}));
```

Update stores/index.ts to export useAuthStore.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Auth store available in renderer</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] Auth types defined in shared/types
- [ ] AuthManager checks all 5 automatic credential sources
- [ ] IPC handlers registered and working
- [ ] Preload exposes auth API
- [ ] Auth store created for renderer
</verification>

<success_criteria>
- AuthManager with priority chain implementation
- Credential storage in ~/.dagent/credentials.json
- IPC bridge for auth operations
- Renderer auth store for UI integration
- Manual credential entry support
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-integration/07-01-SUMMARY.md` with:
- Tasks completed
- Files created/modified
- Key decisions
- Ready for 07-02
</output>
