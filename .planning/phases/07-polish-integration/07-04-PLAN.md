---
phase: 07-polish-integration
plan: 04
type: execute
---

<objective>
Implement error handling and status displays throughout the application.

Purpose: Provide clear feedback on errors, loading states, and task statuses.
Output: Comprehensive error handling with user-visible status indicators.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-polish-integration/07-03-SUMMARY.md
@src/renderer/src/views/DAGView.tsx
@src/renderer/src/components/DAG/TaskNode.tsx
@src/renderer/src/components/Kanban/FeatureCard.tsx

**From DAGENT_SPEC - Status Colors:**
| Status | Color | Hex | Usage |
|--------|-------|-----|-------|
| Not Started / Blocked / Ready | Blue | #3B82F6 | Tasks waiting |
| In Progress / Running / Merging | Yellow | #F59E0B | Active work |
| Completed | Green | #22C55E | Success |
| Failed / Needs Attention | Red | #EF4444 | Errors |

**From ARCHITECTURE.md - Error Handling:**
- Task agent failure: status → 'failed', keep worktree for debugging
- Merge conflict: merge agent proposes resolution to harness
- User-visible status in UI (red = needs attention)

**Error handling needs:**
1. API/IPC call errors
2. Task execution failures
3. Git operation errors
4. Connection/network issues
5. Auth failures
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Toast notification system</name>
  <files>src/renderer/src/components/Toast/Toast.tsx, src/renderer/src/components/Toast/index.ts, src/renderer/src/stores/toast-store.ts</files>
  <action>
Create toast notification system for showing errors and status messages:

**src/renderer/src/stores/toast-store.ts:**
```typescript
import { create } from 'zustand';

export type ToastType = 'success' | 'error' | 'warning' | 'info';

export interface Toast {
  id: string;
  type: ToastType;
  message: string;
  duration?: number; // ms, default 5000
}

interface ToastStoreState {
  toasts: Toast[];
  addToast: (type: ToastType, message: string, duration?: number) => void;
  removeToast: (id: string) => void;
  clearAll: () => void;
}

export const useToastStore = create<ToastStoreState>((set, get) => ({
  toasts: [],

  addToast: (type, message, duration = 5000) => {
    const id = crypto.randomUUID();
    const toast: Toast = { id, type, message, duration };

    set((state) => ({
      toasts: [...state.toasts, toast]
    }));

    // Auto-remove after duration
    if (duration > 0) {
      setTimeout(() => {
        get().removeToast(id);
      }, duration);
    }
  },

  removeToast: (id) => {
    set((state) => ({
      toasts: state.toasts.filter((t) => t.id !== id)
    }));
  },

  clearAll: () => {
    set({ toasts: [] });
  }
}));

// Convenience functions
export const toast = {
  success: (message: string) => useToastStore.getState().addToast('success', message),
  error: (message: string) => useToastStore.getState().addToast('error', message, 8000),
  warning: (message: string) => useToastStore.getState().addToast('warning', message),
  info: (message: string) => useToastStore.getState().addToast('info', message)
};
```

**src/renderer/src/components/Toast/Toast.tsx:**
```tsx
import type { JSX } from 'react';
import { useToastStore, type Toast as ToastType, type ToastType as TType } from '../../stores/toast-store';

const typeStyles: Record<TType, string> = {
  success: 'bg-green-600 border-green-500',
  error: 'bg-red-600 border-red-500',
  warning: 'bg-yellow-600 border-yellow-500',
  info: 'bg-blue-600 border-blue-500'
};

const typeIcons: Record<TType, string> = {
  success: '✓',
  error: '✕',
  warning: '⚠',
  info: 'ℹ'
};

function ToastItem({ toast }: { toast: ToastType }): JSX.Element {
  const removeToast = useToastStore((state) => state.removeToast);

  return (
    <div
      className={`flex items-center gap-3 px-4 py-3 rounded-lg border shadow-lg text-white ${typeStyles[toast.type]}`}
      role="alert"
    >
      <span className="text-lg">{typeIcons[toast.type]}</span>
      <span className="flex-1">{toast.message}</span>
      <button
        onClick={() => removeToast(toast.id)}
        className="text-white/70 hover:text-white"
        aria-label="Dismiss"
      >
        ✕
      </button>
    </div>
  );
}

export default function ToastContainer(): JSX.Element {
  const toasts = useToastStore((state) => state.toasts);

  if (toasts.length === 0) return <></>;

  return (
    <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2 max-w-md">
      {toasts.map((toast) => (
        <ToastItem key={toast.id} toast={toast} />
      ))}
    </div>
  );
}
```

**src/renderer/src/components/Toast/index.ts:**
```typescript
export { default as ToastContainer } from './Toast';
export { useToastStore, toast } from '../../stores/toast-store';
```
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Toast notification system with success/error/warning/info types</done>
</task>

<task type="auto">
  <name>Task 2: Create ErrorBoundary component</name>
  <files>src/renderer/src/components/ErrorBoundary/ErrorBoundary.tsx, src/renderer/src/components/ErrorBoundary/index.ts</files>
  <action>
Create React ErrorBoundary for catching rendering errors:

**src/renderer/src/components/ErrorBoundary/ErrorBoundary.tsx:**
```tsx
import { Component, type ReactNode, type ErrorInfo } from 'react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

export default class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo): void {
    console.error('ErrorBoundary caught error:', error, errorInfo);
  }

  render(): ReactNode {
    if (this.state.hasError) {
      if (this.props.fallback) {
        return this.props.fallback;
      }

      return (
        <div className="flex flex-col items-center justify-center h-full p-8 bg-gray-900 text-white">
          <div className="bg-red-900/50 border border-red-500 rounded-lg p-6 max-w-lg">
            <h2 className="text-xl font-semibold text-red-400 mb-2">
              Something went wrong
            </h2>
            <p className="text-gray-300 mb-4">
              {this.state.error?.message || 'An unexpected error occurred'}
            </p>
            <button
              onClick={() => this.setState({ hasError: false, error: null })}
              className="px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-white"
            >
              Try Again
            </button>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}
```

**src/renderer/src/components/ErrorBoundary/index.ts:**
```typescript
export { default as ErrorBoundary } from './ErrorBoundary';
```
  </action>
  <verify>npm run typecheck passes</verify>
  <done>ErrorBoundary catches and displays React errors</done>
</task>

<task type="auto">
  <name>Task 3: Create StatusBadge component</name>
  <files>src/renderer/src/components/StatusBadge/StatusBadge.tsx, src/renderer/src/components/StatusBadge/index.ts</files>
  <action>
Create reusable StatusBadge component for task/feature status:

**src/renderer/src/components/StatusBadge/StatusBadge.tsx:**
```tsx
import type { JSX } from 'react';
import type { TaskStatus, FeatureStatus } from '@shared/types';

type Status = TaskStatus | FeatureStatus;

const statusConfig: Record<Status, { color: string; bg: string; label: string }> = {
  // Task statuses
  blocked: { color: 'text-blue-400', bg: 'bg-blue-500/20', label: 'Blocked' },
  ready: { color: 'text-blue-400', bg: 'bg-blue-500/20', label: 'Ready' },
  running: { color: 'text-yellow-400', bg: 'bg-yellow-500/20', label: 'Running' },
  merging: { color: 'text-yellow-400', bg: 'bg-yellow-500/20', label: 'Merging' },
  completed: { color: 'text-green-400', bg: 'bg-green-500/20', label: 'Completed' },
  failed: { color: 'text-red-400', bg: 'bg-red-500/20', label: 'Failed' },
  // Feature statuses
  not_started: { color: 'text-blue-400', bg: 'bg-blue-500/20', label: 'Not Started' },
  in_progress: { color: 'text-yellow-400', bg: 'bg-yellow-500/20', label: 'In Progress' },
  needs_attention: { color: 'text-red-400', bg: 'bg-red-500/20', label: 'Needs Attention' }
};

interface StatusBadgeProps {
  status: Status;
  showLabel?: boolean;
  size?: 'sm' | 'md' | 'lg';
}

export default function StatusBadge({
  status,
  showLabel = true,
  size = 'md'
}: StatusBadgeProps): JSX.Element {
  const config = statusConfig[status] || statusConfig.blocked;

  const sizeClasses = {
    sm: 'text-xs px-1.5 py-0.5',
    md: 'text-sm px-2 py-1',
    lg: 'text-base px-3 py-1.5'
  };

  const dotSizes = {
    sm: 'w-1.5 h-1.5',
    md: 'w-2 h-2',
    lg: 'w-2.5 h-2.5'
  };

  return (
    <span
      className={`inline-flex items-center gap-1.5 rounded-full ${config.bg} ${config.color} ${sizeClasses[size]}`}
    >
      <span
        className={`${dotSizes[size]} rounded-full ${
          status === 'running' || status === 'merging' || status === 'in_progress'
            ? 'animate-pulse bg-current'
            : 'bg-current'
        }`}
      />
      {showLabel && <span>{config.label}</span>}
    </span>
  );
}
```

**src/renderer/src/components/StatusBadge/index.ts:**
```typescript
export { default as StatusBadge } from './StatusBadge';
```
  </action>
  <verify>npm run typecheck passes</verify>
  <done>StatusBadge component for consistent status display</done>
</task>

<task type="auto">
  <name>Task 4: Create LoadingSpinner component</name>
  <files>src/renderer/src/components/Loading/LoadingSpinner.tsx, src/renderer/src/components/Loading/index.ts</files>
  <action>
Create loading indicator component:

**src/renderer/src/components/Loading/LoadingSpinner.tsx:**
```tsx
import type { JSX } from 'react';

interface LoadingSpinnerProps {
  size?: 'sm' | 'md' | 'lg';
  message?: string;
}

export default function LoadingSpinner({
  size = 'md',
  message
}: LoadingSpinnerProps): JSX.Element {
  const sizeClasses = {
    sm: 'w-4 h-4',
    md: 'w-8 h-8',
    lg: 'w-12 h-12'
  };

  return (
    <div className="flex flex-col items-center justify-center gap-3">
      <div
        className={`${sizeClasses[size]} border-2 border-gray-600 border-t-blue-500 rounded-full animate-spin`}
      />
      {message && <span className="text-gray-400 text-sm">{message}</span>}
    </div>
  );
}

// Full-screen loading overlay
export function LoadingOverlay({ message }: { message?: string }): JSX.Element {
  return (
    <div className="fixed inset-0 bg-gray-900/80 flex items-center justify-center z-50">
      <LoadingSpinner size="lg" message={message} />
    </div>
  );
}
```

**src/renderer/src/components/Loading/index.ts:**
```typescript
export { default as LoadingSpinner, LoadingOverlay } from './LoadingSpinner';
```
  </action>
  <verify>npm run typecheck passes</verify>
  <done>LoadingSpinner component for loading states</done>
</task>

<task type="auto">
  <name>Task 5: Integrate components into App</name>
  <files>src/renderer/src/App.tsx</files>
  <action>
Update App.tsx to include ToastContainer and ErrorBoundary:

1. Import ToastContainer from components/Toast
2. Import ErrorBoundary from components/ErrorBoundary
3. Wrap main content with ErrorBoundary
4. Add ToastContainer at the root level

```tsx
import { ToastContainer } from './components/Toast';
import { ErrorBoundary } from './components/ErrorBoundary';

function App(): JSX.Element {
  // ... existing code ...

  return (
    <ErrorBoundary>
      <div className="flex flex-col h-screen bg-gray-900 text-white">
        {/* ... existing navigation and content ... */}
      </div>
      <ToastContainer />
    </ErrorBoundary>
  );
}
```
  </action>
  <verify>npm run typecheck passes</verify>
  <done>App wrapped with error handling and toast notifications</done>
</task>

<task type="auto">
  <name>Task 6: Add error handling to stores</name>
  <files>src/renderer/src/stores/feature-store.ts, src/renderer/src/stores/dag-store.ts, src/renderer/src/stores/execution-store.ts</files>
  <action>
Add toast notifications for errors in stores:

Import toast from toast-store in each store file.

Add error handling to async actions. Example pattern:

```typescript
import { toast } from './toast-store';

// In store actions:
loadFeatures: async () => {
  try {
    const features = await window.electronAPI.storage.loadFeatures();
    set({ features });
  } catch (error) {
    toast.error(`Failed to load features: ${error}`);
    console.error('Failed to load features:', error);
  }
}

// For execution store:
start: async (featureId) => {
  try {
    const result = await window.electronAPI.execution.start(featureId);
    if (result.success) {
      toast.success('Execution started');
      // ... update state
    } else {
      toast.error(result.error || 'Failed to start execution');
    }
    return result;
  } catch (error) {
    toast.error(`Execution error: ${error}`);
    return { success: false, error: String(error) };
  }
}
```

Add error toasts to:
- feature-store: loadFeatures, createFeature, archiveFeature
- dag-store: loadDag, saveDag, undo, redo
- execution-store: start, pause, resume, stop
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Stores show toast notifications on errors</done>
</task>

<task type="auto">
  <name>Task 7: Update STATE.md and ROADMAP.md for completion</name>
  <files>.planning/STATE.md, .planning/ROADMAP.md</files>
  <action>
Update project state files to mark Phase 7 and milestone complete:

**STATE.md updates:**
- Phase: Complete (7 of 7)
- Progress: 100%
- Last activity: Phase 7 complete

Add Phase 7 to completed phases list:
```
### Phase 7: Polish & Integration ✓

- **07-01**: Authentication priority chain with AuthManager
- **07-02**: Play/Stop execution controls connected to orchestrator
- **07-03**: Graph versioning with 20-version undo/redo
- **07-04**: Error handling with toasts, ErrorBoundary, StatusBadge
```

**ROADMAP.md updates:**
- Mark Phase 7 checkboxes as complete
- Update progress table to show 4/4 plans complete for Phase 7
- Set Phase 7 status to Complete with date
  </action>
  <verify>Files updated correctly</verify>
  <done>Project files reflect milestone completion</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] Toast notifications appear for errors
- [ ] ErrorBoundary catches and displays React errors
- [ ] StatusBadge shows correct colors for all statuses
- [ ] LoadingSpinner displays during async operations
- [ ] Stores show error toasts on failures
- [ ] STATE.md and ROADMAP.md updated
</verification>

<success_criteria>
- Toast notification system operational
- ErrorBoundary prevents app crashes
- StatusBadge with consistent status colors
- LoadingSpinner for async operations
- Stores integrated with error toasts
- Phase 7 marked complete
- Milestone 1 complete
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-integration/07-04-SUMMARY.md` with:
- Tasks completed
- Files created/modified
- Key decisions
- Phase 7 complete
- Milestone 1 complete
</output>
