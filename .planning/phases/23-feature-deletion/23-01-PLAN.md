---
phase: 23-feature-deletion
plan: 01
type: execute
---

<objective>
Implement safe feature deletion with full cleanup including storage, git worktrees/branches, and running agents.

Purpose: Allow users to delete features from the Kanban board with proper cleanup of all associated resources.
Output: Delete button on feature cards, confirmation dialog, comprehensive cleanup IPC handler.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-pm-agent-crud-operations/22-02-SUMMARY.md

**Key files:**
@src/main/storage/feature-store.ts - Has deleteFeature() method
@src/main/ipc/storage-handlers.ts - Has storage:deleteFeature handler (just deletes storage)
@src/main/git/git-manager.ts - Has removeWorktree(), deleteBranch()
@src/main/agents/agent-pool.ts - Has terminateAgent(), getAgents()
@src/renderer/src/stores/feature-store.ts - Has removeFeature() but no deleteFeature async action
@src/renderer/src/components/Kanban/FeatureCard.tsx - Already has onArchive prop pattern
@src/preload/index.ts - Exposes storage.deleteFeature
@src/preload/index.d.ts - Type declarations

**Tech stack available:** Electron IPC, Zustand stores, Tailwind CSS, React
**Established patterns:** IPC handlers return { success, error? }, toast for feedback, confirmation dialogs (see NewFeatureDialog)

**Constraining decisions:**
- Phase 22: PM Agent has DeleteTask tool with reassignDependents options (reference pattern)
- Storage deleteFeature already exists but only deletes .dagent directory
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive feature deletion IPC handler</name>
  <files>src/main/ipc/feature-handlers.ts (new), src/main/ipc/handlers.ts</files>
  <action>
Create a new IPC handler file for feature-level operations. Add a `feature:delete` handler that:
1. Accepts featureId and options: { deleteBranch?: boolean, force?: boolean }
2. Gets feature info first to collect branch name
3. Terminates any agents working on this feature's tasks (filter by featureId)
4. Lists and removes all task worktrees for the feature using GitManager
5. Removes the feature worktree using GitManager
6. Deletes the feature branch (if deleteBranch option is true)
7. Deletes the feature storage (.dagent/worktrees/{featureId}/)
8. Returns { success, deletedBranch, deletedWorktrees, terminatedAgents, error? }

Register the new handlers in handlers.ts. Use try-catch with detailed error messages. Do NOT skip cleanup steps on partial failure - collect all errors and report.

Import getGitManager from '../git/git-manager', getAgentPool from '../agents/agent-pool', getFeatureStore from './storage-handlers'.
  </action>
  <verify>TypeScript compiles without errors: `npm run build`</verify>
  <done>feature:delete IPC handler exists that performs full cleanup sequence</done>
</task>

<task type="auto">
  <name>Task 2: Add deleteFeature to preload and renderer store</name>
  <files>src/preload/index.ts, src/preload/index.d.ts, src/renderer/src/stores/feature-store.ts</files>
  <action>
1. In preload/index.ts, add feature API namespace:
   ```
   feature: {
     delete: (featureId: string, options?: { deleteBranch?: boolean; force?: boolean }) =>
       ipcRenderer.invoke('feature:delete', featureId, options)
   }
   ```

2. In preload/index.d.ts, add FeatureAPI interface:
   ```
   export interface FeatureDeleteResult {
     success: boolean
     deletedBranch?: boolean
     deletedWorktrees?: number
     terminatedAgents?: number
     error?: string
   }

   export interface FeatureAPI {
     delete: (featureId: string, options?: { deleteBranch?: boolean; force?: boolean }) => Promise<FeatureDeleteResult>
   }
   ```
   Add `feature: FeatureAPI` to ElectronAPI interface.

3. In renderer feature-store.ts, add async deleteFeature action:
   - Call window.electronAPI.feature.delete(featureId, { deleteBranch: true })
   - On success: call removeFeature(featureId), toast.success
   - On failure: toast.error with message
   - Set loading states appropriately
  </action>
  <verify>TypeScript compiles: `npm run build`</verify>
  <done>deleteFeature available via window.electronAPI.feature.delete and useFeatureStore().deleteFeature</done>
</task>

<task type="auto">
  <name>Task 3: Create DeleteFeatureDialog and wire to FeatureCard</name>
  <files>src/renderer/src/components/Feature/DeleteFeatureDialog.tsx (new), src/renderer/src/components/Kanban/FeatureCard.tsx, src/renderer/src/views/KanbanView.tsx</files>
  <action>
1. Create DeleteFeatureDialog.tsx:
   - Props: { isOpen, onClose, feature: Feature | null, onConfirm: (deleteBranch: boolean) => void }
   - Show feature name, warning text about irreversibility
   - Checkbox for "Also delete git branch" (default checked)
   - Cancel and Delete buttons (Delete is red/danger styled)
   - Use same dialog pattern as NewFeatureDialog (fixed overlay, centered card)

2. Update FeatureCard.tsx:
   - Add onDelete prop: (featureId: string) => void
   - Add trash icon button (üóëÔ∏è or SVG) that appears on hover (like the Archive button)
   - Icon is subtle gray, brightens on hover
   - Clicking triggers onDelete(feature.id)
   - Don't show delete for features that are in_progress (safety)

3. Update KanbanView.tsx:
   - Import DeleteFeatureDialog
   - Add state: deleteDialogOpen, featureToDelete
   - Pass onDelete handler to FeatureCard that sets featureToDelete and opens dialog
   - In dialog onConfirm: call useFeatureStore().deleteFeature(featureId), close dialog
   - Map through features in all columns and pass the handler
  </action>
  <verify>npm run dev - delete button appears on feature cards, clicking opens dialog</verify>
  <done>Delete button on FeatureCard, confirmation dialog shows with branch deletion option</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] Delete icon visible on feature cards in Kanban view
- [ ] Clicking delete opens confirmation dialog
- [ ] Dialog shows feature name and branch deletion checkbox
- [ ] Confirming delete removes feature from list
- [ ] Git worktree and branch are cleaned up (verify with `git worktree list`)
- [ ] Running agents for the feature are terminated
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Features can be deleted from Kanban board
- Full cleanup of storage, git resources, and agents
- User-friendly confirmation dialog prevents accidental deletion
</success_criteria>

<output>
After completion, create `.planning/phases/23-feature-deletion/23-01-SUMMARY.md` with:
- Phase 23 Plan 01 summary
- Accomplishments (IPC handler, preload, store, dialog, UI)
- Files created/modified
- Decisions made
- Issues encountered
- Next Phase Readiness (Phase 24 or v1.4 completion)
</output>
