---
phase: v3.1-02-analysis-orchestrator
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/main/services/task-analysis-orchestrator.ts]
autonomous: true
must_haves:
  truths:
    - "TaskAnalysisOrchestrator can find all needs_analysis tasks"
    - "Orchestrator exposes streaming event interface"
  artifacts:
    - path: "src/main/services/task-analysis-orchestrator.ts"
      provides: "Core orchestrator service with event types and scanning"
      min_lines: 100
      exports: ["TaskAnalysisOrchestrator", "AnalysisEvent", "AnalysisResult", "getTaskAnalysisOrchestrator"]
  key_links:
    - from: "src/main/services/task-analysis-orchestrator.ts"
      to: "@shared/types"
      via: "Task type import"
      pattern: "import.*Task.*from.*@shared/types"
---

<objective>
Create TaskAnalysisOrchestrator service foundation with types and task scanning.

Purpose: Establish the core service that will manage the analysis loop for needs_analysis tasks.
Output: TaskAnalysisOrchestrator class with getPendingTasks(), hasPendingAnalysis(), and event type definitions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/main/services/feature-status-manager.ts
@src/main/dag-engine/orchestrator.ts
@src/shared/types/task.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TaskAnalysisOrchestrator service with types</name>
  <files>src/main/services/task-analysis-orchestrator.ts</files>
  <action>
Create a new service file with:

1. Type definitions for AnalysisEvent (union type with analyzing, kept, split, complete, error variants)
2. Type definition for AnalysisResult (decision: 'keep' | 'split', with optional newTasks array)
3. TaskAnalysisOrchestrator class with:
   - Constructor taking featureStore reference
   - getPendingTasks(featureId: string): Promise<Task[]> - returns all needs_analysis tasks
   - hasPendingAnalysis(featureId: string): Promise<boolean> - returns true if any needs_analysis tasks
   - Placeholder async generator analyzeFeatureTasks(featureId: string): AsyncGenerator<AnalysisEvent>
   - Placeholder analyzeTask(featureId: string, taskId: string): Promise<AnalysisResult>

Import Task from @shared/types, FeatureStore from ../storage/feature-store.

Pattern after feature-status-manager.ts for service structure.
Use DAGGraph loading via featureStore.loadDag() to scan tasks.
  </action>
  <verify>npm run build passes</verify>
  <done>TaskAnalysisOrchestrator service exists with correct type exports and task scanning methods</done>
</task>

<task type="auto">
  <name>Task 2: Add singleton accessor</name>
  <files>src/main/services/task-analysis-orchestrator.ts</files>
  <action>
Add singleton pattern for global access:

```typescript
let orchestratorInstance: TaskAnalysisOrchestrator | null = null

export function getTaskAnalysisOrchestrator(featureStore: FeatureStore): TaskAnalysisOrchestrator {
  if (!orchestratorInstance) {
    orchestratorInstance = new TaskAnalysisOrchestrator(featureStore)
  }
  return orchestratorInstance
}

export function resetTaskAnalysisOrchestrator(): void {
  orchestratorInstance = null
}
```

This follows the pattern used in orchestrator.ts for singleton management.
  </action>
  <verify>npm run build passes</verify>
  <done>Singleton accessor functions exported and working</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] src/main/services/task-analysis-orchestrator.ts exists
- [ ] Exports: TaskAnalysisOrchestrator, AnalysisEvent, AnalysisResult, getTaskAnalysisOrchestrator
- [ ] getPendingTasks returns Task[] filtered by needs_analysis status
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Service foundation ready for prompt builder and execution implementation
</success_criteria>

<output>
After completion, create `.planning/phases/v3.1-02-analysis-orchestrator/02-01-SUMMARY.md`
</output>
