---
phase: v3.1-02-analysis-orchestrator
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified: [src/main/services/task-analysis-orchestrator.ts, src/main/agent/agent-service.ts]
autonomous: true
must_haves:
  truths:
    - "analyzeTask executes PM query and parses response"
    - "Split decision creates new tasks with needs_analysis status"
    - "Keep decision transitions task to ready_for_dev"
  artifacts:
    - path: "src/main/services/task-analysis-orchestrator.ts"
      provides: "Complete analysis execution logic"
      contains: "analyzeTask"
  key_links:
    - from: "src/main/services/task-analysis-orchestrator.ts"
      to: "src/main/agent/pm-analysis-prompt.ts"
      via: "prompt builder import"
      pattern: "import.*buildAnalysisPrompt.*from"
    - from: "src/main/services/task-analysis-orchestrator.ts"
      to: "src/main/ipc/pm-dag-handlers.ts"
      via: "DAG operations"
      pattern: "pmDAGAddNode|pmDAGAddConnection"
---

<objective>
Implement analysis execution connecting orchestrator to AgentService and DAGManager.

Purpose: Complete the analysis loop logic - PM analyzes task, orchestrator applies decision.
Output: Working analyzeTask and analyzeFeatureTasks methods with full execution flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/v3.1-02-analysis-orchestrator/02-01-SUMMARY.md
@.planning/phases/v3.1-02-analysis-orchestrator/02-02-SUMMARY.md

@src/main/agent/agent-service.ts
@src/main/ipc/pm-dag-handlers.ts
@src/main/services/task-analysis-orchestrator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement analyzeTask method</name>
  <files>src/main/services/task-analysis-orchestrator.ts</files>
  <action>
Complete the analyzeTask method implementation:

1. Load feature spec from FeatureSpecStore (via agents/feature-spec-store.ts)
2. Build analysis prompt using buildAnalysisPrompt(task, featureSpec)
3. Execute PM query via AgentService with:
   - toolPreset: 'pmAgent' (or minimal tools - no DAG tools needed for analysis-only)
   - permissionMode: 'default'
   - Collect full response text
4. Parse response using parseAnalysisResponse
5. Return AnalysisResult with decision and any new tasks

Import dependencies:
- buildAnalysisPrompt, parseAnalysisResponse from './agent/pm-analysis-prompt'
- getAgentService from './agent/agent-service'
- getFeatureSpecStore from './agents/feature-spec-store'

Handle errors gracefully - return error result, don't throw.
  </action>
  <verify>npm run build passes</verify>
  <done>analyzeTask executes PM query and returns parsed AnalysisResult</done>
</task>

<task type="auto">
  <name>Task 2: Implement analyzeFeatureTasks loop</name>
  <files>src/main/services/task-analysis-orchestrator.ts</files>
  <action>
Complete the analyzeFeatureTasks async generator:

```typescript
async *analyzeFeatureTasks(featureId: string): AsyncGenerator<AnalysisEvent> {
  // Loop until no more needs_analysis tasks
  while (true) {
    const pendingTasks = await this.getPendingTasks(featureId)
    if (pendingTasks.length === 0) {
      yield { type: 'complete', featureId }
      return
    }

    // Process first task
    const task = pendingTasks[0]
    yield { type: 'analyzing', taskId: task.id }

    try {
      const result = await this.analyzeTask(featureId, task.id)

      if (result.decision === 'keep') {
        // Transition to ready_for_dev via DAG operations
        await this.transitionToReady(featureId, task.id)
        yield { type: 'kept', taskId: task.id }
      } else {
        // Create subtasks and remove original
        const newTasks = await this.createSubtasks(featureId, task.id, result.newTasks!)
        yield { type: 'split', taskId: task.id, newTasks }
      }
    } catch (error) {
      yield { type: 'error', taskId: task.id, error: error instanceof Error ? error.message : 'Unknown error' }
      // Continue with next task instead of stopping
    }
  }
}
```

Implement helper methods:
- transitionToReady(featureId, taskId): Update task status to ready_for_dev via DAGManager
- createSubtasks(featureId, taskId, newTaskDefs): Create new tasks via pmDAGAddNode, add dependencies via pmDAGAddConnection, remove original task
  </action>
  <verify>npm run build passes</verify>
  <done>analyzeFeatureTasks loops through all needs_analysis tasks and yields events</done>
</task>

<task type="auto">
  <name>Task 3: Add helper methods for task transitions</name>
  <files>src/main/services/task-analysis-orchestrator.ts</files>
  <action>
Implement the helper methods:

1. transitionToReady(featureId: string, taskId: string): Promise<void>
   - Load DAG via featureStore.loadDag(featureId)
   - Find task, update status to 'ready_for_dev'
   - Save DAG via featureStore.saveDag(featureId, dag)

2. createSubtasks(featureId: string, parentTaskId: string, taskDefs: Array<{title, description, dependsOn?}>): Promise<Task[]>
   - Create each subtask via pmDAGAddNode with status 'needs_analysis'
   - Track created task IDs
   - Add dependencies: for each subtask with dependsOn, call pmDAGAddConnection
   - Remove parent task via pmDAGRemoveNode
   - Return array of created tasks

Import pmDAGAddNode, pmDAGAddConnection, pmDAGRemoveNode from '../ipc/pm-dag-handlers'.

Note: The pmDAG handlers already use getPMToolsFeatureContext() which reads from the stored feature context. Ensure the feature context is set before calling these handlers (pm-tools-handlers.setPMToolsFeatureContext).
  </action>
  <verify>npm run build passes</verify>
  <done>Helper methods handle task status transitions and subtask creation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] analyzeTask calls PM and parses response
- [ ] analyzeFeatureTasks loops until no needs_analysis tasks remain
- [ ] transitionToReady updates task status correctly
- [ ] createSubtasks creates new tasks and removes parent
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Core analysis execution flow complete
</success_criteria>

<output>
After completion, create `.planning/phases/v3.1-02-analysis-orchestrator/02-03-SUMMARY.md`
</output>
