---
phase: v3.1-02-analysis-orchestrator
plan: 04
type: execute
wave: 3
depends_on: ["02-02"]
files_modified: [src/main/ipc/analysis-handlers.ts, src/main/index.ts]
autonomous: true
must_haves:
  truths:
    - "Renderer can trigger analysis via IPC"
    - "Renderer receives streaming analysis events"
  artifacts:
    - path: "src/main/ipc/analysis-handlers.ts"
      provides: "IPC handlers for analysis orchestrator"
      min_lines: 50
      exports: ["registerAnalysisHandlers"]
  key_links:
    - from: "src/main/ipc/analysis-handlers.ts"
      to: "src/main/services/task-analysis-orchestrator.ts"
      via: "orchestrator import"
      pattern: "import.*TaskAnalysisOrchestrator|getTaskAnalysisOrchestrator"
---

<objective>
Add IPC handlers for analysis orchestrator to expose functionality to renderer.

Purpose: Enable UI to start, monitor, and receive events from analysis orchestrator.
Output: IPC handlers for analysis:start, analysis:status, analysis:pending with event streaming.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/v3.1-02-analysis-orchestrator/02-01-SUMMARY.md
@.planning/phases/v3.1-02-analysis-orchestrator/02-02-SUMMARY.md

@src/main/ipc/storage-handlers.ts
@src/main/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analysis IPC handlers file</name>
  <files>src/main/ipc/analysis-handlers.ts</files>
  <action>
Create new IPC handlers file with:

```typescript
import { ipcMain, BrowserWindow } from 'electron'
import { getTaskAnalysisOrchestrator } from '../services/task-analysis-orchestrator'
import { getFeatureStore } from './storage-handlers'

// Track running analysis per feature
const runningAnalysis: Map<string, boolean> = new Map()

export function registerAnalysisHandlers(): void {
  // Start analysis for a feature
  ipcMain.handle('analysis:start', async (event, featureId: string) => {
    if (runningAnalysis.get(featureId)) {
      return { success: false, error: 'Analysis already running for this feature' }
    }

    const featureStore = getFeatureStore()
    if (!featureStore) {
      return { success: false, error: 'Feature store not initialized' }
    }

    const orchestrator = getTaskAnalysisOrchestrator(featureStore)
    runningAnalysis.set(featureId, true)

    // Start analysis in background, stream events to renderer
    startAnalysisStream(featureId, orchestrator, event.sender)

    return { success: true }
  })

  // Check if analysis is running
  ipcMain.handle('analysis:status', async (event, featureId: string) => {
    return { running: runningAnalysis.get(featureId) || false }
  })

  // Get count of pending tasks
  ipcMain.handle('analysis:pending', async (event, featureId: string) => {
    const featureStore = getFeatureStore()
    if (!featureStore) {
      return { count: 0 }
    }
    const orchestrator = getTaskAnalysisOrchestrator(featureStore)
    const pending = await orchestrator.getPendingTasks(featureId)
    return { count: pending.length }
  })
}

async function startAnalysisStream(
  featureId: string,
  orchestrator: TaskAnalysisOrchestrator,
  sender: Electron.WebContents
): Promise<void> {
  try {
    for await (const event of orchestrator.analyzeFeatureTasks(featureId)) {
      sender.send('analysis:event', { featureId, event })
      if (event.type === 'complete' || event.type === 'error') {
        break
      }
    }
  } finally {
    runningAnalysis.delete(featureId)
  }
}
```

Pattern after storage-handlers.ts for handler registration structure.
  </action>
  <verify>npm run build passes</verify>
  <done>analysis-handlers.ts created with start, status, pending handlers</done>
</task>

<task type="auto">
  <name>Task 2: Register handlers in main index</name>
  <files>src/main/index.ts</files>
  <action>
Add import and registration call:

1. Add import at top with other handler imports:
   ```typescript
   import { registerAnalysisHandlers } from './ipc/analysis-handlers'
   ```

2. Add registration call where other handlers are registered (look for registerStorageHandlers or similar pattern):
   ```typescript
   registerAnalysisHandlers()
   ```

Do NOT modify any existing handler registrations. Just add the new one.
  </action>
  <verify>npm run build passes</verify>
  <done>Analysis handlers registered in main process</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] src/main/ipc/analysis-handlers.ts exists
- [ ] Handlers registered in main index
- [ ] analysis:start, analysis:status, analysis:pending handlers implemented
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Renderer can invoke analysis operations via IPC
</success_criteria>

<output>
After completion, create `.planning/phases/v3.1-02-analysis-orchestrator/02-04-SUMMARY.md`
</output>
