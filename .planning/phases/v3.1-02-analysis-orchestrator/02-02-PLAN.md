---
phase: v3.1-02-analysis-orchestrator
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/main/agent/pm-analysis-prompt.ts]
autonomous: true
must_haves:
  truths:
    - "buildAnalysisPrompt generates JSON-output-focused prompt"
    - "Prompt includes decision framework (keep vs split)"
  artifacts:
    - path: "src/main/agent/pm-analysis-prompt.ts"
      provides: "Analysis prompt builder for PM task analysis"
      min_lines: 50
      exports: ["buildAnalysisPrompt"]
  key_links:
    - from: "src/main/agent/pm-analysis-prompt.ts"
      to: "@shared/types"
      via: "Task type for input"
      pattern: "import.*Task.*from.*@shared/types"
---

<objective>
Create PM analysis prompt builder for task complexity analysis.

Purpose: Generate prompts that guide PM to make keep/split decisions with structured JSON output.
Output: buildAnalysisPrompt function that creates prompts with clear decision framework.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/v3.1-02-analysis-orchestrator/02-01-SUMMARY.md

@src/main/agent/prompt-builders.ts
@.planning/milestones/v3.1-task-analysis-orchestrator-ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PM analysis prompt builder</name>
  <files>src/main/agent/pm-analysis-prompt.ts</files>
  <action>
Create new prompt builder file with:

```typescript
import type { Task } from '@shared/types'

export function buildAnalysisPrompt(task: Task, featureSpec: string): string
```

The prompt should include:
1. Feature spec context section
2. Task details section (title, description)
3. Decision framework with clear KEEP vs SPLIT criteria:
   - KEEP: Single deliverable, tightly coupled items, reasonable scope
   - SPLIT: Multiple independent deliverables, too complex for one session
4. JSON output format specification:
   - For KEEP: `{ "decision": "keep" }`
   - For SPLIT: `{ "decision": "split", "tasks": [{ "title": "...", "description": "...", "dependsOn": [] }] }`
5. IMPORTANT rules:
   - Never create verification/QA tasks
   - Never create planning tasks
   - Use dependsOn when task B needs output from task A
   - Keep tasks focused and actionable
   - New subtasks should NOT have circular dependencies

Use template literal for the prompt structure. Follow the format from roadmap section 2.2.
  </action>
  <verify>npm run build passes</verify>
  <done>buildAnalysisPrompt exports and generates proper prompt with JSON output format</done>
</task>

<task type="auto">
  <name>Task 2: Add response parsing helper</name>
  <files>src/main/agent/pm-analysis-prompt.ts</files>
  <action>
Add a parsing helper for the PM response:

```typescript
export interface ParsedAnalysisResponse {
  decision: 'keep' | 'split'
  tasks?: Array<{
    title: string
    description: string
    dependsOn?: string[]
  }>
  error?: string
}

export function parseAnalysisResponse(response: string): ParsedAnalysisResponse
```

Implementation:
1. Try to extract JSON from the response (handle markdown code blocks)
2. Validate decision is 'keep' or 'split'
3. If 'split', validate tasks array exists and has at least one item
4. Return parsed result or error message

This helps the orchestrator handle malformed PM responses gracefully.
  </action>
  <verify>npm run build passes</verify>
  <done>parseAnalysisResponse exported and handles valid/invalid responses</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] src/main/agent/pm-analysis-prompt.ts exists
- [ ] Exports: buildAnalysisPrompt, parseAnalysisResponse, ParsedAnalysisResponse
- [ ] Prompt includes JSON output format specification
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Prompt generates structured analysis instructions with JSON output
</success_criteria>

<output>
After completion, create `.planning/phases/v3.1-02-analysis-orchestrator/02-02-SUMMARY.md`
</output>
