---
phase: 38-message-queue
plan: 02
type: execute
---

<objective>
Migrate TaskAgent to send messages instead of direct harness method calls.

Purpose: TaskAgent becomes a message publisher, sending intentions and status updates through MessageBus.
Output: TaskAgent uses MessageBus for all harness communication.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/38-message-queue/38-01-SUMMARY.md

**Key files from prior plans:**
@src/main/agents/task-agent.ts
@src/main/agents/harness-agent.ts
@src/main/agents/message-bus.ts

**Tech stack available:** MessageBus, AgentMessage types, createTaskToHarnessMessage helper
**Established patterns:** Session logging alongside message sending
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace registerTaskAssignment call with message</name>
  <files>src/main/agents/task-agent.ts</files>
  <action>
In initialize() method, after registering with harness (line ~117):

1. Import MessageBus and message helpers at top of file
2. Replace direct harness.registerTaskAssignment() call with:
   ```typescript
   const bus = getMessageBus()
   bus.publish(createTaskToHarnessMessage(
     this.state.taskId,
     this.state.agentId!,
     'task_registered',
     { taskId: this.state.taskId }
   ))
   ```
3. Keep the harness.registerTaskAssignment() call for now (dual-write during migration)
   - This maintains backward compatibility until harness is updated in Phase 39

Session logging continues to work alongside message publishing.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>TaskAgent publishes task_registered message on initialize</done>
</task>

<task type="auto">
  <name>Task 2: Replace receiveIntention call with message</name>
  <files>src/main/agents/task-agent.ts</files>
  <action>
In proposeIntention() method:

1. After logging to session, publish intention message:
   ```typescript
   const bus = getMessageBus()
   bus.publish(createTaskToHarnessMessage(
     this.state.taskId,
     this.state.agentId!,
     'intention_proposed',
     { intention: intentionText, files: undefined }
   ))
   ```
2. Keep the harness.receiveIntention() call for backward compatibility

The message bus allows harness to receive intentions via subscription in Phase 39.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>TaskAgent publishes intention_proposed message</done>
</task>

<task type="auto">
  <name>Task 3: Subscribe TaskAgent to approval messages</name>
  <files>src/main/agents/task-agent.ts</files>
  <action>
Add subscription for approval/rejection messages:

1. In initialize() after publishing task_registered:
   ```typescript
   // Subscribe to approval/rejection messages for this task
   const bus = getMessageBus()
   this.unsubscribe = bus.subscribeToTask(this.state.taskId, (msg) => {
     if (msg.type === 'intention_approved' && msg.to.id === this.state.agentId) {
       this.handleApprovalMessage(msg.payload as IntentionApprovedPayload)
     } else if (msg.type === 'intention_rejected' && msg.to.id === this.state.agentId) {
       this.handleRejectionMessage(msg.payload as IntentionRejectedPayload)
     }
   })
   ```

2. Add private unsubscribe property: `private unsubscribe?: () => void`

3. Add handler methods:
   - handleApprovalMessage(payload: IntentionApprovedPayload): void
     - Convert payload to IntentionDecision
     - Call existing receiveApproval() logic
   - handleRejectionMessage(payload: IntentionRejectedPayload): void
     - Convert payload to IntentionDecision with approved=false
     - Call existing receiveApproval() logic

4. In cleanup(), call this.unsubscribe?.() to clean up subscription

This allows TaskAgent to receive approvals via either direct call OR message.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>TaskAgent subscribes to and handles approval/rejection messages</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] TaskAgent publishes task_registered on initialize
- [ ] TaskAgent publishes intention_proposed on proposeIntention
- [ ] TaskAgent subscribes to approval/rejection messages
- [ ] Backward compatibility maintained (direct calls still work)
</verification>

<success_criteria>
- All tasks completed
- TaskAgent communicates via both messages AND direct calls
- Session logging continues alongside messaging
- No regressions in task execution flow
</success_criteria>

<output>
After completion, create `.planning/phases/38-message-queue/38-02-SUMMARY.md`
</output>
