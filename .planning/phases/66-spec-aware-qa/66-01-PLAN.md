---
phase: 66-spec-aware-qa
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/agents/qa-types.ts
  - src/main/agents/qa-agent.ts
  - src/main/dag-engine/orchestrator.ts
autonomous: true
must_haves:
  truths:
    - "QA agent receives feature spec when reviewing code"
    - "QA validates against spec acceptance criteria, not just task description"
    - "QA feedback references specific spec requirements when failing"
  artifacts:
    - path: "src/main/agents/qa-types.ts"
      provides: "QAAgentState with featureSpec field"
      contains: "featureSpec"
    - path: "src/main/agents/qa-agent.ts"
      provides: "QA review prompt includes acceptance criteria"
      contains: "acceptanceCriteria"
    - path: "src/main/dag-engine/orchestrator.ts"
      provides: "Orchestrator loads and passes spec to QA agent"
      contains: "getFeatureSpecStore"
  key_links:
    - from: "orchestrator.ts handleQATasks()"
      to: "qa-agent.ts initialize()"
      via: "passes featureSpec parameter"
      pattern: "qaAgent\\.initialize.*featureSpec"
    - from: "qa-agent.ts buildReviewPrompt()"
      to: "featureSpec.acceptanceCriteria"
      via: "includes acceptance criteria in prompt"
      pattern: "acceptanceCriteria"
---

<objective>
Enable QA agent to validate code against feature spec acceptance criteria, not just task description.

Purpose: QA currently only sees task title/description. By reading the feature spec, QA can validate implementation meets the broader feature requirements and acceptance criteria, catching issues where code "works" but doesn't meet spec.

Output: QA agent receives and uses feature spec in code review prompts, with feedback referencing specific acceptance criteria when failing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/65-spec-aware-devagent/65-01-SUMMARY.md

# Relevant source files:
@src/main/agents/qa-agent.ts
@src/main/agents/qa-types.ts
@src/main/agents/feature-spec-types.ts
@src/main/dag-engine/orchestrator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add featureSpec to QAAgentState type</name>
  <files>src/main/agents/qa-types.ts</files>
  <action>
    1. Import FeatureSpec type from './feature-spec-types'
    2. Add optional `featureSpec: FeatureSpec | null` field to QAAgentState interface
    3. Update DEFAULT_QA_AGENT_STATE to include `featureSpec: null`
  </action>
  <verify>npm run typecheck passes</verify>
  <done>QAAgentState type includes featureSpec field with proper typing</done>
</task>

<task type="auto">
  <name>Task 2: Update QAAgent to accept and use featureSpec</name>
  <files>src/main/agents/qa-agent.ts</files>
  <action>
    1. Import FeatureSpec type from './feature-spec-types'
    2. Add private `featureSpec: FeatureSpec | null = null` field to QAAgent class
    3. Update initialize() signature to accept optional featureSpec parameter:
       `initialize(taskTitle, taskDescription, worktreePath, featureSpec?: FeatureSpec)`
    4. In initialize(), store featureSpec: `this.featureSpec = featureSpec || null`
       and `this.state.featureSpec = featureSpec || null`
    5. Update buildReviewPrompt() to include spec-aware sections when featureSpec exists:
       - Add "## Feature Specification" section with goals and acceptance criteria
       - Update review criteria to include "Does the code satisfy the acceptance criteria?"
       - Update response format to reference spec items (e.g., "AC-001 not satisfied")

    The prompt structure when spec exists:
    ```
    # Code Review Request

    ## Feature Specification
    **Feature:** {featureName}

    ### Goals
    - {goal1}
    - {goal2}

    ### Acceptance Criteria
    - AC-001: {description} [○/✓]
    - AC-002: {description} [○/✓]

    ## Task Being Reviewed
    **Title:** {taskTitle}
    **Description:** {taskDescription}

    ## Review Criteria
    1. Does the code implement what the task specified?
    2. Does the code satisfy the acceptance criteria listed above?
    3. Are there any obvious bugs or issues?
    4. Does the code follow reasonable patterns?

    ## Instructions
    ...existing instructions...

    ## Response Format
    ...existing format with addition:
    CRITERIA_STATUS: [list AC-XXX items that pass/fail, if spec exists]
    ```
  </action>
  <verify>npm run typecheck passes</verify>
  <done>QAAgent accepts featureSpec and includes acceptance criteria in review prompt</done>
</task>

<task type="auto">
  <name>Task 3: Load and pass featureSpec in orchestrator handleQATasks()</name>
  <files>src/main/dag-engine/orchestrator.ts</files>
  <action>
    1. Add import for getFeatureSpecStore from '../agents/feature-spec-store'
    2. Add import for FeatureSpec type from '../agents/feature-spec-types'
    3. In handleQATasks(), before spawning QA agent:
       - Load feature spec: `const specStore = getFeatureSpecStore(projectRoot)`
       - Get spec: `const featureSpec = await specStore.loadSpec(this.state.featureId)`
    4. Update qaAgent.initialize() call to pass featureSpec:
       `qaAgent.initialize(task.title, task.description, worktreePath, featureSpec || undefined)`

    Note: projectRoot should be obtained from gitManager.getConfig().projectRoot or similar.
    Check how task-controller.ts gets projectRoot for consistency.
  </action>
  <verify>npm run build succeeds</verify>
  <done>Orchestrator loads feature spec and passes to QA agent during initialization</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run typecheck passes
- [ ] npm run build succeeds
- [ ] QAAgentState type includes featureSpec field
- [ ] QAAgent.initialize() accepts optional featureSpec parameter
- [ ] buildReviewPrompt() includes acceptance criteria when spec exists
- [ ] orchestrator loads spec and passes to QA agent
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- QA agent can receive feature spec during initialization
- Review prompt includes acceptance criteria from spec
- Spec-aware review criteria added to prompt
</success_criteria>

<output>
After completion, create `.planning/phases/66-spec-aware-qa/66-01-SUMMARY.md`
</output>
