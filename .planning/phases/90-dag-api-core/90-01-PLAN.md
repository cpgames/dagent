---
phase: 90-dag-api-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/dag-engine/dag-manager.ts
  - src/main/dag-engine/dag-validation.ts
  - src/main/dag-engine/dag-api-types.ts
autonomous: true

must_haves:
  truths:
    - "DAGManager provides addNode/removeNode/addConnection/removeConnection methods"
    - "Cycle detection prevents invalid connections from being added"
    - "DAGManager emits events when graph changes"
    - "All graph mutations go through DAGManager API"
  artifacts:
    - path: "src/main/dag-engine/dag-manager.ts"
      provides: "Centralized DAG operations API"
      min_lines: 100
      exports: ["DAGManager"]
    - path: "src/main/dag-engine/dag-validation.ts"
      provides: "Cycle detection algorithm"
      exports: ["detectCycle", "validateConnection"]
    - path: "src/main/dag-engine/dag-api-types.ts"
      provides: "API interfaces and event types"
      exports: ["DAGManagerConfig", "DAGEvent"]
  key_links:
    - from: "dag-manager.ts"
      to: "dag-validation.ts"
      via: "calls validateConnection before adding edges"
      pattern: "validateConnection\\(.*source.*target"
    - from: "dag-manager.ts"
      to: "EventEmitter or custom events"
      via: "emits events on graph changes"
      pattern: "emit\\(|dispatchEvent\\("
---

<objective>
Create centralized DAG API with cycle detection and validation.

Purpose: Establish single source of truth for all DAG operations, preventing invalid graph states (cycles) and enabling event-driven updates to UI.

Output: DAGManager class, cycle detection algorithm, and API type definitions ready for integration with DAGView and PM agent.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/milestones/v2.8-ROADMAP.md
@.planning/STATE.md

# Existing DAG infrastructure
@src/shared/types/dag.ts
@src/shared/types/task.ts
@src/shared/types/connection.ts
@src/main/dag-engine/topological-sort.ts

# DAG View current implementation
@src/renderer/src/views/DAGView.tsx
@src/renderer/src/stores/dag-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DAG API types</name>
  <files>src/main/dag-engine/dag-api-types.ts</files>
  <action>
Define TypeScript interfaces for DAGManager:

**DAGManagerConfig:**
- `featureId: string` - feature this manager operates on
- `projectRoot: string` - for storage access
- Optional: `autoSave?: boolean` - whether to persist changes automatically

**DAGEvent types:**
- `NodeAdded` - { type: 'node-added', node: Task }
- `NodeRemoved` - { type: 'node-removed', nodeId: string }
- `ConnectionAdded` - { type: 'connection-added', connection: Connection }
- `ConnectionRemoved` - { type: 'connection-removed', connectionId: string }
- `NodeMoved` - { type: 'node-moved', nodeId: string, position: { x: number, y: number } }
- `GraphReset` - { type: 'graph-reset', graph: DAGGraph }

**Export union type:** `DAGEvent = NodeAdded | NodeRemoved | ...`

**Use Node.js EventEmitter pattern** (not custom implementation) - import from 'events' module.
  </action>
  <verify>TypeScript compiles with no errors, exports are visible</verify>
  <done>All event types and config interface defined and exported</done>
</task>

<task type="auto">
  <name>Task 2: Implement cycle detection algorithm</name>
  <files>src/main/dag-engine/dag-validation.ts</files>
  <action>
Implement DFS-based cycle detection per v2.8 roadmap algorithm:

**detectCycle(graph: DAGGraph, source: string, target: string): boolean**
1. Create temporary graph with new edge added
2. Run DFS from target node
3. If DFS reaches source node, cycle detected (return true)
4. Otherwise, no cycle (return false)

**validateConnection(graph: DAGGraph, source: string, target: string): { valid: boolean, reason?: string }**
- Check source exists in graph.nodes
- Check target exists in graph.nodes
- Check connection doesn't already exist
- Check adding connection won't create cycle (call detectCycle)
- Return { valid: true } or { valid: false, reason: "specific error" }

**Use existing topological-sort.ts** for reference but implement independent DFS for clarity.

**Avoid:** Mutating input graph - always work with copies for validation.
  </action>
  <verify>Unit test: detectCycle returns true for A→B, B→C, C→A; false for A→B, B→C</verify>
  <done>Cycle detection correctly identifies cycles in directed graphs</done>
</task>

<task type="auto">
  <name>Task 3: Create DAGManager class</name>
  <files>src/main/dag-engine/dag-manager.ts</files>
  <action>
Create DAGManager extending EventEmitter:

**Constructor:**
- Accept DAGManagerConfig
- Load feature graph from storage
- Initialize EventEmitter

**Methods:**
- `addNode(task: Partial<Task>): Task` - Generate ID, set default position, add to graph, emit 'node-added', return task
- `removeNode(nodeId: string): void` - Remove node and connected edges, emit 'node-removed'
- `addConnection(sourceId: string, targetId: string): Connection | null` - Validate with validateConnection, add if valid, emit 'connection-added', return connection or null
- `removeConnection(connectionId: string): void` - Remove connection, emit 'connection-removed'
- `moveNode(nodeId: string, position: { x: number, y: number }): void` - Update node position, emit 'node-moved'
- `getGraph(): DAGGraph` - Return copy of current graph (not reference)
- `resetGraph(graph: DAGGraph): void` - Replace graph entirely, emit 'graph-reset'

**Auto-save:** If config.autoSave is true, persist graph to storage after each mutation (use FeatureStore.updateFeature).

**Error handling:** Log warnings for invalid operations (e.g., adding connection to non-existent nodes) but don't throw.

**Import:** dag-validation.ts, dag-api-types.ts, FeatureStore from storage
  </action>
  <verify>Manual test: create manager, addNode, addConnection (valid), addConnection (creates cycle - should fail)</verify>
  <done>DAGManager provides full API with validation and event emission</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles with no errors
- [ ] All exports are present in each file
- [ ] detectCycle correctly identifies cycles
- [ ] DAGManager emits events for all mutations
- [ ] Invalid operations (cycles) are prevented
</verification>

<success_criteria>
- All tasks completed
- DAGManager API functional with validation
- Cycle detection prevents invalid graphs
- Event emission works for all operations
- Ready for DAGView integration (Phase 92)
</success_criteria>

<output>
After completion, create `.planning/phases/90-dag-api-core/90-01-SUMMARY.md`
</output>
