---
phase: v3.0-08-testing-polish
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/main/services/__tests__/migration.test.ts
  - src/main/services/__tests__/fixtures/old-pm-chat.json
  - src/main/services/__tests__/fixtures/old-dev-session.json
  - src/main/services/__tests__/fixtures/corrupted-session.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Migration tests validate old PM chat format conversion"
    - "Migration tests validate old dev session format conversion"
    - "Migration handles corrupted files gracefully"
    - "Backward compatibility maintained for existing sessions"
  artifacts:
    - path: "src/main/services/__tests__/migration.test.ts"
      provides: "Migration test suite"
      min_lines: 120
    - path: "src/main/services/__tests__/fixtures/old-pm-chat.json"
      provides: "Test fixture for old PM chat format"
      min_lines: 10
    - path: "src/main/services/__tests__/fixtures/old-dev-session.json"
      provides: "Test fixture for old dev session format"
      min_lines: 10
  key_links:
    - from: "src/main/services/__tests__/migration.test.ts"
      to: "src/main/services/session-manager.ts"
      via: "tests migration compatibility"
      pattern: "import.*SessionManager"
---

<objective>
Implement migration tests validating that old PM chats, dev sessions, and corrupted files are handled correctly by SessionManager.

Purpose: Ensure smooth transition from old session formats to new SessionManager structure without data loss.
Output: Migration test file with fixtures representing old data formats.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/v3.0-08-testing-polish/08-01-SUMMARY.md
@src/main/services/session-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration test fixtures</name>
  <files>src/main/services/__tests__/fixtures/old-pm-chat.json, src/main/services/__tests__/fixtures/old-dev-session.json, src/main/services/__tests__/fixtures/corrupted-session.json</files>
  <action>
Create test fixtures representing old data formats:

1. old-pm-chat.json - Old PM agent chat format:
   - Array of messages with role/content structure
   - Missing session metadata fields
   - Old timestamp format if applicable
   - Example: messages array without agentType, featureId structure

2. old-dev-session.json - Old dev agent session format:
   - Task-based session structure
   - Different field names or structure
   - Include chat history in old format

3. corrupted-session.json - Various corruption scenarios:
   - Malformed JSON (partial file)
   - Missing required fields
   - Invalid data types (string where array expected)
   - Empty file representation

Create fixtures directory: src/main/services/__tests__/fixtures/
  </action>
  <verify>ls src/main/services/__tests__/fixtures/</verify>
  <done>Fixture files created with realistic old format data</done>
</task>

<task type="auto">
  <name>Task 2: Implement migration tests</name>
  <files>src/main/services/__tests__/migration.test.ts</files>
  <action>
Create comprehensive migration test suite:

1. Old PM chat migration:
   - Load old-pm-chat.json fixture
   - Pass through SessionManager loading logic
   - Verify messages are converted to new format
   - Verify no data loss (all messages preserved)
   - Verify session can be saved in new format

2. Old dev session migration:
   - Load old-dev-session.json fixture
   - Verify task context preserved
   - Verify chat history converted correctly
   - Test round-trip: load old format, save new, reload

3. Corrupted file handling:
   - Test loading corrupted-session.json variants
   - Verify graceful failure (returns null or empty session)
   - Verify no exceptions thrown
   - Verify error logged appropriately (mock logger)

4. Backward compatibility:
   - Create session in new format, save, modify manually to old format
   - Load and verify still works
   - Verify automatic upgrade on next save

5. Edge cases:
   - Empty session files
   - Session with only metadata, no messages
   - Very old format with minimal fields
  </action>
  <verify>npm test -- --run src/main/services/__tests__/migration.test.ts</verify>
  <done>All migration tests pass, validating format conversion and error handling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All migration tests pass
- [ ] Fixtures represent realistic old data formats
- [ ] No data loss during migration (verified by tests)
- [ ] Corrupted file handling is graceful (no crashes)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- 100% migration success on test fixtures (per roadmap)
- Error handling tested for all corruption scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/v3.0-08-testing-polish/08-03-SUMMARY.md`
</output>
