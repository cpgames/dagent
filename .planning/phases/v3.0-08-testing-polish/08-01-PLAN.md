---
phase: v3.0-08-testing-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/services/__tests__/session-manager.test.ts
  - src/main/services/__tests__/session-manager-crud.test.ts
  - src/main/services/__tests__/session-manager-compaction.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Unit tests cover SessionManager CRUD operations"
    - "Unit tests cover compaction logic"
    - "Unit tests cover token estimation"
    - "Unit tests cover request building"
    - "All tests pass with npm test"
  artifacts:
    - path: "src/main/services/__tests__/session-manager.test.ts"
      provides: "Core SessionManager tests"
      min_lines: 100
    - path: "src/main/services/__tests__/session-manager-crud.test.ts"
      provides: "CRUD operation tests"
      min_lines: 150
    - path: "src/main/services/__tests__/session-manager-compaction.test.ts"
      provides: "Compaction logic tests"
      min_lines: 100
  key_links:
    - from: "src/main/services/__tests__/session-manager.test.ts"
      to: "src/main/services/session-manager.ts"
      via: "imports SessionManager"
      pattern: "import.*SessionManager"
---

<objective>
Implement comprehensive unit tests for SessionManager covering CRUD operations, compaction logic, token estimation, and request building.

Purpose: Establish test coverage foundation for the session management system, ensuring reliability and catching regressions.
Output: Test files with >80% coverage of SessionManager functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/main/services/session-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up test infrastructure and core tests</name>
  <files>src/main/services/__tests__/session-manager.test.ts</files>
  <action>
Create the __tests__ directory if needed. Create session-manager.test.ts with:

1. Test setup:
   - Mock file system operations (use vi.mock for fs-extra)
   - Mock EventEmitter for event broadcasting
   - Create test fixtures for sessions, messages, checkpoints
   - Use beforeEach to reset SessionManager singleton

2. Core SessionManager tests:
   - Singleton pattern: getSessionManager returns same instance
   - resetSessionManager creates new instance
   - Constructor initializes empty maps

3. Session lifecycle tests:
   - buildSessionId generates correct format for each agent type
   - createSession creates valid session structure
   - getOrCreateSession returns existing or creates new
   - getSessionById returns null for non-existent
   - archiveSession moves session to archive path

Use Vitest (already configured in project). Follow existing test patterns.
  </action>
  <verify>npm test -- --run src/main/services/__tests__/session-manager.test.ts</verify>
  <done>Core SessionManager tests pass, covering singleton pattern and session lifecycle</done>
</task>

<task type="auto">
  <name>Task 2: CRUD operation tests</name>
  <files>src/main/services/__tests__/session-manager-crud.test.ts</files>
  <action>
Create comprehensive tests for message and checkpoint CRUD operations:

1. Message operations:
   - addMessage appends to session messages
   - addMessage triggers save
   - getRecentMessages returns last N messages (default 50)
   - getRecentMessages respects custom limit
   - getAllMessages returns complete history
   - clearMessages empties message array
   - Test edge cases: empty session, single message, boundary limits

2. Checkpoint operations:
   - getCheckpoint returns null initially
   - updateCheckpoint stores checkpoint data
   - getCompactionMetrics returns correct token counts
   - forceCompact triggers compaction flow

3. Context and AgentDescription operations:
   - setContext/getContext store and retrieve
   - setAgentDescription/getAgentDescription store and retrieve
   - Operations persist to correct file paths

4. File persistence:
   - saveSession writes to correct path
   - loadSession reads from path
   - Handle missing files gracefully (return null/defaults)
  </action>
  <verify>npm test -- --run src/main/services/__tests__/session-manager-crud.test.ts</verify>
  <done>All CRUD tests pass, covering messages, checkpoints, context, and persistence</done>
</task>

<task type="auto">
  <name>Task 3: Compaction and token estimation tests</name>
  <files>src/main/services/__tests__/session-manager-compaction.test.ts</files>
  <action>
Create tests for compaction logic and token estimation:

1. Token estimation tests:
   - estimateMessagesTokens calculates correct token count
   - estimateCheckpointTokens handles null checkpoint
   - estimateRequest combines all components
   - Test with various message sizes

2. Compaction trigger tests:
   - checkAndTriggerCompaction returns false under threshold (90% of 100k)
   - checkAndTriggerCompaction returns true at/above threshold
   - Compaction threshold respects configured MAX_CONTEXT_TOKENS

3. Request building tests:
   - buildRequest combines agentDescription, context, checkpoint, messages
   - buildRequest respects token limits
   - previewRequest returns accurate token estimates
   - Test with empty components (no checkpoint, no context, etc.)

4. Integration tests:
   - Full flow: add messages until threshold, verify compaction triggers
   - Verify compaction produces valid checkpoint structure
   - Mock Claude SDK for compaction generation

Note: For Claude SDK compaction, mock the SDK response to avoid actual API calls.
  </action>
  <verify>npm test -- --run src/main/services/__tests__/session-manager-compaction.test.ts</verify>
  <done>Compaction and token estimation tests pass, including threshold logic</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm test passes for all new test files
- [ ] No TypeScript errors (npm run build)
- [ ] Tests use mocks appropriately (no real file I/O in tests)
- [ ] Test coverage includes edge cases and error conditions
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Test files follow Vitest conventions
- Mocks prevent external side effects
</success_criteria>

<output>
After completion, create `.planning/phases/v3.0-08-testing-polish/08-01-SUMMARY.md`
</output>
