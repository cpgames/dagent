---
phase: v3.0-08-testing-polish
plan: 04
type: execute
wave: 3
depends_on: ["08-01", "08-02", "08-03"]
files_modified:
  - doc/session-architecture.md
  - doc/compaction-guide.md
  - doc/api-reference.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Architecture documentation explains session management system"
    - "Compaction guide documents automatic checkpoint compression"
    - "API reference documents all public SessionManager methods"
    - "Migration guide helps developers transition from old code"
  artifacts:
    - path: "doc/session-architecture.md"
      provides: "Architecture overview documentation"
      min_lines: 100
    - path: "doc/compaction-guide.md"
      provides: "Compaction and checkpoint documentation"
      min_lines: 80
    - path: "doc/api-reference.md"
      provides: "API documentation for SessionManager"
      min_lines: 150
  key_links:
    - from: "doc/session-architecture.md"
      to: "src/main/services/session-manager.ts"
      via: "documents implementation"
      pattern: "SessionManager"
---

<objective>
Create comprehensive documentation for the session management system including architecture overview, compaction guide, and API reference.

Purpose: Enable developers to understand, use, and maintain the session management system effectively.
Output: Three documentation files covering architecture, compaction, and API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/v3.0-08-testing-polish/08-01-SUMMARY.md
@.planning/phases/v3.0-08-testing-polish/08-02-SUMMARY.md
@.planning/phases/v3.0-08-testing-polish/08-03-SUMMARY.md
@src/main/services/session-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Architecture documentation</name>
  <files>doc/session-architecture.md</files>
  <action>
Create architecture documentation covering:

1. Overview section:
   - Purpose of SessionManager
   - Key concepts: sessions, checkpoints, compaction
   - Relationship to agent types (PM, Dev, QA, Harness, Merge)

2. Architecture diagram (ASCII or Mermaid):
   - SessionManager singleton at center
   - Connections to file system, agents, IPC
   - Data flow for message handling

3. Session lifecycle:
   - Creation: getOrCreateSession flow
   - Usage: adding messages, updating checkpoints
   - Archival: when and how sessions are archived

4. File structure:
   - Session storage paths
   - File formats (JSON structure)
   - Checkpoint vs session vs context files

5. Integration points:
   - How agents use SessionManager
   - IPC handlers for renderer communication
   - Event broadcasting system
  </action>
  <verify>Test that doc/session-architecture.md exists and has content</verify>
  <done>Architecture documentation complete with diagrams and explanations</done>
</task>

<task type="auto">
  <name>Task 2: Compaction guide</name>
  <files>doc/compaction-guide.md</files>
  <action>
Create compaction-focused documentation:

1. What is compaction:
   - Problem: context window limits (100k tokens)
   - Solution: automatic checkpoint compression
   - Threshold: 90% of limit triggers compaction

2. How compaction works:
   - Token estimation process
   - Checkpoint generation using Claude SDK
   - Message history compression
   - What's preserved vs summarized

3. Configuration:
   - MAX_CONTEXT_TOKENS setting
   - Compaction threshold (90%)
   - Force compaction option

4. Troubleshooting:
   - When compaction doesn't trigger
   - Token estimation accuracy
   - Checkpoint quality issues

5. Best practices:
   - Message size guidelines
   - When to force compaction
   - Monitoring compaction metrics
  </action>
  <verify>Test that doc/compaction-guide.md exists and has content</verify>
  <done>Compaction guide complete with explanations and troubleshooting</done>
</task>

<task type="auto">
  <name>Task 3: API reference and migration guide</name>
  <files>doc/api-reference.md</files>
  <action>
Create API reference documentation:

1. SessionManager API:
   - getSessionManager(): SessionManager
   - resetSessionManager(): void
   - List all public methods with signatures

2. Session methods:
   - getOrCreateSession(agentType, entityId, featureId?)
   - createSession(agentType, entityId, featureId?)
   - getSessionById(sessionId)
   - archiveSession(sessionId)

3. Message methods:
   - addMessage(sessionId, message)
   - getRecentMessages(sessionId, limit?)
   - getAllMessages(sessionId)
   - clearMessages(sessionId)

4. Checkpoint methods:
   - getCheckpoint(sessionId)
   - updateCheckpoint(sessionId, checkpoint)
   - forceCompact(sessionId)
   - getCompactionMetrics(sessionId)

5. Request building:
   - buildRequest(sessionId)
   - previewRequest(sessionId)
   - Token estimation methods

6. Migration guide section:
   - Old API vs new API mapping
   - Code migration examples
   - Deprecation timeline
   - Common migration issues
  </action>
  <verify>Test that doc/api-reference.md exists and has content</verify>
  <done>API reference and migration guide complete with examples</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All three documentation files created
- [ ] Documentation covers all major SessionManager functionality
- [ ] Examples are accurate and runnable
- [ ] Migration guide addresses old to new transition
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Documentation is clear and comprehensive
- Examples match actual API (verified against code)
</success_criteria>

<output>
After completion, create `.planning/phases/v3.0-08-testing-polish/08-04-SUMMARY.md`
</output>
