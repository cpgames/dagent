# Phase 16 Plan 03: Auth System Update for SDK

**Objective**: Update auth system to detect SDK availability and simplify UI when SDK handles auth

## Context

### Current State
- Auth system manually extracts Claude Code OAuth tokens
- AuthDialog allows manual API key entry
- AuthStatusIndicator shows authentication state
- Chat works via manual auth OR could use SDK auto-auth

### Required Changes
1. Add SDK availability check (detect if Claude Code is installed)
2. Update auth store with SDK status
3. Simplify auth UI when SDK is available
4. Keep manual auth as fallback for users without Claude Code

## Dependencies

- Requires: 16-02 (Agent SDK integration working)
- Provides: Streamlined auth experience with SDK auto-detection

## Tasks

### Task 1: Add SDK availability detection

Create utility to check if Claude Agent SDK can authenticate.

**Files to create:**
- `src/main/auth/sdk-detector.ts`

**Implementation:**
```typescript
// src/main/auth/sdk-detector.ts
import { existsSync } from 'fs'
import { join } from 'path'
import { homedir } from 'os'

export interface SDKStatus {
  available: boolean
  claudeCodeInstalled: boolean
  hasCredentials: boolean
  message: string
}

export function detectSDKAvailability(): SDKStatus {
  // Check if Claude Code is installed
  const claudeDir = join(homedir(), '.claude')
  const claudeCodeInstalled = existsSync(claudeDir)

  // Check for credentials file
  const credentialsPath = join(claudeDir, '.credentials.json')
  const hasCredentials = existsSync(credentialsPath)

  if (!claudeCodeInstalled) {
    return {
      available: false,
      claudeCodeInstalled: false,
      hasCredentials: false,
      message: 'Claude Code not installed. Install Claude Code for automatic authentication.'
    }
  }

  if (!hasCredentials) {
    return {
      available: false,
      claudeCodeInstalled: true,
      hasCredentials: false,
      message: 'Claude Code installed but not logged in. Run "claude" CLI to authenticate.'
    }
  }

  return {
    available: true,
    claudeCodeInstalled: true,
    hasCredentials: true,
    message: 'Claude Agent SDK ready - authentication automatic'
  }
}
```

**Verification:**
- Returns correct status based on file existence
- Helpful messages for each state

### Task 2: Add SDK status IPC handler

Expose SDK detection to renderer.

**Files to modify:**
- `src/main/ipc/auth-handlers.ts`
- `src/preload/index.ts`
- `src/preload/index.d.ts`

**Implementation:**
```typescript
// In auth-handlers.ts
import { detectSDKAvailability, type SDKStatus } from '../auth/sdk-detector'

// Add to registerAuthHandlers():
ipcMain.handle('auth:getSDKStatus', async (): Promise<SDKStatus> => {
  return detectSDKAvailability()
})

// In preload index.d.ts - extend AuthAPI:
export interface SDKStatus {
  available: boolean
  claudeCodeInstalled: boolean
  hasCredentials: boolean
  message: string
}

export interface AuthAPI {
  // ... existing methods
  getSDKStatus: () => Promise<SDKStatus>
}

// In preload index.ts:
auth: {
  // ... existing methods
  getSDKStatus: () => ipcRenderer.invoke('auth:getSDKStatus')
}
```

**Verification:**
- `window.electronAPI.auth.getSDKStatus()` returns status
- No errors when called

### Task 3: Update auth store with SDK status

Track SDK availability in auth state.

**Files to modify:**
- `src/renderer/src/stores/auth-store.ts`

**Implementation:**
```typescript
interface SDKStatus {
  available: boolean
  claudeCodeInstalled: boolean
  hasCredentials: boolean
  message: string
}

interface AuthStore {
  state: AuthState
  sdkStatus: SDKStatus | null
  isLoading: boolean

  initialize: () => Promise<void>
  checkSDK: () => Promise<void>
  // ... existing methods
}

export const useAuthStore = create<AuthStore>((set, get) => ({
  state: { authenticated: false, credentials: null, error: null },
  sdkStatus: null,
  isLoading: false,

  initialize: async () => {
    set({ isLoading: true })
    try {
      // Check SDK first
      const sdkStatus = await window.electronAPI.auth.getSDKStatus()
      set({ sdkStatus })

      // If SDK available, we're effectively authenticated
      if (sdkStatus.available) {
        set({
          state: {
            authenticated: true,
            credentials: { type: 'sdk', value: '', source: 'Claude Agent SDK' },
            error: null
          }
        })
      } else {
        // Fall back to manual auth check
        const state = await window.electronAPI.auth.initialize()
        set({ state })
      }
    } catch (error) {
      set({ state: { authenticated: false, credentials: null, error: 'Init failed' } })
    } finally {
      set({ isLoading: false })
    }
  },

  checkSDK: async () => {
    const sdkStatus = await window.electronAPI.auth.getSDKStatus()
    set({ sdkStatus })
  }
}))
```

**Verification:**
- SDK status populated on initialize
- Auth state reflects SDK availability
- Manual auth still works when SDK unavailable

### Task 4: Update AuthStatusIndicator for SDK

Show SDK status in auth indicator.

**Files to modify:**
- `src/renderer/src/components/Auth/AuthStatusIndicator.tsx`

**Implementation:**
```tsx
export function AuthStatusIndicator({ onConfigureClick }: Props) {
  const { state, sdkStatus, isLoading, initialize } = useAuthStore()

  useEffect(() => {
    initialize()
  }, [initialize])

  if (isLoading) {
    return <div className="text-gray-500 text-sm">Checking auth...</div>
  }

  // SDK available - show special status
  if (sdkStatus?.available) {
    return (
      <button
        onClick={onConfigureClick}
        className="flex items-center gap-2 px-3 py-1.5 text-sm text-green-400 hover:text-green-300 hover:bg-gray-800 rounded transition-colors"
        title="Using Claude Agent SDK - automatic authentication"
      >
        <div className="w-2 h-2 rounded-full bg-green-500" />
        <span>SDK Active</span>
      </button>
    )
  }

  // Manual auth state (existing logic)
  if (state.authenticated) {
    return (
      <button
        onClick={onConfigureClick}
        className="flex items-center gap-2 px-3 py-1.5 text-sm text-green-400 hover:text-green-300 hover:bg-gray-800 rounded transition-colors"
        title={state.credentials?.source || 'Click to view or change authentication'}
      >
        <div className="w-2 h-2 rounded-full bg-green-500" />
        <span>Authenticated</span>
      </button>
    )
  }

  // Not authenticated
  return (
    <button
      onClick={onConfigureClick}
      className="flex items-center gap-2 px-3 py-1.5 text-sm text-yellow-400 hover:text-yellow-300 hover:bg-gray-800 rounded transition-colors"
      title="Click to configure authentication"
    >
      <div className="w-2 h-2 rounded-full bg-yellow-500" />
      <span>Not Authenticated</span>
    </button>
  )
}
```

**Verification:**
- Shows "SDK Active" when SDK available
- Shows "Authenticated" for manual auth
- Shows "Not Authenticated" otherwise

### Task 5: Update AuthDialog for SDK info

Show SDK status and guidance in auth dialog.

**Files to modify:**
- `src/renderer/src/components/Auth/AuthDialog.tsx`

**Implementation:**
```tsx
export function AuthDialog({ isOpen, onClose }: Props) {
  const { state, sdkStatus, refreshAuth, checkSDK } = useAuthStore()

  // Show SDK status section
  if (sdkStatus) {
    return (
      <Dialog open={isOpen} onClose={onClose}>
        <DialogContent>
          <DialogTitle>Authentication</DialogTitle>

          {/* SDK Status */}
          <div className="mb-4 p-3 bg-gray-800 rounded">
            <div className="text-sm font-medium text-gray-300 mb-2">
              Claude Agent SDK
            </div>
            <div className={`text-sm ${sdkStatus.available ? 'text-green-400' : 'text-yellow-400'}`}>
              {sdkStatus.message}
            </div>
            {sdkStatus.available && (
              <div className="text-xs text-gray-500 mt-1">
                Authentication handled automatically by Claude Code
              </div>
            )}
          </div>

          {/* Manual auth fallback - only show if SDK not available */}
          {!sdkStatus.available && (
            <>
              <div className="text-sm text-gray-400 mb-2">
                Manual authentication (fallback):
              </div>
              {/* Existing manual auth UI */}
              {state.authenticated ? (
                <CurrentAuthSection credentials={state.credentials} />
              ) : (
                <ManualKeyEntry />
              )}
            </>
          )}

          <div className="flex justify-end gap-2 mt-4">
            <button onClick={checkSDK} className="btn-secondary">
              Refresh
            </button>
            <button onClick={onClose} className="btn-primary">
              Close
            </button>
          </div>
        </DialogContent>
      </Dialog>
    )
  }

  // Loading state
  return null
}
```

**Verification:**
- SDK status prominently displayed
- Manual auth only shown as fallback
- Clear guidance for non-SDK users

### Task 6: Remove old ChatService usage

Update chat to prefer Agent SDK over ChatService.

**Files to modify:**
- `src/renderer/src/stores/chat-store.ts`
- `src/main/ipc/chat-handlers.ts`

**Changes:**
- Keep `chat:send` handler for backwards compat
- Add check in chat-store to use agent when SDK available
- Fall back to ChatService if SDK fails

**Implementation:**
```typescript
// In chat-store.ts
sendMessage: async () => {
  const { sdkStatus } = useAuthStore.getState()

  if (sdkStatus?.available) {
    // Use Agent SDK
    return get().sendToAgent()
  } else {
    // Fall back to old ChatService
    return get().sendToAI()
  }
}
```

**Verification:**
- Uses Agent SDK when available
- Falls back to ChatService otherwise
- No regression in chat functionality

## Verification Checklist

- [ ] `detectSDKAvailability()` correctly detects Claude Code
- [ ] `auth:getSDKStatus` IPC handler works
- [ ] Auth store tracks SDK status
- [ ] AuthStatusIndicator shows "SDK Active"
- [ ] AuthDialog displays SDK status
- [ ] Manual auth works as fallback
- [ ] Chat automatically uses SDK when available
- [ ] Users without Claude Code can still use manual auth

## Files Summary

| File | Action | Purpose |
|------|--------|---------|
| `src/main/auth/sdk-detector.ts` | Create | SDK availability detection |
| `src/main/ipc/auth-handlers.ts` | Modify | Add getSDKStatus handler |
| `src/preload/index.ts` | Modify | Expose SDK status |
| `src/preload/index.d.ts` | Modify | SDKStatus types |
| `src/renderer/src/stores/auth-store.ts` | Modify | Track SDK status |
| `src/renderer/src/components/Auth/AuthStatusIndicator.tsx` | Modify | Show SDK status |
| `src/renderer/src/components/Auth/AuthDialog.tsx` | Modify | SDK info display |
| `src/renderer/src/stores/chat-store.ts` | Modify | Auto-select chat method |

## Estimated Tasks: 6

## Notes

- SDK authentication is transparent to users
- Manual auth preserved for users without Claude Code
- AuthDialog becomes mostly informational when SDK is active
- ChatService kept as fallback, not removed

---
*Phase: 16-agent-sdk-integration*
*Plan: 03 of 03*
