# Phase 16 Plan 01: Install Agent SDK and Create AgentService

**Objective**: Add Claude Agent SDK dependency and create AgentService wrapper for SDK query() function

## Context

### Current State
- Chat uses `@anthropic-ai/sdk` with manual API key management
- `ChatService` class wraps the raw Anthropic client
- Auth system manually extracts OAuth tokens from Claude Code credentials
- Feature chat works but requires user to configure credentials

### Required Changes
1. Install `@anthropic-ai/claude-agent-sdk` package
2. Create new `AgentService` class that wraps SDK query() function
3. Define message types for streaming agent output
4. Export service alongside existing ChatService (gradual migration)

## Dependencies

- Requires: v1.2 milestone complete (auth, chat infrastructure)
- Provides: AgentService wrapper for SDK, streaming message types

## Tasks

### Task 1: Install Claude Agent SDK

Add the SDK dependency to the project.

**Command:**
```bash
pnpm add @anthropic-ai/claude-agent-sdk
```

**Verification:**
- Package appears in package.json dependencies
- No npm errors during install
- TypeScript can resolve `@anthropic-ai/claude-agent-sdk` imports

### Task 2: Create AgentService types

Define TypeScript interfaces for agent communication.

**Files to create:**
- `src/main/agent/types.ts`

**Implementation:**
```typescript
// src/main/agent/types.ts

// Message types from SDK
export type AgentMessageType =
  | 'assistant'     // AI text response
  | 'user'          // User input
  | 'result'        // Tool result
  | 'system'        // System message

export interface AgentMessage {
  type: AgentMessageType
  content: string
  timestamp: string
  toolName?: string  // For result messages
  toolInput?: unknown
}

export interface AgentQueryOptions {
  prompt: string
  systemPrompt?: string
  allowedTools?: string[]
  permissionMode?: 'default' | 'acceptEdits' | 'bypassPermissions' | 'plan'
  cwd?: string  // Working directory for file operations
}

export interface AgentStreamEvent {
  type: 'message' | 'tool_use' | 'tool_result' | 'done' | 'error'
  message?: AgentMessage
  error?: string
}
```

**Verification:**
- Types compile without errors
- Matches SDK message structure

### Task 3: Create AgentService wrapper

Create service class that wraps SDK query() and handles streaming.

**Files to create:**
- `src/main/agent/agent-service.ts`

**Implementation:**
```typescript
// src/main/agent/agent-service.ts
import { query, type Query } from '@anthropic-ai/claude-agent-sdk'
import type { AgentQueryOptions, AgentStreamEvent, AgentMessage } from './types'

export class AgentService {
  private activeQuery: Query | null = null

  async *streamQuery(options: AgentQueryOptions): AsyncGenerator<AgentStreamEvent> {
    try {
      const queryOptions = {
        prompt: options.prompt,
        options: {
          systemPrompt: options.systemPrompt,
          allowedTools: options.allowedTools || [],
          permissionMode: options.permissionMode || 'default',
          cwd: options.cwd
        }
      }

      this.activeQuery = query(queryOptions)

      for await (const message of this.activeQuery) {
        const event = this.convertMessage(message)
        if (event) {
          yield event
        }
      }

      yield { type: 'done' }
    } catch (error) {
      yield {
        type: 'error',
        error: error instanceof Error ? error.message : 'Agent query failed'
      }
    } finally {
      this.activeQuery = null
    }
  }

  private convertMessage(sdkMessage: unknown): AgentStreamEvent | null {
    // SDK returns various message types - map to our unified format
    const msg = sdkMessage as Record<string, unknown>

    if (msg.type === 'assistant') {
      return {
        type: 'message',
        message: {
          type: 'assistant',
          content: String(msg.content || ''),
          timestamp: new Date().toISOString()
        }
      }
    }

    if (msg.type === 'tool_use') {
      return {
        type: 'tool_use',
        message: {
          type: 'assistant',
          content: `Using tool: ${msg.name}`,
          timestamp: new Date().toISOString(),
          toolName: String(msg.name),
          toolInput: msg.input
        }
      }
    }

    if (msg.type === 'tool_result') {
      return {
        type: 'tool_result',
        message: {
          type: 'result',
          content: String(msg.content || ''),
          timestamp: new Date().toISOString()
        }
      }
    }

    return null
  }

  abort(): void {
    if (this.activeQuery) {
      this.activeQuery.abort()
      this.activeQuery = null
    }
  }
}

let agentService: AgentService | null = null

export function getAgentService(): AgentService {
  if (!agentService) {
    agentService = new AgentService()
  }
  return agentService
}
```

**Verification:**
- Service instantiates without error
- streamQuery() returns async generator
- abort() cancels active query

### Task 4: Create agent module index

Export types and service for easy importing.

**Files to create:**
- `src/main/agent/index.ts`

**Implementation:**
```typescript
// src/main/agent/index.ts
export * from './types'
export * from './agent-service'
```

**Verification:**
- Can import from `../agent` in other files
- All exports accessible

### Task 5: Verify SDK installation and imports

Run typecheck to ensure SDK integrates correctly.

**Command:**
```bash
pnpm typecheck
```

**Verification:**
- No type errors related to SDK
- AgentService compiles successfully
- All imports resolve

## Verification Checklist

- [ ] `@anthropic-ai/claude-agent-sdk` in package.json dependencies
- [ ] `src/main/agent/types.ts` defines message types
- [ ] `src/main/agent/agent-service.ts` wraps SDK query()
- [ ] `src/main/agent/index.ts` exports all items
- [ ] `pnpm typecheck` passes
- [ ] Existing ChatService still works (not modified)

## Files Summary

| File | Action | Purpose |
|------|--------|---------|
| `package.json` | Modify | Add @anthropic-ai/claude-agent-sdk |
| `src/main/agent/types.ts` | Create | Agent message type definitions |
| `src/main/agent/agent-service.ts` | Create | SDK wrapper with streaming |
| `src/main/agent/index.ts` | Create | Module exports |

## Estimated Tasks: 5

## Notes

- AgentService runs alongside ChatService initially
- Next plan (16-02) will wire IPC handlers to use AgentService
- SDK handles authentication automatically via Claude Code credentials
- No changes to existing auth system in this plan

---
*Phase: 16-agent-sdk-integration*
*Plan: 01 of 03*
