---
phase: 18-task-agent-migration
plan: 03
type: execute
---

<objective>
Migrate MergeAgent conflict analysis to use Claude Agent SDK.

Purpose: Add AI-powered conflict resolution analysis for complex merge scenarios.
Output: MergeAgent uses SDK to analyze conflicts and suggest resolutions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries:
@.planning/phases/18-task-agent-migration/18-01-SUMMARY.md
@.planning/phases/18-task-agent-migration/18-02-SUMMARY.md

# Key files:
@src/main/agent/agent-service.ts
@src/main/agent/tool-config.ts
@src/main/agents/merge-agent.ts
@src/main/agents/merge-types.ts

**Tech stack available:** AgentService, tool presets (mergeAgent: Read, Glob, Grep, Bash)
**Established patterns:** streamQuery() for SDK calls, worktree paths for file operations
**Constraining decisions:**
- Phase 17-01: Tool preset `mergeAgent` defined with Bash for git operations
- MergeAgent already uses GitManager for merge operations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SDK-based conflict analysis</name>
  <files>src/main/agents/merge-agent.ts, src/main/agents/merge-types.ts</files>
  <action>
Add a new `analyzeConflicts()` method that uses SDK for intelligent conflict resolution:

1. Import getAgentService from '../agent'
2. Create analyzeConflicts() async method:
   - Build prompt describing the merge context:
     - Task branch being merged
     - Feature branch target
     - List of conflicting files
     - Conflict content (from git diff)
   - Call AgentService.streamQuery() with:
     - toolPreset: 'mergeAgent' (Read, Glob, Grep, Bash)
     - permissionMode: 'acceptEdits' (analysis only)
     - cwd: featureWorktreePath
   - Parse response for resolution suggestions
3. Add ConflictAnalysis type to merge-types.ts:
   - suggestions: string[] (resolution approaches)
   - recommendation: string (best approach)
   - autoResolvable: boolean
  </action>
  <verify>`npm run typecheck` passes, analyzeConflicts() defined</verify>
  <done>MergeAgent.analyzeConflicts() uses SDK for conflict analysis</done>
</task>

<task type="auto">
  <name>Task 2: Integrate analysis into merge flow</name>
  <files>src/main/agents/merge-agent.ts</files>
  <action>
Call analyzeConflicts() when conflicts are detected:

1. In executeMerge(), when result.conflicts exist:
   - Call analyzeConflicts() to get AI suggestions
   - Store analysis in state
   - Emit 'merge-agent:analysis' event with suggestions
2. Update proposeIntention() to include analysis if available:
   - Add conflict analysis to intention text
   - Include AI recommendations

This enhances the merge workflow without changing the existing GitManager integration.
  </action>
  <verify>`npm run typecheck` passes, analysis integrated in merge flow</verify>
  <done>Conflict analysis called automatically when conflicts detected</done>
</task>

<task type="auto">
  <name>Task 3: Update STATE.md and verify milestone</name>
  <files>.planning/STATE.md</files>
  <action>
Update STATE.md to reflect Phase 18 completion:

1. Update Current Position section:
   - Phase: 18 of 18 (v1.3) - Complete
   - Status: v1.3 Claude Agent SDK Migration complete
   - Progress: 100%

2. Add Phase 18 to Completed Phases section:
   - 18-01: HarnessAgent SDK migration
   - 18-02: TaskAgent SDK migration
   - 18-03: MergeAgent SDK migration

3. Add milestone completion note for v1.3
  </action>
  <verify>STATE.md shows v1.3 complete</verify>
  <done>STATE.md updated, v1.3 milestone marked complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] MergeAgent.analyzeConflicts() uses SDK
- [ ] Analysis integrated into merge workflow
- [ ] STATE.md reflects v1.3 completion
- [ ] All three agents (Harness, Task, Merge) use SDK
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- MergeAgent uses SDK for conflict analysis
- v1.3 milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/18-task-agent-migration/18-03-SUMMARY.md`

# v1.3 Milestone Summary

All three phases of the Claude Agent SDK migration complete:
- Phase 16: Core SDK integration (AgentService, IPC, auth detection)
- Phase 17: Tool configuration and UI (presets, ToolUsageDisplay)
- Phase 18: Agent migration (Harness, Task, Merge agents)

The application now uses Claude Agent SDK for all AI operations with automatic authentication.
</output>
