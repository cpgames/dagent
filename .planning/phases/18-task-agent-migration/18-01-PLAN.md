---
phase: 18-task-agent-migration
plan: 01
type: execute
---

<objective>
Migrate HarnessAgent intention review to use Claude Agent SDK.

Purpose: Replace stub auto-approval logic with intelligent AI-powered intention review.
Output: HarnessAgent uses SDK for intention analysis with contextual decision-making.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependency graph):
@.planning/phases/17-agent-tools-permissions/17-01-SUMMARY.md
@.planning/phases/17-agent-tools-permissions/17-02-SUMMARY.md

# Key files:
@src/main/agent/agent-service.ts
@src/main/agent/tool-config.ts
@src/main/agents/harness-agent.ts
@src/main/agents/harness-types.ts

**Tech stack available:** AgentService with streaming, tool presets (harnessAgent: Read, Glob, Grep)
**Established patterns:** AgentService.streamQuery(), tool presets via toolPreset option, cwd for project context
**Constraining decisions:**
- Phase 17-01: Tool presets defined including `harnessAgent` preset
- Phase 16-01: AgentService wrapper for SDK query() function
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SDK integration to HarnessAgent</name>
  <files>src/main/agents/harness-agent.ts, src/main/agents/harness-types.ts</files>
  <action>
Import AgentService and modify the `reviewIntention()` method to use SDK for intelligent review:

1. Import getAgentService from '../agent'
2. Add async to `reviewIntention()` method
3. Build a prompt from IntentionReviewContext with:
   - Feature goal and CLAUDE.md context
   - Task details (title, description)
   - Proposed intention
   - Completed dependencies for context
   - Other active tasks to avoid conflicts
4. Call AgentService.streamQuery() with:
   - toolPreset: 'harnessAgent' (Read, Glob, Grep)
   - permissionMode: 'acceptEdits'
   - cwd: project root (from context or state)
5. Parse response to extract decision (approve/reject) and notes
6. Return IntentionDecision based on AI analysis

Keep the existing auto-approve fallback for cases where SDK is unavailable.
  </action>
  <verify>`npm run typecheck` passes, HarnessAgent imports compile</verify>
  <done>HarnessAgent.reviewIntention() calls SDK with harnessAgent tools</done>
</task>

<task type="auto">
  <name>Task 2: Update processIntention to be async</name>
  <files>src/main/agents/harness-agent.ts</files>
  <action>
Update `processIntention()` method to be async since `reviewIntention()` is now async:

1. Change `processIntention()` to `async processIntention()`
2. Await the reviewIntention() call
3. Update any callers to handle Promise return

Also add project root tracking:
1. Add `projectRoot: string | null` to HarnessState
2. Accept projectRoot in initialize() method
3. Pass projectRoot to SDK query calls
  </action>
  <verify>`npm run typecheck` passes, processIntention returns Promise</verify>
  <done>processIntention is async, projectRoot tracked in state</done>
</task>

<task type="auto">
  <name>Task 3: Update orchestrator to await harness decisions</name>
  <files>src/main/orchestrator/execution-orchestrator.ts</files>
  <action>
Find calls to harness.processIntention() and await them:

1. Search for processIntention calls in orchestrator
2. Add await keyword to calls
3. Handle Promise rejection with error logging

If no direct calls exist (event-driven architecture), verify event handlers work with async flow.
  </action>
  <verify>`npm run typecheck` passes, no unhandled promises</verify>
  <done>Orchestrator properly awaits harness decisions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] HarnessAgent.reviewIntention() uses SDK query
- [ ] processIntention() is async
- [ ] Tool preset 'harnessAgent' used (Read, Glob, Grep)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- HarnessAgent uses SDK for intention review
</success_criteria>

<output>
After completion, create `.planning/phases/18-task-agent-migration/18-01-SUMMARY.md`
</output>
