---
phase: 18-task-agent-migration
plan: 02
type: execute
---

<objective>
Migrate TaskAgent execution to use Claude Agent SDK.

Purpose: Replace stub execute() with actual AI-powered task implementation in isolated worktrees.
Output: TaskAgent uses SDK with full tool access (Edit, Write, Bash) to implement tasks.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries:
@.planning/phases/17-agent-tools-permissions/17-01-SUMMARY.md
@.planning/phases/18-task-agent-migration/18-01-SUMMARY.md

# Key files:
@src/main/agent/agent-service.ts
@src/main/agent/tool-config.ts
@src/main/agents/task-agent.ts
@src/main/agents/task-types.ts

**Tech stack available:** AgentService with streaming, tool presets (taskAgent: Read, Edit, Write, Bash, Glob, Grep)
**Established patterns:** streamQuery() with tool presets, cwd for project context, worktree isolation
**Constraining decisions:**
- Phase 17-01: Tool preset `taskAgent` defined with full edit capabilities
- Tasks execute in isolated worktrees (git worktree per task)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SDK-based task execution</name>
  <files>src/main/agents/task-agent.ts, src/main/agents/task-types.ts</files>
  <action>
Replace the stub `execute()` method with SDK-powered implementation:

1. Import getAgentService from '../agent'
2. Build execution prompt from TaskAgentState.context:
   - CLAUDE.md content (coding guidelines)
   - Feature goal
   - Task title and description
   - Dependency context (what completed tasks provide)
   - Clear instruction to implement the task
3. Call AgentService.streamQuery() with:
   - toolPreset: 'taskAgent' (Read, Edit, Write, Bash, Glob, Grep)
   - permissionMode: 'bypassPermissions' (autonomous execution)
   - cwd: worktreePath (task's isolated worktree)
4. Stream events and emit progress via EventEmitter
5. On completion, collect summary from final message
6. Return TaskExecutionResult with success/failure and summary

Add streaming events:
- 'task-agent:progress' for streamed content
- 'task-agent:tool-use' for tool operations
  </action>
  <verify>`npm run typecheck` passes, TaskAgent.execute() uses SDK</verify>
  <done>TaskAgent.execute() calls SDK with taskAgent tools in worktree</done>
</task>

<task type="auto">
  <name>Task 2: Add execution progress events</name>
  <files>src/main/agents/task-types.ts, src/main/agents/task-agent.ts</files>
  <action>
Add types and implementation for execution progress streaming:

1. Add to task-types.ts:
   - TaskProgressEvent interface with type, content, toolName fields
   - Export the interface

2. In task-agent.ts execute():
   - Emit 'task-agent:progress' events during streaming
   - Emit 'task-agent:tool-use' when tools are invoked
   - Track tool usage for summary

3. Add abort capability:
   - Add abort() method that calls AgentService.abort()
   - Track abortController in state
  </action>
  <verify>`npm run typecheck` passes, progress events defined</verify>
  <done>TaskAgent emits progress events during execution</done>
</task>

<task type="auto">
  <name>Task 3: Commit changes after execution</name>
  <files>src/main/agents/task-agent.ts</files>
  <action>
Add git commit after successful task execution:

1. After SDK query completes successfully:
   - Use GitManager to check for changes in worktree
   - If changes exist, stage all and commit with message:
     "feat({taskId}): {taskTitle}"
2. Update TaskExecutionResult to include:
   - commitHash if commit was made
   - filesChanged count

This ensures task work is committed to the task branch before merge.
  </action>
  <verify>`npm run typecheck` passes, commits created after execution</verify>
  <done>TaskAgent commits changes to task branch after successful execution</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] TaskAgent.execute() uses SDK with taskAgent preset
- [ ] Execution runs in worktree (cwd: worktreePath)
- [ ] Progress events emitted during streaming
- [ ] Changes committed after successful execution
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- TaskAgent executes real work via SDK
</success_criteria>

<output>
After completion, create `.planning/phases/18-task-agent-migration/18-02-SUMMARY.md`
</output>
