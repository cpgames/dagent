---
phase: 22-pm-agent-crud-operations
plan: 02
type: execute
---

<objective>
Add batch operations and task reorganization tools for advanced task management.

Purpose: Enable PM Agent to perform multi-task operations like bulk status changes, dependency rewiring, and task reordering.
Output: RemoveDependency tool and enhanced PM Agent instructions for complex task management scenarios.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-pm-agent-crud-operations/22-01-SUMMARY.md

**Key files:**
@src/shared/types/pm-tools.ts
@src/main/ipc/pm-tools-handlers.ts
@src/main/agent/pm-tool-handlers.ts
@src/main/agent/tool-config.ts
@src/shared/types/agent-config.ts
@src/preload/index.ts
@src/preload/index.d.ts

**Tech stack available:** Electron IPC, Claude Agent SDK, Zustand stores
**Established patterns:** PM tool types, IPC handlers, SDK tool definitions, handler registry
**From 22-01:** UpdateTask, DeleteTask already implemented
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RemoveDependency types and IPC handler</name>
  <files>src/shared/types/pm-tools.ts, src/main/ipc/pm-tools-handlers.ts</files>
  <action>
**pm-tools.ts - Add types:**
```typescript
export interface RemoveDependencyInput {
  fromTaskId: string
  toTaskId: string
}

export interface RemoveDependencyResult {
  success: boolean
  statusChanged?: boolean  // True if toTask status changed (blocked â†’ ready)
  error?: string
}
```

**pm-tools-handlers.ts - Add IPC handler:**
- Validate both tasks exist
- Find and remove the connection from fromTaskId to toTaskId
- Check if toTask has any remaining incomplete dependencies
- If no incomplete deps, update toTask status to 'ready' (if currently 'blocked')
- Save DAG
- Return success with statusChanged indicator
  </action>
  <verify>npm run typecheck passes</verify>
  <done>RemoveDependency types and IPC handler implemented</done>
</task>

<task type="auto">
  <name>Task 2: Add RemoveDependency to SDK tools and preload</name>
  <files>src/main/agent/pm-tool-handlers.ts, src/main/agent/tool-config.ts, src/preload/index.ts, src/preload/index.d.ts</files>
  <action>
**pm-tool-handlers.ts:**
1. Add removeDependencyHandler with setter/clearer
2. Add to executePMTool switch case
3. Add to isPMTool check
4. Add PM_TOOLS entry:
```typescript
{
  name: 'RemoveDependency',
  description: 'Remove an existing dependency between two tasks. The toTask may become ready if it has no other incomplete dependencies.',
  inputSchema: {
    type: 'object',
    properties: {
      fromTaskId: { type: 'string', description: 'ID of the dependency task to remove' },
      toTaskId: { type: 'string', description: 'ID of the task that currently depends on fromTaskId' }
    },
    required: ['fromTaskId', 'toTaskId']
  },
  handler: async (input) => ...
}
```

**tool-config.ts:**
- Add 'RemoveDependency' to pmAgent preset

**preload/index.ts:**
- Add removeDependency method

**preload/index.d.ts:**
- Add removeDependency type declaration
  </action>
  <verify>npm run typecheck passes</verify>
  <done>RemoveDependency available in pmAgent preset and preload</done>
</task>

<task type="auto">
  <name>Task 3: Update PM Agent instructions for complete CRUD</name>
  <files>src/shared/types/agent-config.ts, src/main/agent/pm-tool-handlers.ts</files>
  <action>
**agent-config.ts - Update DEFAULT_AGENT_CONFIGS.pm.instructions:**
Enhance the PM Agent default instructions to cover all CRUD operations:

```
You are a project management agent. You help users manage tasks in their feature DAG.

## Capabilities
- Create new tasks with dependencies (CreateTask)
- Update existing task titles and descriptions (UpdateTask)
- Delete tasks with proper dependency handling (DeleteTask)
- Add dependencies between tasks (AddDependency)
- Remove dependencies between tasks (RemoveDependency)
- List all tasks (ListTasks)
- Get task details (GetTask)

## Workflow
1. **Always call ListTasks first** to understand the current DAG state
2. For task creation, analyze dependencies based on logical workflow
3. For updates, confirm the taskId before modifying
4. For deletion, explain dependency handling options:
   - reconnect (default): Dependents inherit this task's dependencies
   - cascade: Delete task and all dependents
   - orphan: Delete only this task, leave dependents with missing dep
5. Explain all changes to the user before executing

## Task Management Best Practices
- Group related work into dependent chains
- Keep task descriptions actionable and specific
- When restructuring, explain the before/after state
```

**pm-tool-handlers.ts - Update getPMToolInstructions():**
Add sections for UpdateTask, DeleteTask, RemoveDependency tools with usage guidance.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>PM Agent has comprehensive CRUD instructions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run typecheck passes
- [ ] RemoveDependency types exported
- [ ] RemoveDependency IPC handler registered
- [ ] RemoveDependency in PM_TOOLS array
- [ ] pmAgent preset includes all 7 tools (ListTasks, GetTask, CreateTask, UpdateTask, DeleteTask, AddDependency, RemoveDependency)
- [ ] PM Agent instructions cover all CRUD operations
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- PM Agent can perform complete task CRUD operations
- Phase 22 complete, ready for Phase 23
</success_criteria>

<output>
After completion, create `.planning/phases/22-pm-agent-crud-operations/22-02-SUMMARY.md`
</output>
