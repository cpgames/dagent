---
phase: 64-pm-task-decomposition
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/agent/prompt-builders.ts
  - src/main/agent/pm-mcp-server.ts
autonomous: true
must_haves:
  truths:
    - "PM agent analyzes spec complexity before creating tasks"
    - "Simple specs result in single task creation"
    - "Complex specs result in multiple tasks with proper dependencies"
    - "PM explains decomposition rationale to user"
  artifacts:
    - path: "src/main/agent/prompt-builders.ts"
      provides: "Task decomposition instructions for PM agent"
      contains: "complexity analysis"
    - path: "src/main/agent/pm-mcp-server.ts"
      provides: "DecomposeSpec MCP tool"
      contains: "DecomposeSpec"
  key_links:
    - from: "src/main/agent/pm-mcp-server.ts"
      to: "CreateTask"
      via: "DecomposeSpec calls CreateTask for each decomposed task"
      pattern: "pmCreateTask"
---

<objective>
Implement intelligent task decomposition in the PM agent.

Purpose: Enable PM to analyze feature spec complexity and create appropriately-sized tasks instead of creating one overwhelming task for complex features.
Output: Updated PM prompts with decomposition workflow and a DecomposeSpec MCP tool that analyzes complexity and creates tasks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-pm-spec-management/63-01-SUMMARY.md

@src/main/agent/prompt-builders.ts
@src/main/agent/pm-mcp-server.ts
@src/main/agents/feature-spec-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update PM prompts for task decomposition workflow</name>
  <files>src/main/agent/prompt-builders.ts</files>
  <action>
Update the PM agent role instructions in `getAgentRoleInstructions('pm')` to include the task decomposition workflow:

After the existing Spec Management section, add a Task Decomposition section:

```
## Task Decomposition
After spec is created or updated, analyze complexity before creating tasks:
1. Simple feature (1-2 clear requirements) → Create single task with all requirements
2. Complex feature (3+ requirements OR cross-cutting concerns) → Break into multiple tasks:
   - Group related requirements into logical tasks
   - Add dependencies between tasks (foundation first, dependent features after)
   - Each task should be completable in a single dev session

When decomposing:
- Call DecomposeSpec to analyze the spec and automatically create tasks
- Explain briefly: "Breaking into N tasks: [task1], [task2]..."
- Tasks reference spec requirements by ID (e.g., "Implements REQ-001, REQ-002")
```

The key insight: The PM should call DecomposeSpec after creating/updating a spec with significant requirements, rather than manually creating tasks one by one.
  </action>
  <verify>npm run build passes (type check confirms changes)</verify>
  <done>PM prompt includes task decomposition workflow with complexity analysis</done>
</task>

<task type="auto">
  <name>Task 2: Add DecomposeSpec MCP tool</name>
  <files>src/main/agent/pm-mcp-server.ts, src/main/agent/tool-config.ts</files>
  <action>
Add a new `DecomposeSpec` MCP tool to pm-mcp-server.ts that:

1. Gets the current spec via pmGetSpec
2. Analyzes complexity based on:
   - Number of requirements (3+ = complex)
   - Cross-cutting concerns (mentions of API, UI, database = cross-cutting)
   - Explicit user request for breakdown
3. Returns a decomposition analysis with suggested tasks

Tool signature:
```typescript
tool(
  'DecomposeSpec',
  'Analyze the feature spec and suggest task decomposition. Call after creating or updating a spec to determine if multiple tasks are needed.',
  {
    forceDecompose: z.boolean().optional().describe('Force decomposition even for simple specs')
  },
  async (args) => {
    // 1. Get current spec
    // 2. Analyze complexity
    // 3. Return analysis with:
    //    - isComplex: boolean
    //    - reason: string (why complex or simple)
    //    - suggestedTasks: Array<{title, description, requirementIds, dependsOn}>
  }
)
```

The tool returns analysis but does NOT create tasks directly - the PM agent uses the analysis to decide whether to create tasks via CreateTask. This keeps the PM in control of task creation.

Also add 'DecomposeSpec' to:
- getPMToolNamesForAllowedTools() array
- tool-config.ts pmAgent preset
  </action>
  <verify>npm run build passes</verify>
  <done>DecomposeSpec tool available to PM agent and returns complexity analysis</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] PM prompt includes Task Decomposition section with complexity analysis
- [ ] DecomposeSpec tool registered in MCP server
- [ ] DecomposeSpec added to pmAgent tool preset
- [ ] DecomposeSpec added to allowedTools list
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- PM agent can analyze spec complexity and receive task decomposition suggestions
</success_criteria>

<output>
After completion, create `.planning/phases/64-pm-task-decomposition/64-01-SUMMARY.md`
</output>
