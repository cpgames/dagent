---
phase: v3.0-09-cleanup-deprecation
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - doc/file-structure.md
autonomous: true

must_haves:
  truths:
    - "New session file structure is documented"
    - "Old chat.json structure is marked as legacy"
    - "Migration instructions are clear and actionable"
  artifacts:
    - path: "doc/file-structure.md"
      provides: "File structure documentation with session vs legacy comparison"
      min_lines: 100
      contains: "session.json"
  key_links:
    - from: "doc/file-structure.md"
      to: "doc/api-reference.md"
      via: "cross-reference to API documentation"
      pattern: "api-reference.md"
---

<objective>
Create comprehensive file structure documentation covering the new session-based storage.

Purpose: Help developers understand the .dagent directory structure and migration path from old chat.json to new session.json format.
Output: doc/file-structure.md with clear documentation of both old and new structures.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/v3.0-09-cleanup-deprecation/09-01-SUMMARY.md
@doc/api-reference.md
@doc/session-architecture.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create file-structure.md documentation</name>
  <files>doc/file-structure.md</files>
  <action>
Create doc/file-structure.md with the following sections:

1. **Overview** - Brief intro to .dagent directory purpose

2. **Current Structure (v3.0+)** - Document the new session-based structure:
```
.dagent/
├── features/
│   └── {feature-id}/
│       ├── feature.json          # Feature metadata
│       ├── dag.json              # Task DAG graph
│       ├── spec.md               # Feature specification (PM-generated)
│       ├── sessions/
│       │   └── {session-id}/
│       │       └── session.json  # SessionManager session file
│       ├── nodes/
│       │   └── {node-id}/
│       │       ├── plan.json     # Task execution plan
│       │       └── session.json  # Task-specific session (legacy)
│       └── attachments/          # Feature file attachments
├── harness_log.json              # Agent communication log
└── layout.json                   # DAG view layout data
```

3. **Legacy Structure (pre-v3.0)** - Document old structure being deprecated:
```
.dagent/
├── features/
│   └── {feature-id}/
│       ├── feature.json
│       ├── dag.json
│       ├── chat.json             # [DEPRECATED] Old PM chat format
│       └── nodes/
│           └── {node-id}/
│               └── session.json  # Old task session format
```

4. **Session File Format** - Document session.json structure:
- id, type, featureId, taskId (optional)
- messages array with ChatMessage format
- checkpoint object with version, summary, sections
- context object with tokenCount, lastCompaction
- metadata with createdAt, updatedAt

5. **Migration Notes**:
- Old chat.json files are automatically migrated on first access
- Old node session.json files are migrated to SessionManager format
- Backup files created before migration (.backup suffix)
- See doc/api-reference.md for SessionManager API details

6. **Cross-references**:
- Link to doc/session-architecture.md for architecture details
- Link to doc/api-reference.md for API documentation
- Link to doc/compaction-guide.md for compaction details
  </action>
  <verify>File exists and has all required sections: cat doc/file-structure.md</verify>
  <done>doc/file-structure.md created with complete structure documentation</done>
</task>

<task type="auto">
  <name>Task 2: Update api-reference.md with deprecation notes</name>
  <files>doc/api-reference.md</files>
  <action>
Add a "Deprecated APIs" section to doc/api-reference.md (before the Migration Guide section):

```markdown
## Deprecated APIs

The following APIs are deprecated and will be removed in a future version:

### FeatureStore Chat Methods

| Method | Replacement | Notes |
|--------|-------------|-------|
| `saveChat(featureId, chat)` | `SessionManager.addMessage()` | Use session-based storage |
| `loadChat(featureId)` | `SessionManager.getSession()` | Returns full session with checkpoint |
| `saveNodeChat(featureId, nodeId, chat)` | `SessionManager` with task context | Pass taskId in session metadata |
| `loadNodeChat(featureId, nodeId)` | `SessionManager` with task context | Query by taskId |

### chat-store (Renderer)

The `chat-store.ts` Zustand store uses the legacy chat format. New features should use SessionManager directly via IPC handlers.

See [Migration Guide](#migration-guide) for detailed migration instructions.
```

Keep this section concise - detailed migration is already in the Migration Guide section.
  </action>
  <verify>Grep for "Deprecated APIs" in doc/api-reference.md</verify>
  <done>api-reference.md has Deprecated APIs section with replacement table</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] doc/file-structure.md exists with all sections
- [ ] doc/api-reference.md has Deprecated APIs section
- [ ] Cross-references between docs are valid
- [ ] npm run build succeeds
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- File structure clearly documented
- Legacy vs new structure comparison clear
- Migration path documented
</success_criteria>

<output>
After completion, create `.planning/phases/v3.0-09-cleanup-deprecation/09-02-SUMMARY.md`
</output>
