---
phase: 93-pm-agent-dag-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/agent/pm-mcp-server.ts
  - src/main/ipc/pm-dag-handlers.ts
  - src/main/agent/prompt-builders.ts
autonomous: true

must_haves:
  truths:
    - PM agent can create tasks with automatic DAG placement
    - PM agent can add connections between tasks with cycle validation
    - PM agent receives error feedback when operations fail (e.g., cycles)
  artifacts:
    - path: "src/main/ipc/pm-dag-handlers.ts"
      provides: "Handler functions for DAG operations called by MCP tools"
      min_lines: 100
      exports: ["pmDAGAddNode", "pmDAGAddConnection", "pmDAGRemoveNode", "pmDAGRemoveConnection"]
    - path: "src/main/agent/pm-mcp-server.ts"
      provides: "MCP tools for DAG operations"
      contains: "DAGAddNode"
      exports: ["createPMMcpServer"]
  key_links:
    - from: "pm-mcp-server.ts"
      to: "pm-dag-handlers.ts"
      via: "tool handlers call DAG handler functions"
      pattern: "pmDAGAddNode|pmDAGAddConnection"
    - from: "pm-dag-handlers.ts"
      to: "DAGManager via IPC"
      via: "calls window.electronAPI.dagManager methods"
      pattern: "dagManager\\.(addNode|addConnection)"
---

<objective>
Expose DAGManager API to PM agent via MCP tools, enabling the PM to create tasks with automatic placement and add dependencies with cycle validation.

Purpose: Give PM agent ability to manipulate the DAG directly through validated operations, removing manual positioning burden and preventing invalid graph states.

Output: Four new MCP tools (DAGAddNode, DAGAddConnection, DAGRemoveNode, DAGRemoveConnection) integrated into PM agent toolset.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v2.8-ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/92-dag-view-integration/92-01-SUMMARY.md
@.planning/phases/90-dag-api-core/90-01-SUMMARY.md

# Existing PM MCP infrastructure
@src/main/agent/pm-mcp-server.ts
@src/main/ipc/pm-tools-handlers.ts
@src/main/ipc/dag-handlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PM DAG handler functions</name>
  <files>src/main/ipc/pm-dag-handlers.ts</files>
  <action>
Create new file `src/main/ipc/pm-dag-handlers.ts` with handler functions for DAG operations:

1. **pmDAGAddNode()**:
   - Input: { title: string, description: string, dependsOn?: string[] }
   - Get current feature context from getPMToolsFeatureContext()
   - Create Task object with randomUUID() for id
   - Call window.electronAPI.dagManager.addNode() for auto-placement
   - Return success/error result

2. **pmDAGAddConnection()**:
   - Input: { sourceTaskId: string, targetTaskId: string }
   - Get current feature context
   - Call window.electronAPI.dagManager.addConnection() with validation
   - Return success/error result (error if cycle detected)

3. **pmDAGRemoveNode()**:
   - Input: { taskId: string }
   - Get current feature context
   - Call window.electronAPI.dagManager.removeNode()
   - Return success/error result

4. **pmDAGRemoveConnection()**:
   - Input: { sourceTaskId: string, targetTaskId: string }
   - Get current feature context
   - Build connectionId as "sourceTaskId->targetTaskId"
   - Call window.electronAPI.dagManager.removeConnection()
   - Return success/error result

All handlers should:
- Use getPMToolsFeatureContext() from pm-tools-handlers.ts
- Import required types from @shared/types
- Handle errors gracefully with descriptive messages
- Return standard { success: boolean, error?: string, ... } result objects

Import structure:
```typescript
import { randomUUID } from 'crypto'
import { getPMToolsFeatureContext } from './pm-tools-handlers'
import type { Task, TaskStatus } from '@shared/types'
```
  </action>
  <verify>grep -n "export.*pmDAGAddNode" src/main/ipc/pm-dag-handlers.ts</verify>
  <done>File exists with all 4 handler functions exported, each calls appropriate dagManager method</done>
</task>

<task type="auto">
  <name>Task 2: Add DAG MCP tools to pm-mcp-server</name>
  <files>src/main/agent/pm-mcp-server.ts</files>
  <action>
Update pm-mcp-server.ts to add 4 new DAG tools:

1. Import the new handlers at top of file:
```typescript
import {
  pmDAGAddNode,
  pmDAGAddConnection,
  pmDAGRemoveNode,
  pmDAGRemoveConnection
} from '../ipc/pm-dag-handlers'
```

2. Add tools to the `tools` array in createPMMcpServer():

**DAGAddNode tool**:
- Name: 'DAGAddNode'
- Description: 'Add a new task node to the DAG with automatic vertical placement. Use this instead of CreateTask when you want DAGManager to handle positioning.'
- Schema: { title: z.string(), description: z.string(), dependsOn: z.array(z.string()).optional() }
- Handler: calls pmDAGAddNode(args), returns success/taskId or error

**DAGAddConnection tool**:
- Name: 'DAGAddConnection'
- Description: 'Add a dependency connection between tasks with cycle validation. Creates edge from source to target (source must complete before target starts).'
- Schema: { sourceTaskId: z.string(), targetTaskId: z.string() }
- Handler: calls pmDAGAddConnection(args), returns success or cycle error

**DAGRemoveNode tool**:
- Name: 'DAGRemoveNode'
- Description: 'Remove a task node and all connected edges from the DAG.'
- Schema: { taskId: z.string() }
- Handler: calls pmDAGRemoveNode(args), returns success or error

**DAGRemoveConnection tool**:
- Name: 'DAGRemoveConnection'
- Description: 'Remove a dependency connection between two tasks.'
- Schema: { sourceTaskId: z.string(), targetTaskId: z.string() }
- Handler: calls pmDAGRemoveConnection(args), returns success or error

3. Update getPMToolNamesForAllowedTools() at bottom of file:
Add the 4 new tool names with MCP prefix:
- 'mcp__pm-tools__DAGAddNode'
- 'mcp__pm-tools__DAGAddConnection'
- 'mcp__pm-tools__DAGRemoveNode'
- 'mcp__pm-tools__DAGRemoveConnection'

Follow existing tool pattern from CreateTask, UpdateTask, etc. All tools should return { content: [{ type: 'text', text: '...' }] }.
  </action>
  <verify>grep -n "DAGAddNode" src/main/agent/pm-mcp-server.ts</verify>
  <done>Four DAG tools added to pm-mcp-server with proper schemas and handlers, tool names added to getPMToolNamesForAllowedTools()</done>
</task>

<task type="auto">
  <name>Task 3: Update PM agent prompt with DAG tool guidance</name>
  <files>src/main/agent/prompt-builders.ts</files>
  <action>
Update the PM agent's prompt instructions in `buildPMPrompt()` to include guidance on DAG tools:

Find the section with PM agent instructions (where it lists CreateTask, UpdateTask, etc.) and add:

```
**DAG Operations (via DAGManager):**
- Use DAGAddNode to create tasks with automatic vertical placement
  - DAGManager handles positioning in top-to-bottom flow
  - Tasks without dependencies appear at top
  - Dependent tasks appear below blockers
- Use DAGAddConnection to add dependencies with cycle validation
  - Returns error if connection would create a cycle
  - Source task must complete before target task starts
- DAGRemoveNode removes task and all connected edges
- DAGRemoveConnection removes single dependency edge

**When to use DAG tools vs legacy CreateTask:**
- Use DAGAddNode when you want automatic placement (recommended for new tasks)
- Use CreateTask if you need manual position control or legacy compatibility
- Both are valid - DAGAddNode provides better placement, CreateTask gives more control

**Cycle prevention:**
If DAGAddConnection fails with "would create a cycle", explain to user which tasks form the cycle and suggest removing one dependency to break it.
```

Add this after the existing PM tool descriptions, before the "Context awareness" section.
  </action>
  <verify>grep -n "DAGAddNode" src/main/agent/prompt-builders.ts</verify>
  <done>Prompt includes DAG tool usage guidance with cycle prevention instructions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compilation succeeds with no errors
- [ ] All 4 handler functions exist in pm-dag-handlers.ts
- [ ] All 4 MCP tools added to pm-mcp-server.ts
- [ ] Tool names added to getPMToolNamesForAllowedTools()
- [ ] Prompt guidance added to buildPMPrompt()
- [ ] Build succeeds
</verification>

<success_criteria>
- All tasks completed
- PM agent can call DAGAddNode, DAGAddConnection, DAGRemoveNode, DAGRemoveConnection via MCP
- DAG operations use validated DAGManager API (no direct graph manipulation)
- Cycle detection errors returned to PM agent with clear messages
- PM prompt includes guidance on when/how to use DAG tools
- TypeScript types correct, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/93-pm-agent-dag-integration/93-01-SUMMARY.md`
</output>
