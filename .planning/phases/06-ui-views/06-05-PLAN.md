---
phase: 06-ui-views
plan: 05
type: execute
---

<objective>
Implement Feature Chat sidebar for DAG view with message history.

Purpose: Enable feature-level AI conversation alongside DAG visualization.
Output: Working chat sidebar with message display and input per DAGENT_SPEC 3.2.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-ui-views/06-03-SUMMARY.md
@.planning/phases/06-ui-views/06-04-SUMMARY.md
@src/renderer/src/stores/feature-store.ts
@src/shared/types/index.ts

**Tech stack available:** React, TypeScript, Tailwind CSS, Zustand
**Established patterns:**
- Feature chat stored in .dagent/chat.json per feature
- Chat type: { featureId, messages: ChatMessage[] }
- ChatMessage: { id, role: 'user' | 'assistant', content, timestamp }

**From DAGENT_SPEC 3.2:**
- Sidebar on right side of DAG view
- Feature-level chat panel
- Message history display
- Message input with send button
- "Re-evaluate deps" button for AI to analyze graph

**From DAGENT_SPEC 4.5:**
```typescript
interface Chat {
  featureId: string;
  messages: ChatMessage[];
}

interface ChatMessage {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: string;
}
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chat store</name>
  <files>src/renderer/src/stores/chat-store.ts, src/renderer/src/stores/index.ts</files>
  <action>
Create Zustand store for chat state:

```tsx
interface ChatState {
  messages: ChatMessage[];
  isLoading: boolean;

  // Actions
  loadChat: (featureId: string) => Promise<void>;
  addMessage: (message: Omit<ChatMessage, 'id' | 'timestamp'>) => void;
  clearChat: () => void;
}
```

For now, loadChat will try IPC (window.electronAPI.storage.loadChat) and fall back to empty array if not implemented yet.

addMessage generates id (crypto.randomUUID()) and timestamp (new Date().toISOString()) automatically.

Update stores/index.ts to export useChatStore.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Chat store with messages array and loadChat/addMessage actions</done>
</task>

<task type="auto">
  <name>Task 2: Create ChatMessage component</name>
  <files>src/renderer/src/components/Chat/ChatMessage.tsx, src/renderer/src/components/Chat/index.ts</files>
  <action>
Create ChatMessage component for rendering individual messages:

```tsx
interface ChatMessageProps {
  message: ChatMessage;
}
```

Styling based on role:
- User messages: bg-blue-900/50 aligned right
- Assistant messages: bg-gray-700 aligned left
- Show timestamp on hover (optional)
- Support markdown rendering in content (simple line breaks for now)

Structure:
```tsx
<div className={`rounded-lg p-3 max-w-[80%] ${
  message.role === 'user' ? 'bg-blue-900/50 ml-auto' : 'bg-gray-700 mr-auto'
}`}>
  <div className="text-sm text-gray-400 mb-1">
    {message.role === 'user' ? 'You' : 'AI'}
  </div>
  <div className="whitespace-pre-wrap">{message.content}</div>
</div>
```
  </action>
  <verify>npm run typecheck passes</verify>
  <done>ChatMessage renders user/assistant messages with distinct styling</done>
</task>

<task type="auto">
  <name>Task 3: Create FeatureChat sidebar component</name>
  <files>src/renderer/src/components/Chat/FeatureChat.tsx</files>
  <action>
Create FeatureChat sidebar component:

```tsx
interface FeatureChatProps {
  featureId: string;
}
```

Structure:
1. Header: "Feature Chat" title
2. Messages area: scrollable, auto-scroll to bottom on new messages
3. Input area: textarea + send button
4. "Re-evaluate deps" button (placeholder, disabled)

Implementation:
- Load chat on featureId change
- Handle message submission (add user message, no AI response yet)
- Auto-scroll messages container to bottom
- Enter key sends (Shift+Enter for newline)

Layout:
```tsx
<div className="w-80 flex flex-col border-l border-gray-700">
  <div className="p-3 border-b border-gray-700">
    <h3 className="font-semibold">Feature Chat</h3>
  </div>
  <div className="flex-1 overflow-y-auto p-3 space-y-3">
    {messages.map(m => <ChatMessage key={m.id} message={m} />)}
  </div>
  <div className="p-3 border-t border-gray-700">
    <button disabled className="text-sm text-gray-500 mb-2">
      Re-evaluate deps
    </button>
    <div className="flex gap-2">
      <textarea ... />
      <button>Send</button>
    </div>
  </div>
</div>
```
  </action>
  <verify>npm run typecheck passes</verify>
  <done>FeatureChat sidebar with message list and input</done>
</task>

<task type="auto">
  <name>Task 4: Integrate chat sidebar into DAGView</name>
  <files>src/renderer/src/views/DAGView.tsx</files>
  <action>
Update DAGView to include FeatureChat sidebar:

1. Import FeatureChat component
2. Add state for sidebar visibility (optional - can be always visible)
3. Update layout to include sidebar on right

Layout update:
```tsx
<div className="h-full flex flex-col">
  <FeatureTabs ... />
  <div className="flex-1 flex overflow-hidden">
    <div className="flex-1 relative">
      <ReactFlow ... />
      {/* Control bar at bottom */}
    </div>
    {activeFeatureId && <FeatureChat featureId={activeFeatureId} />}
  </div>
</div>
```

The chat sidebar appears when a feature is selected.
  </action>
  <verify>npm run dev shows chat sidebar next to DAG graph</verify>
  <done>DAGView includes FeatureChat sidebar for active feature</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] Chat sidebar visible in DAG view when feature selected
- [ ] Messages display with correct styling (user right, AI left)
- [ ] Message input works, messages appear in list
- [ ] Chat loads per feature (empty for now)
- [ ] Re-evaluate deps button visible (disabled placeholder)
</verification>

<success_criteria>
- Chat store for message state
- ChatMessage component with role-based styling
- FeatureChat sidebar with messages and input
- Sidebar integrated into DAGView
- Phase 6 UI complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-ui-views/06-05-SUMMARY.md` with:
- Tasks completed
- Files created/modified
- Key decisions
- Phase 6 complete status

Update STATE.md:
- Mark Phase 6 complete
- Update progress percentage
- Ready for Phase 7
</output>
