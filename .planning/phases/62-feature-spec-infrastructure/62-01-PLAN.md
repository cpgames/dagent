---
phase: 62-feature-spec-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/agents/feature-spec-types.ts
  - src/main/agents/feature-spec-store.ts
  - src/main/storage/paths.ts
  - src/main/agents/index.ts
autonomous: true

must_haves:
  truths:
    - "Feature spec can be created with structured sections"
    - "Feature spec persists to feature-spec.md in feature's .dagent directory"
    - "Feature spec can be loaded and updated"
    - "Spec is human-readable markdown format"
  artifacts:
    - path: "src/main/agents/feature-spec-types.ts"
      provides: "FeatureSpec interface and section types"
      exports: ["FeatureSpec", "SpecSection", "RequirementItem", "AcceptanceCriterion"]
    - path: "src/main/agents/feature-spec-store.ts"
      provides: "CRUD operations for feature specs"
      exports: ["FeatureSpecStore", "getFeatureSpecStore"]
    - path: "src/main/storage/paths.ts"
      provides: "Path helper for feature-spec.md"
      contains: "getFeatureSpecPath"
  key_links:
    - from: "feature-spec-store.ts"
      to: "paths.ts"
      via: "getFeatureSpecPath import"
      pattern: "import.*getFeatureSpecPath"
    - from: "feature-spec-store.ts"
      to: "feature-spec-types.ts"
      via: "FeatureSpec type import"
      pattern: "import.*FeatureSpec"
---

<objective>
Create feature spec schema and storage infrastructure.

Purpose: Enable PM agent to maintain a living feature specification that captures user intent,
requirements, and acceptance criteria. This spec becomes the single source of truth for all
agents (Dev, QA, Merge) working on the feature.

Output: FeatureSpec types and FeatureSpecStore class for CRUD operations on feature-spec.md files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/milestones/v2.5-ROADMAP.md

# Existing patterns to follow:
@src/main/agents/task-plan-types.ts
@src/main/agents/task-plan-store.ts
@src/main/storage/paths.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FeatureSpec types</name>
  <files>src/main/agents/feature-spec-types.ts</files>
  <action>
Create TypeScript interfaces for feature specification:

1. **SpecSection** - Enum/union for section types:
   - 'goals' - What user wants to achieve
   - 'requirements' - Specific behaviors needed
   - 'constraints' - Limitations/preferences
   - 'acceptance_criteria' - How to verify done

2. **RequirementItem** - Individual requirement:
   - id: string (e.g., 'REQ-001')
   - description: string
   - completed: boolean
   - addedAt: ISO timestamp
   - completedAt?: ISO timestamp

3. **AcceptanceCriterion** - Testable criterion:
   - id: string (e.g., 'AC-001')
   - description: string
   - passed: boolean
   - testedAt?: ISO timestamp

4. **SpecHistoryEntry** - Track spec changes:
   - timestamp: ISO string
   - change: string (brief description of what changed)

5. **FeatureSpec** - Full spec document:
   - featureId: string
   - featureName: string
   - goals: string[] (bullet points)
   - requirements: RequirementItem[]
   - constraints: string[] (bullet points)
   - acceptanceCriteria: AcceptanceCriterion[]
   - history: SpecHistoryEntry[]
   - createdAt: ISO timestamp
   - updatedAt: ISO timestamp

Follow task-plan-types.ts patterns for documentation style and export structure.
  </action>
  <verify>tsc --noEmit passes with no errors</verify>
  <done>FeatureSpec interface and related types exported from feature-spec-types.ts</done>
</task>

<task type="auto">
  <name>Task 2: Add path helper and create FeatureSpecStore</name>
  <files>src/main/storage/paths.ts, src/main/agents/feature-spec-store.ts</files>
  <action>
**In paths.ts:**
Add `getFeatureSpecPath` function:
- Location: {projectRoot}/.dagent-worktrees/{featureId}/.dagent/feature-spec.md
- Follow existing pattern from getFeaturePath

**In feature-spec-store.ts:**
Create FeatureSpecStore class following TaskPlanStore patterns:

1. **Singleton pattern** - stores Map keyed by projectRoot, getFeatureSpecStore() factory

2. **CRUD methods:**
   - createSpec(featureId, featureName): Create new spec with empty sections, save immediately
   - loadSpec(featureId): Load and parse feature-spec.md, return FeatureSpec or null
   - saveSpec(featureId, spec): Save spec as markdown, update updatedAt
   - deleteSpec(featureId): Delete feature-spec.md, return boolean
   - specExists(featureId): Check if spec file exists

3. **Update methods:**
   - addGoal(featureId, goal): Add goal to goals array
   - addRequirement(featureId, description): Add RequirementItem with auto-generated ID
   - addConstraint(featureId, constraint): Add constraint string
   - addAcceptanceCriterion(featureId, description): Add AcceptanceCriterion with auto ID
   - markRequirementComplete(featureId, reqId): Set completed=true, completedAt
   - markCriterionPassed(featureId, acId): Set passed=true, testedAt
   - addHistoryEntry(featureId, change): Add SpecHistoryEntry

4. **Markdown format:**
   The spec should be saved as human-readable markdown:
   ```markdown
   # Feature: {featureName}

   ## Goals
   - {goal1}
   - {goal2}

   ## Requirements
   - [ ] REQ-001: {description}
   - [x] REQ-002: {description} (completed)

   ## Constraints
   - {constraint1}
   - {constraint2}

   ## Acceptance Criteria
   - [ ] AC-001: {description}
   - [x] AC-002: {description} (passed)

   ## History
   - 2026-01-15: Initial spec from user request
   - 2026-01-15: Added refresh token requirement
   ```

5. **Parsing logic:**
   - Parse markdown back to FeatureSpec object when loading
   - Handle checkboxes [x] / [ ] for completed/passed status
   - Extract IDs from format "REQ-001:" or "AC-001:"

Use fs/promises for file operations (readFile, writeFile, unlink, access).
  </action>
  <verify>tsc --noEmit passes, FeatureSpecStore methods are type-safe</verify>
  <done>FeatureSpecStore class with CRUD operations and markdown serialization</done>
</task>

<task type="auto">
  <name>Task 3: Export from agents index</name>
  <files>src/main/agents/index.ts</files>
  <action>
Add exports for feature spec infrastructure:
- Export * from './feature-spec-types'
- Export { FeatureSpecStore, getFeatureSpecStore } from './feature-spec-store'

Follow existing export patterns in the file.
  </action>
  <verify>Import { FeatureSpec, getFeatureSpecStore } from '../agents' resolves correctly</verify>
  <done>Feature spec types and store exported from agents barrel</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] FeatureSpec type is properly documented with JSDoc comments
- [ ] FeatureSpecStore follows singleton pattern like TaskPlanStore
- [ ] Markdown format is human-readable (can open in any text editor)
- [ ] All exports accessible from src/main/agents/index.ts
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- FeatureSpec infrastructure ready for PM agent integration in Phase 63
</success_criteria>

<output>
After completion, create `.planning/phases/62-feature-spec-infrastructure/62-01-SUMMARY.md`
</output>
