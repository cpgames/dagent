---
phase: 94-layout-refinements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/src/views/DAGView.tsx
  - src/renderer/src/components/DAG/LayoutControls.tsx
  - src/main/storage/dag-layout-store.ts
autonomous: true

must_haves:
  truths:
    - "Node positions animate smoothly when auto-layout repositions them"
    - "User can reset layout to auto-calculated positions"
    - "Layout state persists across app restarts"
    - "Pan is constrained to prevent excessive negative space"
    - "Manual node dragging snaps to grid"
  artifacts:
    - path: "src/renderer/src/components/DAG/LayoutControls.tsx"
      provides: "Layout control UI component with reset button"
      min_lines: 50
      exports: ["LayoutControls"]
    - path: "src/main/storage/dag-layout-store.ts"
      provides: "Layout persistence service"
      min_lines: 80
      exports: ["LayoutStore", "loadLayout", "saveLayout"]
    - path: "src/renderer/src/views/DAGView.tsx"
      provides: "Integrated layout controls and persistence"
      contains: "LayoutControls"
  key_links:
    - from: "src/renderer/src/views/DAGView.tsx"
      to: "src/renderer/src/components/DAG/LayoutControls.tsx"
      via: "import and render"
      pattern: "import.*LayoutControls"
    - from: "src/renderer/src/views/DAGView.tsx"
      to: "window.electron.dagLayout"
      via: "IPC calls for persistence"
      pattern: "window\\.electron\\.dagLayout"
---

<objective>
Polish DAG layout behavior with smooth animations, layout persistence, pan constraints, snap-to-grid dragging, and layout reset controls.

Purpose: Complete the vertical DAG flow feature with production-ready layout UX that feels smooth, constrained, and preserves user adjustments.
Output: Polished layout controls, persistence, and interaction refinements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v2.8-ROADMAP.md
@.planning/STATE.md
@.planning/phases/91-vertical-node-ui/91-01-SUMMARY.md
@.planning/phases/93-pm-agent-dag-integration/93-01-SUMMARY.md
@src/renderer/src/views/DAGView.tsx
@src/main/storage/feature-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create layout persistence store</name>
  <files>src/main/storage/dag-layout-store.ts, src/main/ipc/index.ts, src/preload/index.ts, src/preload/index.d.ts</files>
  <action>
    Create `dag-layout-store.ts` in main/storage with:
    - LayoutStore class for reading/writing layout JSON files
    - Schema: `{ featureId: string, positions: Record<taskId, {x, y}> }`
    - `saveLayout(featureId, positions)` - write to `.dagent/layouts/{featureId}.json`
    - `loadLayout(featureId)` - read from layout file, return positions or null
    - Auto-create layouts directory if missing

    Add IPC handlers in `src/main/ipc/index.ts`:
    - `handle('dag-layout:save', (featureId, positions) => { ... })`
    - `handle('dag-layout:load', (featureId) => { ... })`

    Add preload bindings in `src/preload/index.ts`:
    - `dagLayout: { save: (featureId, positions), load: (featureId) }`

    Add types to `src/preload/index.d.ts`:
    - Extend ElectronAPI interface with dagLayout property

    WHY: Layout persistence requires file I/O in main process, exposed via IPC. Separate layout files per feature keeps state isolated.
  </action>
  <verify>tsc --noEmit passes, grep confirms handlers registered</verify>
  <done>Layout persistence API exists and is type-safe</done>
</task>

<task type="auto">
  <name>Task 2: Create LayoutControls component</name>
  <files>src/renderer/src/components/DAG/LayoutControls.tsx, src/renderer/src/components/DAG/index.ts</files>
  <action>
    Create `LayoutControls.tsx` component with:
    - Props: `featureId: string | null, onResetLayout: () => void`
    - Single button: "Reset Layout" (icon: arrow-path or refresh)
    - Styled with existing DAG control aesthetic (matches Controls/MiniMap theme)
    - Tooltip: "Reset to auto-calculated positions"
    - Disabled when no feature selected
    - Position: Absolute positioned in top-right of DAG canvas (near minimap)

    Export from `src/renderer/src/components/DAG/index.ts`.

    WHY: Layout reset button needs to be accessible but not cluttered. Top-right placement groups it with other canvas controls (zoom, minimap).
  </action>
  <verify>npm run build succeeds, component exports verified</verify>
  <done>LayoutControls component renders and triggers reset callback</done>
</task>

<task type="auto">
  <name>Task 3: Integrate layout features in DAGView</name>
  <files>src/renderer/src/views/DAGView.tsx</files>
  <action>
    Update DAGView to add:

    1. **Layout persistence:**
       - On component mount: `const savedLayout = await window.electron.dagLayout.load(featureId)`
       - If savedLayout exists, merge into node positions before rendering
       - On node position change: debounce and call `window.electron.dagLayout.save(featureId, positions)`
       - Use 500ms debounce to avoid excessive writes

    2. **Smooth animations:**
       - Add to ReactFlow props: `defaultEdgeOptions={{ animated: false }}`
       - Add CSS transition to TaskNode positions (already applied by React Flow when fitView disabled)
       - No custom animation needed - React Flow handles this

    3. **Pan constraints:**
       - Add to ReactFlow props: `translateExtent={[[-500, -500], [3000, 3000]]}`
       - Prevents excessive panning into negative space
       - Allows some negative space for UX flexibility

    4. **Snap to grid:**
       - Add to ReactFlow props: `snapToGrid={true}, snapGrid={[20, 20]}`
       - Matches Background grid size for visual alignment

    5. **Layout reset:**
       - Import and render LayoutControls component
       - Implement `handleResetLayout` callback:
         - Clear saved layout: `await window.electron.dagLayout.save(featureId, {})`
         - Trigger DAGManager auto-placement for all nodes
         - Call `fitView()` to recenter
       - Pass to LayoutControls as `onResetLayout` prop

    WHY: These refinements polish the layout UX. Persistence preserves manual adjustments. Pan constraints prevent users from getting lost. Snap-to-grid keeps manual edits aligned. Reset provides escape hatch back to auto-layout.
  </action>
  <verify>npm run build succeeds, no TypeScript errors, grep confirms new props present</verify>
  <done>DAGView has persistence, animations, pan constraints, snap-to-grid, and reset button</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] TypeScript type checking passes
- [ ] LayoutControls component renders in DAGView
- [ ] Layout persistence IPC handlers registered
- [ ] React Flow props include snapToGrid, translateExtent
</verification>

<success_criteria>
- All tasks completed
- Layout state persists across app restarts
- Node dragging snaps to 20px grid
- Pan is constrained to reasonable bounds
- Reset layout button clears saved positions and re-runs auto-placement
- No TypeScript errors or build warnings
</success_criteria>

<output>
After completion, create `.planning/phases/94-layout-refinements/94-01-SUMMARY.md`
</output>
