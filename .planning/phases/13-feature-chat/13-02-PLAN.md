# Phase 13 Plan 02: AI Chat Integration

**Objective**: Send user messages to Claude API and stream AI responses back to the chat

## Context

### Current State
- Chat UI exists with user message input
- Messages persist to storage (from 13-01)
- `AuthManager` provides credentials via `getApiKey()`
- No AI response mechanism - user sends messages but gets no response

### Required Changes
1. Create chat service in main process to call Claude API
2. Add IPC handler for sending chat messages and streaming responses
3. Update chat-store to handle streaming assistant messages
4. Display streaming responses in UI with loading state

## Dependencies

- Requires: 13-01 (chat persistence)
- Provides: AI response capability for feature chat

## Tasks

### Task 1: Create Claude chat service in main process

Create a service that calls Claude API using stored credentials.

**Files to create:**
- `src/main/chat/chat-service.ts`
- `src/main/chat/index.ts`

**Implementation:**
```typescript
// src/main/chat/chat-service.ts
import Anthropic from '@anthropic-ai/sdk'
import { getAuthManager } from '../auth/auth-manager'
import type { ChatEntry } from '@shared/types'

export interface ChatRequest {
  messages: ChatEntry[]
  systemPrompt?: string
}

export interface ChatResponse {
  content: string
  error?: string
}

export class ChatService {
  private client: Anthropic | null = null

  private getClient(): Anthropic {
    if (!this.client) {
      const authManager = getAuthManager()
      const apiKey = authManager.getApiKey()
      if (!apiKey) {
        throw new Error('Not authenticated. Please configure API credentials.')
      }
      this.client = new Anthropic({ apiKey })
    }
    return this.client
  }

  async sendMessage(request: ChatRequest): Promise<ChatResponse> {
    try {
      const client = this.getClient()

      const response = await client.messages.create({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 4096,
        system: request.systemPrompt || 'You are a helpful AI assistant.',
        messages: request.messages.map(m => ({
          role: m.role,
          content: m.content
        }))
      })

      const textContent = response.content.find(c => c.type === 'text')
      return {
        content: textContent?.text || ''
      }
    } catch (error) {
      return {
        content: '',
        error: error instanceof Error ? error.message : 'Failed to get AI response'
      }
    }
  }

  // Reset client when credentials change
  resetClient(): void {
    this.client = null
  }
}

let chatService: ChatService | null = null

export function getChatService(): ChatService {
  if (!chatService) {
    chatService = new ChatService()
  }
  return chatService
}
```

**Verification:**
- Service instantiates without error
- `getClient()` throws if not authenticated

### Task 2: Add IPC handler for chat messages

Create IPC handler that receives messages and returns AI response.

**Files to create:**
- `src/main/ipc/chat-handlers.ts`

**Files to modify:**
- `src/main/ipc/index.ts` - Register chat handlers

**Implementation:**
```typescript
// src/main/ipc/chat-handlers.ts
import { ipcMain } from 'electron'
import { getChatService, type ChatRequest, type ChatResponse } from '../chat/chat-service'

export function registerChatHandlers(): void {
  ipcMain.handle('chat:send', async (_event, request: ChatRequest): Promise<ChatResponse> => {
    const service = getChatService()
    return service.sendMessage(request)
  })
}
```

**Verification:**
- Handler registered without conflict
- Returns response or error

### Task 3: Add preload API for chat

Expose chat IPC to renderer process.

**Files to modify:**
- `src/preload/index.ts` - Add chat.send method
- `src/preload/index.d.ts` - Add ChatAPI types

**Implementation:**
```typescript
// In index.d.ts
export interface ChatAPI {
  send: (request: { messages: ChatEntry[]; systemPrompt?: string }) => Promise<{ content: string; error?: string }>
}

// In ElectronAPI
chat: ChatAPI

// In index.ts
chat: {
  send: (request) => ipcRenderer.invoke('chat:send', request)
}
```

**Verification:**
- `window.electronAPI.chat.send` is callable
- Returns ChatResponse type

### Task 4: Update chat-store with AI response handling

Modify chat-store to send messages and receive AI responses.

**Files to modify:**
- `src/renderer/src/stores/chat-store.ts`

**Changes:**
1. Add `isResponding` state for loading indicator
2. Modify `addMessage()` to trigger AI response for user messages
3. Add `sendToAI()` action that calls the API and adds response
4. Handle errors gracefully

**Implementation:**
```typescript
interface ChatState {
  messages: ChatMessage[]
  isLoading: boolean
  isResponding: boolean  // NEW - AI is generating response
  currentFeatureId: string | null

  loadChat: (featureId: string) => Promise<void>
  addMessage: (message: Omit<ChatMessage, 'id' | 'timestamp'>) => void
  sendToAI: () => Promise<void>  // NEW
  clearChat: () => void
}

// In the store:
sendToAI: async () => {
  const { messages, currentFeatureId } = get()
  if (!currentFeatureId || messages.length === 0) return

  set({ isResponding: true })

  try {
    const response = await window.electronAPI.chat.send({
      messages: messages.map(m => ({
        role: m.role,
        content: m.content,
        timestamp: m.timestamp
      }))
    })

    if (response.error) {
      toast.error(response.error)
    } else if (response.content) {
      // Add assistant message
      const assistantMessage: ChatMessage = {
        id: crypto.randomUUID(),
        role: 'assistant',
        content: response.content,
        timestamp: new Date().toISOString()
      }
      set((state) => ({
        messages: [...state.messages, assistantMessage]
      }))

      // Persist
      const { messages: updatedMessages } = get()
      await window.electronAPI.storage.saveChat(currentFeatureId, {
        entries: updatedMessages.map(m => ({
          role: m.role,
          content: m.content,
          timestamp: m.timestamp
        }))
      })
    }
  } catch (error) {
    console.error('AI response error:', error)
    toast.error('Failed to get AI response')
  } finally {
    set({ isResponding: false })
  }
}
```

**Verification:**
- User sends message -> AI responds
- Loading indicator shows during response
- Response is saved to storage
- Errors show toast

### Task 5: Update FeatureChat UI for AI responses

Show loading state while AI is responding.

**Files to modify:**
- `src/renderer/src/components/Chat/FeatureChat.tsx`

**Changes:**
1. Use `isResponding` from store
2. Show typing indicator while AI responds
3. Disable input while responding
4. Trigger `sendToAI()` after adding user message

**Implementation:**
```tsx
const { messages, loadChat, addMessage, sendToAI, isLoading, isResponding } = useChatStore()

const handleSend = useCallback(async () => {
  const trimmedValue = inputValue.trim()
  if (!trimmedValue) return

  addMessage({
    role: 'user',
    content: trimmedValue
  })
  setInputValue('')

  // Trigger AI response
  await sendToAI()
}, [inputValue, addMessage, sendToAI])

// In JSX:
{isResponding && (
  <div className="text-gray-400 text-sm flex items-center gap-2">
    <span className="animate-pulse">AI is thinking...</span>
  </div>
)}

<textarea
  disabled={isResponding}
  // ...
/>
<button
  onClick={handleSend}
  disabled={!inputValue.trim() || isResponding}
  // ...
>
  {isResponding ? 'Thinking...' : 'Send'}
</button>
```

**Verification:**
- Input disabled while AI responds
- "AI is thinking..." shows during response
- Button text changes to "Thinking..."
- Response appears when complete

## Verification Checklist

- [ ] User sends message -> AI responds with relevant text
- [ ] Loading indicator shows during AI response
- [ ] Input is disabled while AI responds
- [ ] AI response is saved to chat.json
- [ ] Not authenticated -> shows error toast
- [ ] API error -> shows error toast, UI recoverable
- [ ] Multiple messages build conversation context

## Files Summary

| File | Action | Purpose |
|------|--------|---------|
| `src/main/chat/chat-service.ts` | Create | Claude API client wrapper |
| `src/main/chat/index.ts` | Create | Module exports |
| `src/main/ipc/chat-handlers.ts` | Create | IPC handler for chat |
| `src/main/ipc/index.ts` | Modify | Register chat handlers |
| `src/preload/index.ts` | Modify | Expose chat API |
| `src/preload/index.d.ts` | Modify | ChatAPI types |
| `src/renderer/src/stores/chat-store.ts` | Modify | Add sendToAI action |
| `src/renderer/src/components/Chat/FeatureChat.tsx` | Modify | Loading states, trigger AI |

## Estimated Tasks: 5

## npm Dependencies

Need to install Anthropic SDK if not present:
```bash
npm install @anthropic-ai/sdk
```

---
*Phase: 13-feature-chat*
*Plan: 02 of 03*
