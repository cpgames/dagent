# Phase 13 Plan 03: Chat Context Assembly

**Objective**: Include feature context (goal, tasks, DAG state) in AI prompts for relevant responses

## Context

### Current State
- AI chat works (from 13-02) but has no context about the feature
- User asking "what should I do next?" gets generic response
- Need to provide feature goal, task list, DAG status to AI

### Required Changes
1. Build system prompt with feature context
2. Include DAG task summary in context
3. Pass context to chat service
4. Update chat UI to show context status

## Dependencies

- Requires: 13-02 (AI chat integration)
- Provides: Context-aware AI responses

## Tasks

### Task 1: Create context assembly utility

Build a function that assembles feature context into a system prompt.

**Files to create:**
- `src/main/chat/context-builder.ts`

**Implementation:**
```typescript
// src/main/chat/context-builder.ts
import type { Feature, DAGGraph, Task, TaskStatus } from '@shared/types'

export interface FeatureContext {
  featureId: string
  featureName: string
  goal: string
  tasks: TaskSummary[]
  dagSummary: string
}

interface TaskSummary {
  id: string
  title: string
  status: TaskStatus
  description?: string
}

export function buildFeatureContext(feature: Feature, dag: DAGGraph | null): FeatureContext {
  const tasks: TaskSummary[] = dag?.tasks.map(t => ({
    id: t.id,
    title: t.title,
    status: t.status,
    description: t.description
  })) || []

  const statusCounts = tasks.reduce((acc, t) => {
    acc[t.status] = (acc[t.status] || 0) + 1
    return acc
  }, {} as Record<string, number>)

  const dagSummary = Object.entries(statusCounts)
    .map(([status, count]) => `${status}: ${count}`)
    .join(', ')

  return {
    featureId: feature.id,
    featureName: feature.name,
    goal: feature.goal || 'No goal specified',
    tasks,
    dagSummary: dagSummary || 'No tasks'
  }
}

export function buildSystemPrompt(context: FeatureContext): string {
  const taskList = context.tasks.length > 0
    ? context.tasks.map(t => `- [${t.status}] ${t.title}${t.description ? `: ${t.description}` : ''}`).join('\n')
    : 'No tasks defined yet.'

  return `You are an AI assistant helping with a software development feature.

## Current Feature
**Name:** ${context.featureName}
**Goal:** ${context.goal}

## Task Status
${context.dagSummary}

## Task List
${taskList}

## Your Role
- Help the user plan, execute, and complete tasks for this feature
- Provide guidance on next steps based on task dependencies and status
- Answer questions about the feature implementation
- Suggest improvements to the task breakdown if asked

Be concise and actionable in your responses. Focus on helping complete the feature.`
}
```

**Verification:**
- Context built correctly from feature/DAG
- System prompt includes all relevant info

### Task 2: Add IPC handler for context retrieval

Create handler to get feature context from renderer.

**Files to modify:**
- `src/main/ipc/chat-handlers.ts`

**Changes:**
1. Add handler to get feature context
2. Load feature and DAG data
3. Return assembled context

**Implementation:**
```typescript
// In chat-handlers.ts
import { buildFeatureContext, buildSystemPrompt, type FeatureContext } from '../chat/context-builder'
import { FeatureStore } from '../storage/feature-store'

let featureStore: FeatureStore | null = null

export function initializeChatStore(store: FeatureStore): void {
  featureStore = store
}

ipcMain.handle('chat:getContext', async (_event, featureId: string): Promise<{ context: FeatureContext; systemPrompt: string } | null> => {
  if (!featureStore) return null

  const feature = await featureStore.loadFeature(featureId)
  if (!feature) return null

  const dag = await featureStore.loadDag(featureId)
  const context = buildFeatureContext(feature, dag)
  const systemPrompt = buildSystemPrompt(context)

  return { context, systemPrompt }
})
```

**Verification:**
- Handler returns context for valid feature
- Returns null for invalid feature

### Task 3: Update preload with context API

Expose context retrieval to renderer.

**Files to modify:**
- `src/preload/index.ts`
- `src/preload/index.d.ts`

**Implementation:**
```typescript
// In index.d.ts
export interface FeatureContext {
  featureId: string
  featureName: string
  goal: string
  tasks: Array<{ id: string; title: string; status: string; description?: string }>
  dagSummary: string
}

export interface ChatAPI {
  send: (request: { messages: ChatEntry[]; systemPrompt?: string }) => Promise<{ content: string; error?: string }>
  getContext: (featureId: string) => Promise<{ context: FeatureContext; systemPrompt: string } | null>
}

// In index.ts
chat: {
  send: (request) => ipcRenderer.invoke('chat:send', request),
  getContext: (featureId: string) => ipcRenderer.invoke('chat:getContext', featureId)
}
```

**Verification:**
- `window.electronAPI.chat.getContext` callable
- Returns context or null

### Task 4: Update chat-store to use context

Modify sendToAI to fetch and use feature context.

**Files to modify:**
- `src/renderer/src/stores/chat-store.ts`

**Changes:**
1. Add `systemPrompt` to state (cached)
2. Fetch context when loading chat
3. Use systemPrompt in sendToAI call

**Implementation:**
```typescript
interface ChatState {
  messages: ChatMessage[]
  isLoading: boolean
  isResponding: boolean
  currentFeatureId: string | null
  systemPrompt: string | null  // NEW - cached context prompt
  contextLoaded: boolean       // NEW - track if context loaded

  loadChat: (featureId: string) => Promise<void>
  addMessage: (message: Omit<ChatMessage, 'id' | 'timestamp'>) => void
  sendToAI: () => Promise<void>
  refreshContext: () => Promise<void>  // NEW - reload context
  clearChat: () => void
}

// In loadChat:
loadChat: async (featureId: string) => {
  set({ isLoading: true, currentFeatureId: featureId, systemPrompt: null, contextLoaded: false })

  try {
    // Load messages
    const chat = await window.electronAPI.storage.loadChat(featureId)
    // ... existing message loading ...

    // Load context
    const contextResult = await window.electronAPI.chat.getContext(featureId)
    if (contextResult) {
      set({ systemPrompt: contextResult.systemPrompt, contextLoaded: true })
    }
  } catch (error) {
    // ...
  }
}

// In sendToAI:
sendToAI: async () => {
  const { messages, currentFeatureId, systemPrompt } = get()
  // ...

  const response = await window.electronAPI.chat.send({
    messages: messages.map(m => ({
      role: m.role,
      content: m.content,
      timestamp: m.timestamp
    })),
    systemPrompt: systemPrompt || undefined  // Use cached context
  })
  // ...
}

// New action to refresh context
refreshContext: async () => {
  const { currentFeatureId } = get()
  if (!currentFeatureId) return

  const contextResult = await window.electronAPI.chat.getContext(currentFeatureId)
  if (contextResult) {
    set({ systemPrompt: contextResult.systemPrompt, contextLoaded: true })
    toast.success('Context refreshed')
  }
}
```

**Verification:**
- Context loaded with chat
- AI responses are context-aware
- Refresh context updates system prompt

### Task 5: Add context indicator to chat UI

Show user that AI has feature context and allow refresh.

**Files to modify:**
- `src/renderer/src/components/Chat/FeatureChat.tsx`

**Changes:**
1. Show context status indicator
2. Add refresh button
3. Visual feedback when context loaded

**Implementation:**
```tsx
const { messages, loadChat, addMessage, sendToAI, refreshContext, isLoading, isResponding, contextLoaded } = useChatStore()

// In header section:
<div className="p-3 border-b border-gray-700 flex items-center justify-between">
  <h3 className="font-semibold text-white">Feature Chat</h3>
  <div className="flex items-center gap-2">
    {contextLoaded ? (
      <span className="text-xs text-green-400" title="AI has feature context">
        Context loaded
      </span>
    ) : (
      <span className="text-xs text-yellow-400">No context</span>
    )}
    <button
      onClick={refreshContext}
      className="text-xs text-gray-400 hover:text-white"
      title="Refresh feature context"
    >
      Refresh
    </button>
  </div>
</div>
```

**Verification:**
- "Context loaded" shows when context available
- Refresh button updates context
- AI responses reference feature tasks

## Verification Checklist

- [ ] AI responses reference feature name/goal
- [ ] AI knows task statuses (blocked, ready, completed)
- [ ] "What should I do next?" gives task-aware answer
- [ ] Context indicator shows in chat header
- [ ] Refresh button updates context
- [ ] Feature switch loads new context
- [ ] Missing feature shows "No context"

## Files Summary

| File | Action | Purpose |
|------|--------|---------|
| `src/main/chat/context-builder.ts` | Create | Build context from feature/DAG |
| `src/main/ipc/chat-handlers.ts` | Modify | Add getContext handler |
| `src/preload/index.ts` | Modify | Expose getContext |
| `src/preload/index.d.ts` | Modify | FeatureContext types |
| `src/renderer/src/stores/chat-store.ts` | Modify | Cache context, refresh action |
| `src/renderer/src/components/Chat/FeatureChat.tsx` | Modify | Context indicator, refresh |

## Estimated Tasks: 5

---
*Phase: 13-feature-chat*
*Plan: 03 of 03*
