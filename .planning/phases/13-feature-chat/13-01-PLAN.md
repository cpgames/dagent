# Phase 13 Plan 01: Chat Message Persistence

**Objective**: Save and load chat messages to .dagent storage so conversations persist between sessions

## Context

### Current State
- `FeatureChat.tsx` component exists with message display and input
- `chat-store.ts` exists with in-memory messages, `loadChat()` and `addMessage()`
- `loadChat()` checks for `window.electronAPI.storage.loadChat()` but it returns null
- IPC handlers for `storage:saveChat` and `storage:loadChat` exist
- `FeatureStore` class has `saveChat()` and `loadChat()` methods
- Chat is stored in `.dagent-worktrees/{featureId}/.dagent/chat.json`
- Messages are NOT persisted - they reset when switching features or restarting app

### Required Changes
1. Modify `addMessage()` in chat-store to save after each message
2. Ensure chat loads correctly on feature switch
3. Wire up preload API if not already connected

## Dependencies

- Requires: Phase 12 complete (project selection)
- Provides: Chat message persistence for Phase 13-02 (AI integration)

## Tasks

### Task 1: Verify and fix preload chat API connection

Check that `saveChat` is exposed in preload and correctly wired to IPC handlers.

**Files to modify:**
- `src/preload/index.ts` - Verify saveChat/loadChat are exposed

**Changes:**
1. Verify `storage.saveChat` and `storage.loadChat` are in preload
2. Test IPC connection works

**Verification:**
- `window.electronAPI.storage.saveChat` is callable
- `window.electronAPI.storage.loadChat` returns ChatHistory or null

### Task 2: Update chat-store to persist messages

Modify `addMessage()` to save the full chat history after adding each message.

**Files to modify:**
- `src/renderer/src/stores/chat-store.ts`

**Changes:**
1. Add `currentFeatureId` state to track which feature's chat is loaded
2. Update `loadChat()` to store the featureId
3. Update `addMessage()` to call `saveChat()` after adding the message
4. Add error handling with toast for save failures

**Implementation:**
```typescript
interface ChatState {
  messages: ChatMessage[]
  isLoading: boolean
  currentFeatureId: string | null  // NEW

  loadChat: (featureId: string) => Promise<void>
  addMessage: (message: Omit<ChatMessage, 'id' | 'timestamp'>) => void
  clearChat: () => void
}

// In addMessage:
addMessage: (message) => {
  const newMessage: ChatMessage = {
    ...message,
    id: crypto.randomUUID(),
    timestamp: new Date().toISOString()
  }
  set((state) => ({
    messages: [...state.messages, newMessage]
  }))

  // Persist to storage
  const { currentFeatureId, messages } = get()
  if (currentFeatureId) {
    const chatHistory: ChatHistory = {
      entries: messages.map(m => ({
        role: m.role,
        content: m.content,
        timestamp: m.timestamp
      }))
    }
    window.electronAPI.storage.saveChat(currentFeatureId, chatHistory)
      .catch(err => {
        console.error('Failed to save chat:', err)
        toast.error('Failed to save chat message')
      })
  }
}
```

**Verification:**
- Add a message, switch features, switch back - message persists
- Check `.dagent/chat.json` file is created with correct format

### Task 3: Handle chat loading edge cases

Ensure chat loads properly on feature changes and handles errors gracefully.

**Files to modify:**
- `src/renderer/src/stores/chat-store.ts`

**Changes:**
1. Clear messages before loading new feature's chat
2. Handle missing chat.json gracefully (empty messages array)
3. Add loading state management

**Verification:**
- Switching features loads correct chat history
- New feature with no chat shows empty state
- Loading errors show toast and don't break UI

## Verification Checklist

- [ ] User sends message - appears in UI
- [ ] User sends message - saved to `.dagent/chat.json`
- [ ] App restart - messages reload correctly
- [ ] Switch feature - loads that feature's chat
- [ ] Switch back - original feature's chat is restored
- [ ] New feature - shows empty chat state
- [ ] Save error - shows toast, UI remains functional

## Files Summary

| File | Action | Purpose |
|------|--------|---------|
| `src/preload/index.ts` | Verify | Check saveChat/loadChat wired |
| `src/renderer/src/stores/chat-store.ts` | Modify | Add persistence, track featureId |

## Estimated Tasks: 3

---
*Phase: 13-feature-chat*
*Plan: 01 of 03*
