---
phase: 51-qa-commits
plan: 01
subsystem: agents
tags: [task-agent, git, commit, workflow]

# Dependency graph
requires:
  - phase: 50-queue-based-pools/50-02
    provides: Queue-based pools and orchestrator integration
provides:
  - TaskAgent no longer commits code
  - Worktree preserved for QA review
  - DEV_COMPLETE event emitted without commit
affects: [qa-agent.ts, orchestrator.ts]

# Tech tracking
tech-stack:
  added: []
  patterns: [qa-commits-only]

key-files:
  created: []
  modified:
    - src/main/agents/task-agent.ts

key-decisions:
  - "TaskAgent removes commitChanges() call and commit verification"
  - "task_ready_for_merge message no longer includes commitHash"
  - "Worktree must remain intact for QA to review"
---

# Phase 51-01: Remove Git Commit from TaskAgent

**Objective:** TaskAgent no longer commits code after execution - QA will commit on pass.

## Context

Currently, TaskAgent commits code after execution (lines 463-474 in execute()):
```typescript
// Commit changes after successful execution
const commitResult = await this.commitChanges()
// Verify commit succeeded if there were changes
if (commitResult.error) {
  throw new Error(`Task commit failed: ${commitResult.error}`)
}
```

This creates a problem: if QA fails, there's already a bad commit that needs fixing.

**New flow:** Dev codes but doesn't commit. QA reviews uncommitted changes. If QA passes, QA commits.

## Tasks

### Task 1: Remove commit logic from execute()

**File:** `src/main/agents/task-agent.ts`

**Changes:**
1. Remove the `commitChanges()` call in execute() (around line 465)
2. Remove commit verification logic (lines 469-474)
3. Update task_ready_for_merge message to not include commitHash
4. Update TaskExecutionResult to not require commitHash/filesChanged

**Before:**
```typescript
// Commit changes after successful execution
console.log(`[TaskAgent ${this.state.taskId}] SDK stream finished, starting commit...`)
const commitResult = await this.commitChanges()
console.log(`[TaskAgent ${this.state.taskId}] Commit finished:`, commitResult)

// Verify commit succeeded if there were changes or if there was an error
if (commitResult.error) {
  throw new Error(`Task commit failed: ${commitResult.error}`)
}
if (commitResult.filesChanged && commitResult.filesChanged > 0 && !commitResult.commitHash) {
  throw new Error('Task made changes but commit failed - work not saved')
}
```

**After:**
```typescript
// Dev work complete - changes remain uncommitted for QA review
console.log(`[TaskAgent ${this.state.taskId}] SDK stream finished, dev work complete`)
// Note: QA agent will commit changes if review passes
```

### Task 2: Update task_ready_for_merge message

**File:** `src/main/agents/task-agent.ts`

**Changes:**
Remove commitHash from the message payload since there's no commit yet:

**Before:**
```typescript
completionBus.publish(
  createTaskToHarnessMessage(this.state.taskId, this.state.agentId!, 'task_ready_for_merge', {
    summary: completionSummary,
    commitHash: commitResult.commitHash
  })
)

const result: TaskExecutionResult = {
  success: true,
  taskId: this.state.taskId,
  summary: completionSummary,
  commitHash: commitResult.commitHash,
  filesChanged: commitResult.filesChanged
}
```

**After:**
```typescript
completionBus.publish(
  createTaskToHarnessMessage(this.state.taskId, this.state.agentId!, 'task_ready_for_merge', {
    summary: completionSummary
  })
)

const result: TaskExecutionResult = {
  success: true,
  taskId: this.state.taskId,
  summary: completionSummary
}
```

### Task 3: Keep commitChanges() method for future use

**File:** `src/main/agents/task-agent.ts`

The `commitChanges()` method (lines 600-682) should remain in the file but be marked as unused for now. This method will be moved/copied to QA agent in plan 51-02. For this plan, we only stop calling it.

**Rationale:** Keeping the method allows plan 51-02 to reference or copy the implementation. We can remove it after QA commits are working.

## Verification

After implementation:
1. `npm run build` passes with no errors
2. Verify execute() no longer calls commitChanges()
3. Verify task_ready_for_merge message doesn't include commitHash

## Expected Impact

- TaskAgent no longer creates commits
- Worktree contains uncommitted changes after dev work
- QA can review uncommitted changes (existing git diff approach)
- If QA fails, no bad commit exists to clean up

## Notes

- The QA agent already reviews using `git diff` (see buildReviewPrompt() in qa-agent.ts)
- Worktree lifecycle stays the same - orchestrator keeps worktree until merge complete
- Plan 51-02 will add commit logic to QA agent
