---
phase: v3.2-05-pm-planning-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/ipc/feature-handlers.ts
  - src/renderer/src/stores/chat-store.ts
  - src/main/services/feature-status-manager.ts
autonomous: true

must_haves:
  truths:
    - "PM agent automatically starts when feature enters investigating state"
    - "Chat messages route to PM agent during investigating state (not just questioning/planning)"
    - "PM agent can transition feature through investigating → questioning → planning → ready"
  artifacts:
    - path: "src/main/ipc/feature-handlers.ts"
      provides: "Auto-trigger PM on investigating status"
      contains: "startPlanningForFeature"
    - path: "src/renderer/src/stores/chat-store.ts"
      provides: "Chat routing for investigating state"
      contains: "investigating"
  key_links:
    - from: "src/main/ipc/feature-handlers.ts"
      to: "PMAgentManager.startPlanningForFeature"
      via: "worktree creation completion callback"
      pattern: "startPlanningForFeature"
---

<objective>
Auto-trigger PM agent when feature enters investigating state and enable chat routing for all PM planning states.

Purpose: Connect worktree creation completion to PM agent workflow start, and ensure users can chat with PM during all planning phases (investigating, questioning, planning).

Output: Modified feature-handlers.ts with auto-trigger, updated chat-store.ts with investigating routing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/main/ipc/feature-handlers.ts
@src/renderer/src/stores/chat-store.ts
@src/main/agent/pm-agent-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auto-trigger PM agent on investigating status</name>
  <files>src/main/ipc/feature-handlers.ts</files>
  <action>
In the `feature:startWorktreeCreation` IPC handler, after the worktree creation succeeds and status transitions to `investigating`:

1. Find the `.then(async (result) => { if (result.success) { ... } })` block where status is updated to 'investigating'
2. After the status update to 'investigating', automatically trigger PM agent planning:
   - Load the feature to get name, description, attachments
   - Import and use `createPMAgentManager` from '../agent/pm-agent-manager'
   - Create PMAgentManager instance and call `startPlanningForFeature(featureId, feature.name, feature.description, feature.attachments)`
   - Add try/catch with console.error for errors (non-blocking, don't affect worktree success)
   - Add console.log for debugging: `[FeatureHandlers] Auto-starting PM agent for ${featureId}`

Key code insertion point - after this existing line:
```typescript
await manager.updateFeatureStatus(featureId, 'investigating')
console.log(`[FeatureHandlers] Worktree created, status updated to investigating for ${featureId}`)
```

Add the PM auto-start code AFTER the console.log.

IMPORTANT: The PM agent start should be fire-and-forget (don't await), so it doesn't block the worktree success return.
  </action>
  <verify>npm run typecheck:node</verify>
  <done>PM agent auto-starts when worktree creation completes and feature enters investigating state</done>
</task>

<task type="auto">
  <name>Task 2: Add investigating state to chat routing</name>
  <files>src/renderer/src/stores/chat-store.ts</files>
  <action>
In the `sendToAgent` function, find the condition that checks for PM routing:

```typescript
if (feature && (feature.status === 'planning' || feature.status === 'questioning')) {
  return get().sendToPMAgent()
}
```

Update it to also include 'investigating' state:

```typescript
if (feature && (feature.status === 'investigating' || feature.status === 'questioning' || feature.status === 'planning')) {
  return get().sendToPMAgent()
}
```

This ensures users can chat with the PM agent during all three PM planning phases.
  </action>
  <verify>npm run typecheck:web</verify>
  <done>Chat messages route to PM agent for features in investigating, questioning, or planning states</done>
</task>

<task type="auto">
  <name>Task 3: Fix investigating → questioning transition validation</name>
  <files>src/main/services/feature-status-manager.ts</files>
  <action>
Check the VALID_TRANSITIONS map to ensure the PM workflow transitions are correct:

Current transitions should be:
- investigating: ['questioning']  ← PM done investigating, has questions
- questioning: ['planning']       ← All questions answered, create tasks

The current code has:
```typescript
investigating: ['questioning'],  // Investigation done -> ask questions
questioning: ['planning'],  // Questions answered -> create tasks
```

However, we need to also allow:
- investigating → planning (if PM has no questions, skip questioning)

Update the investigating transitions to:
```typescript
investigating: ['questioning', 'planning'],  // Investigation done -> ask questions OR skip to planning if no questions
```

This allows the PM to either:
1. Go to questioning if it has clarifying questions
2. Go directly to planning if it has enough context (simple features)
  </action>
  <verify>npm run typecheck:node</verify>
  <done>PM can transition directly from investigating to planning when no questions needed</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run typecheck passes (both :node and :web)
- [ ] npm run build succeeds
- [ ] No console errors when starting app
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- PM agent auto-starts when feature enters investigating state
- Chat routes to PM during investigating state
- PM can skip questioning if no clarifications needed
</success_criteria>

<output>
After completion, create `.planning/phases/v3.2-05-pm-planning-integration/v3.2-05-01-SUMMARY.md`
</output>
