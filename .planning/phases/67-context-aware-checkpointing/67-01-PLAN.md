---
phase: 67-context-aware-checkpointing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/dag-engine/task-controller-types.ts
  - src/main/dag-engine/task-controller.ts
  - src/main/agent/agent-service.ts
  - src/main/agent/types.ts
autonomous: true
must_haves:
  truths:
    - "TaskController exits when context limit (~150k tokens) is approached"
    - "DevAgent signals 'continuing in next iteration' naturally without hardcoded max"
    - "Token usage is tracked and accumulated across iterations"
  artifacts:
    - path: "src/main/dag-engine/task-controller-types.ts"
      provides: "Token tracking configuration and state fields"
      contains: "contextTokenLimit"
    - path: "src/main/dag-engine/task-controller.ts"
      provides: "Context-aware checkpointing logic"
      contains: "checkContextLimit"
    - path: "src/main/agent/agent-service.ts"
      provides: "Token usage extraction from SDK"
      contains: "usage"
  key_links:
    - from: "src/main/agent/agent-service.ts"
      to: "src/main/dag-engine/task-controller.ts"
      via: "Token usage returned in execution result"
      pattern: "tokenUsage"
---

<objective>
Replace fixed maxIterations limit with context-aware checkpointing based on token usage.

Purpose: Enable DevAgent to naturally work until context fills up rather than arbitrary iteration counts. This provides more intelligent task completion signals.
Output: Modified TaskController that tracks token usage and checkpoints when approaching context limit.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v2.5-ROADMAP.md

@src/main/dag-engine/task-controller-types.ts
@src/main/dag-engine/task-controller.ts
@src/main/agent/agent-service.ts
@src/main/agent/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add token usage to AgentStreamEvent and TaskExecutionResult</name>
  <files>src/main/agent/types.ts, src/main/agents/dev-types.ts</files>
  <action>
1. In `src/main/agent/types.ts`, add token usage fields to `AgentStreamEvent`:
   - Add optional `usage?: { inputTokens: number; outputTokens: number; totalTokens: number }` to the event
   - This will be populated from SDK messages that include usage data

2. In `src/main/agents/dev-types.ts`, add token usage to `TaskExecutionResult`:
   - Add `tokenUsage?: { inputTokens: number; outputTokens: number; totalTokens: number }`
   - This captures cumulative usage for the iteration

The Claude Agent SDK provides usage data via `message.usage` on assistant messages. We need to capture and propagate this.
  </action>
  <verify>npm run typecheck</verify>
  <done>AgentStreamEvent and TaskExecutionResult include optional tokenUsage fields</done>
</task>

<task type="auto">
  <name>Task 2: Extract token usage from SDK messages</name>
  <files>src/main/agent/agent-service.ts</files>
  <action>
1. Modify the `convertMessage` method to extract usage data from SDK messages:
   - The SDK's assistant messages can include `usage` with `input_tokens` and `output_tokens`
   - When present, include this in the returned AgentStreamEvent

2. Track cumulative usage across the query stream:
   - Add private fields to track total input/output tokens
   - Reset at start of each query
   - Include final totals in the 'done' event

The SDK message structure includes:
```typescript
{
  type: 'assistant',
  message: { ... },
  usage?: { input_tokens: number, output_tokens: number }
}
```

Map this to our `usage` field in AgentStreamEvent.
  </action>
  <verify>npm run typecheck</verify>
  <done>AgentService extracts and propagates token usage from SDK messages</done>
</task>

<task type="auto">
  <name>Task 3: Add context-aware config and state to TaskController</name>
  <files>src/main/dag-engine/task-controller-types.ts</files>
  <action>
1. Add context limit configuration to `TaskControllerConfig`:
   - `contextTokenLimit: number` (default: 150000) - soft limit for checkpointing
   - `maxIterations: number` - keep as safety backstop but increase default to 50
   - `useContextCheckpointing: boolean` (default: true) - enable context-aware mode

2. Add token tracking to `TaskControllerState`:
   - `cumulativeTokens: { input: number; output: number; total: number }`
   - This tracks usage across all iterations

3. Add `LoopExitReason` value: `'context_limit_reached'`

4. Update `DEFAULT_TASK_CONTROLLER_CONFIG`:
   - Set `contextTokenLimit: 150000`
   - Set `maxIterations: 50` (safety backstop)
   - Set `useContextCheckpointing: true`
  </action>
  <verify>npm run typecheck</verify>
  <done>TaskControllerConfig and State support context-aware checkpointing</done>
</task>

<task type="auto">
  <name>Task 4: Implement context-aware checkpointing in TaskController</name>
  <files>src/main/dag-engine/task-controller.ts, src/main/agents/dev-agent.ts</files>
  <action>
1. In DevAgent.executeIteration(), capture token usage from events:
   - Track cumulative tokens during the stream loop
   - Return tokenUsage in TaskExecutionResult

2. In TaskController.runIterationLoop():
   - After each iteration, accumulate token usage in state.cumulativeTokens
   - Update checkExitConditions() to check context limit:
     - If `useContextCheckpointing && cumulativeTokens.total >= contextTokenLimit`
     - Return `'context_limit_reached'` as exit reason
   - Keep `max_iterations_reached` as fallback safety

3. In TaskController.buildIterationSummary():
   - Include token usage in the summary for visibility

4. Emit 'iteration:complete' with token usage data for UI tracking
  </action>
  <verify>npm run typecheck && npm run build</verify>
  <done>TaskController uses context-aware checkpointing instead of arbitrary iteration limits</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run typecheck passes
- [ ] npm run build passes
- [ ] TaskControllerConfig has contextTokenLimit field
- [ ] TaskControllerState tracks cumulativeTokens
- [ ] AgentService extracts usage from SDK messages
- [ ] DevAgent.executeIteration returns tokenUsage
- [ ] TaskController checks context limit in exit conditions
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Token usage flows from SDK → AgentService → DevAgent → TaskController
- Context-aware checkpointing replaces fixed iteration limits
</success_criteria>

<output>
After completion, create `.planning/phases/67-context-aware-checkpointing/67-01-SUMMARY.md`
</output>
