---
phase: 58-task-controller
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/dag-engine/task-controller.ts
  - src/main/dag-engine/task-controller-types.ts
autonomous: true
must_haves:
  truths:
    - "TaskController can run multiple iterations until checks pass"
    - "Each iteration spawns a fresh DevAgent"
    - "Iteration exits when all required checks pass or max iterations reached"
    - "Activity is logged for each iteration"
  artifacts:
    - path: "src/main/dag-engine/task-controller-types.ts"
      provides: "Loop state, config, and result interfaces"
      exports: ["TaskControllerState", "TaskControllerConfig", "IterationResult", "LoopExitReason"]
    - path: "src/main/dag-engine/task-controller.ts"
      provides: "TaskController class with iteration loop"
      exports: ["TaskController", "createTaskController"]
  key_links:
    - from: "task-controller.ts"
      to: "task-plan-store.ts"
      via: "loadPlan/savePlan for iteration state"
      pattern: "getTaskPlanStore.*loadPlan"
    - from: "task-controller.ts"
      to: "verification-runner.ts"
      via: "runAllChecks after each iteration"
      pattern: "getVerificationRunner.*runAllChecks"
    - from: "task-controller.ts"
      to: "dev-agent.ts"
      via: "createDevAgent for fresh context"
      pattern: "createDevAgent"
---

<objective>
Implement TaskController class that manages the Ralph Loop iteration cycle for DevAgent task execution.

Purpose: Enable iterative task execution with fresh context windows and automated verification. Each iteration runs a DevAgent with focused context on failing items, followed by verification checks. Loop continues until all checks pass or max iterations reached.

Output: TaskController class with iteration loop, prompt building, and exit condition checking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v2.4-ROADMAP.md

Prior phase summaries (used directly by this plan):
@.planning/phases/56-task-plan-infrastructure/56-01-SUMMARY.md
@.planning/phases/57-verification-runner/57-01-SUMMARY.md

Source files this plan builds upon:
@src/main/agents/task-plan-types.ts
@src/main/agents/task-plan-store.ts
@src/main/agents/verification-runner.ts
@src/main/agents/verification-types.ts
@src/main/agents/dev-agent.ts
@src/main/agents/dev-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TaskController Type Definitions</name>
  <files>src/main/dag-engine/task-controller-types.ts</files>
  <action>
Create TypeScript interfaces for TaskController state and configuration:

1. **TaskControllerStatus** - Literal union: 'idle' | 'running' | 'paused' | 'completed' | 'failed' | 'aborted'

2. **LoopExitReason** - Literal union:
   - 'all_checks_passed' - All required checks pass
   - 'max_iterations_reached' - Hit maxIterations limit
   - 'aborted' - User or system abort
   - 'error' - Unrecoverable error occurred

3. **IterationResult** - Result of single iteration:
   - iteration: number (1-based)
   - devAgentSuccess: boolean
   - verificationResults: VerificationResult[] (from verification-types.ts)
   - duration: number (ms)
   - summary: string (what happened)
   - error?: string

4. **TaskControllerState** - Full controller state:
   - status: TaskControllerStatus
   - featureId: string
   - taskId: string
   - worktreePath: string | null
   - currentIteration: number
   - maxIterations: number
   - iterationResults: IterationResult[]
   - startedAt: string | null
   - completedAt: string | null
   - exitReason: LoopExitReason | null
   - error: string | null

5. **TaskControllerConfig** - Configuration:
   - maxIterations: number (default 10)
   - runBuild: boolean (default true)
   - runLint: boolean (default true)
   - runTests: boolean (default false)
   - continueOnLintFail: boolean (default true)
   - abortOnDevAgentFail: boolean (default false)

6. **DEFAULT_TASK_CONTROLLER_CONFIG** constant with sensible defaults

Import VerificationResult from verification-types.ts.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>task-controller-types.ts exports all interfaces and DEFAULT_TASK_CONTROLLER_CONFIG constant</done>
</task>

<task type="auto">
  <name>Task 2: TaskController Class Implementation</name>
  <files>src/main/dag-engine/task-controller.ts</files>
  <action>
Create TaskController class that manages the Ralph Loop iteration cycle:

**Constructor:**
- Takes featureId, taskId, config (partial, merged with defaults)
- Initializes state with status 'idle'

**Core Methods:**

1. **start(task: Task, graph: DAGGraph, claudeMd?: string, featureGoal?: string): Promise<void>**
   - Set status to 'running'
   - Create or load TaskPlan via TaskPlanStore
   - Set plan.status to 'running'
   - Enter iteration loop (call runIterationLoop)

2. **runIterationLoop(): Promise<void>** (private)
   - While not done:
     a. Check exit conditions (checkExitConditions)
     b. If should exit, break
     c. Build iteration prompt (buildIterationPrompt)
     d. Spawn fresh DevAgent (spawnDevAgent)
     e. Wait for DevAgent completion
     f. Run verification (runVerification)
     g. Update TaskPlan with results
     h. Increment iteration
     i. Log activity
   - Set final status and exitReason

3. **checkExitConditions(): LoopExitReason | null** (private)
   - Return 'all_checks_passed' if all required checklist items pass
   - Return 'max_iterations_reached' if iteration >= maxIterations
   - Return 'aborted' if status is 'aborted'
   - Return null to continue

4. **buildIterationPrompt(): string** (private)
   - Read TaskPlan checklist
   - Focus on failing items with their error messages
   - Include activity log summary from prior iterations
   - Return focused prompt for DevAgent

5. **spawnDevAgent(): Promise<TaskExecutionResult>** (private)
   - Create fresh DevAgent instance
   - Initialize with task, graph, claudeMd, featureGoal
   - Propose intention and wait for approval
   - Execute and return result
   - Note: DevAgent cleanup handled after each iteration

6. **runVerification(): Promise<VerificationResult[]>** (private)
   - Get VerificationRunner for worktree
   - Run all checks with config options
   - Update TaskPlan checklist items with results
   - Return results

7. **updatePlanFromResults(devResult: TaskExecutionResult, verifyResults: VerificationResult[]): Promise<void>** (private)
   - Update 'implement' checklist item based on devResult.success
   - Update build/lint/test items based on verifyResults
   - Save plan via TaskPlanStore

8. **abort(): void**
   - Set status to 'aborted'
   - Abort current DevAgent if running
   - Update TaskPlan status to 'aborted'

9. **getState(): TaskControllerState**
   - Return copy of current state

10. **pause() / resume()** (optional, for future use)
    - Set status to 'paused' / 'running'

**Events (EventEmitter):**
- 'iteration:start' - Before each iteration
- 'iteration:complete' - After each iteration with IterationResult
- 'loop:complete' - When loop exits with final state
- 'verification:start' / 'verification:complete'

**Factory Function:**
- createTaskController(featureId, taskId, config?) â†’ TaskController

**Key Integration Points:**
- Use getTaskPlanStore() from task-plan-store.ts
- Use getVerificationRunner() from verification-runner.ts
- Use createDevAgent() from dev-agent.ts
- Do NOT modify DevAgent - TaskController wraps it

**Important: Fresh Context Per Iteration**
Each iteration creates a NEW DevAgent instance. This is the core of Ralph Loop - no context bloat because each agent starts fresh, reading the TaskPlan to understand what's failing.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>task-controller.ts exports TaskController class and createTaskController factory</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run typecheck passes
- [ ] task-controller-types.ts exports: TaskControllerStatus, TaskControllerState, TaskControllerConfig, LoopExitReason, IterationResult, DEFAULT_TASK_CONTROLLER_CONFIG
- [ ] task-controller.ts exports: TaskController, createTaskController
- [ ] TaskController imports from task-plan-store, verification-runner, dev-agent
- [ ] No circular imports (verified by typecheck)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- TaskController can spawn fresh DevAgents per iteration
- TaskController integrates TaskPlanStore for state persistence
- TaskController integrates VerificationRunner for automated checks
</success_criteria>

<output>
After completion, create `.planning/phases/58-task-controller/58-01-SUMMARY.md`
</output>
