---
phase: 41-request-manager
plan: 02
type: execute
---

<objective>
Integrate RequestManager with AgentService so all SDK requests go through the priority queue.

Purpose: Route all agent queries through RequestManager to enforce concurrency limits and priority ordering.
Output: AgentService.streamQuery() uses RequestManager.enqueue() for all SDK calls.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v2.0-ROADMAP.md

**Prior plan in this phase:**
@.planning/phases/41-request-manager/41-01-SUMMARY.md

**Key source files:**
@src/main/agent/types.ts
@src/main/agent/agent-service.ts
@src/main/agent/request-types.ts
@src/main/agent/request-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add priority option to AgentQueryOptions</name>
  <files>src/main/agent/types.ts</files>
  <action>
Update AgentQueryOptions interface to include priority information:

1. Import RequestPriority from './request-types'

2. Add to AgentQueryOptions:
   - priority?: RequestPriority (optional - defaults to DEV if not specified)
   - agentId?: string (e.g., 'pm', 'dev-task1', 'qa-task2' - defaults to agentType if not specified)

These allow callers to specify request priority explicitly. The priority will be used by RequestManager to order requests in the queue.
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit</verify>
  <done>AgentQueryOptions has priority and agentId optional fields</done>
</task>

<task type="auto">
  <name>Task 2: Integrate RequestManager into AgentService</name>
  <files>src/main/agent/agent-service.ts</files>
  <action>
Modify AgentService.streamQuery() to use RequestManager:

1. Import at top:
   - import { getRequestManager } from './request-manager'
   - import { RequestPriority } from './request-types'

2. In streamQuery() method:
   - Determine priority from options:
     - If options.priority specified: use it directly
     - Else if options.agentType === 'pm': RequestPriority.PM
     - Else if options.agentType === 'harness': RequestPriority.HARNESS_DEV (default, specific routing handled later)
     - Else if options.agentType === 'merge': RequestPriority.MERGE
     - Else: RequestPriority.DEV (default for task agents)

   - Determine agentId from options:
     - If options.agentId specified: use it
     - Else if options.taskId: `${options.agentType}-${options.taskId}`
     - Else: options.agentType || 'unknown'

3. Refactor the SDK call into a factory function that returns AsyncIterable<AgentStreamEvent>:
   - Move SDK query creation logic into a function `createSDKQuery(): AsyncIterable<AgentStreamEvent>`
   - This function contains the existing sdk.query() call setup

4. Use RequestManager.enqueue():
   ```typescript
   const requestManager = getRequestManager()
   const stream = await requestManager.enqueue(
     priority,
     agentId,
     () => this.executeSDKQuery(options), // factory that creates SDK query
     options.taskId
   )

   for await (const event of stream) {
     yield event
   }
   ```

5. Create private helper `executeSDKQuery(options: AgentQueryOptions)`:
   - Move existing SDK query logic here
   - This is called by RequestManager when the request gets a slot
   - Returns the async iterable from sdk.query()

Note: The actual SDK call happens inside executeSDKQuery(), which is only called when RequestManager gives it a slot.
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit</verify>
  <done>AgentService.streamQuery() routes through RequestManager.enqueue()</done>
</task>

<task type="auto">
  <name>Task 3: Update existing agent callers with priority</name>
  <files>
    src/main/agents/harness-agent.ts,
    src/main/agents/task-agent.ts,
    src/main/agents/merge-agent.ts
  </files>
  <action>
Update agent implementations to pass appropriate priority:

1. **HarnessAgent** (src/main/agents/harness-agent.ts):
   - When calling agentService.streamQuery(), add:
     - agentType: 'harness'
     - priority: Will be set based on who harness is responding to (handled in Phase 45)
     - For now, use RequestPriority.HARNESS_DEV as default

2. **TaskAgent** (src/main/agents/task-agent.ts):
   - When calling agentService.streamQuery(), add:
     - agentType: 'task' (already present if using autoContext)
     - agentId: `dev-${taskId}` (so logs show 'dev-task1' etc.)
     - priority: RequestPriority.DEV

3. **MergeAgent** (src/main/agents/merge-agent.ts):
   - When calling agentService.streamQuery(), add:
     - agentType: 'merge' (already present if using autoContext)
     - agentId: `merge-${taskId}`
     - priority: RequestPriority.MERGE

Import RequestPriority from '../agent/request-types' in each file.

Note: PM Agent priority is already handled by agentType detection in AgentService.
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit</verify>
  <done>All agent types pass appropriate priority to AgentService</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes without errors
- [ ] AgentQueryOptions includes priority and agentId fields
- [ ] AgentService.streamQuery() calls RequestManager.enqueue()
- [ ] HarnessAgent, TaskAgent, MergeAgent pass appropriate priority
- [ ] PM Agent requests automatically get PM priority via agentType detection
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- All SDK requests route through RequestManager
- Priority is correctly assigned based on agent type
- Phase 41 complete - Request Manager Infrastructure operational
</success_criteria>

<output>
After completion, create `.planning/phases/41-request-manager/41-02-SUMMARY.md`:

# Phase 41 Plan 02: AgentService Integration Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/main/agent/types.ts` - Description
- `src/main/agent/agent-service.ts` - Description
- `src/main/agents/harness-agent.ts` - Description
- `src/main/agents/task-agent.ts` - Description
- `src/main/agents/merge-agent.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 41 complete, ready for Phase 42 (Task State Machine Refactor)
</output>
