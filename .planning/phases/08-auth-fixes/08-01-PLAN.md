---
phase: 08-auth-fixes
plan: 01
type: execute
---

<objective>
Initialize authentication on app startup in both main and renderer processes.

Purpose: Auth currently never runs - main process doesn't auto-init AuthManager, and App.tsx doesn't call useAuthStore.initialize(). Users see no auth status and can't use Claude API.
Output: Auth automatically initializes on app start, credentials are checked, and state flows to renderer.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-integration/07-01-SUMMARY.md

**Key files:**
@src/main/index.ts
@src/main/auth/auth-manager.ts
@src/renderer/src/App.tsx
@src/renderer/src/stores/auth-store.ts

**Issues being addressed:**
- App.tsx doesn't call `useAuthStore.initialize()` on startup
- Main process doesn't auto-init AuthManager
- setCredentials error handler doesn't update error state in auth-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize AuthManager in main process on startup</name>
  <files>src/main/index.ts</files>
  <action>
Import getAuthManager from './auth' and call initialize() after registerIpcHandlers(). Log the auth state result to console for debugging. The auth manager singleton already exists - just need to trigger initialization.

```typescript
import { getAuthManager } from './auth'

// After registerIpcHandlers()
const auth = getAuthManager()
auth.initialize().then((state) => {
  console.log('[DAGent] Auth initialized:', state.authenticated ? 'authenticated' : 'not authenticated')
})
```

Do NOT block app startup on auth - use .then() not await.
  </action>
  <verify>npm run typecheck passes, console shows auth init message on app start</verify>
  <done>Main process initializes auth on startup, logs result to console</done>
</task>

<task type="auto">
  <name>Task 2: Initialize auth store in App.tsx on mount</name>
  <files>src/renderer/src/App.tsx</files>
  <action>
Import useAuthStore and call initialize() in the existing useEffect. This triggers the renderer to fetch auth state from main process via IPC.

```typescript
import { useFeatureStore, useViewStore, useAuthStore, type ViewType } from './stores'

// In App component:
const { initialize: initAuth } = useAuthStore()

useEffect(() => {
  loadFeatures()
  initAuth()  // Add this - initializes auth on mount
}, [loadFeatures, initAuth])
```

This ensures auth state is loaded when the app mounts, enabling UI to show status.
  </action>
  <verify>npm run typecheck passes, app initializes auth on start (check Network/IPC tab)</verify>
  <done>App.tsx calls initAuth() on mount, auth state flows to renderer</done>
</task>

<task type="auto">
  <name>Task 3: Fix auth-store error handling in setCredentials</name>
  <files>src/renderer/src/stores/auth-store.ts</files>
  <action>
The setCredentials catch block doesn't update error state. Fix it to set the error in state.

Change lines 44-46 from:
```typescript
} catch (error) {
  set({ isLoading: false });
}
```

To:
```typescript
} catch (error) {
  set({
    state: {
      authenticated: false,
      credentials: null,
      error: String(error)
    },
    isLoading: false
  });
}
```

Also fix clearCredentials to set isLoading properly (wrap in try/catch with loading state).
  </action>
  <verify>npm run typecheck passes</verify>
  <done>setCredentials and clearCredentials properly handle errors and loading state</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` succeeds
- [ ] App startup logs "[DAGent] Auth initialized: ..." message in terminal
- [ ] Opening app triggers IPC call to auth:initialize (check console)
- [ ] Auth store has isLoading=false and valid state after init
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Auth initializes automatically on app startup in both processes
</success_criteria>

<output>
After completion, create `.planning/phases/08-auth-fixes/08-01-SUMMARY.md`
</output>
