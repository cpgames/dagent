---
phase: 08-auth-fixes
plan: 02
type: execute
---

<objective>
Fix credential detection - Windows paths and Claude CLI detection stub.

Purpose: Windows path for Claude CLI config is identical to Unix (bug). Claude CLI detection always returns null (stub). These prevent automatic credential discovery.
Output: Proper Windows path detection, functional Claude CLI credential reading.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-auth-fixes/08-01-PLAN.md

**Key files:**
@src/main/auth/paths.ts
@src/main/auth/auth-manager.ts

**Issues being addressed:**
- Windows path for Claude CLI config is identical to Unix path (both return ~/.config/claude)
- Claude CLI detection always returns null (stub implementation)

**Research notes:**
Claude Code stores credentials in:
- Unix/macOS: ~/.config/claude/ (specifically ~/.claude.json or ~/.config/claude/credentials.json)
- Windows: %APPDATA%\Claude\ or %LOCALAPPDATA%\Claude\ (typically AppData\Roaming\Claude)

The credentials file format varies by Claude Code version but typically contains OAuth tokens.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Windows path in getClaudeCliConfigPath</name>
  <files>src/main/auth/paths.ts</files>
  <action>
Fix the Windows path to use AppData instead of .config. Also add a function to get the Claude credentials file path.

Replace the entire file with:

```typescript
import { homedir } from 'os';
import { join } from 'path';

/**
 * Get Claude Code config directory path (cross-platform).
 * - Windows: %APPDATA%\Claude or %LOCALAPPDATA%\Claude
 * - Unix/macOS: ~/.config/claude
 */
export function getClaudeCliConfigPath(): string {
  const home = homedir();
  if (process.platform === 'win32') {
    // Windows: prefer APPDATA (Roaming), fallback to LOCALAPPDATA
    const appData = process.env.APPDATA || join(home, 'AppData', 'Roaming');
    return join(appData, 'Claude');
  }
  // Unix/macOS
  return join(home, '.config', 'claude');
}

/**
 * Get possible Claude Code credential file paths.
 * Claude Code may store credentials in different locations depending on version.
 */
export function getClaudeCredentialPaths(): string[] {
  const configDir = getClaudeCliConfigPath();
  const home = homedir();

  return [
    join(configDir, 'credentials.json'),
    join(configDir, 'settings.json'),
    join(home, '.claude.json'),
    join(home, '.claude', 'credentials.json')
  ];
}

/**
 * Get DAGent credentials storage path.
 */
export function getDagentCredentialsPath(): string {
  return join(homedir(), '.dagent', 'credentials.json');
}
```

This provides proper Windows path and multiple fallback locations for Claude Code credentials.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Windows uses AppData path, multiple credential file locations supported</done>
</task>

<task type="auto">
  <name>Task 2: Implement Claude CLI credential detection</name>
  <files>src/main/auth/auth-manager.ts</files>
  <action>
Replace the stub checkClaudeCli method with actual credential file reading. Import getClaudeCredentialPaths and check each location for OAuth tokens.

Add import at top:
```typescript
import { getClaudeCredentialPaths, getDagentCredentialsPath } from './paths';
```

Replace checkClaudeCli method (lines 44-53):
```typescript
// Priority 1: Claude CLI auto-detect
private async checkClaudeCli(): Promise<AuthCredentials | null> {
  const paths = getClaudeCredentialPaths();

  for (const credPath of paths) {
    try {
      if (!existsSync(credPath)) continue;

      const content = readFileSync(credPath, 'utf-8');
      const data = JSON.parse(content);

      // Check for OAuth token in various formats Claude Code uses
      const token = data.oauth_token || data.oauthToken || data.token ||
                    data.credentials?.oauth_token || data.credentials?.token;

      if (token && typeof token === 'string') {
        return {
          type: 'claude_cli',
          value: token,
          source: `Claude Code credentials (${credPath})`
        };
      }

      // Check for API key format
      const apiKey = data.api_key || data.apiKey || data.key ||
                     data.credentials?.api_key || data.credentials?.apiKey;

      if (apiKey && typeof apiKey === 'string' && apiKey.startsWith('sk-')) {
        return {
          type: 'claude_cli',
          value: apiKey,
          source: `Claude Code credentials (${credPath})`
        };
      }
    } catch {
      // File doesn't exist or isn't valid JSON - try next
      continue;
    }
  }

  return null;
}
```

Also update the import statement to include getClaudeCredentialPaths (remove getClaudeCliConfigPath if no longer used).
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Claude CLI detection reads actual credential files, supports multiple formats and locations</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` succeeds
- [ ] Windows path returns AppData\Roaming\Claude (not .config/claude)
- [ ] getClaudeCredentialPaths() returns array of 4 paths
- [ ] checkClaudeCli() checks all paths and parses JSON for tokens
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Windows users can auto-detect Claude Code credentials
- Multiple Claude Code credential formats supported
</success_criteria>

<output>
After completion, create `.planning/phases/08-auth-fixes/08-02-SUMMARY.md`
</output>
