---
phase: v3.0-05-dev-agent-integration
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/main/services/migration/dev-session-migration.ts
  - src/main/ipc/session-handlers.ts
  - src/preload/index.d.ts
  - src/preload/index.ts
autonomous: true
must_haves:
  truths:
    - "Migration script can convert old session.json to new format"
    - "IPC handlers exposed for dev session migration"
    - "Backup created before migration"
  artifacts:
    - path: "src/main/services/migration/dev-session-migration.ts"
      provides: "Dev session migration logic"
      exports: ["migrateDevSession", "needsDevSessionMigration"]
    - path: "src/main/ipc/session-handlers.ts"
      provides: "IPC handlers for migration"
      contains: "session:migrateDevSession"
  key_links:
    - from: "dev-session-migration.ts"
      to: "session-manager.ts"
      via: "creates session and imports messages"
      pattern: "getSessionManager"
---

<objective>
Create migration script to convert existing dev session.json files to new SessionManager format.

Purpose: Enable seamless upgrade for existing projects with task sessions.
Output: Migration service with IPC handlers for migrating dev sessions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v3.0-session-checkpoint-ROADMAP.md
@.planning/phases/v3.0-05-dev-agent-integration/05-01-SUMMARY.md

@src/main/services/migration/chat-to-session.ts
@src/main/services/session-manager.ts
@src/main/ipc/session-handlers.ts
@src/shared/types/session.ts
@src/shared/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dev session migration service</name>
  <files>src/main/services/migration/dev-session-migration.ts</files>
  <action>
    Create migration service following the pattern from chat-to-session.ts:

    ```typescript
    /**
     * Dev Session Migration Service
     *
     * Migrates old nodes/{taskId}/session.json files to new SessionManager format.
     * Old format: TaskAgentSession with messages array
     * New format: SessionManager session with chat_*.json, checkpoint_*.json, etc.
     */

    import * as fs from 'fs/promises'
    import * as path from 'path'
    import { getSessionManager } from '../session-manager'
    import type { TaskAgentSession, DevAgentMessage } from '../../../shared/types'

    export interface DevMigrationResult {
      success: boolean
      sessionId?: string
      messagesImported?: number
      backupPath?: string
      error?: string
    }

    /**
     * Check if a task needs dev session migration.
     */
    export async function needsDevSessionMigration(
      projectRoot: string,
      featureId: string,
      taskId: string
    ): Promise<boolean> {
      // Check if old session.json exists
      const oldSessionPath = path.join(
        projectRoot,
        '.dagent-worktrees',
        featureId,
        '.dagent',
        'nodes',
        taskId,
        'session.json'
      )

      try {
        await fs.access(oldSessionPath)
        const data = await fs.readFile(oldSessionPath, 'utf-8')
        const oldSession: TaskAgentSession = JSON.parse(data)

        // Check if it has messages to migrate
        if (!oldSession.messages || oldSession.messages.length === 0) {
          return false
        }

        // Check if new session already exists with messages
        const sessionManager = getSessionManager(projectRoot)
        const session = await sessionManager.getOrCreateSession({
          type: 'task',
          agentType: 'dev',
          featureId,
          taskId,
          taskState: 'in_dev'
        })

        const messages = await sessionManager.getAllMessages(session.id, featureId)
        return messages.length === 0  // Only migrate if new session is empty
      } catch {
        return false
      }
    }

    /**
     * Migrate a single task's dev session.
     */
    export async function migrateDevSession(
      projectRoot: string,
      featureId: string,
      taskId: string
    ): Promise<DevMigrationResult> {
      const oldSessionPath = path.join(
        projectRoot,
        '.dagent-worktrees',
        featureId,
        '.dagent',
        'nodes',
        taskId,
        'session.json'
      )

      try {
        // Read old session
        const data = await fs.readFile(oldSessionPath, 'utf-8')
        const oldSession: TaskAgentSession = JSON.parse(data)

        if (!oldSession.messages || oldSession.messages.length === 0) {
          return {
            success: true,
            messagesImported: 0
          }
        }

        // Create backup
        const backupPath = oldSessionPath + '.backup'
        await fs.copyFile(oldSessionPath, backupPath)

        // Get or create new session
        const sessionManager = getSessionManager(projectRoot)
        const session = await sessionManager.getOrCreateSession({
          type: 'task',
          agentType: 'dev',
          featureId,
          taskId,
          taskState: 'in_dev'
        })

        // Import messages
        for (const msg of oldSession.messages) {
          await sessionManager.addMessage(session.id, featureId, {
            role: msg.direction === 'task_to_harness' ? 'assistant' : 'user',
            content: msg.content,
            metadata: {
              migratedFrom: 'session.json',
              originalTimestamp: msg.timestamp,
              originalType: msg.type,
              internal: true
            }
          })
        }

        return {
          success: true,
          sessionId: session.id,
          messagesImported: oldSession.messages.length,
          backupPath
        }
      } catch (error) {
        return {
          success: false,
          error: (error as Error).message
        }
      }
    }

    /**
     * Migrate all dev sessions for a feature.
     */
    export async function migrateAllDevSessions(
      projectRoot: string,
      featureId: string
    ): Promise<{ results: Map<string, DevMigrationResult>; totalMigrated: number }> {
      const results = new Map<string, DevMigrationResult>()
      let totalMigrated = 0

      const nodesDir = path.join(
        projectRoot,
        '.dagent-worktrees',
        featureId,
        '.dagent',
        'nodes'
      )

      try {
        const taskDirs = await fs.readdir(nodesDir)

        for (const taskId of taskDirs) {
          const needsMigration = await needsDevSessionMigration(projectRoot, featureId, taskId)
          if (needsMigration) {
            const result = await migrateDevSession(projectRoot, featureId, taskId)
            results.set(taskId, result)
            if (result.success && result.messagesImported && result.messagesImported > 0) {
              totalMigrated++
            }
          }
        }
      } catch {
        // nodes dir may not exist, that's OK
      }

      return { results, totalMigrated }
    }
    ```

    Export types and functions from the service.
  </action>
  <verify>npm run build succeeds, migration service created</verify>
  <done>Dev session migration service implemented</done>
</task>

<task type="auto">
  <name>Task 2: Add IPC handlers for dev migration</name>
  <files>src/main/ipc/session-handlers.ts, src/preload/index.d.ts, src/preload/index.ts</files>
  <action>
    1. Add IPC handlers in session-handlers.ts:
       ```typescript
       import {
         migrateDevSession,
         migrateAllDevSessions,
         needsDevSessionMigration
       } from '../services/migration/dev-session-migration'

       // Add handlers in registerSessionHandlers():
       ipcMain.handle('session:migrateDevSession', async (_event, projectRoot: string, featureId: string, taskId: string) => {
         return await migrateDevSession(projectRoot, featureId, taskId)
       })

       ipcMain.handle('session:migrateAllDevSessions', async (_event, projectRoot: string, featureId: string) => {
         const { results, totalMigrated } = await migrateAllDevSessions(projectRoot, featureId)
         return {
           results: Object.fromEntries(results),
           totalMigrated
         }
       })

       ipcMain.handle('session:needsDevSessionMigration', async (_event, projectRoot: string, featureId: string, taskId: string) => {
         return await needsDevSessionMigration(projectRoot, featureId, taskId)
       })
       ```

    2. Add type definitions in preload/index.d.ts (in SessionAPI interface):
       ```typescript
       migrateDevSession(projectRoot: string, featureId: string, taskId: string): Promise<{
         success: boolean
         sessionId?: string
         messagesImported?: number
         backupPath?: string
         error?: string
       }>
       migrateAllDevSessions(projectRoot: string, featureId: string): Promise<{
         results: Record<string, {
           success: boolean
           sessionId?: string
           messagesImported?: number
           error?: string
         }>
         totalMigrated: number
       }>
       needsDevSessionMigration(projectRoot: string, featureId: string, taskId: string): Promise<boolean>
       ```

    3. Add implementations in preload/index.ts (in session object):
       ```typescript
       migrateDevSession: (projectRoot: string, featureId: string, taskId: string) =>
         ipcRenderer.invoke('session:migrateDevSession', projectRoot, featureId, taskId),
       migrateAllDevSessions: (projectRoot: string, featureId: string) =>
         ipcRenderer.invoke('session:migrateAllDevSessions', projectRoot, featureId),
       needsDevSessionMigration: (projectRoot: string, featureId: string, taskId: string) =>
         ipcRenderer.invoke('session:needsDevSessionMigration', projectRoot, featureId, taskId),
       ```
  </action>
  <verify>npm run build succeeds, IPC handlers registered</verify>
  <done>IPC handlers for dev session migration added</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] dev-session-migration.ts created with migrateDevSession, migrateAllDevSessions, needsDevSessionMigration
- [ ] IPC handlers registered: session:migrateDevSession, session:migrateAllDevSessions, session:needsDevSessionMigration
- [ ] Preload API exposes dev migration methods
- [ ] Migration creates backup before modifying
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Dev session migration can convert old session.json to new format
</success_criteria>

<output>
After completion, create `.planning/phases/v3.0-05-dev-agent-integration/05-03-SUMMARY.md`
</output>
