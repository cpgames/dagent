---
phase: 24-universal-context-access
plan: 01
type: execute
---

<objective>
Create a ContextService that assembles comprehensive project and codebase context for all agent queries.

Purpose: Enable all agents (PM, Harness, Task, Merge) to have automatic access to project structure, CLAUDE.md content, recent git history, and current feature/task context for intelligent decision-making.
Output: ContextService class with methods to assemble context, integrated into agent system prompts.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-feature-deletion/23-01-SUMMARY.md

**Key files:**
@src/main/chat/context-builder.ts - Current basic context (feature/task only)
@src/main/agent/agent-service.ts - AgentService with systemPrompt option
@src/main/ipc/chat-handlers.ts - chat:getContext handler using buildSystemPrompt
@src/main/storage/feature-store.ts - Feature and DAG loading
@src/main/git/git-manager.ts - Git operations, can get log/history
@src/renderer/src/stores/chat-store.ts - Where agent queries are built

**Tech stack:** TypeScript, Node fs/path, simple-git
**Established patterns:**
- Services as singletons with getXService() factory
- Context building returns structured data + formatted prompt string
- IPC handlers for cross-process data flow

**Constraining decisions:**
- Phase 13-03: Context builder pattern established
- Phase 16-01: AgentService accepts systemPrompt
- Use projectRoot from storage initialization for file operations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContextService with project structure discovery</name>
  <files>src/main/context/context-service.ts (new), src/main/context/index.ts (new)</files>
  <action>
Create a new ContextService class that gathers comprehensive project context.

1. Create `src/main/context/context-service.ts`:
   - Class `ContextService` with constructor taking projectRoot: string
   - Method `getProjectStructure()`: Return key directories and file patterns
     - Read directory at projectRoot, identify: src/, tests/, docs/, package.json, README.md
     - Return summary: { srcDirs: string[], configFiles: string[], hasTests: boolean }
   - Method `getClaudeMd()`: Read CLAUDE.md from projectRoot if exists, return content or null
   - Method `getProjectMd()`: Read PROJECT.md from projectRoot if exists, return content or null
   - Method `getRecentGitHistory(limit: number = 10)`: Use simple-git to get recent commits
     - Return array of { hash, message, author, date } (last 10 commits)
   - Method `buildProjectContext()`: Combine all above into a ProjectContext object:
     ```typescript
     interface ProjectContext {
       structure: ProjectStructure
       claudeMd: string | null
       projectMd: string | null
       recentCommits: GitCommit[]
     }
     ```

2. Create `src/main/context/index.ts` exporting ContextService and types.

Use async/await, handle file not found gracefully (return null/empty). Import simpleGit from 'simple-git'.
  </action>
  <verify>TypeScript compiles: `npm run typecheck`</verify>
  <done>ContextService class with getProjectStructure, getClaudeMd, getProjectMd, getRecentGitHistory, buildProjectContext methods</done>
</task>

<task type="auto">
  <name>Task 2: Add feature and DAG context to ContextService</name>
  <files>src/main/context/context-service.ts</files>
  <action>
Extend ContextService with feature-aware context methods:

1. Add method `getFeatureContext(featureId: string)`:
   - Use getFeatureStore() to load feature and DAG
   - Return existing buildFeatureContext() output
   - Include task count, status breakdown, dependency graph summary

2. Add method `getTaskContext(taskId: string, featureId: string)`:
   - Load specific task from DAG
   - Include task details, dependencies (upstream tasks), dependents (downstream tasks)
   - Include related file paths if task has filePaths field

3. Add method `buildFullContext(options: ContextOptions)`:
   ```typescript
   interface ContextOptions {
     featureId?: string
     taskId?: string
     includeGitHistory?: boolean  // default true
     includeClaudeMd?: boolean    // default true
     maxCommits?: number          // default 10
   }
   ```
   - Assembles ProjectContext + FeatureContext + TaskContext based on options
   - Returns combined FullContext object

Import buildFeatureContext from '../chat/context-builder'. Import getFeatureStore from './storage-handlers' - but wait, that's in ipc, so instead access storage directly or make featureStore a parameter.

Actually, pass featureStore instance to methods that need it to avoid circular dependencies.
  </action>
  <verify>TypeScript compiles: `npm run typecheck`</verify>
  <done>ContextService has getFeatureContext, getTaskContext, buildFullContext methods</done>
</task>

<task type="auto">
  <name>Task 3: Create context formatting for agent prompts</name>
  <files>src/main/context/context-service.ts</files>
  <action>
Add prompt formatting methods to ContextService:

1. Add method `formatContextAsPrompt(context: FullContext): string`:
   - Build a structured system prompt section from the context
   - Format like:
     ```
     ## Project Context

     **Project Structure:**
     - Source directories: src/main, src/renderer, src/shared
     - Config files: package.json, tsconfig.json, electron-builder.yml
     - Has tests: Yes

     **CLAUDE.md Guidelines:**
     [Content of CLAUDE.md if exists, or "No CLAUDE.md found"]

     **Recent Git Activity:**
     - abc1234: Fix authentication bug (2 days ago)
     - def5678: Add feature deletion (1 day ago)
     ...

     ## Current Feature
     **Name:** User Authentication
     **Tasks:** 5 total (2 ready, 1 in_progress, 2 blocked)
     ...

     ## Current Task (if taskId provided)
     **Title:** Implement login form
     **Dependencies:** Setup database schema (completed)
     **Dependents:** Add session management (blocked)
     ```

2. Keep existing buildSystemPrompt() in context-builder.ts for backward compatibility, but ContextService.formatContextAsPrompt() provides the enhanced version.
  </action>
  <verify>TypeScript compiles: `npm run typecheck`</verify>
  <done>formatContextAsPrompt method produces structured prompt text from FullContext</done>
</task>

<task type="auto">
  <name>Task 4: Create IPC handler for context service</name>
  <files>src/main/ipc/context-handlers.ts (new), src/main/ipc/handlers.ts, src/preload/index.ts, src/preload/index.d.ts</files>
  <action>
1. Create `src/main/ipc/context-handlers.ts`:
   - Import ContextService from '../context'
   - Create singleton: let contextService: ContextService | null = null
   - Add `initContextService(projectRoot: string)` function
   - Handler `context:getProjectContext` → contextService.buildProjectContext()
   - Handler `context:getFullContext` → contextService.buildFullContext(options)
   - Handler `context:getFormattedPrompt` → contextService.formatContextAsPrompt(context)

2. Register handlers in `handlers.ts`:
   - Import registerContextHandlers from './context-handlers'
   - Call registerContextHandlers() in registerAllHandlers()

3. Update `preload/index.ts`:
   - Add context API namespace:
     ```
     context: {
       getProjectContext: () => ipcRenderer.invoke('context:getProjectContext'),
       getFullContext: (options) => ipcRenderer.invoke('context:getFullContext', options),
       getFormattedPrompt: (context) => ipcRenderer.invoke('context:getFormattedPrompt', context)
     }
     ```

4. Update `preload/index.d.ts` with types:
   ```typescript
   export interface ContextAPI {
     getProjectContext: () => Promise<ProjectContext>
     getFullContext: (options: ContextOptions) => Promise<FullContext>
     getFormattedPrompt: (context: FullContext) => Promise<string>
   }
   ```
  </action>
  <verify>npm run build succeeds</verify>
  <done>Context IPC handlers registered, preload exposes context API</done>
</task>

<task type="auto">
  <name>Task 5: Wire context initialization to project loading</name>
  <files>src/main/ipc/project-handlers.ts, src/main/ipc/context-handlers.ts</files>
  <action>
Initialize ContextService when a project is opened:

1. In `context-handlers.ts`, export `initContextService(projectRoot: string)` function

2. In `project-handlers.ts`:
   - Import { initContextService } from './context-handlers'
   - In the `project:open` handler, after storage is initialized:
     - Call initContextService(projectPath)
   - This ensures context service has correct projectRoot for all operations

3. Also call initContextService in `project:create` handler after project creation.
  </action>
  <verify>npm run build succeeds</verify>
  <done>ContextService initialized when project is opened/created</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] ContextService can read project structure from projectRoot
- [ ] ContextService reads CLAUDE.md and PROJECT.md if they exist
- [ ] ContextService retrieves recent git commits
- [ ] Full context includes feature and task information
- [ ] Formatted prompt output is well-structured markdown
- [ ] Context IPC handlers are accessible from renderer
- [ ] Context service is initialized when project is opened
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- ContextService provides comprehensive project/codebase context
- Context can be formatted as structured system prompt
- IPC bridge allows renderer access to context
- Ready for Plan 24-02 to integrate context into all agent presets
</success_criteria>

<output>
After completion, create `.planning/phases/24-universal-context-access/24-01-SUMMARY.md` with:
- Phase 24 Plan 01 summary
- Accomplishments (ContextService, methods, IPC, preload)
- Files created/modified
- Decisions made (context structure, formatting approach)
- Issues encountered
- Next Plan Readiness (24-02: Integrate into agent prompts)
</output>
