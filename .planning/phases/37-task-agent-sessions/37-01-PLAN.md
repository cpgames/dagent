# Plan: 37-01 Task Agent Session Types and Storage

## Context

Phase 37 introduces per-task log files for conversation history between task agents and harness. Currently, all agent communication goes to a single `harness_log.json` per feature. This plan adds task-specific session types and storage methods.

### Current State
- `src/main/storage/paths.ts` already has `getNodeLogsPath()` for per-task logs
- `src/main/storage/feature-store.ts` has `saveNodeLogs()`/`loadNodeLogs()` methods
- `src/shared/types/log.ts` defines `LogEntry` and `AgentLog` types
- Task agents emit events but don't persist conversation history

### Goal
Define TaskAgentSession type and add storage methods for per-task session persistence.

## Tasks

### Task 1: Define TaskAgentSession Type
**File:** `src/shared/types/log.ts`

Add types for task agent sessions:

```typescript
// After existing AgentLog interface

export interface TaskAgentMessage {
  timestamp: string;
  direction: 'task_to_harness' | 'harness_to_task';
  type: 'intention' | 'approval' | 'rejection' | 'progress' | 'completion' | 'error';
  content: string;
  metadata?: {
    toolName?: string;
    toolInput?: unknown;
    toolResult?: unknown;
  };
}

export interface TaskAgentSession {
  taskId: string;
  agentId: string;
  status: 'active' | 'completed' | 'failed' | 'paused';
  startedAt: string;
  completedAt?: string;
  messages: TaskAgentMessage[];
}
```

**Checkpoint:** TypeScript compiles with new types

### Task 2: Add Session Storage Methods
**File:** `src/main/storage/feature-store.ts`

Add methods for task session persistence:

```typescript
// Add import for TaskAgentSession
import type { Feature, DAGGraph, ChatHistory, AgentLog, TaskAgentSession } from '@shared/types';

// Add after loadNodeLogs method

/**
 * Save task agent session.
 */
async saveTaskSession(featureId: string, taskId: string, session: TaskAgentSession): Promise<void> {
  const filePath = paths.getTaskSessionPath(this.projectRoot, featureId, taskId);
  await writeJson(filePath, session);
}

/**
 * Load task agent session.
 * @returns Session, or null if not found.
 */
async loadTaskSession(featureId: string, taskId: string): Promise<TaskAgentSession | null> {
  const filePath = paths.getTaskSessionPath(this.projectRoot, featureId, taskId);
  return readJson<TaskAgentSession>(filePath);
}

/**
 * Append a message to an existing task session.
 * Creates session if it doesn't exist.
 */
async appendSessionMessage(
  featureId: string,
  taskId: string,
  message: TaskAgentMessage,
  sessionDefaults?: Partial<TaskAgentSession>
): Promise<void> {
  let session = await this.loadTaskSession(featureId, taskId);
  if (!session) {
    session = {
      taskId,
      agentId: sessionDefaults?.agentId || 'unknown',
      status: 'active',
      startedAt: new Date().toISOString(),
      messages: [],
      ...sessionDefaults
    };
  }
  session.messages.push(message);
  await this.saveTaskSession(featureId, taskId, session);
}
```

**Checkpoint:** Methods added, TypeScript compiles

### Task 3: Add Session Path Helper
**File:** `src/main/storage/paths.ts`

Add path helper for task sessions:

```typescript
// Add after getNodeLogsPath

/**
 * Get the path to session.json for a specific task.
 * Location: {projectRoot}/.dagent-worktrees/{featureId}/.dagent/nodes/{taskId}/session.json
 */
export function getTaskSessionPath(projectRoot: string, featureId: string, taskId: string): string {
  return path.join(getNodeDir(projectRoot, featureId, taskId), 'session.json');
}
```

**Checkpoint:** Path function works correctly

### Task 4: Export New Types
**File:** `src/shared/types/index.ts`

Ensure new types are exported:

```typescript
// Verify log.ts exports include:
export type { LogEntry, LogEntryType, AgentType, AgentLog, TaskAgentMessage, TaskAgentSession } from './log';
```

**Checkpoint:** Types accessible from @shared/types

## Verification

```bash
# 1. TypeScript compilation
npm run typecheck

# 2. Check exports work
# In any test file, verify:
# import { TaskAgentSession, TaskAgentMessage } from '@shared/types'

# 3. Manual test (optional)
# Run app, check that feature-store methods don't break existing functionality
```

## Files Modified

1. `src/shared/types/log.ts` - Add TaskAgentSession and TaskAgentMessage types
2. `src/main/storage/paths.ts` - Add getTaskSessionPath()
3. `src/main/storage/feature-store.ts` - Add session storage methods
4. `src/shared/types/index.ts` - Export new types

## Summary

This plan adds the foundational types and storage layer for task agent sessions. The next plan (37-02) will integrate these into TaskAgent class for session lifecycle management.
