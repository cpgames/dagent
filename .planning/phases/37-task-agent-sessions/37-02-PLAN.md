---
phase: 37-task-agent-sessions
plan: 02
type: execute
---

<objective>
Integrate TaskAgentSession into TaskAgent class for automatic session lifecycle management.

Purpose: Every task agent conversation is automatically persisted to its session file, enabling future resumption and log viewing.
Output: TaskAgent creates, updates, and persists sessions throughout its lifecycle.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/37-task-agent-sessions/37-01-SUMMARY.md

**Key files from 37-01:**
@src/shared/types/log.ts
@src/main/storage/feature-store.ts
@src/main/storage/paths.ts

**Target file:**
@src/main/agents/task-agent.ts

**Tech stack available:** TaskAgentSession, TaskAgentMessage, appendSessionMessage()
**Established patterns:** Session stored at `.dagent/nodes/{taskId}/session.json`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session state to TaskAgent</name>
  <files>src/main/agents/task-agent.ts</files>
  <action>
1. Import TaskAgentSession and TaskAgentMessage from @shared/types
2. Add session property to TaskAgentState interface or TaskAgent class
3. Add helper method to get FeatureStore instance (import getFeatureStore from ipc/storage-handlers)
4. Create private method `logToSession(direction, type, content, metadata?)` that:
   - Creates TaskAgentMessage with timestamp
   - Calls appendSessionMessage with featureId, taskId, message, and session defaults
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>TaskAgent has session property and logToSession helper method</done>
</task>

<task type="auto">
  <name>Task 2: Create session on task initialization</name>
  <files>src/main/agents/task-agent.ts</files>
  <action>
In the `initialize()` method, after successful context loading:
1. Call logToSession('task_to_harness', 'progress', 'Task agent initialized')
   - Pass sessionDefaults with agentId from state

In `proposeIntention()`:
1. After setting intention, call logToSession('task_to_harness', 'intention', intention text)

In `receiveApproval()`:
1. If approved: logToSession('harness_to_task', 'approval', decision.notes or 'Approved')
2. If rejected: logToSession('harness_to_task', 'rejection', decision.reason)
  </action>
  <verify>Run app, start a task, check .dagent/nodes/{taskId}/session.json exists with messages</verify>
  <done>Session created with initialization and intention/approval messages logged</done>
</task>

<task type="auto">
  <name>Task 3: Log execution progress and completion</name>
  <files>src/main/agents/task-agent.ts</files>
  <action>
In `execute()` method:
1. At start: logToSession('task_to_harness', 'progress', 'Starting task execution')
2. On successful completion: logToSession('task_to_harness', 'completion', summary)
3. On failure: logToSession('task_to_harness', 'error', error message)

Also update session status by loading, modifying, and saving:
- On completion: set session.status = 'completed', session.completedAt = timestamp
- On failure: set session.status = 'failed', session.completedAt = timestamp

Import getFeatureStore from '../ipc/storage-handlers' at top of file.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Execution progress and completion status persisted to session</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] Session file created at `.dagent/nodes/{taskId}/session.json` when task runs
- [ ] Session contains initialization, intention, approval, and completion messages
- [ ] Session status updated to 'completed' or 'failed' at end
</verification>

<success_criteria>
- All tasks completed
- TaskAgent automatically logs all significant events to session
- Session persisted throughout task lifecycle
- No regressions in existing task execution flow
</success_criteria>

<output>
After completion, create `.planning/phases/37-task-agent-sessions/37-02-SUMMARY.md`
</output>
