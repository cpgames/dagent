---
phase: 98-automatic-planning-workflow
plan: 01
type: execute
wave: 3
depends_on: ["100-01", "101-01"]
files_modified:
  - src/renderer/src/stores/feature-store.ts
  - src/main/ipc/feature-handlers.ts
  - src/main/agent/pm-agent-manager.ts
  - src/renderer/src/components/Kanban/FeatureCard.tsx
autonomous: true

must_haves:
  truths:
    - "PM agent auto-starts when feature created"
    - "PM agent receives feature name, description, and attachments"
    - "PM agent populates spec.md with feature specification"
    - "PM agent creates initial task breakdown in DAG"
    - "PM agent moves feature to Backlog when planning completes"
    - "Planning column shows progress indicator for PM agent work"
  artifacts:
    - path: "src/main/agent/pm-agent-manager.ts"
      provides: "PM agent lifecycle management for planning phase"
      min_lines: 80
      exports: ["PMAgentManager", "startPlanningForFeature"]
    - path: "src/renderer/src/stores/feature-store.ts"
      provides: "Triggers PM agent on feature creation"
      contains: "startPlanningForFeature"
    - path: "src/renderer/src/components/Kanban/FeatureCard.tsx"
      provides: "Planning progress indicator"
      contains: "status === 'planning'"
  key_links:
    - from: "src/renderer/src/stores/feature-store.ts"
      to: "window.electronAPI.pm.startPlanning"
      via: "triggers PM agent after feature creation"
      pattern: "startPlanning"
    - from: "src/main/agent/pm-agent-manager.ts"
      to: "FeatureStatusManager"
      via: "moves feature to backlog on completion"
      pattern: "updateFeatureStatus.*backlog"
---

<objective>
Implement PM agent auto-start on feature creation.

Purpose: Automate the planning phase by having PM agent create spec.md and initial DAG tasks immediately after feature creation, then move feature to Backlog.
Output: PM agent manager, automatic planning workflow trigger, and UI progress indication for Planning column.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v2.9-create-feature-workflow.md
@.planning/phases/100-feature-status-system/100-01-SUMMARY.md
@.planning/phases/101-enhanced-feature-dialog/101-01-SUMMARY.md
@src/renderer/src/stores/feature-store.ts
@src/main/agent/agent-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PMAgentManager for planning lifecycle</name>
  <files>src/main/agent/pm-agent-manager.ts</files>
  <action>
    Create new PMAgentManager class to handle PM agent planning workflow:

    **Core method**:
    ```typescript
    async startPlanningForFeature(
      featureId: string,
      featureName: string,
      description?: string,
      attachments?: string[]
    ): Promise<void>
    ```

    **Implementation**:
    1. **Load feature context**:
       - Read attached files from `.dagent/features/{featureId}/attachments/`
       - Parse images, markdown, CSV files into context
       - Build planning prompt with feature name, description, and file contents

    2. **Start PM agent**:
       - Use AgentService.streamQuery with agentType: 'pm'
       - Pass context to PM agent via prompt
       - Prompt should instruct PM to:
         - Create spec.md in feature directory
         - Design initial task breakdown
         - Save DAG structure via available tools

    3. **Monitor PM agent**:
       - Stream events from PM agent
       - Log progress to console
       - Handle errors gracefully (retry once, then fail)

    4. **On completion**:
       - Verify spec.md exists
       - Verify DAG has at least one task
       - Call FeatureStatusManager.updateFeatureStatus(featureId, 'backlog')
       - Emit 'planning-complete' event

    5. **On failure**:
       - Log error
       - Move feature to 'needs_attention' status
       - Emit 'planning-failed' event with error details

    **Constructor**:
    - Takes AgentService, FeatureStore, FeatureStatusManager instances

    Why: Dedicated manager isolates PM planning workflow from general agent service.
    Avoid: Do not make PM agent wait for user input - planning should be fully autonomous.
  </action>
  <verify>npm run build succeeds</verify>
  <done>PMAgentManager class exists with startPlanningForFeature method</done>
</task>

<task type="auto">
  <name>Task 2: Trigger PM agent on feature creation</name>
  <files>src/renderer/src/stores/feature-store.ts, src/main/ipc/feature-handlers.ts</files>
  <action>
    **In feature-handlers.ts**:
    - Import PMAgentManager
    - Instantiate pmAgentManager with dependencies
    - After createFeature succeeds, call pmAgentManager.startPlanningForFeature(...)
    - Pass feature name, description, attachments to PM agent
    - Run planning asynchronously (don't block feature creation response)
    - Return feature immediately to renderer (planning happens in background)

    **In feature-store.ts (renderer)**:
    - createFeature method already returns feature immediately
    - No changes needed unless adding loading state for planning
    - Feature starts in 'planning' status (from Phase 100)
    - PM agent will move it to 'backlog' when done

    **Preload API**:
    - Add window.electronAPI.pm.onPlanningComplete listener (optional)
    - Allows UI to react when planning finishes
    - Payload: { featureId: string, success: boolean, error?: string }

    **Event flow**:
    1. User clicks "Create" in NewFeatureDialog
    2. createFeature IPC call creates feature with status='planning'
    3. PM agent starts in background
    4. User sees feature in Planning column with progress indicator
    5. PM agent completes, updates status to 'backlog'
    6. Feature moves to Backlog column automatically

    Why: Non-blocking planning allows user to continue working while PM runs.
    Avoid: Do not wait for PM agent to finish before returning feature to UI.
  </action>
  <verify>npm run build succeeds</verify>
  <done>createFeature triggers PM agent in background, feature starts in Planning status</done>
</task>

<task type="auto">
  <name>Task 3: Add planning progress indicator in Kanban</name>
  <files>src/renderer/src/components/Kanban/FeatureCard.tsx</files>
  <action>
    **Add planning indicator to FeatureCard**:

    **Visual indicator** (for planning status only):
    - Add animated spinner icon or pulsing dot
    - Show "Planning in progress..." text below feature name
    - Use synthwave colors (purple/cyan pulsing animation)

    **CSS animation** (FeatureCard.css):
    ```css
    .feature-card--planning {
      border-left: 3px solid var(--color-purple);
    }

    .feature-card__planning-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .feature-card__planning-spinner {
      width: 12px;
      height: 12px;
      border: 2px solid var(--color-purple);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    ```

    **Conditional rendering**:
    ```tsx
    {feature.status === 'planning' && (
      <div className="feature-card__planning-indicator">
        <div className="feature-card__planning-spinner" />
        <span>Planning in progress...</span>
      </div>
    )}
    ```

    **No actions available**:
    - Planning features should not have Start/Stop/Merge buttons
    - Only show Delete button (to cancel/remove if needed)

    Why: User needs visual feedback that PM agent is working.
    Avoid: Do not add "Cancel Planning" button - just let PM finish or fail.
  </action>
  <verify>npm run build succeeds</verify>
  <done>Planning column features show animated progress indicator</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds with no TypeScript errors
- [ ] PMAgentManager class exists with startPlanningForFeature method
- [ ] createFeature triggers PM agent in background
- [ ] Features start in 'planning' status
- [ ] PM agent populates spec.md and creates DAG tasks
- [ ] PM agent moves feature to 'backlog' on completion
- [ ] Planning column features show progress indicator
- [ ] Planning failures move feature to 'needs_attention'
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Automatic planning workflow streamlines feature creation UX
</success_criteria>

<output>
After completion, create `.planning/phases/98-automatic-planning-workflow/98-01-SUMMARY.md`
</output>
