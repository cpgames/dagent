---
phase: 53-feature-merge-agent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/agents/feature-merge-agent.ts
  - src/main/agents/feature-merge-types.ts
  - src/main/agents/index.ts
  - src/main/git/git-manager.ts
autonomous: true

must_haves:
  truths:
    - "FeatureMergeAgent can merge feature branch into main/working branch"
    - "FeatureMergeAgent detects and reports conflicts"
    - "FeatureMergeAgent uses AI to analyze conflicts and suggest resolutions"
  artifacts:
    - path: "src/main/agents/feature-merge-agent.ts"
      provides: "FeatureMergeAgent class for feature-to-main merges"
      contains: "class FeatureMergeAgent"
    - path: "src/main/agents/feature-merge-types.ts"
      provides: "Types for feature merge operations"
      contains: "FeatureMergeAgentState"
    - path: "src/main/git/git-manager.ts"
      provides: "mergeFeatureIntoMain method"
      contains: "mergeFeatureIntoMain"
  key_links:
    - from: "feature-merge-agent.ts"
      to: "git-manager.ts"
      via: "mergeFeatureIntoMain call"
      pattern: "gitManager.mergeFeatureIntoMain"
---

<objective>
Create FeatureMergeAgent to handle merging completed features into the main/working branch.

Purpose: Enable AI-assisted merging of feature branches to main with conflict detection and resolution suggestions.
Output: FeatureMergeAgent class with types, and GitManager.mergeFeatureIntoMain method.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/main/agents/merge-agent.ts
@src/main/agents/merge-types.ts
@src/main/git/git-manager.ts
@src/main/git/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FeatureMergeAgent types</name>
  <files>src/main/agents/feature-merge-types.ts</files>
  <action>
Create types for FeatureMergeAgent following the pattern from merge-types.ts:

1. Define FeatureMergeAgentStatus union type:
   - 'initializing' | 'checking_branches' | 'proposing_intention' | 'awaiting_approval'
   - | 'merging' | 'resolving_conflicts' | 'completed' | 'failed'

2. Define FeatureMergeAgentState interface:
   - status: FeatureMergeAgentStatus
   - agentId: string | null
   - featureId: string
   - featureBranch: string | null (e.g., feature/car/main)
   - targetBranch: string | null (e.g., main)
   - conflicts: MergeConflict[]
   - conflictAnalysis: ConflictAnalysis | null (reuse from merge-types.ts)
   - intention: string | null
   - approval: IntentionDecision | null
   - mergeResult: FeatureMergeResult | null
   - error: string | null
   - startedAt: string | null
   - completedAt: string | null

3. Define FeatureMergeResult interface:
   - success: boolean
   - merged: boolean
   - conflicts?: MergeConflict[]
   - commitHash?: string
   - branchDeleted: boolean
   - error?: string

4. Export DEFAULT_FEATURE_MERGE_AGENT_STATE (similar to DEFAULT_MERGE_AGENT_STATE)

Import types from '../git/types' and './merge-types' as needed.
  </action>
  <verify>npm run build succeeds (tsc --noEmit)</verify>
  <done>FeatureMergeAgent types defined and exported</done>
</task>

<task type="auto">
  <name>Task 2: Add mergeFeatureIntoMain to GitManager</name>
  <files>src/main/git/git-manager.ts, src/main/git/types.ts</files>
  <action>
Add method to GitManager for merging feature branch into main branch:

1. In types.ts, add FeatureMergeResult interface (if not using shared type from feature-merge-types):
   ```typescript
   export interface FeatureMergeResult extends GitOperationResult {
     merged: boolean
     conflicts?: MergeConflict[]
     commitHash?: string
     branchDeleted: boolean
   }
   ```

2. In git-manager.ts, add mergeFeatureIntoMain method:
   ```typescript
   /**
    * Merge a feature branch into the main/working branch.
    * This is used when completing a feature and merging all its work to main.
    *
    * Unlike task merges (which use worktrees), this operates on the main repo:
    * 1. Ensure main branch is checked out
    * 2. Merge feature branch into main
    * 3. Optionally delete the feature branch after successful merge
    */
   async mergeFeatureIntoMain(
     featureId: string,
     deleteBranchOnSuccess: boolean = false,
     targetBranch: string = 'main'
   ): Promise<FeatureMergeResult>
   ```

   Implementation:
   - Get feature branch name using getFeatureBranchName(featureId)
   - Verify feature branch exists
   - Get current branch and check if we need to checkout target branch
   - If not on target branch, checkout target branch
   - Perform merge: git.merge([featureBranch, '--no-ff', '-m', message])
   - Handle conflicts by returning them without aborting (let agent decide)
   - On success, optionally delete feature branch (and all task branches with prefix)
   - Return to original branch if we switched

   Handle edge cases:
   - Feature branch doesn't exist -> error
   - Target branch doesn't exist -> error
   - Already on target branch -> proceed with merge
   - Uncommitted changes in target -> error (require clean working directory)
  </action>
  <verify>npm run build succeeds</verify>
  <done>GitManager.mergeFeatureIntoMain method implemented</done>
</task>

<task type="auto">
  <name>Task 3: Create FeatureMergeAgent class</name>
  <files>src/main/agents/feature-merge-agent.ts, src/main/agents/index.ts</files>
  <action>
Create FeatureMergeAgent class following the MergeAgent pattern but for feature-to-main merges:

1. Create src/main/agents/feature-merge-agent.ts:

```typescript
import { EventEmitter } from 'events'
import type { MergeConflict } from '../git/types'
import type { FeatureMergeAgentState, FeatureMergeAgentStatus, FeatureMergeResult } from './feature-merge-types'
import { DEFAULT_FEATURE_MERGE_AGENT_STATE } from './feature-merge-types'
import type { IntentionDecision } from './harness-types'
import type { ConflictAnalysis } from './merge-types'
import { getAgentPool } from './agent-pool'
import { getGitManager, getFeatureBranchName } from '../git'
import { getAgentService } from '../agent'
import { RequestPriority } from '../agent/request-types'

export class FeatureMergeAgent extends EventEmitter {
  private state: FeatureMergeAgentState

  constructor(featureId: string, targetBranch: string = 'main') {
    super()
    this.state = {
      ...DEFAULT_FEATURE_MERGE_AGENT_STATE,
      featureId,
      targetBranch
    }
  }

  // Initialize agent for feature merge
  async initialize(): Promise<boolean>

  // Check that feature and target branches exist
  async checkBranches(): Promise<boolean>

  // Propose intention (optional - can skip for auto-approval)
  async proposeIntention(): Promise<boolean>

  // Receive approval decision
  receiveApproval(decision: IntentionDecision): void

  // Execute the merge
  async executeMerge(deleteBranchOnSuccess: boolean = false): Promise<FeatureMergeResult>

  // Abort merge (if in progress)
  async abortMerge(): Promise<boolean>

  // Analyze conflicts using Claude SDK (reuse logic from MergeAgent)
  async analyzeConflicts(conflicts: MergeConflict[]): Promise<ConflictAnalysis | null>

  // Get state
  getState(): FeatureMergeAgentState

  // Get status
  getStatus(): FeatureMergeAgentStatus

  // Cleanup
  async cleanup(): Promise<void>
}
```

Key differences from MergeAgent:
- No worktree paths (operates on main repo)
- Uses mergeFeatureIntoMain instead of mergeTaskIntoFeature
- Target branch is configurable (default: 'main')
- Emits 'feature-merge-agent:*' events

2. Add factory and registry functions:
   - createFeatureMergeAgent(featureId, targetBranch)
   - registerFeatureMergeAgent(agent)
   - getFeatureMergeAgent(featureId)
   - removeFeatureMergeAgent(featureId)
   - getAllFeatureMergeAgents()
   - clearFeatureMergeAgents()

3. Export from src/main/agents/index.ts:
   - Export FeatureMergeAgent class
   - Export all factory/registry functions
   - Export types from feature-merge-types.ts
  </action>
  <verify>npm run build succeeds</verify>
  <done>FeatureMergeAgent class created with full merge workflow</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] FeatureMergeAgent types defined in feature-merge-types.ts
- [ ] GitManager.mergeFeatureIntoMain method implemented
- [ ] FeatureMergeAgent class created with full workflow
- [ ] All exports added to agents/index.ts
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors or warnings
- FeatureMergeAgent follows established MergeAgent patterns
</success_criteria>

<output>
After completion, create `.planning/phases/53-feature-merge-agent/53-01-SUMMARY.md`
</output>
