# Phase 17 Plan 01: Configure Allowed Tools for Feature Chat

**Objective**: Enable agent tools (Read, Glob, Grep) for feature chat so the AI can explore project context

## Context

### Current State
- AgentService wrapper exists with `allowedTools` option support
- Feature chat currently passes `allowedTools: []` (no tools enabled)
- Agent can respond but cannot explore the codebase
- `permissionMode: 'default'` requires tool approval

### Required Changes
1. Define tool presets for different chat modes
2. Update chat-store to pass appropriate tools for feature planning
3. Configure working directory (cwd) based on current project
4. Stream tool usage events to UI

## Dependencies

- Requires: 16-03 (SDK integration complete)
- Provides: Codebase-aware feature chat

## Tasks

### Task 1: Create tool configuration module

Define tool presets for different use cases.

**Files to create:**
- `src/main/agent/tool-config.ts`

**Implementation:**
```typescript
// src/main/agent/tool-config.ts

// Tool presets for different chat contexts
export const TOOL_PRESETS = {
  // Feature planning chat - read-only exploration
  featureChat: ['Read', 'Glob', 'Grep'],

  // Task execution - full capabilities
  taskAgent: ['Read', 'Edit', 'Write', 'Bash', 'Glob', 'Grep'],

  // Harness agent - read + intent generation
  harnessAgent: ['Read', 'Glob', 'Grep'],

  // Merge agent - read + conflict analysis
  mergeAgent: ['Read', 'Glob', 'Grep', 'Bash'],

  // No tools - basic chat only
  none: []
} as const

export type ToolPreset = keyof typeof TOOL_PRESETS

export function getToolsForPreset(preset: ToolPreset): string[] {
  return [...TOOL_PRESETS[preset]]
}
```

**Verification:**
- Module exports compile without errors
- TOOL_PRESETS contains valid tool names

### Task 2: Update AgentQueryOptions with preset support

Add tool preset option alongside manual tool list.

**Files to modify:**
- `src/main/agent/types.ts`
- `src/main/agent/index.ts`

**Implementation:**
```typescript
// In types.ts - extend AgentQueryOptions
export interface AgentQueryOptions {
  prompt: string
  systemPrompt?: string
  allowedTools?: string[]
  toolPreset?: 'featureChat' | 'taskAgent' | 'harnessAgent' | 'mergeAgent' | 'none'
  permissionMode?: 'default' | 'acceptEdits' | 'bypassPermissions' | 'plan'
  cwd?: string
}

// In index.ts - export tool config
export * from './tool-config'
```

**In agent-service.ts - resolve preset:**
```typescript
import { getToolsForPreset } from './tool-config'

// In streamQuery:
const tools = options.allowedTools ||
  (options.toolPreset ? getToolsForPreset(options.toolPreset) : [])
const queryOptions: Options = {
  cwd: options.cwd,
  allowedTools: tools,
  permissionMode: options.permissionMode || 'default'
}
```

**Verification:**
- TypeScript compiles without errors
- Preset resolves to correct tools

### Task 3: Update chat-store to use featureChat preset

Configure feature chat to use appropriate tools and project cwd.

**Files to modify:**
- `src/renderer/src/stores/chat-store.ts`
- `src/shared/types/sdk-agent.ts`

**Changes:**
1. Import project-store to get current project path
2. Pass `toolPreset: 'featureChat'` instead of `allowedTools: []`
3. Pass `cwd` as current project root
4. Use `permissionMode: 'acceptEdits'` for seamless tool use

**Implementation:**
```typescript
// In sendToAgent():
import { useProjectStore } from './project-store'

// Get current project for cwd
const projectState = useProjectStore.getState()
const projectRoot = projectState.currentProject?.root

await window.electronAPI.sdkAgent.query({
  prompt,
  systemPrompt: systemPrompt || undefined,
  toolPreset: 'featureChat',  // Read, Glob, Grep
  permissionMode: 'acceptEdits',  // Auto-approve read-only tools
  cwd: projectRoot
})
```

**Verification:**
- Feature chat can now use Read/Glob/Grep tools
- Tools operate within current project directory

### Task 4: Update preload types for tool preset

Ensure shared types include toolPreset option.

**Files to modify:**
- `src/shared/types/sdk-agent.ts`

**Implementation:**
```typescript
// Update AgentQueryOptions in shared types
export interface AgentQueryOptions {
  prompt: string
  systemPrompt?: string
  allowedTools?: string[]
  toolPreset?: 'featureChat' | 'taskAgent' | 'harnessAgent' | 'mergeAgent' | 'none'
  permissionMode?: 'default' | 'acceptEdits' | 'bypassPermissions' | 'plan'
  cwd?: string
}
```

**Verification:**
- TypeScript compiles in both main and renderer
- Types are consistent across process boundary

## Verification Checklist

- [ ] Tool presets defined in tool-config.ts
- [ ] AgentQueryOptions includes toolPreset
- [ ] Feature chat passes `toolPreset: 'featureChat'`
- [ ] cwd set to current project root
- [ ] permissionMode set to 'acceptEdits'
- [ ] `pnpm typecheck` passes
- [ ] Agent can use Read/Glob/Grep during feature chat

## Files Summary

| File | Action | Purpose |
|------|--------|---------|
| `src/main/agent/tool-config.ts` | Create | Tool preset definitions |
| `src/main/agent/types.ts` | Modify | Add toolPreset to options |
| `src/main/agent/agent-service.ts` | Modify | Resolve preset to tools |
| `src/main/agent/index.ts` | Modify | Export tool-config |
| `src/shared/types/sdk-agent.ts` | Modify | Shared type updates |
| `src/renderer/src/stores/chat-store.ts` | Modify | Use featureChat preset |

## Estimated Tasks: 4

## Notes

- Using 'acceptEdits' permission mode for read-only tools is safe
- Read/Glob/Grep cannot modify files, so auto-approval is appropriate
- cwd ensures tools operate within project boundary
- Tool presets enable consistent configuration across agents

---
*Phase: 17-agent-tools-permissions*
*Plan: 01 of 02*
