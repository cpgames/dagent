# Phase 17 Plan 02: Tool Usage Display and Streaming Enhancement

**Objective**: Show tool usage in chat UI with real-time feedback when agent explores codebase

## Context

### Current State
- Agent can now use Read/Glob/Grep tools (from 17-01)
- Tool usage events stream as `[Using {toolName}...]` inline text
- No visual distinction between tool usage and regular messages
- No indication of what the tool found (tool results not shown)

### Required Changes
1. Enhance tool_use event handling to show tool details
2. Display tool results in a collapsible format
3. Add visual styling for tool usage vs regular messages
4. Handle tool errors gracefully

## Dependencies

- Requires: 17-01 (tools enabled for feature chat)
- Provides: Clear visibility into agent tool usage

## Tasks

### Task 1: Enhance streaming event types for tool details

Add tool result tracking to stream events.

**Files to modify:**
- `src/main/agent/types.ts`
- `src/main/agent/agent-service.ts`

**Implementation:**
```typescript
// In types.ts - enhance AgentMessage
export interface AgentMessage {
  type: AgentMessageType
  content: string
  timestamp: string
  toolName?: string
  toolInput?: unknown
  toolResult?: string  // NEW: Result from tool execution
}

// In agent-service.ts - capture tool results
// The SDK sends tool results as separate messages
// Handle 'result' type messages with tool context
```

**Verification:**
- Tool results captured in stream events
- Types compile correctly

### Task 2: Update chat-store for tool state tracking

Track active tool usage and results.

**Files to modify:**
- `src/renderer/src/stores/chat-store.ts`

**Changes:**
1. Add `activeToolUse` state for current tool operation
2. Handle tool_use events to show what's being used
3. Handle tool_result events to show results
4. Clear tool state when done or on error

**Implementation:**
```typescript
interface ChatState {
  // ... existing state
  activeToolUse: {
    name: string
    input?: unknown
    result?: string
  } | null
}

// In stream handler:
if (event.type === 'tool_use' && event.message) {
  set({
    activeToolUse: {
      name: event.message.toolName!,
      input: event.message.toolInput
    }
  })
} else if (event.type === 'tool_result' && event.message) {
  set((state) => ({
    activeToolUse: state.activeToolUse ? {
      ...state.activeToolUse,
      result: event.message!.content
    } : null
  }))
}
```

**Verification:**
- activeToolUse populated during tool execution
- Result captured when tool completes

### Task 3: Create ToolUsageDisplay component

Visual component for showing tool operations.

**Files to create:**
- `src/renderer/src/components/Chat/ToolUsageDisplay.tsx`

**Implementation:**
```typescript
import type { JSX } from 'react'

interface ToolUsageDisplayProps {
  toolName: string
  input?: unknown
  result?: string
  isLoading: boolean
}

export function ToolUsageDisplay({
  toolName,
  input,
  result,
  isLoading
}: ToolUsageDisplayProps): JSX.Element {
  return (
    <div className="bg-gray-800/50 rounded-lg p-2 my-2 border border-gray-700">
      <div className="flex items-center gap-2 text-sm">
        <span className="text-purple-400 font-mono">{toolName}</span>
        {isLoading && (
          <span className="text-yellow-400 animate-pulse">Running...</span>
        )}
      </div>

      {/* Tool input (for Grep/Glob show pattern) */}
      {input && (
        <div className="text-xs text-gray-500 mt-1 font-mono">
          {typeof input === 'object' && 'pattern' in (input as object)
            ? `Pattern: ${(input as { pattern: string }).pattern}`
            : typeof input === 'object' && 'file_path' in (input as object)
            ? `File: ${(input as { file_path: string }).file_path}`
            : JSON.stringify(input)}
        </div>
      )}

      {/* Tool result (collapsible for large results) */}
      {result && (
        <details className="mt-2">
          <summary className="text-xs text-gray-400 cursor-pointer hover:text-gray-300">
            View result ({result.length} chars)
          </summary>
          <pre className="mt-1 text-xs text-gray-400 bg-gray-900 p-2 rounded overflow-x-auto max-h-32 overflow-y-auto">
            {result.slice(0, 500)}
            {result.length > 500 && '...'}
          </pre>
        </details>
      )}
    </div>
  )
}
```

**Verification:**
- Component renders tool name
- Shows loading state
- Displays input pattern/path
- Collapses large results

### Task 4: Integrate ToolUsageDisplay into FeatureChat

Show tool usage in the streaming response area.

**Files to modify:**
- `src/renderer/src/components/Chat/FeatureChat.tsx`

**Implementation:**
```typescript
import { ToolUsageDisplay } from './ToolUsageDisplay'

// In component:
const { activeToolUse } = useChatStore()

// In JSX, add above streamingContent:
{activeToolUse && (
  <ToolUsageDisplay
    toolName={activeToolUse.name}
    input={activeToolUse.input}
    result={activeToolUse.result}
    isLoading={!activeToolUse.result}
  />
)}
```

**Verification:**
- Tool usage visible during streaming
- Shows what tool is being used
- Result appears when complete

### Task 5: Run verification and typecheck

Ensure all changes compile and work correctly.

**Commands:**
```bash
pnpm typecheck
```

**Verification:**
- No TypeScript errors
- Tool display renders during agent queries
- Results show in collapsible format

## Verification Checklist

- [ ] Tool results tracked in stream events
- [ ] activeToolUse state in chat-store
- [ ] ToolUsageDisplay component created
- [ ] FeatureChat shows tool usage
- [ ] Collapsible results for large outputs
- [ ] Loading state shown during tool execution
- [ ] `pnpm typecheck` passes

## Files Summary

| File | Action | Purpose |
|------|--------|---------|
| `src/main/agent/types.ts` | Modify | Add toolResult to message |
| `src/main/agent/agent-service.ts` | Modify | Capture tool results |
| `src/renderer/src/stores/chat-store.ts` | Modify | Track active tool use |
| `src/renderer/src/components/Chat/ToolUsageDisplay.tsx` | Create | Tool UI component |
| `src/renderer/src/components/Chat/FeatureChat.tsx` | Modify | Integrate tool display |

## Estimated Tasks: 5

## Notes

- Collapsible results prevent UI bloat from large file contents
- Purple color for tool names distinguishes from regular text
- Pattern/path display helps user understand what agent is searching
- Loading state provides feedback during tool execution

---
*Phase: 17-agent-tools-permissions*
*Plan: 02 of 02*
