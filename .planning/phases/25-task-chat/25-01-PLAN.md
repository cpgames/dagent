# Plan 25-01: Task Chat Overlay

## Context

Phase 25 adds a task-specific chat panel that overlays the existing feature chat when a task is selected in the DAG view.

**Current state:**
- `ChatPanel` component handles chat UI with agent name, messages, input
- `FeatureChat` wraps ChatPanel for feature context (contextType: 'feature')
- `chat-store.ts` supports contextType: 'feature' | 'task' | 'agent'
- `dialog-store.ts` tracks open task with `nodeDialogTaskId`
- `DAGView` shows FeatureChat in right sidebar

**Goal:** When user clicks a task node, a TaskChat overlay slides in over the FeatureChat with task-specific context and a back button.

## Tasks

### Task 1: Add TaskChat state to dialog store

Update `dialog-store.ts` to track task chat overlay state.

**File:** `src/renderer/src/stores/dialog-store.ts`

**Changes:**
```typescript
interface DialogState {
  // Existing
  nodeDialogOpen: boolean;
  nodeDialogTaskId: string | null;

  // New: Task chat overlay
  taskChatOpen: boolean;
  taskChatTaskId: string | null;
  taskChatFeatureId: string | null;

  // Existing actions
  openNodeDialog: (taskId: string) => void;
  closeNodeDialog: () => void;

  // New actions
  openTaskChat: (taskId: string, featureId: string) => void;
  closeTaskChat: () => void;
}
```

Add state and actions:
- `taskChatOpen`: boolean
- `taskChatTaskId`: string | null
- `taskChatFeatureId`: string | null
- `openTaskChat(taskId, featureId)`: sets all three
- `closeTaskChat()`: resets to false/null

### Task 2: Create TaskChat component

Create a new component that wraps ChatPanel for task context.

**File:** `src/renderer/src/components/Chat/TaskChat.tsx`

**Implementation:**
```typescript
import type { JSX } from 'react'
import { ChatPanel } from './ChatPanel'
import { useDialogStore } from '../../stores/dialog-store'
import { useDAGStore } from '../../stores/dag-store'

interface TaskChatProps {
  taskId: string
  featureId: string
}

export function TaskChat({ taskId, featureId }: TaskChatProps): JSX.Element {
  const { closeTaskChat } = useDialogStore()
  const { dag } = useDAGStore()

  // Get task title for header
  const task = dag?.nodes.find(n => n.id === taskId)
  const taskTitle = task?.title || 'Task'

  return (
    <div className="absolute inset-0 flex flex-col bg-gray-900 z-10 animate-slide-in-right">
      {/* Back button header */}
      <div className="flex items-center gap-2 px-3 py-2 border-b border-gray-700">
        <button
          onClick={closeTaskChat}
          className="p-1 rounded hover:bg-gray-700 text-gray-400 hover:text-white"
          title="Back to feature chat"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <span className="text-sm text-gray-300 truncate">{taskTitle}</span>
      </div>

      {/* Chat panel for task context */}
      <ChatPanel
        agentName="Task Agent"
        contextId={taskId}
        contextType="task"
        className="flex-1"
      />
    </div>
  )
}
```

**Export:** Add to `src/renderer/src/components/Chat/index.ts`

### Task 3: Add slide-in animation CSS

Add Tailwind animation for overlay slide-in.

**File:** `src/renderer/src/assets/main.css` (or equivalent)

**Add:**
```css
@keyframes slide-in-right {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(0);
  }
}

.animate-slide-in-right {
  animation: slide-in-right 0.2s ease-out;
}
```

### Task 4: Add chat button to TaskNode

Add a chat icon button to TaskNode that opens task chat.

**File:** `src/renderer/src/components/DAG/TaskNode.tsx`

**Changes:**
1. Add `onChat` callback to `TaskNodeData` interface
2. Add chat button next to edit/delete buttons
3. Button calls `onChat(task.id)`

```typescript
export interface TaskNodeData extends Record<string, unknown> {
  task: Task
  onEdit: (taskId: string) => void
  onDelete: (taskId: string) => void
  onChat: (taskId: string) => void  // New
}
```

Add button in header between edit and delete:
```tsx
<button
  onClick={(e) => {
    e.stopPropagation()
    onChat(task.id)
  }}
  className="p-1 rounded hover:bg-gray-700 text-gray-400 hover:text-blue-400"
  title="Open task chat"
>
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
          d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
  </svg>
</button>
```

### Task 5: Wire TaskChat overlay into DAGView

Update DAGView to render TaskChat when open and pass onChat to TaskNode.

**File:** `src/renderer/src/views/DAGView.tsx`

**Changes:**

1. Import TaskChat and add useDialogStore destructure:
```typescript
import { TaskChat } from '../components/Chat'
// ...
const { taskChatOpen, taskChatTaskId, taskChatFeatureId, openTaskChat } = useDialogStore()
```

2. Add handler for chat button:
```typescript
const handleChatTask = useCallback(
  (taskId: string) => {
    if (activeFeatureId) {
      openTaskChat(taskId, activeFeatureId)
    }
  },
  [activeFeatureId, openTaskChat]
)
```

3. Update dagToNodes to pass onChat:
```typescript
function dagToNodes(
  dag: DAGGraph | null,
  onEdit: (taskId: string) => void,
  onDelete: (taskId: string) => void,
  onChat: (taskId: string) => void  // New parameter
): Node[] {
  // ...
  data: {
    task,
    onEdit,
    onDelete,
    onChat  // Pass to TaskNodeData
  } as TaskNodeData
}
```

4. Update useMemo and useEffect calls to include handleChatTask

5. Wrap FeatureChat section with relative positioning and add TaskChat overlay:
```tsx
{/* Chat sidebar with overlay support */}
{activeFeatureId && (
  <div className="relative w-80">
    <FeatureChat featureId={activeFeatureId} />
    {taskChatOpen && taskChatTaskId && taskChatFeatureId && (
      <TaskChat taskId={taskChatTaskId} featureId={taskChatFeatureId} />
    )}
  </div>
)}
```

## Verification

1. Build succeeds: `npm run build`
2. Click chat icon on any task node - TaskChat slides in from right
3. TaskChat shows task title in header with back arrow
4. Back button returns to feature chat
5. Task chat messages are independent from feature chat
6. Multiple tasks can have separate chat histories

## Files Changed

- `src/renderer/src/stores/dialog-store.ts` - Add task chat state
- `src/renderer/src/components/Chat/TaskChat.tsx` - New component
- `src/renderer/src/components/Chat/index.ts` - Export TaskChat
- `src/renderer/src/assets/main.css` - Slide animation
- `src/renderer/src/components/DAG/TaskNode.tsx` - Chat button
- `src/renderer/src/views/DAGView.tsx` - Wire overlay

## Estimated Scope

- **Files:** 6
- **Lines:** ~100
- **Complexity:** Medium (new component + wiring)
