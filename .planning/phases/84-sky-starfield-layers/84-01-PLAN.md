---
phase: 84-sky-starfield-layers
plan: 01
type: execute
wave: 1
depends_on:
  - 83-canvas-infrastructure
files_modified:
  - src/renderer/src/components/Background/layers/SkyLayer.ts
  - src/renderer/src/components/Background/layers/StarsLayer.ts
  - src/renderer/src/components/Background/layers/index.ts
autonomous: true

must_haves:
  truths:
    - "SkyLayer renders a vertical gradient from deep purple (#1b2853) to pink (#f222ff)"
    - "SkyLayer gradient is positioned correctly with pink at horizon (bottom 30-40%)"
    - "StarsLayer creates exactly 360 star objects on init"
    - "Stars have random sizes between 0.5px and 2.2px radius"
    - "Stars have sinusoidal opacity flicker using sin(time * 0.0015 + offset)"
    - "Stars have base opacity 0.4 with flicker amplitude 0.5 (range: 0.4-0.9)"
    - "Stars are distributed across canvas with higher density toward top"
  artifacts:
    - path: "src/renderer/src/components/Background/layers/SkyLayer.ts"
      provides: "Sky gradient layer with deep purple to pink transition"
      exports: ["SkyLayer"]
    - path: "src/renderer/src/components/Background/layers/StarsLayer.ts"
      provides: "Starfield layer with 360 flickering stars"
      exports: ["StarsLayer"]
    - path: "src/renderer/src/components/Background/layers/index.ts"
      provides: "Barrel export for all layer implementations"
      exports: ["SkyLayer", "StarsLayer"]
  key_links:
    - from: "SkyLayer.ts"
      to: "layers/types.ts"
      via: "implements Layer interface"
      pattern: "implements Layer"
    - from: "StarsLayer.ts"
      to: "layers/types.ts"
      via: "implements Layer interface"
      pattern: "implements Layer"
---

<objective>
Implement the first two visual effect layers for the unified canvas background system.

Purpose: Create concrete Layer implementations for the sky gradient and starfield effects, establishing the pattern for subsequent VFX layers. These are the foundational visual elements that will sit behind all other effects.

Output: SkyLayer class for gradient background, StarsLayer class for twinkling starfield, barrel export for layers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/FEATURES.md

Relevant source files:
@src/renderer/src/components/Background/layers/types.ts (Layer interface to implement)
@src/renderer/src/components/Background/UnifiedCanvas.tsx (consumer of layers)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SkyLayer</name>
  <files>src/renderer/src/components/Background/layers/SkyLayer.ts</files>
  <action>
Create a Layer implementation that renders the synthwave sky gradient.

Requirements from VFX-01 and research FEATURES.md:
- Implement the Layer interface (init, update, render methods)
- Render a vertical linear gradient from top to bottom:
  - Top: Deep purple `#1b2853`
  - Middle: Purple-blue `#162b79` at ~50%
  - Bottom: Hot pink `#f222ff`
- The gradient should cover the full canvas
- No animation needed - gradient is static (update() can be empty)
- Use createLinearGradient with addColorStop

Pattern:
```typescript
import type { Layer, LayerContext } from './types';

export class SkyLayer implements Layer {
  private gradient: CanvasGradient | null = null;

  init(ctx: CanvasRenderingContext2D, context: LayerContext): void {
    // Create gradient from top (0) to bottom (height)
    this.gradient = ctx.createLinearGradient(0, 0, 0, context.height);
    this.gradient.addColorStop(0, '#1b2853');     // Deep purple at top
    this.gradient.addColorStop(0.5, '#162b79');   // Purple-blue middle
    this.gradient.addColorStop(1, '#f222ff');     // Pink at bottom
  }

  update(_deltaTime: number): void {
    // Static gradient - no update needed
  }

  render(ctx: CanvasRenderingContext2D, context: LayerContext): void {
    if (!this.gradient) return;
    ctx.fillStyle = this.gradient;
    ctx.fillRect(0, 0, context.width, context.height);
  }
}
```

Export: `SkyLayer`
  </action>
  <verify>tsc --noEmit src/renderer/src/components/Background/layers/SkyLayer.ts</verify>
  <done>SkyLayer class implements Layer interface and TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Create StarsLayer</name>
  <files>src/renderer/src/components/Background/layers/StarsLayer.ts</files>
  <action>
Create a Layer implementation for the twinkling starfield.

Requirements from VFX-02 and research FEATURES.md:
- Create exactly 360 star objects on init
- Each star has: x, y, radius (0.5-2.2), phase offset for flicker
- Distribution: Random x, y with bias toward top (use Math.pow for y to cluster toward top)
- Flicker: Sinusoidal animation using `sin(time * 0.0015 + phase)`
- Base opacity: 0.4, flicker amplitude: 0.5 (resulting range: 0.4 to 0.9)
- Color: White `#ffffff`

Star interface:
```typescript
interface Star {
  x: number;        // 0 to 1 (normalized, multiply by width)
  y: number;        // 0 to 1 (normalized, multiply by height)
  radius: number;   // 0.5 to 2.2
  phase: number;    // Random offset for desynchronized flicker
}
```

Implementation pattern:
```typescript
export class StarsLayer implements Layer {
  private stars: Star[] = [];
  private time = 0;

  init(_ctx: CanvasRenderingContext2D, _context: LayerContext): void {
    // Only generate stars once
    if (this.stars.length > 0) return;

    this.stars = Array.from({ length: 360 }, () => ({
      x: Math.random(),
      y: Math.pow(Math.random(), 1.5), // Bias toward top (0)
      radius: 0.5 + Math.random() * 1.7, // 0.5 to 2.2
      phase: Math.random() * Math.PI * 2,
    }));
  }

  update(deltaTime: number): void {
    this.time += deltaTime;
  }

  render(ctx: CanvasRenderingContext2D, context: LayerContext): void {
    const { width, height } = context;

    for (const star of this.stars) {
      // Calculate flicker opacity: base 0.4, amplitude 0.5, range [0.4, 0.9]
      // sin returns [-1, 1], so (sin + 1) / 2 gives [0, 1]
      // Then: 0.4 + 0.5 * [0, 1] = [0.4, 0.9]
      const flicker = Math.sin(this.time * 0.0015 + star.phase);
      const opacity = 0.4 + 0.5 * (flicker + 1) / 2;

      ctx.beginPath();
      ctx.arc(star.x * width, star.y * height, star.radius, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
      ctx.fill();
    }
  }

  reset(): void {
    this.time = 0;
  }
}
```

Export: `StarsLayer`
  </action>
  <verify>tsc --noEmit src/renderer/src/components/Background/layers/StarsLayer.ts</verify>
  <done>StarsLayer creates 360 stars with correct flicker animation</done>
</task>

<task type="auto">
  <name>Task 3: Create layers barrel export</name>
  <files>src/renderer/src/components/Background/layers/index.ts</files>
  <action>
Create a barrel export file for all layer implementations.

Content:
```typescript
export { SkyLayer } from './SkyLayer';
export { StarsLayer } from './StarsLayer';
export type { Layer, LayerContext } from './types';
```

This provides a clean import path for consumers:
```typescript
import { SkyLayer, StarsLayer } from './layers';
```

Export: `SkyLayer`, `StarsLayer`, `Layer`, `LayerContext`
  </action>
  <verify>tsc --noEmit src/renderer/src/components/Background/layers/index.ts</verify>
  <done>Barrel export file created with all exports</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] SkyLayer implements Layer interface with init/update/render
- [ ] SkyLayer renders gradient from #1b2853 to #f222ff
- [ ] StarsLayer creates exactly 360 stars
- [ ] Stars have radius range 0.5-2.2
- [ ] Stars have sinusoidal flicker with base 0.4, amplitude 0.5
- [ ] Barrel export includes SkyLayer, StarsLayer, Layer, LayerContext
- [ ] No TypeScript errors introduced
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Layers ready for integration testing with UnifiedCanvas
</success_criteria>

<output>
After completion, create `.planning/phases/84-sky-starfield-layers/84-01-SUMMARY.md`
</output>
