---
phase: v3.2-02-non-blocking-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/storage/paths.ts
  - src/main/storage/feature-store.ts
  - src/main/ipc/storage-handlers.ts
autonomous: true

must_haves:
  truths:
    - "Feature can be created without worktree existing"
    - "Feature.json stored in .dagent/features/{featureId}/ when no worktree"
    - "Feature status is 'not_started' immediately after creation"
  artifacts:
    - path: "src/main/storage/paths.ts"
      provides: "getPendingFeatureDir() and getPendingFeaturePath() functions"
      contains: "getPendingFeatureDir"
    - path: "src/main/storage/feature-store.ts"
      provides: "createFeature() that doesn't create worktree"
      contains: "not_started"
  key_links:
    - from: "src/main/storage/feature-store.ts"
      to: "src/main/storage/paths.ts"
      via: "getPendingFeatureDir import"
      pattern: "getPendingFeatureDir"
---

<objective>
Modify feature storage to support features without worktrees by adding a "pending features" storage location.

Purpose: Features in `not_started` status have no worktree yet, so they can't be stored in `.dagent-worktrees/{featureId}/.dagent/`. Create an alternative storage location at `.dagent/features/{featureId}/` for pending features.

Output: Updated storage layer that stores features in `not_started` status separately from worktree-based features.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Prior phase context:
@.planning/phases/v3.2-01-state-machine-foundation/v3.2-01-01-SUMMARY.md

# Source files to modify:
@src/main/storage/paths.ts
@src/main/storage/feature-store.ts
@src/main/ipc/storage-handlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pending feature storage paths</name>
  <files>src/main/storage/paths.ts</files>
  <action>
    Add new path functions for pending features (features without worktrees):

    1. Add `getPendingFeaturesDir(projectRoot: string): string`
       - Returns `{projectRoot}/.dagent/features/`
       - This is where features in `not_started` status are stored

    2. Add `getPendingFeatureDir(projectRoot: string, featureId: string): string`
       - Returns `{projectRoot}/.dagent/features/{featureId}/`

    3. Add `getPendingFeaturePath(projectRoot: string, featureId: string): string`
       - Returns `{projectRoot}/.dagent/features/{featureId}/feature.json`

    4. Add `getPendingDagPath(projectRoot: string, featureId: string): string`
       - Returns `{projectRoot}/.dagent/features/{featureId}/dag.json`

    5. Add `ensurePendingFeaturesDir(projectRoot: string): Promise<void>`
       - Creates the `.dagent/features/` directory if it doesn't exist

    Keep all existing functions unchanged - they're still used for features WITH worktrees.
  </action>
  <verify>npm run typecheck:node passes</verify>
  <done>New path functions exported from paths.ts for pending feature storage</done>
</task>

<task type="auto">
  <name>Task 2: Update FeatureStore.createFeature() to use pending storage</name>
  <files>src/main/storage/feature-store.ts</files>
  <action>
    Modify `createFeature()` method to:

    1. Set initial status to `'not_started'` (not `'planning'`)

    2. REMOVE the worktree creation block entirely:
       - Delete the `getGitManager()` call
       - Delete the `gitManager.createFeatureWorktree(id)` call
       - The worktree will be created later (Phase v3.2-03) when user clicks Start

    3. Store feature in pending location:
       - Import `getPendingFeatureDir`, `getPendingFeaturePath`, `getPendingDagPath` from `./paths`
       - Use `ensurePendingFeaturesDir()` to create the `.dagent/features/` directory
       - Write feature.json to `getPendingFeaturePath(this.projectRoot, id)`
       - Write dag.json to `getPendingDagPath(this.projectRoot, id)`

    4. Update `saveFeature()` to handle pending features:
       - Check if feature status is `'not_started'`
       - If so, save to pending path; otherwise save to worktree path

    5. Update `loadFeature()` to check both locations:
       - First check pending path (for not_started features)
       - Then check worktree path (for features with worktrees)

    6. Update `listFeatures()` to list from BOTH directories:
       - List from `.dagent/features/` (pending features)
       - List from `.dagent-worktrees/` (active features)
       - Combine and deduplicate results

    7. Update `saveDag()` and `loadDag()` similarly to handle both locations

    DO NOT change the initial task creation logic - keep creating the initial task with `needs_analysis` status.
  </action>
  <verify>npm run typecheck:node passes</verify>
  <done>FeatureStore creates features without worktree, stores in pending location</done>
</task>

<task type="auto">
  <name>Task 3: Add moveFeatureToWorktree() method</name>
  <files>src/main/storage/feature-store.ts</files>
  <action>
    Add a new method `moveFeatureToWorktree(featureId: string): Promise<void>` that:

    1. Loads feature from pending location
    2. Verifies feature exists and is in `not_started` status
    3. Creates the worktree directory (doesn't create git worktree - that's separate)
       - Use `fs.mkdir` to create `.dagent-worktrees/{featureId}/.dagent/` directory
    4. Copies feature.json from pending to worktree location
    5. Copies dag.json from pending to worktree location
    6. Deletes the pending feature directory
    7. Updates feature status (caller will do this via FeatureStatusManager)

    This method will be called by Phase v3.2-03 when creating the actual git worktree.

    Also add IPC handler `storage:moveFeatureToWorktree` in storage-handlers.ts.
  </action>
  <verify>npm run typecheck:node passes</verify>
  <done>moveFeatureToWorktree() method exists for migrating pending features to worktree storage</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck:node` passes
- [ ] paths.ts exports all new functions
- [ ] FeatureStore.createFeature() sets status to 'not_started'
- [ ] FeatureStore.createFeature() does NOT call gitManager.createFeatureWorktree()
- [ ] FeatureStore.listFeatures() lists from both pending and worktree directories
</verification>

<success_criteria>
- All tasks completed
- Feature creation no longer creates worktree
- Features in not_started status stored in .dagent/features/
- moveFeatureToWorktree() method ready for Phase v3.2-03
</success_criteria>

<output>
After completion, create `.planning/phases/v3.2-02-non-blocking-creation/v3.2-02-01-SUMMARY.md`
</output>
