---
phase: v3.2-02-non-blocking-creation
plan: 02
type: execute
wave: 2
depends_on: ["v3.2-02-01"]
files_modified:
  - src/renderer/src/App.tsx
  - src/renderer/src/components/Feature/NewFeatureDialog.tsx
  - src/main/ipc/feature-handlers.ts
autonomous: true

must_haves:
  truths:
    - "Feature creation dialog closes immediately after creation"
    - "No loading overlay blocks user during feature creation"
    - "PM planning does NOT start automatically on feature creation"
  artifacts:
    - path: "src/renderer/src/App.tsx"
      provides: "handleCreateFeature without PM planning trigger"
    - path: "src/renderer/src/components/Feature/NewFeatureDialog.tsx"
      provides: "Non-blocking submission flow"
  key_links:
    - from: "App.tsx handleCreateFeature"
      to: "feature-store createFeature"
      via: "simple await without planning"
---

<objective>
Make feature creation truly non-blocking by removing the loading overlay and PM planning trigger.

Purpose: Users should be able to create multiple features rapidly. Planning happens later when Start is clicked.

Output: Instant feature creation that closes dialog immediately and doesn't block UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Prior plan context:
@.planning/phases/v3.2-02-non-blocking-creation/v3.2-02-01-PLAN.md

# Source files to modify:
@src/renderer/src/App.tsx
@src/renderer/src/components/Feature/NewFeatureDialog.tsx
@src/main/ipc/feature-handlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify handleCreateFeature in App.tsx</name>
  <files>src/renderer/src/App.tsx</files>
  <action>
    Simplify the `handleCreateFeature` function to be truly non-blocking:

    1. REMOVE the loading overlay logic:
       - Remove `setIsCreatingFeature(true/false)` calls
       - Remove `setCreationProgress()` calls
       - Remove the entire `useEffect` for worktree progress subscription (no longer needed at creation time)
       - Remove `isCreatingFeature` and `creationProgress` state variables

    2. REMOVE PM planning trigger:
       - Delete the `await window.electronAPI.feature.startPlanning()` call
       - PM planning will be triggered by Start button (Phase v3.2-03)

    3. REMOVE DAGManager initialization during creation:
       - Delete the `await initializeDAGManager()` call
       - DAGManager will be initialized when feature is opened (already happens on feature selection)

    4. Simplify to just:
       ```typescript
       const handleCreateFeature = async (data: FeatureCreateData): Promise<void> => {
         // Create feature (now instant - no worktree)
         const feature = await createFeature(data.name, {
           description: data.description,
           completionAction: data.completionAction,
           autoStart: data.autoStart
         });

         if (feature) {
           // Close dialog
           setNewFeatureDialogOpen(false);

           // Upload attachments if provided (background - don't await)
           if (data.attachments && data.attachments.length > 0) {
             // Store attachments in pending feature directory
             window.electronAPI.feature.uploadAttachments(feature.id, data.attachments)
               .catch(err => console.error('Failed to upload attachments:', err));
           }

           // Switch to Kanban view to see the new feature in Backlog
           setView('kanban');
         }
       };
       ```

    5. Keep attachment upload but make it fire-and-forget (don't await)
       - Attachments can be stored in the pending feature directory

    Note: Do NOT remove the `onWorktreeProgress` subscription entirely - just move it out of App.tsx.
    It will be used in KanbanView (Phase v3.2-03) for the Start button progress.
  </action>
  <verify>npm run typecheck:web passes</verify>
  <done>handleCreateFeature is instant, no loading overlay, no PM planning trigger</done>
</task>

<task type="auto">
  <name>Task 2: Remove creation blocking from NewFeatureDialog</name>
  <files>src/renderer/src/components/Feature/NewFeatureDialog.tsx</files>
  <action>
    The dialog already handles submission state well, but verify it doesn't over-block:

    1. Verify `isSubmitting` state is only used during the actual IPC call
    2. The dialog should close via `onClose()` call from parent (App.tsx) after creation succeeds
    3. No changes may be needed if the parent handles closing correctly

    If the dialog has any delays or waits beyond the store call, remove them.

    The key behavior: Dialog calls `onSubmit(data)`, parent awaits `createFeature()` (now instant), parent calls `onClose()`, dialog closes.
  </action>
  <verify>npm run typecheck:web passes</verify>
  <done>NewFeatureDialog submission is non-blocking</done>
</task>

<task type="auto">
  <name>Task 3: Update uploadAttachments to work with pending features</name>
  <files>src/main/ipc/feature-handlers.ts</files>
  <action>
    The `feature:uploadAttachments` handler currently saves to the worktree directory.
    Update it to save to the pending feature directory for `not_started` features:

    1. Load the feature to check its status
    2. If status is `not_started`, save attachments to `.dagent/features/{featureId}/attachments/`
    3. If status is not `not_started`, save to `.dagent-worktrees/{featureId}/.dagent/attachments/` (existing behavior)

    This requires adding a `getPendingAttachmentsDir()` function to paths.ts (or inline it).

    The attachment paths stored in feature.json should be relative (`attachments/filename.png`) so they work regardless of where the feature is stored.
  </action>
  <verify>npm run typecheck:node passes</verify>
  <done>Attachments can be uploaded to pending features</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes (both node and web)
- [ ] `npm run build` completes successfully
- [ ] App.tsx no longer has isCreatingFeature state
- [ ] App.tsx no longer calls feature.startPlanning on creation
- [ ] Attachments save to correct location based on feature status
</verification>

<success_criteria>
- All tasks completed
- Feature creation dialog closes immediately
- No loading overlay during creation
- PM planning not triggered on creation
- User can create multiple features rapidly
</success_criteria>

<output>
After completion, create `.planning/phases/v3.2-02-non-blocking-creation/v3.2-02-02-SUMMARY.md`
</output>
