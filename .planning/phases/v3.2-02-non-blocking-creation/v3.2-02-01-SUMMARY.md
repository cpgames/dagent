# Plan v3.2-02-01 Summary

## Overview

**Phase:** v3.2-02-non-blocking-creation
**Plan:** 01 - Storage Layer Changes
**Status:** Complete
**Execution Time:** ~10 min

## Objective

Modify feature storage to support features without worktrees by adding a "pending features" storage location at `.dagent/features/{featureId}/` for features in `not_started` status.

## Tasks Completed

### Task 1: Add pending feature storage paths to paths.ts
- **File:** `src/main/storage/paths.ts`
- **Changes:**
  - Added `fs/promises` import for async operations
  - Updated module JSDoc to document dual storage locations
  - Added `getPendingFeaturesDir()` - returns `{projectRoot}/.dagent/features/`
  - Added `getPendingFeatureDir()` - returns `{projectRoot}/.dagent/features/{featureId}/`
  - Added `getPendingFeaturePath()` - returns path to pending feature.json
  - Added `getPendingDagPath()` - returns path to pending dag.json
  - Added `getPendingAttachmentsDir()` - returns path to pending attachments directory
  - Added `ensurePendingFeaturesDir()` - creates `.dagent/features/` if needed

### Task 2: Update FeatureStore.createFeature() for pending storage
- **File:** `src/main/storage/feature-store.ts`
- **Changes:**
  - Removed `getGitManager` import (no longer needed at creation time)
  - Changed initial status from `'planning'` to `'not_started'`
  - Removed worktree creation block entirely (`gitManager.createFeatureWorktree()`)
  - Added pending directory creation via `paths.ensurePendingFeaturesDir()` and `fs.mkdir()`
  - Updated `saveFeature()` to save to pending location for `not_started` features
  - Updated `loadFeature()` to check pending location first, then worktree location
  - Updated `deleteFeature()` to handle both locations
  - Updated `saveDag()` to determine location based on feature status
  - Updated `loadDag()` to check both locations
  - Updated `listFeatures()` to list from both directories using `Set` for deduplication
  - Updated `saveAttachment()`, `listAttachments()`, `deleteAttachment()` for pending features

### Task 3: Add moveFeatureToWorktree() method
- **File:** `src/main/storage/feature-store.ts`
- **Changes:**
  - Added `moveFeatureToWorktree(featureId)` method that:
    - Loads feature from pending location
    - Verifies feature is in `not_started` status
    - Creates worktree `.dagent/` directory structure
    - Copies feature.json, dag.json, and attachments
    - Deletes pending feature directory
  - Added IPC handler `storage:moveFeatureToWorktree` in `storage-handlers.ts`

## Verification Results

- [x] `npm run typecheck:node` passes
- [x] paths.ts exports all new pending feature functions
- [x] FeatureStore.createFeature() sets status to `'not_started'`
- [x] FeatureStore.createFeature() does NOT call gitManager.createFeatureWorktree()
- [x] FeatureStore.listFeatures() lists from both pending and worktree directories

## Files Modified

| File | Lines Changed | Purpose |
|------|--------------|---------|
| `src/main/storage/paths.ts` | +60 | Pending feature path functions |
| `src/main/storage/feature-store.ts` | +150/-30 | Dual storage support + moveFeatureToWorktree |
| `src/main/ipc/storage-handlers.ts` | +10 | IPC handler for moveFeatureToWorktree |

## Key Decisions

1. **Pending location:** `.dagent/features/{featureId}/` chosen to keep pending features separate from worktrees
2. **Status-based routing:** Feature status determines storage location (not_started → pending, others → worktree)
3. **Load order:** Pending location checked first during load operations for faster lookup of new features
4. **Deduplication:** `Set` used in listFeatures to handle edge cases where feature might exist in both locations

## Next Steps

Proceed to Plan v3.2-02-02 for UI non-blocking changes.
