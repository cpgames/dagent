---
phase: v3.0-03-request-building
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/services/session-manager.ts
  - src/main/ipc/session-handlers.ts
  - src/preload/index.d.ts
  - src/preload/index.ts
autonomous: true

must_haves:
  truths:
    - "SessionManager can build complete agent requests from session components"
    - "Request includes all 4 components: agent description + context + checkpoint + messages"
    - "Request preview shows token breakdown by component"
    - "Token estimates are accurate and prevent overflow"
  artifacts:
    - path: "src/main/services/session-manager.ts"
      provides: "Request building methods"
      exports: ["buildRequest", "previewRequest"]
      min_lines: 1000
    - path: "src/main/ipc/session-handlers.ts"
      provides: "IPC handlers for request operations"
      contains: "session:buildRequest"
    - path: "src/preload/index.d.ts"
      provides: "Type definitions for request API"
      contains: "buildRequest"
    - path: "src/preload/index.ts"
      provides: "Preload implementation for request API"
      contains: "buildRequest"
  key_links:
    - from: "src/main/services/session-manager.ts"
      to: "token-estimator.ts"
      via: "uses formatContextAsPrompt, formatCheckpointAsPrompt, formatMessagesAsPrompt"
      pattern: "formatContextAsPrompt|formatCheckpointAsPrompt|formatMessagesAsPrompt"
    - from: "src/main/ipc/session-handlers.ts"
      to: "SessionManager.buildRequest"
      via: "IPC handler calls manager method"
      pattern: "manager\\.buildRequest"
---

<objective>
Implement request building functionality that combines all session components into complete agent prompts ready for Claude Agent SDK.

Purpose: Enable rendering agents to build complete requests with all context (agent description, project context, checkpoint summary, and recent messages) formatted as proper system and user prompts.

Output:
- `buildRequest()` method that assembles complete prompts from session components
- `previewRequest()` method that shows token breakdown before sending
- IPC handlers for request building
- Preload API for renderer integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v3.0-session-checkpoint-ROADMAP.md
@.planning/STATE.md
@.planning/phases/v3.0-02-compaction-engine/02-01-SUMMARY.md
@.planning/phases/v3.0-02-compaction-engine/02-02-SUMMARY.md

# Relevant source files:
@src/main/services/session-manager.ts
@src/main/services/token-estimator.ts
@src/shared/types/session.ts
@src/main/ipc/session-handlers.ts
@src/preload/index.d.ts
@src/preload/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add request building methods to SessionManager</name>
  <files>src/main/services/session-manager.ts</files>
  <action>
Add two new public methods to SessionManager class:

1. **buildRequest(sessionId: string, featureId: string, userMessage: string)**: Returns complete request ready for Agent SDK
   - Load session, chat, checkpoint, context, and agent description
   - Use existing formatContextAsPrompt(), formatCheckpointAsPrompt(), formatMessagesAsPrompt() from token-estimator.ts (import them)
   - Build system prompt by concatenating:
     - Agent description (roleInstructions + toolInstructions)
     - Formatted context
     - Formatted checkpoint (if exists)
     - Formatted messages
   - User prompt is the userMessage parameter
   - Return object with systemPrompt, userPrompt, and totalTokens (use estimateRequest)
   - Throw clear errors if session/components not found

2. **previewRequest(sessionId: string, featureId: string, userMessage?: string)**: Returns request preview with token breakdown
   - Same logic as buildRequest but with detailed breakdown
   - userMessage is optional (defaults to empty string for preview)
   - Return object with systemPrompt, userPrompt, and breakdown object containing:
     - agentDescTokens (from estimateAgentDescriptionTokens)
     - contextTokens (from estimateContextTokens)
     - checkpointTokens (from estimateCheckpointTokens)
     - messagesTokens (from estimateMessagesTokens)
     - userPromptTokens (from estimateTokens)
     - total (sum of all)
   - This is useful for debugging and UI display

Implementation details:
- Import formatting functions from token-estimator.ts: formatContextAsPrompt, formatCheckpointAsPrompt, formatMessagesAsPrompt
- Import estimation functions: estimateRequest, estimateAgentDescriptionTokens, estimateContextTokens, estimateCheckpointTokens, estimateMessagesTokens, estimateTokens
- Both methods are async and public
- Place methods in a new "Request Building" section after "Archive Operations" section (around line 730)
- Use consistent error handling with descriptive messages
- Agent description formatting: join roleInstructions + "\n\n" + toolInstructions (if exists)
  </action>
  <verify>npm run build succeeds with no TypeScript errors</verify>
  <done>SessionManager has buildRequest() and previewRequest() methods that compile without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add IPC handlers for request building</name>
  <files>src/main/ipc/session-handlers.ts, src/preload/index.d.ts, src/preload/index.ts</files>
  <action>
**session-handlers.ts:**
Add two new IPC handlers in the appropriate section:

```typescript
ipcMain.handle(
  'session:buildRequest',
  async (
    _event,
    projectRoot: string,
    sessionId: string,
    featureId: string,
    userMessage: string
  ): Promise<{
    systemPrompt: string
    userPrompt: string
    totalTokens: number
  }> => {
    const manager = getSessionManager(projectRoot)
    return await manager.buildRequest(sessionId, featureId, userMessage)
  }
)

ipcMain.handle(
  'session:previewRequest',
  async (
    _event,
    projectRoot: string,
    sessionId: string,
    featureId: string,
    userMessage?: string
  ): Promise<{
    systemPrompt: string
    userPrompt: string
    breakdown: {
      agentDescTokens: number
      contextTokens: number
      checkpointTokens: number
      messagesTokens: number
      userPromptTokens: number
      total: number
    }
  }> => {
    const manager = getSessionManager(projectRoot)
    return await manager.previewRequest(sessionId, featureId, userMessage)
  }
)
```

**preload/index.d.ts:**
Extend SessionAPI interface with new methods:

```typescript
buildRequest: (
  projectRoot: string,
  sessionId: string,
  featureId: string,
  userMessage: string
) => Promise<{
  systemPrompt: string
  userPrompt: string
  totalTokens: number
}>

previewRequest: (
  projectRoot: string,
  sessionId: string,
  featureId: string,
  userMessage?: string
) => Promise<{
  systemPrompt: string
  userPrompt: string
  breakdown: {
    agentDescTokens: number
    contextTokens: number
    checkpointTokens: number
    messagesTokens: number
    userPromptTokens: number
    total: number
  }
}>
```

**preload/index.ts:**
Implement both methods in session object:

```typescript
buildRequest: (
  projectRoot: string,
  sessionId: string,
  featureId: string,
  userMessage: string
): Promise<any> =>
  ipcRenderer.invoke('session:buildRequest', projectRoot, sessionId, featureId, userMessage),

previewRequest: (
  projectRoot: string,
  sessionId: string,
  featureId: string,
  userMessage?: string
): Promise<any> =>
  ipcRenderer.invoke('session:previewRequest', projectRoot, sessionId, featureId, userMessage)
```

Place these in the existing session object after the compaction methods.
  </action>
  <verify>npm run build succeeds, IPC handlers registered, preload API matches types</verify>
  <done>IPC handlers and preload API for buildRequest and previewRequest work without errors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds with no errors
- [ ] SessionManager has buildRequest() and previewRequest() methods
- [ ] IPC handlers registered for session:buildRequest and session:previewRequest
- [ ] Preload API exposes both methods with correct signatures
- [ ] All imports resolved correctly
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript compilation errors
- buildRequest() returns complete request with systemPrompt + userPrompt + totalTokens
- previewRequest() returns request with detailed token breakdown
- IPC integration complete for renderer access
</success_criteria>

<output>
After completion, create `.planning/phases/v3.0-03-request-building/03-01-SUMMARY.md`
</output>
