---
phase: 101-enhanced-feature-dialog
plan: 01
type: execute
wave: 2
depends_on: ["100-01"]
files_modified:
  - src/renderer/src/components/Feature/NewFeatureDialog.tsx
  - src/renderer/src/components/Feature/NewFeatureDialog.css
  - src/shared/types/feature.ts
  - src/main/storage/feature-store.ts
  - src/main/ipc/feature-handlers.ts
  - src/renderer/src/stores/feature-store.ts
autonomous: true

must_haves:
  truths:
    - "Feature creation dialog has multi-line description textarea"
    - "User can attach files during feature creation"
    - "Feature creation dialog has auto-merge checkbox"
    - "Duplicate feature names are rejected with inline error"
    - "Empty descriptions are allowed"
    - "Feature data includes description, attachments, autoMerge fields"
  artifacts:
    - path: "src/shared/types/feature.ts"
      provides: "Updated Feature interface with new fields"
      contains: "description?"
      exports: ["Feature"]
    - path: "src/renderer/src/components/Feature/NewFeatureDialog.tsx"
      provides: "Enhanced dialog with all new fields"
      min_lines: 200
      contains: "textarea"
    - path: "src/main/storage/feature-store.ts"
      provides: "File attachment storage support"
      contains: "attachments"
  key_links:
    - from: "src/renderer/src/components/Feature/NewFeatureDialog.tsx"
      to: "window.electronAPI.storage.createFeature"
      via: "passes description, attachments, autoMerge"
      pattern: "createFeature"
    - from: "src/main/ipc/feature-handlers.ts"
      to: "FeatureStore.createFeature"
      via: "handles new fields"
      pattern: "createFeature"
---

<objective>
Add description, file attachments, auto-merge, and validation to feature creation.

Purpose: Enable users to provide rich context (description, files) upfront and configure auto-merge behavior during feature creation.
Output: Enhanced NewFeatureDialog component, updated Feature type, file storage system, and unique name validation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v2.9-create-feature-workflow.md
@.planning/phases/100-feature-status-system/100-01-SUMMARY.md
@src/renderer/src/components/Feature/NewFeatureDialog.tsx
@src/shared/types/feature.ts
@src/main/storage/feature-store.ts
@src/renderer/src/stores/feature-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Feature type with new fields</name>
  <files>src/shared/types/feature.ts</files>
  <action>
    Add new optional fields to Feature interface:
    - description?: string (optional multi-line text)
    - attachments?: string[] (optional array of file paths relative to feature directory)
    - autoMerge?: boolean (optional, defaults to false if not provided)

    These fields are optional because:
    - Description: Simple features may not need detailed descriptions
    - Attachments: Not all features need files
    - AutoMerge: User preference, defaults to false for safety

    Why: These fields extend the Feature model to support rich context.
    Avoid: Do not make description required - PM agent should handle missing descriptions.
  </action>
  <verify>npm run build succeeds</verify>
  <done>Feature interface includes description?, attachments?, autoMerge? fields</done>
</task>

<task type="auto">
  <name>Task 2: Implement file storage for feature attachments</name>
  <files>src/main/storage/feature-store.ts, src/main/ipc/feature-handlers.ts</files>
  <action>
    **In feature-store.ts**:
    - Add saveAttachment(featureId: string, fileName: string, fileBuffer: Buffer): Promise<string> method
    - Store attachments in `.dagent/features/{featureId}/attachments/` directory
    - Return relative path: `attachments/{fileName}`
    - Add listAttachments(featureId: string): Promise<string[]> method to list all attachments

    **In feature-handlers.ts**:
    - Add IPC handler: ipcMain.handle('feature:saveAttachment', (event, featureId, fileName, fileBuffer) => ...)
    - Handler calls featureStore.saveAttachment(featureId, fileName, fileBuffer)
    - Return the saved file path

    **Preload API**:
    - Expose window.electronAPI.feature.saveAttachment in preload script
    - Signature: saveAttachment(featureId: string, fileName: string, fileBuffer: ArrayBuffer): Promise<string>

    Why: Feature attachments need secure server-side storage, not just in-memory handling.
    Avoid: Do not validate file types (accept all formats: images, md, csv, pdf, etc.).
  </action>
  <verify>
    npm run build succeeds
    No TypeScript errors in feature-store.ts or feature-handlers.ts
  </verify>
  <done>File attachment storage methods exist and are exposed via IPC</done>
</task>

<task type="auto">
  <name>Task 3: Enhance NewFeatureDialog with all new fields</name>
  <files>src/renderer/src/components/Feature/NewFeatureDialog.tsx, src/renderer/src/components/Feature/NewFeatureDialog.css</files>
  <action>
    **Update NewFeatureDialog component**:

    **State additions**:
    - description: string (for textarea)
    - attachments: File[] (for file picker)
    - autoMerge: boolean (for checkbox)
    - uniqueNameError: boolean (for duplicate name validation)

    **New UI fields**:
    1. **Description textarea**:
       - Add after name input
       - Multi-line textarea (4-5 rows)
       - Placeholder: "Describe the feature (optional)"
       - Optional field, no validation required

    2. **File attachment input**:
       - Add drag-and-drop zone + file picker button
       - Accept all file types (images, .md, .csv, .pdf, etc.)
       - Display list of selected files with remove button
       - Store File objects in state

    3. **Auto-merge checkbox**:
       - Add at bottom of form
       - Label: "Auto-merge when completed"
       - Unchecked by default
       - Helper text: "Automatically create PR/merge when feature is complete"

    **Validation additions**:
    - Check for duplicate names before submitting
    - Call new window.electronAPI.storage.featureExists(name) method
    - If exists, show inline error: "A feature with this name already exists"
    - Display error under name input (similar to existing "Feature name is required")

    **Submit handler**:
    - Upload attachments to server via window.electronAPI.feature.saveAttachment
    - Get attachment paths from upload responses
    - Pass name, description, attachments, autoMerge to onSubmit callback
    - onSubmit signature changes to: onSubmit(data: {name, description?, attachments?, autoMerge?})

    **CSS updates** (NewFeatureDialog.css):
    - Add styles for textarea (.new-feature-dialog__textarea)
    - Add styles for file drop zone (.new-feature-dialog__dropzone)
    - Add styles for file list (.new-feature-dialog__file-list)
    - Add styles for checkbox (.new-feature-dialog__checkbox)
    - Match synthwave theme (purple/cyan accents)

    Why: All new fields in one dialog update for cohesive UX.
    Avoid: Do not trigger PM agent here (that's Phase 98).
  </action>
  <verify>
    npm run build succeeds
    Dialog renders without TypeScript errors
  </verify>
  <done>NewFeatureDialog includes description textarea, file attachments, auto-merge checkbox, and unique name validation</done>
</task>

<task type="auto">
  <name>Task 4: Update createFeature to handle new fields</name>
  <files>src/main/storage/feature-store.ts, src/main/ipc/feature-handlers.ts, src/renderer/src/stores/feature-store.ts</files>
  <action>
    **In feature-store.ts (main)**:
    - Update createFeature signature: createFeature(name: string, options?: {description?: string, attachments?: string[], autoMerge?: boolean})
    - Set description, attachments, autoMerge fields on Feature object
    - Set status to 'planning' (using new status from Phase 100)
    - Feature validation: Check if feature with same name already exists
    - If exists, throw error: "Feature with this name already exists"

    **In feature-handlers.ts**:
    - Update IPC handler for storage:createFeature to accept new options parameter
    - Pass options to featureStore.createFeature(name, options)

    **In feature-store.ts (renderer)**:
    - Update createFeature method signature to accept options object
    - Update IPC call to pass options: window.electronAPI.storage.createFeature(name, options)
    - Add featureExists method that calls window.electronAPI.storage.featureExists(name)

    **Preload API**:
    - Update storage.createFeature signature in preload
    - Add storage.featureExists(name): Promise<boolean> method

    Why: Backend must handle new fields and enforce unique names.
    Avoid: Do not start PM agent automatically yet (that's Phase 98).
  </action>
  <verify>
    npm run build succeeds
    No TypeScript errors
    Feature creation accepts new fields
  </verify>
  <done>createFeature handles description, attachments, autoMerge, and validates unique names</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds with no TypeScript errors
- [ ] Feature interface has description?, attachments?, autoMerge? fields
- [ ] File attachment storage methods exist in FeatureStore
- [ ] NewFeatureDialog has description textarea, file picker, and auto-merge checkbox
- [ ] Duplicate feature name validation works with inline error display
- [ ] createFeature accepts and stores new fields
- [ ] Features are created with 'planning' status (not 'not_started')
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Enhanced dialog provides rich context capture for PM agent (Phase 98)
</success_criteria>

<output>
After completion, create `.planning/phases/101-enhanced-feature-dialog/101-01-SUMMARY.md`
</output>
