---
phase: 50-queue-based-pools
plan: 01
type: execute
---

<objective>
Restructure TaskPoolManager to use queue-based pools as workflow queues.

Purpose: Make pools the single source of truth for task state, with clear assignment queues (ready_for_dev, ready_for_qa, ready_for_merge) that the orchestrator monitors for work.
Output: Updated TaskPoolManager with new pool structure and updated TaskStatus type.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v2.2-ROADMAP.md

**Key files:**
@src/main/dag-engine/task-pool.ts
@src/shared/types/task.ts
@src/main/dag-engine/task-controller.ts

**Current pool structure (7 pools):**
- blocked, ready, dev, qa, merging, completed, failed

**New pool structure (7 pools, renamed for clarity):**
- blocked (unchanged - waiting on dependencies)
- ready_for_dev (was: ready - tasks ready for dev agent assignment)
- in_progress (NEW - nominal, tracks all active work: dev/qa/merge combined)
- ready_for_qa (was implicit in state machine - tasks ready for QA review)
- ready_for_merge (was implicit - tasks that passed QA, ready for merge)
- completed (unchanged - done)
- failed (unchanged - error state)

**Key insight:** The orchestrator only cares about "ready_for_*" queues. The in_progress pool is nominal tracking only.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TaskStatus type with queue-based states</name>
  <files>src/shared/types/task.ts</files>
  <action>
Update TaskStatus type to use queue-based naming:
- Keep: 'blocked', 'completed', 'failed'
- Rename: 'ready' → 'ready_for_dev'
- Add: 'ready_for_qa', 'ready_for_merge'
- Change: 'dev', 'qa', 'merging' → 'in_progress'

The new type should be:
```typescript
export type TaskStatus =
  | 'blocked'           // Waiting on dependencies
  | 'ready_for_dev'     // Ready for dev agent assignment
  | 'in_progress'       // Being worked on (dev, qa, or merge)
  | 'ready_for_qa'      // Dev complete, ready for QA review
  | 'ready_for_merge'   // QA passed, ready for merge
  | 'completed'         // Done
  | 'failed';           // Error state
```

This is a breaking change - other files will need updates in subsequent tasks.
  </action>
  <verify>npx tsc --noEmit shows errors in expected files (task-pool.ts, task-controller.ts, orchestrator.ts)</verify>
  <done>TaskStatus type updated with queue-based naming</done>
</task>

<task type="auto">
  <name>Task 2: Update TaskPoolManager with new pool structure</name>
  <files>src/main/dag-engine/task-pool.ts</files>
  <action>
Update TaskPoolManager to use the new pool names:

1. Update pools Map initialization:
```typescript
private pools: Map<TaskStatus, Set<string>> = new Map([
  ['blocked', new Set()],
  ['ready_for_dev', new Set()],
  ['in_progress', new Set()],
  ['ready_for_qa', new Set()],
  ['ready_for_merge', new Set()],
  ['completed', new Set()],
  ['failed', new Set()]
])
```

2. Update getCounts() return type to match new TaskStatus values

3. Update getNextTask() priority order:
- Priority: ready_for_merge > ready_for_qa > ready_for_dev
- (Unblocks dependents fastest by prioritizing merge)

4. Update JSDoc comments to reflect new pool semantics:
- Assignment queues: ready_for_dev, ready_for_qa, ready_for_merge
- Terminal pools: completed, failed
- Tracking pools: blocked, in_progress

Note: Don't change moveTask() signature - it's generic and works with any status.
  </action>
  <verify>npx tsc --noEmit on task-pool.ts compiles without errors</verify>
  <done>TaskPoolManager uses new queue-based pool structure</done>
</task>

<task type="auto">
  <name>Task 3: Update task-controller transitions for new states</name>
  <files>src/main/dag-engine/task-controller.ts</files>
  <action>
Update the task state machine to use new status names:

1. Update VALID_TRANSITIONS map:
```typescript
const VALID_TRANSITIONS: Record<TaskStatus, Partial<Record<TaskEvent, TaskStatus>>> = {
  blocked: {
    UNBLOCKED: 'ready_for_dev'
  },
  ready_for_dev: {
    AGENT_ASSIGNED: 'in_progress'
  },
  in_progress: {
    DEV_COMPLETE: 'ready_for_qa',
    QA_PASSED: 'ready_for_merge',
    MERGE_SUCCESS: 'completed',
    TASK_FAILED: 'failed',
    MERGE_FAILED: 'failed',
    QA_FAILED: 'in_progress'  // QA failed stays in_progress (dev rework)
  },
  ready_for_qa: {
    QA_STARTED: 'in_progress'
  },
  ready_for_merge: {
    MERGE_STARTED: 'in_progress'
  },
  completed: {},
  failed: {
    RETRY: 'ready_for_dev'
  }
}
```

Note: The transition from in_progress on QA_FAILED loops back to in_progress because dev agent picks it back up. The orchestrator tracks the specific work phase internally.

2. Update TaskEvent type if needed to include QA_STARTED and MERGE_STARTED

3. Update any helper functions that reference old status names
  </action>
  <verify>npx tsc --noEmit on task-controller.ts compiles without errors</verify>
  <done>Task state machine updated for queue-based transitions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes for task-pool.ts
- [ ] `npx tsc --noEmit` passes for task-controller.ts
- [ ] TaskStatus type has 7 values: blocked, ready_for_dev, in_progress, ready_for_qa, ready_for_merge, completed, failed
- [ ] TaskPoolManager initializes 7 pools with correct names
- [ ] getNextTask() uses correct priority order
</verification>

<success_criteria>
- TaskStatus type updated with queue-based naming
- TaskPoolManager pools renamed to match workflow queues
- Task state machine transitions updated
- TypeScript compiles without errors in modified files
- Note: orchestrator.ts will have compile errors - fixed in 50-02-PLAN.md
</success_criteria>

<output>
After completion, create `.planning/phases/50-queue-based-pools/50-01-SUMMARY.md`
</output>
