---
phase: 44-qa-agent
plan: 01
title: QA Agent Core Implementation
subsystem: agent
tags: [qa-agent, code-review, state-transitions]

# Dependency graph
requires:
  - phase: 42-task-state-refactor
    plan: 02
    provides: TaskStatus with dev/qa states, qaFeedback field
  - phase: 43-pool-management
    plan: 01
    provides: TaskPoolManager with qa pool tracking
provides:
  - QAAgent class with code review capability
  - QA review prompt builder
  - State transition: qa → merging (pass), qa → dev (fail)
affects: [44-02, 45-communication-refactor]

# Research requirements
research:
  needed: false
---

<objective>
Create QA Agent class that reviews code changes against task spec and provides feedback.

Purpose: QA Agent verifies code quality and spec compliance before merge. On failure, provides concise feedback so dev agent can fix issues.

Output: QAAgent class with autonomous code review capability.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/42-task-state-refactor/42-02-SUMMARY.md
@.planning/phases/43-pool-management/43-01-SUMMARY.md

# Key files:
@src/main/agents/task-agent.ts
@src/main/agents/merge-agent.ts
@src/main/agents/task-types.ts
@src/main/dag-engine/state-machine.ts
@src/shared/types/task.ts

**Tech stack available:**
- TaskStatus: 'blocked' | 'ready' | 'dev' | 'qa' | 'merging' | 'completed' | 'failed'
- State transitions: DEV_COMPLETE (dev→qa), QA_PASSED (qa→merging), QA_FAILED (qa→dev)
- Task.qaFeedback field for storing QA feedback
- AgentService with RequestPriority.QA (P3)
- AgentPool for agent registration

**Established patterns:**
- Agent structure: EventEmitter, state object, config, factory function, registry
- Agent lifecycle: initialize → execute → cleanup
- MessageBus for inter-agent communication
- SDK streaming with tool presets

**Constraining decisions:**
- Phase 42: QA is autonomous (no harness communication)
- Phase 42: QA_FAILED transitions back to dev for rework
- Pool priority: merging > qa > ready
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QA Agent Types</name>
  <files>src/main/agents/qa-types.ts</files>
  <action>
Create QA agent type definitions following the pattern from task-types.ts:

1. **QAAgentStatus** - Internal status enum:
   - 'initializing'
   - 'loading_context'
   - 'reviewing'
   - 'completed'
   - 'failed'

2. **QAAgentState** - State interface:
   - status: QAAgentStatus
   - agentId: string | null
   - featureId: string
   - taskId: string
   - worktreePath: string | null
   - reviewResult: QAReviewResult | null
   - error: string | null
   - startedAt: string | null
   - completedAt: string | null

3. **QAReviewResult** - Review outcome:
   - passed: boolean
   - feedback?: string (only when !passed)
   - filesReviewed: string[]

4. **QAAgentConfig** - Configuration:
   - autoReview: boolean (default: true)

5. **DEFAULT_QA_AGENT_STATE** - Initial state object
6. **DEFAULT_QA_AGENT_CONFIG** - Default config
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit -p tsconfig.node.json`</verify>
  <done>QA agent types defined, TypeScript compiles successfully</done>
</task>

<task type="auto">
  <name>Task 2: Create QA Agent Class</name>
  <files>src/main/agents/qa-agent.ts</files>
  <action>
Create QAAgent class following MergeAgent pattern (simpler than TaskAgent since QA is autonomous):

1. **Constructor** - Initialize with featureId, taskId

2. **initialize(taskTitle: string, taskDescription: string, worktreePath: string)** - Set up agent:
   - Register with AgentPool (type: 'qa')
   - Store task context for review
   - Set worktreePath for git diff access
   - Return boolean success

3. **execute()** - Perform code review:
   - Build review prompt (task spec + code changes)
   - Query SDK with toolPreset 'qaAgent', priority RequestPriority.QA
   - Parse response for PASS/FAIL + feedback
   - Store result in state.reviewResult
   - Return QAReviewResult

4. **buildReviewPrompt()** - Create prompt:
   ```
   # Code Review Request

   ## Task Specification
   **Title:** {title}
   **Description:** {description}

   ## Your Review Criteria
   1. Does the code implement what the task specified?
   2. Are there any obvious bugs or issues?
   3. Does the code follow reasonable patterns?

   ## Instructions
   Use git diff to see what changed, then respond:
   - PASSED if code meets spec and has no obvious issues
   - FAILED with brief, actionable feedback if issues found

   Format:
   QA_RESULT: [PASSED|FAILED]
   FEEDBACK: [only if FAILED - 1-3 bullet points]
   ```

5. **parseReviewResponse(response: string)** - Extract result:
   - Look for "QA_RESULT: PASSED" or "QA_RESULT: FAILED"
   - Extract FEEDBACK section if present
   - Default to FAILED if unparseable

6. **getState()**, **getStatus()** - State accessors

7. **cleanup()** - Release from AgentPool

Add factory function: `createQAAgent(featureId, taskId)`
Add registry: `registerQAAgent`, `getQAAgent`, `removeQAAgent`, `getAllQAAgents`, `clearQAAgents`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit -p tsconfig.node.json`</verify>
  <done>QAAgent class created with review capability, compiles successfully</done>
</task>

<task type="auto">
  <name>Task 3: Add QA Tool Preset</name>
  <files>src/main/agent/agent-service.ts</files>
  <action>
Add 'qaAgent' to the tool presets following existing pattern:

1. Add 'qaAgent' to ToolPreset type union

2. Add qaAgent case in getToolsForPreset():
   - Include: Read, Grep, Glob (for code review)
   - Include: Bash (for git diff commands)
   - Exclude: Write, Edit (QA is read-only)

3. Add permission mode handling for qaAgent (same as mergeAgent - acceptEdits for safety)

The QA agent needs to:
- Read files to understand changes
- Run `git diff` to see what changed
- Search codebase for patterns
- NOT modify any files
  </action>
  <verify>TypeScript compiles: `npm run build`</verify>
  <done>qaAgent tool preset added, build succeeds</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] TypeScript compilation passes
- [ ] QAAgent class exists with initialize, execute, cleanup methods
- [ ] QA types defined in qa-types.ts
- [ ] qaAgent tool preset available in agent-service.ts
</verification>

<success_criteria>

- QAAgent class created following established agent patterns
- QA review prompt designed for pass/fail with feedback
- Tool preset restricts QA to read-only operations
- All verification checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/44-qa-agent/44-01-SUMMARY.md` following the summary template.
</output>
