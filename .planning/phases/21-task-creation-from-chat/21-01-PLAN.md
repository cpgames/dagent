# Phase 21 Plan 01: PM Agent Task Creation Tool

**Goal**: Add task creation skill/tool to enable PM Agent to create tasks via Feature Chat

**Depends on**: Phase 20 complete (AgentsView, agent-store, agent configs)

## Context

Per v1.4-ROADMAP.md Phase 21, the PM Agent should be able to create tasks when users request via Feature Chat. This plan implements the PM Agent tools infrastructure and the `createTask` tool.

**Current state (after Phase 20):**
- ChatPanel uses Agent SDK with tool presets (featureChat: Read/Glob/Grep)
- Agent configs stored per-project with PM Agent defined
- dag-store has addNode method for adding tasks
- No PM-specific tools available

**Target state:**
- PM Agent has access to `createTask` tool via Agent SDK
- Tool creates tasks with title, description, and position
- Tasks appear immediately in DAG view
- Tool integrates with dag-store persistence and history

## Tasks

### Task 1: Define PM Agent tool types

**File**: `src/shared/types/pm-tools.ts` (NEW)

1. Create types for PM Agent tools:
   ```typescript
   /**
    * PM Agent tool types for task management
    */

   /**
    * Input for creating a task
    */
   export interface CreateTaskInput {
     title: string
     description: string
     // Optional position (defaults to automatic placement)
     positionX?: number
     positionY?: number
   }

   /**
    * Result of task creation
    */
   export interface CreateTaskResult {
     success: boolean
     taskId?: string
     error?: string
   }

   /**
    * Input for listing tasks
    */
   export interface ListTasksInput {
     featureId?: string // Optional filter
   }

   /**
    * Result of listing tasks
    */
   export interface ListTasksResult {
     tasks: Array<{
       id: string
       title: string
       status: string
       description: string
     }>
   }
   ```

2. Export from `src/shared/types/index.ts`

**Verification**: Types compile without errors

### Task 2: Create PM Agent tools IPC handlers

**File**: `src/main/ipc/pm-tools-handlers.ts` (NEW)

1. Create handlers for PM Agent operations:
   ```typescript
   import { ipcMain } from 'electron'
   import { getStorage } from '../storage'
   import type { CreateTaskInput, CreateTaskResult, ListTasksResult, Task, DAGGraph } from '@shared/types'
   import { v4 as uuidv4 } from 'uuid'

   let currentFeatureId: string | null = null

   /**
    * Set the feature context for PM tool operations
    */
   export function setPMToolsFeatureContext(featureId: string | null): void {
     currentFeatureId = featureId
   }

   /**
    * Calculate next available position for a new task
    */
   function calculateNextPosition(dag: DAGGraph): { x: number; y: number } {
     if (dag.nodes.length === 0) {
       return { x: 100, y: 100 }
     }

     // Find rightmost and bottommost positions
     let maxX = 0
     let maxY = 0
     for (const node of dag.nodes) {
       if (node.position.x > maxX) maxX = node.position.x
       if (node.position.y > maxY) maxY = node.position.y
     }

     // Place new task below existing tasks
     return { x: 100, y: maxY + 150 }
   }

   export function registerPMToolsHandlers(): void {
     // Create a new task
     ipcMain.handle('pm-tools:createTask', async (_event, input: CreateTaskInput): Promise<CreateTaskResult> => {
       if (!currentFeatureId) {
         return { success: false, error: 'No feature selected' }
       }

       try {
         const storage = getStorage()

         // Load current DAG
         const dag = await storage.loadDag(currentFeatureId)
         if (!dag) {
           return { success: false, error: 'DAG not found' }
         }

         // Calculate position
         const position = input.positionX !== undefined && input.positionY !== undefined
           ? { x: input.positionX, y: input.positionY }
           : calculateNextPosition(dag)

         // Create new task
         const newTask: Task = {
           id: uuidv4(),
           title: input.title,
           description: input.description,
           status: dag.nodes.length === 0 ? 'ready' : 'blocked', // First task is ready
           locked: false,
           position
         }

         // Add to DAG
         dag.nodes.push(newTask)

         // Save DAG
         await storage.saveDag(currentFeatureId, dag)

         return { success: true, taskId: newTask.id }
       } catch (error) {
         return { success: false, error: error instanceof Error ? error.message : 'Unknown error' }
       }
     })

     // List all tasks for current feature
     ipcMain.handle('pm-tools:listTasks', async (): Promise<ListTasksResult> => {
       if (!currentFeatureId) {
         return { tasks: [] }
       }

       try {
         const storage = getStorage()
         const dag = await storage.loadDag(currentFeatureId)

         if (!dag) {
           return { tasks: [] }
         }

         return {
           tasks: dag.nodes.map(node => ({
             id: node.id,
             title: node.title,
             status: node.status,
             description: node.description
           }))
         }
       } catch {
         return { tasks: [] }
       }
     })
   }
   ```

2. Register in `src/main/ipc/handlers.ts`:
   ```typescript
   import { registerPMToolsHandlers, setPMToolsFeatureContext } from './pm-tools-handlers'

   // In registerAllHandlers:
   registerPMToolsHandlers()
   ```

**Verification**: IPC handlers register without errors

### Task 3: Add PM tools to preload API

**File**: `src/preload/index.ts`

1. Add PM tools methods:
   ```typescript
   pmTools: {
     createTask: (input: CreateTaskInput): Promise<CreateTaskResult> =>
       ipcRenderer.invoke('pm-tools:createTask', input),
     listTasks: (): Promise<ListTasksResult> =>
       ipcRenderer.invoke('pm-tools:listTasks')
   }
   ```

2. Update type declarations in `src/preload/index.d.ts`:
   ```typescript
   import type { CreateTaskInput, CreateTaskResult, ListTasksResult } from '@shared/types'

   export interface PMToolsAPI {
     createTask: (input: CreateTaskInput) => Promise<CreateTaskResult>
     listTasks: () => Promise<ListTasksResult>
   }

   // Add to ElectronAPI:
   pmTools: PMToolsAPI
   ```

**Verification**: window.electronAPI.pmTools available

### Task 4: Add pmAgent tool preset to tool-config

**File**: `src/main/agent/tool-config.ts`

1. Add pmAgent preset with createTask and listTasks:
   ```typescript
   export const TOOL_PRESETS = {
     // ... existing presets

     // PM Agent - task management tools
     pmAgent: ['Read', 'Glob', 'Grep', 'CreateTask', 'ListTasks'],
   } as const
   ```

2. Update ToolPreset type to include 'pmAgent'

**Verification**: getToolsForPreset('pmAgent') returns correct tools

### Task 5: Create custom tool handlers for Agent SDK

**File**: `src/main/agent/pm-tool-handlers.ts` (NEW)

1. Create tool handlers that integrate with IPC:
   ```typescript
   import type { CreateTaskInput, CreateTaskResult, ListTasksResult } from '@shared/types'

   /**
    * PM Agent custom tool definitions for Agent SDK
    * These wrap the IPC handlers for use in SDK queries
    */

   export interface PMToolHandler {
     name: string
     description: string
     inputSchema: Record<string, unknown>
     handler: (input: unknown) => Promise<unknown>
   }

   // Handler registry - populated when agent starts
   let createTaskHandler: ((input: CreateTaskInput) => Promise<CreateTaskResult>) | null = null
   let listTasksHandler: (() => Promise<ListTasksResult>) | null = null

   export function setCreateTaskHandler(handler: (input: CreateTaskInput) => Promise<CreateTaskResult>): void {
     createTaskHandler = handler
   }

   export function setListTasksHandler(handler: () => Promise<ListTasksResult>): void {
     listTasksHandler = handler
   }

   export const PM_TOOLS: PMToolHandler[] = [
     {
       name: 'CreateTask',
       description: 'Create a new task in the current feature DAG. Use this when the user asks to add a task, create a task, or add something to the task list.',
       inputSchema: {
         type: 'object',
         properties: {
           title: {
             type: 'string',
             description: 'The title of the task (required)'
           },
           description: {
             type: 'string',
             description: 'Detailed description of what the task should accomplish (required)'
           }
         },
         required: ['title', 'description']
       },
       handler: async (input: unknown): Promise<CreateTaskResult> => {
         if (!createTaskHandler) {
           return { success: false, error: 'CreateTask handler not initialized' }
         }
         return createTaskHandler(input as CreateTaskInput)
       }
     },
     {
       name: 'ListTasks',
       description: 'List all tasks in the current feature DAG. Use this to understand what tasks already exist before creating new ones.',
       inputSchema: {
         type: 'object',
         properties: {},
         required: []
       },
       handler: async (): Promise<ListTasksResult> => {
         if (!listTasksHandler) {
           return { tasks: [] }
         }
         return listTasksHandler()
       }
     }
   ]
   ```

**Verification**: PM_TOOLS exported with correct schema

### Task 6: Update chat-store to use pmAgent preset for Feature Chat

**File**: `src/renderer/src/stores/chat-store.ts`

1. Update sendToAgent to use pmAgent preset when talking to PM:
   ```typescript
   // In sendToAgent, update toolPreset selection:
   // Get agent config to determine which preset to use
   const agentRole = 'pm' // Feature chat uses PM agent

   // Use pmAgent preset for task management capabilities
   await window.electronAPI.sdkAgent.query({
     prompt,
     systemPrompt: systemPrompt || undefined,
     toolPreset: 'pmAgent', // Changed from 'featureChat'
     permissionMode: 'acceptEdits',
     cwd: projectRoot
   })
   ```

2. Connect tool handlers via IPC before query:
   ```typescript
   // Before starting query, set up PM tool handlers
   // The IPC handlers will be invoked by SDK when tools are called
   ```

**Verification**: Feature Chat uses pmAgent tools

### Task 7: Sync DAG after tool creates task

**File**: `src/renderer/src/stores/chat-store.ts`

1. Add DAG refresh after agent completes:
   ```typescript
   import { useDAGStore } from './dag-store'
   import { useFeatureStore } from './feature-store'

   // In sendToAgent, after 'done' event:
   } else if (event.type === 'done') {
     // ... existing finalization code ...

     // Refresh DAG to show any new tasks created by PM agent
     const dagStore = useDAGStore.getState()
     const featureStore = useFeatureStore.getState()
     if (featureStore.selectedFeatureId) {
       dagStore.loadDag(featureStore.selectedFeatureId)
     }

     unsubscribe()
   }
   ```

**Verification**: New tasks appear in DAG view after PM creates them

## Verification Checklist

- [ ] pm-tools types export from @shared/types
- [ ] PM tools IPC handlers registered
- [ ] preload exposes pmTools API
- [ ] pmAgent tool preset includes CreateTask, ListTasks
- [ ] Feature Chat uses pmAgent preset
- [ ] User asks "create a task" and PM agent calls CreateTask
- [ ] New task appears in DAG view after creation
- [ ] TypeScript compiles without errors
- [ ] npm run typecheck passes

## Files Changed

**Created:**
- `src/shared/types/pm-tools.ts`
- `src/main/ipc/pm-tools-handlers.ts`
- `src/main/agent/pm-tool-handlers.ts`

**Modified:**
- `src/shared/types/index.ts`
- `src/main/ipc/handlers.ts`
- `src/preload/index.ts`
- `src/preload/index.d.ts`
- `src/main/agent/tool-config.ts`
- `src/renderer/src/stores/chat-store.ts`
