# Phase 21 Plan 02: Intelligent Task Placement with Dependency Inference

**Goal**: Enable PM Agent to intelligently suggest and set task dependencies based on context

**Depends on**: Plan 21-01 (PM Agent tools, CreateTask IPC)

## Context

Plan 21-01 establishes the basic CreateTask tool. This plan adds intelligent dependency inference so new tasks are automatically connected to relevant existing tasks based on their descriptions and the codebase context.

**Current state (after 21-01):**
- PM Agent can create tasks via CreateTask tool
- Tasks created without dependencies (isolated nodes)
- No analysis of task relationships

**Target state:**
- CreateTask accepts optional suggestedDependencies
- PM Agent analyzes existing tasks and suggests dependencies
- AddDependency tool for explicit dependency creation
- Tasks placed in DAG with correct connections

## Tasks

### Task 1: Extend CreateTaskInput with dependency support

**File**: `src/shared/types/pm-tools.ts`

1. Add dependency fields to CreateTaskInput:
   ```typescript
   export interface CreateTaskInput {
     title: string
     description: string
     positionX?: number
     positionY?: number
     // Dependency inference
     dependsOn?: string[] // Task IDs this task depends on
   }
   ```

2. Add AddDependency types:
   ```typescript
   /**
    * Input for adding a dependency between tasks
    */
   export interface AddDependencyInput {
     fromTaskId: string // Task that must complete first
     toTaskId: string   // Task that depends on fromTaskId
   }

   /**
    * Result of adding a dependency
    */
   export interface AddDependencyResult {
     success: boolean
     error?: string
   }

   /**
    * Input for getting task details
    */
   export interface GetTaskInput {
     taskId: string
   }

   /**
    * Result with full task details
    */
   export interface GetTaskResult {
     task: {
       id: string
       title: string
       status: string
       description: string
       dependencies: string[] // IDs of tasks this depends on
       dependents: string[]   // IDs of tasks that depend on this
     } | null
     error?: string
   }
   ```

**Verification**: Types compile and export correctly

### Task 2: Update CreateTask handler to support dependencies

**File**: `src/main/ipc/pm-tools-handlers.ts`

1. Modify createTask handler to accept and process dependencies:
   ```typescript
   ipcMain.handle('pm-tools:createTask', async (_event, input: CreateTaskInput): Promise<CreateTaskResult> => {
     if (!currentFeatureId) {
       return { success: false, error: 'No feature selected' }
     }

     try {
       const storage = getStorage()
       const dag = await storage.loadDag(currentFeatureId)
       if (!dag) {
         return { success: false, error: 'DAG not found' }
       }

       // Calculate position based on dependencies
       const position = calculatePosition(dag, input)

       // Determine initial status based on dependencies
       let status: TaskStatus = 'ready'
       if (input.dependsOn && input.dependsOn.length > 0) {
         // Check if all dependencies are completed
         const allDepsCompleted = input.dependsOn.every(depId => {
           const dep = dag.nodes.find(n => n.id === depId)
           return dep && dep.status === 'completed'
         })
         status = allDepsCompleted ? 'ready' : 'blocked'
       } else if (dag.nodes.length > 0) {
         // No explicit deps but other tasks exist - default blocked
         status = 'blocked'
       }

       const newTask: Task = {
         id: uuidv4(),
         title: input.title,
         description: input.description,
         status,
         locked: false,
         position
       }

       dag.nodes.push(newTask)

       // Add connections for dependencies
       if (input.dependsOn) {
         for (const depId of input.dependsOn) {
           // Verify dependency exists
           if (dag.nodes.find(n => n.id === depId)) {
             dag.connections.push({
               from: depId,
               to: newTask.id
             })
           }
         }
       }

       await storage.saveDag(currentFeatureId, dag)
       return { success: true, taskId: newTask.id }
     } catch (error) {
       return { success: false, error: error instanceof Error ? error.message : 'Unknown error' }
     }
   })
   ```

2. Add smart position calculation:
   ```typescript
   function calculatePosition(dag: DAGGraph, input: CreateTaskInput): { x: number; y: number } {
     // If position explicitly provided, use it
     if (input.positionX !== undefined && input.positionY !== undefined) {
       return { x: input.positionX, y: input.positionY }
     }

     // Empty DAG - start at origin
     if (dag.nodes.length === 0) {
       return { x: 100, y: 100 }
     }

     // If has dependencies, position below them
     if (input.dependsOn && input.dependsOn.length > 0) {
       let maxY = 0
       let avgX = 0
       let count = 0

       for (const depId of input.dependsOn) {
         const dep = dag.nodes.find(n => n.id === depId)
         if (dep) {
           if (dep.position.y > maxY) maxY = dep.position.y
           avgX += dep.position.x
           count++
         }
       }

       return {
         x: count > 0 ? avgX / count : 100,
         y: maxY + 150
       }
     }

     // No dependencies - place at bottom
     let maxY = 0
     for (const node of dag.nodes) {
       if (node.position.y > maxY) maxY = node.position.y
     }
     return { x: 100, y: maxY + 150 }
   }
   ```

**Verification**: Tasks with dependencies have correct connections

### Task 3: Add AddDependency IPC handler

**File**: `src/main/ipc/pm-tools-handlers.ts`

1. Add handler for adding dependencies:
   ```typescript
   ipcMain.handle('pm-tools:addDependency', async (_event, input: AddDependencyInput): Promise<AddDependencyResult> => {
     if (!currentFeatureId) {
       return { success: false, error: 'No feature selected' }
     }

     try {
       const storage = getStorage()
       const dag = await storage.loadDag(currentFeatureId)
       if (!dag) {
         return { success: false, error: 'DAG not found' }
       }

       // Verify both tasks exist
       const fromTask = dag.nodes.find(n => n.id === input.fromTaskId)
       const toTask = dag.nodes.find(n => n.id === input.toTaskId)

       if (!fromTask) {
         return { success: false, error: `Task ${input.fromTaskId} not found` }
       }
       if (!toTask) {
         return { success: false, error: `Task ${input.toTaskId} not found` }
       }

       // Check for existing connection
       const exists = dag.connections.some(
         c => c.from === input.fromTaskId && c.to === input.toTaskId
       )
       if (exists) {
         return { success: false, error: 'Dependency already exists' }
       }

       // Check for cycle (simple check - would create reverse path)
       const wouldCreateCycle = dag.connections.some(
         c => c.from === input.toTaskId && c.to === input.fromTaskId
       )
       if (wouldCreateCycle) {
         return { success: false, error: 'Would create circular dependency' }
       }

       // Add connection
       dag.connections.push({
         from: input.fromTaskId,
         to: input.toTaskId
       })

       // Update toTask status if fromTask not completed
       if (fromTask.status !== 'completed') {
         const toIndex = dag.nodes.findIndex(n => n.id === input.toTaskId)
         if (toIndex >= 0 && dag.nodes[toIndex].status === 'ready') {
           dag.nodes[toIndex].status = 'blocked'
         }
       }

       await storage.saveDag(currentFeatureId, dag)
       return { success: true }
     } catch (error) {
       return { success: false, error: error instanceof Error ? error.message : 'Unknown error' }
     }
   })
   ```

2. Add getTask handler for dependency analysis:
   ```typescript
   ipcMain.handle('pm-tools:getTask', async (_event, input: GetTaskInput): Promise<GetTaskResult> => {
     if (!currentFeatureId) {
       return { task: null, error: 'No feature selected' }
     }

     try {
       const storage = getStorage()
       const dag = await storage.loadDag(currentFeatureId)
       if (!dag) {
         return { task: null, error: 'DAG not found' }
       }

       const task = dag.nodes.find(n => n.id === input.taskId)
       if (!task) {
         return { task: null, error: 'Task not found' }
       }

       // Find dependencies and dependents
       const dependencies = dag.connections
         .filter(c => c.to === input.taskId)
         .map(c => c.from)

       const dependents = dag.connections
         .filter(c => c.from === input.taskId)
         .map(c => c.to)

       return {
         task: {
           id: task.id,
           title: task.title,
           status: task.status,
           description: task.description,
           dependencies,
           dependents
         }
       }
     } catch (error) {
       return { task: null, error: error instanceof Error ? error.message : 'Unknown error' }
     }
   })
   ```

**Verification**: Dependencies can be added between existing tasks

### Task 4: Update preload with new PM tools

**File**: `src/preload/index.ts`

1. Add new tool methods:
   ```typescript
   pmTools: {
     createTask: (input: CreateTaskInput): Promise<CreateTaskResult> =>
       ipcRenderer.invoke('pm-tools:createTask', input),
     listTasks: (): Promise<ListTasksResult> =>
       ipcRenderer.invoke('pm-tools:listTasks'),
     addDependency: (input: AddDependencyInput): Promise<AddDependencyResult> =>
       ipcRenderer.invoke('pm-tools:addDependency', input),
     getTask: (input: GetTaskInput): Promise<GetTaskResult> =>
       ipcRenderer.invoke('pm-tools:getTask', input)
   }
   ```

2. Update `src/preload/index.d.ts`:
   ```typescript
   export interface PMToolsAPI {
     createTask: (input: CreateTaskInput) => Promise<CreateTaskResult>
     listTasks: () => Promise<ListTasksResult>
     addDependency: (input: AddDependencyInput) => Promise<AddDependencyResult>
     getTask: (input: GetTaskInput) => Promise<GetTaskResult>
   }
   ```

**Verification**: All PM tools exposed via preload

### Task 5: Add PM tools to Agent SDK custom tools

**File**: `src/main/agent/pm-tool-handlers.ts`

1. Add AddDependency and GetTask tool definitions:
   ```typescript
   export const PM_TOOLS: PMToolHandler[] = [
     // CreateTask (from 21-01)
     {
       name: 'CreateTask',
       description: 'Create a new task in the current feature DAG. Use this when the user asks to add a task. You can specify dependencies using dependsOn with task IDs from ListTasks.',
       inputSchema: {
         type: 'object',
         properties: {
           title: {
             type: 'string',
             description: 'The title of the task'
           },
           description: {
             type: 'string',
             description: 'Detailed description of what the task should accomplish'
           },
           dependsOn: {
             type: 'array',
             items: { type: 'string' },
             description: 'Array of task IDs that must complete before this task can start'
           }
         },
         required: ['title', 'description']
       },
       handler: async (input: unknown): Promise<CreateTaskResult> => {
         if (!createTaskHandler) {
           return { success: false, error: 'Handler not initialized' }
         }
         return createTaskHandler(input as CreateTaskInput)
       }
     },

     // ListTasks (from 21-01)
     {
       name: 'ListTasks',
       description: 'List all tasks in the current feature. ALWAYS call this before CreateTask to understand existing tasks and determine dependencies.',
       inputSchema: {
         type: 'object',
         properties: {},
         required: []
       },
       handler: async (): Promise<ListTasksResult> => {
         if (!listTasksHandler) return { tasks: [] }
         return listTasksHandler()
       }
     },

     // AddDependency (new)
     {
       name: 'AddDependency',
       description: 'Add a dependency between two existing tasks. The fromTaskId must complete before toTaskId can start.',
       inputSchema: {
         type: 'object',
         properties: {
           fromTaskId: {
             type: 'string',
             description: 'ID of the task that must complete first'
           },
           toTaskId: {
             type: 'string',
             description: 'ID of the task that depends on fromTaskId'
           }
         },
         required: ['fromTaskId', 'toTaskId']
       },
       handler: async (input: unknown): Promise<AddDependencyResult> => {
         if (!addDependencyHandler) {
           return { success: false, error: 'Handler not initialized' }
         }
         return addDependencyHandler(input as AddDependencyInput)
       }
     },

     // GetTask (new)
     {
       name: 'GetTask',
       description: 'Get detailed information about a specific task including its dependencies and dependents.',
       inputSchema: {
         type: 'object',
         properties: {
           taskId: {
             type: 'string',
             description: 'The ID of the task to retrieve'
           }
         },
         required: ['taskId']
       },
       handler: async (input: unknown): Promise<GetTaskResult> => {
         if (!getTaskHandler) {
           return { task: null, error: 'Handler not initialized' }
         }
         return getTaskHandler(input as GetTaskInput)
       }
     }
   ]
   ```

2. Add handler setters:
   ```typescript
   let addDependencyHandler: ((input: AddDependencyInput) => Promise<AddDependencyResult>) | null = null
   let getTaskHandler: ((input: GetTaskInput) => Promise<GetTaskResult>) | null = null

   export function setAddDependencyHandler(handler: (input: AddDependencyInput) => Promise<AddDependencyResult>): void {
     addDependencyHandler = handler
   }

   export function setGetTaskHandler(handler: (input: GetTaskInput) => Promise<GetTaskResult>): void {
     getTaskHandler = handler
   }
   ```

**Verification**: All PM tools available in pmAgent preset

### Task 6: Update PM Agent system prompt for dependency inference

**File**: `src/shared/types/agent-config.ts`

1. Update PM Agent default instructions:
   ```typescript
   pm: {
     name: 'PM Agent',
     instructions: `You are a project manager agent. Help create and organize tasks in the DAG.

   When asked to create tasks:
   1. ALWAYS call ListTasks first to see existing tasks
   2. Analyze which existing tasks the new task depends on based on:
      - Logical workflow order (setup before implementation)
      - File/module dependencies (data models before API)
      - Explicit mentions ("after X", "once Y is done")
   3. Use the dependsOn field in CreateTask with relevant task IDs
   4. Explain your dependency reasoning to the user

   Example workflow:
   User: "Add a task to implement user login"
   You: [Call ListTasks to see existing tasks]
   You: "I see there's a 'Setup database models' task (id: abc123) and 'Create auth middleware' (id: def456).
         The login feature will need both. I'll create the task with these dependencies."
   You: [Call CreateTask with dependsOn: ["abc123", "def456"]]

   When adding dependencies manually:
   - Use AddDependency to connect existing tasks
   - Prevent circular dependencies
   - Consider transitive dependencies`,
     allowedTools: ['Read', 'Glob', 'Grep', 'CreateTask', 'ListTasks', 'AddDependency', 'GetTask'],
     permissionMode: 'default',
     enabled: true
   }
   ```

**Verification**: PM Agent instructions include dependency guidance

### Task 7: Set feature context for PM tools on chat load

**File**: `src/renderer/src/stores/chat-store.ts`

1. Set PM tools context when loading feature chat:
   ```typescript
   loadChat: async (contextId: string, contextType: ChatContextType = 'feature') => {
     // ... existing code ...

     // Set PM tools feature context for task operations
     if (contextType === 'feature' && window.electronAPI?.pmTools) {
       // Context is set via IPC when loading
       // The main process handler tracks currentFeatureId
     }

     // ... rest of existing code ...
   }
   ```

2. Update pm-tools-handlers to set context from chat context IPC:
   ```typescript
   // In chat-handlers.ts or relevant handler:
   import { setPMToolsFeatureContext } from './pm-tools-handlers'

   // When getContext is called, set the PM tools context
   ipcMain.handle('chat:getContext', async (_event, featureId: string) => {
     // Set PM tools feature context
     setPMToolsFeatureContext(featureId)

     // ... existing context retrieval code ...
   })
   ```

**Verification**: PM tools operate on correct feature

## Verification Checklist

- [ ] CreateTask accepts dependsOn array
- [ ] New tasks connected to specified dependencies
- [ ] Task status correctly set (blocked if deps incomplete)
- [ ] AddDependency creates connections between tasks
- [ ] Circular dependency prevention works
- [ ] GetTask returns dependency information
- [ ] PM Agent lists tasks before creating
- [ ] PM Agent suggests logical dependencies
- [ ] New tasks appear with correct connections in DAG
- [ ] TypeScript compiles without errors
- [ ] npm run typecheck passes

## Files Changed

**Modified:**
- `src/shared/types/pm-tools.ts`
- `src/shared/types/agent-config.ts`
- `src/main/ipc/pm-tools-handlers.ts`
- `src/main/agent/pm-tool-handlers.ts`
- `src/preload/index.ts`
- `src/preload/index.d.ts`
- `src/main/ipc/chat-handlers.ts`

## Example Flow

1. User: "Create a task to add user authentication"
2. PM Agent: [Calls ListTasks]
3. PM Agent sees: "Setup database" (id: a), "Create API routes" (id: b)
4. PM Agent: "I'll create 'Add user authentication'. This should depend on 'Setup database' since auth needs user storage. It should come before 'Create API routes' since the routes need auth middleware."
5. PM Agent: [Calls CreateTask with title, description, dependsOn: ["a"]]
6. PM Agent: [Calls AddDependency with fromTaskId: new-task, toTaskId: "b"]
7. User sees new task in DAG with connections
