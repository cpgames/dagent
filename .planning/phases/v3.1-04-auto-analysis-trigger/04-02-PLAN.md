---
phase: v3.1-04-auto-analysis-trigger
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/main/agent/pm-agent-manager.ts
  - src/main/ipc/feature-handlers.ts
autonomous: true

must_haves:
  truths:
    - "Analysis automatically starts after planning completes when autoAnalyzeNewFeatures is enabled"
    - "Analysis does NOT start when autoAnalyzeNewFeatures is disabled"
    - "Feature moves to backlog only after both planning AND analysis complete"
  artifacts:
    - path: "src/main/agent/pm-agent-manager.ts"
      provides: "Auto-analysis trigger after planning"
      contains: "getTaskAnalysisOrchestrator"
  key_links:
    - from: "src/main/agent/pm-agent-manager.ts"
      to: "src/main/services/task-analysis-orchestrator.ts"
      via: "analysis trigger after planning"
      pattern: "analyzeFeatureTasks"
    - from: "src/main/agent/pm-agent-manager.ts"
      to: "src/main/storage/settings-store.ts"
      via: "autoAnalyzeNewFeatures check"
      pattern: "autoAnalyzeNewFeatures"
---

<objective>
Trigger analysis automatically after feature planning completes.

Purpose: Seamless feature creation → planning → analysis flow when auto-analysis enabled.
Output: Modified PMAgentManager that triggers analysis after spec creation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/v3.1-04-auto-analysis-trigger/04-01-SUMMARY.md

# PMAgentManager that triggers planning:
@src/main/agent/pm-agent-manager.ts

# Analysis orchestrator to trigger:
@src/main/services/task-analysis-orchestrator.ts

# Analysis handlers for event streaming:
@src/main/ipc/analysis-handlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add analysis trigger to PMAgentManager</name>
  <files>src/main/agent/pm-agent-manager.ts</files>
  <action>
1. Import settings store and analysis orchestrator at top:
   ```typescript
   import { getSettingsStore } from '../storage/settings-store'
   import { getTaskAnalysisOrchestrator } from '../services/task-analysis-orchestrator'
   ```

2. After verifyPlanningComplete() succeeds (line ~175 where it says "Planning complete"), add:
   ```typescript
   // Check if auto-analysis is enabled
   const settingsStore = getSettingsStore()
   const autoAnalyze = settingsStore
     ? await settingsStore.get('autoAnalyzeNewFeatures')
     : true // Default to true if store not available

   if (autoAnalyze) {
     console.log(`[PMAgentManager] Auto-analysis enabled, starting analysis for ${featureId}`)

     // Run analysis - iterate through all needs_analysis tasks
     const orchestrator = getTaskAnalysisOrchestrator(this.featureStore)
     try {
       for await (const event of orchestrator.analyzeFeatureTasks(featureId)) {
         console.log(`[PMAgentManager] Analysis event: ${event.type}`)

         // Broadcast analysis events to renderer for UI updates
         const windows = BrowserWindow.getAllWindows()
         for (const win of windows) {
           if (!win.isDestroyed()) {
             win.webContents.send('analysis:event', { featureId, event })
           }
         }

         if (event.type === 'complete') {
           console.log(`[PMAgentManager] Analysis complete for ${featureId}`)
           break
         }
         if (event.type === 'error') {
           console.error(`[PMAgentManager] Analysis error: ${event.error}`)
           // Continue - individual task errors shouldn't stop the process
         }
       }
     } catch (error) {
       console.error(`[PMAgentManager] Analysis failed:`, error)
       // Analysis failure shouldn't prevent feature from going to backlog
     }
   } else {
     console.log(`[PMAgentManager] Auto-analysis disabled, skipping analysis for ${featureId}`)
   }
   ```

3. Move the "Move feature to backlog" and DAG broadcast AFTER analysis completes (still inside the verified block)

4. Update the completion event to reflect both planning and analysis complete
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>PMAgentManager triggers analysis after planning when setting is enabled</done>
</task>

<task type="auto">
  <name>Task 2: Update feature-handlers to initialize settings store</name>
  <files>src/main/ipc/feature-handlers.ts</files>
  <action>
The settings store should already be initialized in main/index.ts from Plan 01, but verify feature-handlers doesn't try to access settings before initialization.

1. Review feature-handlers.ts - no changes needed if settings are accessed only through PMAgentManager

2. If feature:startPlanning handler needs settings access:
   - Import getSettingsStore
   - Pass autoAnalyze setting to PMAgentManager if needed (not required - PMAgentManager reads it directly)

This task may be a no-op if Plan 01 correctly initializes settings before feature handlers run.
  </action>
  <verify>npx tsc --noEmit && npm run build</verify>
  <done>Settings accessible when feature planning starts</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npx tsc --noEmit passes
- [ ] npm run build succeeds
- [ ] PMAgentManager imports and uses getSettingsStore
- [ ] PMAgentManager imports and uses getTaskAnalysisOrchestrator
- [ ] Analysis events broadcast to renderer during auto-analysis
- [ ] Feature moves to backlog after analysis (not just planning)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Auto-analysis triggers after planning when enabled
- Feature workflow: create → planning → analysis → backlog (when auto-analyze on)
- Feature workflow: create → planning → backlog (when auto-analyze off)
</success_criteria>

<output>
After completion, create `.planning/phases/v3.1-04-auto-analysis-trigger/04-02-SUMMARY.md`
</output>
