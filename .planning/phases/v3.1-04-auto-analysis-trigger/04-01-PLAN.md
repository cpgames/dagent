---
phase: v3.1-04-auto-analysis-trigger
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/types/settings.ts
  - src/main/storage/settings-store.ts
  - src/main/ipc/settings-handlers.ts
  - src/preload/index.ts
  - src/preload/index.d.ts
  - src/main/index.ts
autonomous: true

must_haves:
  truths:
    - "Settings can be persisted to disk and loaded on app startup"
    - "autoAnalyzeNewFeatures setting defaults to true"
    - "Settings can be updated via IPC from renderer"
  artifacts:
    - path: "src/shared/types/settings.ts"
      provides: "AppSettings type with autoAnalyzeNewFeatures"
      exports: ["AppSettings"]
    - path: "src/main/storage/settings-store.ts"
      provides: "SettingsStore class for settings persistence"
      exports: ["SettingsStore", "getSettingsStore", "initializeSettingsStore"]
    - path: "src/main/ipc/settings-handlers.ts"
      provides: "IPC handlers for settings operations"
      exports: ["registerSettingsHandlers"]
  key_links:
    - from: "src/main/ipc/settings-handlers.ts"
      to: "src/main/storage/settings-store.ts"
      via: "getSettingsStore()"
      pattern: "getSettingsStore"
    - from: "src/preload/index.ts"
      to: "settings IPC"
      via: "contextBridge exposure"
      pattern: "settings:"
---

<objective>
Create settings infrastructure with auto-analysis setting.

Purpose: Enable persistent app settings with auto-analysis toggle for feature creation workflow.
Output: Settings type, SettingsStore, IPC handlers, preload API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v3.1-task-analysis-orchestrator-ROADMAP.md

# Existing storage pattern:
@src/main/storage/json-store.ts
@src/main/storage/feature-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AppSettings type and SettingsStore</name>
  <files>src/shared/types/settings.ts, src/main/storage/settings-store.ts</files>
  <action>
1. Create `src/shared/types/settings.ts`:
   ```typescript
   export interface AppSettings {
     autoAnalyzeNewFeatures: boolean
   }

   export const DEFAULT_SETTINGS: AppSettings = {
     autoAnalyzeNewFeatures: true
   }
   ```

2. Create `src/main/storage/settings-store.ts`:
   - Import readJson, writeJson from json-store.ts
   - Create SettingsStore class with:
     - constructor(projectRoot: string)
     - getSettingsPath() returns `.dagent/settings.json`
     - async load(): Promise<AppSettings> - returns stored settings merged with defaults
     - async save(settings: AppSettings): Promise<void>
     - async get<K extends keyof AppSettings>(key: K): Promise<AppSettings[K]>
     - async set<K extends keyof AppSettings>(key: K, value: AppSettings[K]): Promise<void>
   - Add singleton pattern: initializeSettingsStore(projectRoot), getSettingsStore()
   - Load merges stored settings with DEFAULT_SETTINGS to handle new settings being added
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>AppSettings type exported, SettingsStore class with CRUD operations, singleton pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create IPC handlers and preload API</name>
  <files>src/main/ipc/settings-handlers.ts, src/preload/index.ts, src/preload/index.d.ts, src/main/index.ts</files>
  <action>
1. Create `src/main/ipc/settings-handlers.ts`:
   ```typescript
   import { ipcMain } from 'electron'
   import { getSettingsStore } from '../storage/settings-store'
   import type { AppSettings } from '@shared/types/settings'

   export function registerSettingsHandlers(): void {
     ipcMain.handle('settings:load', async (): Promise<AppSettings> => {
       const store = getSettingsStore()
       if (!store) throw new Error('Settings store not initialized')
       return store.load()
     })

     ipcMain.handle('settings:save', async (_event, settings: AppSettings): Promise<void> => {
       const store = getSettingsStore()
       if (!store) throw new Error('Settings store not initialized')
       await store.save(settings)
     })

     ipcMain.handle('settings:get', async <K extends keyof AppSettings>(
       _event, key: K
     ): Promise<AppSettings[K]> => {
       const store = getSettingsStore()
       if (!store) throw new Error('Settings store not initialized')
       return store.get(key)
     })

     ipcMain.handle('settings:set', async <K extends keyof AppSettings>(
       _event, key: K, value: AppSettings[K]
     ): Promise<void> => {
       const store = getSettingsStore()
       if (!store) throw new Error('Settings store not initialized')
       await store.set(key, value)
     })
   }
   ```

2. Update `src/preload/index.ts` - add settings namespace to electronAPI:
   ```typescript
   settings: {
     load: (): Promise<AppSettings> => ipcRenderer.invoke('settings:load'),
     save: (settings: AppSettings): Promise<void> => ipcRenderer.invoke('settings:save', settings),
     get: <K extends keyof AppSettings>(key: K): Promise<AppSettings[K]> =>
       ipcRenderer.invoke('settings:get', key),
     set: <K extends keyof AppSettings>(key: K, value: AppSettings[K]): Promise<void> =>
       ipcRenderer.invoke('settings:set', key, value)
   }
   ```

3. Update `src/preload/index.d.ts` - add settings type definitions

4. Update `src/main/index.ts`:
   - Import and call registerSettingsHandlers()
   - Import initializeSettingsStore from settings-store
   - Call initializeSettingsStore(projectRoot) after initializeStorage in the project open handler
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>IPC handlers registered, preload API exposed, settings store initialized on project open</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npx tsc --noEmit passes
- [ ] npm run build succeeds
- [ ] AppSettings type includes autoAnalyzeNewFeatures: boolean
- [ ] DEFAULT_SETTINGS.autoAnalyzeNewFeatures is true
- [ ] SettingsStore can load/save to .dagent/settings.json
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Settings infrastructure ready for use by pm-agent-manager
</success_criteria>

<output>
After completion, create `.planning/phases/v3.1-04-auto-analysis-trigger/04-01-SUMMARY.md`
</output>
