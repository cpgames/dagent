---
phase: v3.0-07-agent-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/agents/harness-agent.ts
  - src/main/agents/harness-types.ts
autonomous: true
must_haves:
  truths:
    - "Harness agent logs activities to SessionManager when sessionId is provided"
    - "Intention reviews saved to session for checkpoint"
    - "Approval/rejection decisions tracked in session"
  artifacts:
    - path: "src/main/agents/harness-agent.ts"
      provides: "SessionManager integration for Harness agent"
      contains: "getSessionManager"
    - path: "src/main/agents/harness-types.ts"
      provides: "sessionId field in Harness state"
      contains: "sessionId"
  key_links:
    - from: "harness-agent.ts"
      to: "session-manager.ts"
      via: "getSessionManager().addMessage()"
      pattern: "getSessionManager"
---

<objective>
Integrate Harness Agent with SessionManager for session logging.

Purpose: Harness agent logs intention reviews, approvals, and rejections to SessionManager, enabling checkpoint tracking of decision history.
Output: Harness agent with sessionId support and SessionManager logging.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v3.0-session-checkpoint-ROADMAP.md
@.planning/phases/v3.0-05-dev-agent-integration/05-02-SUMMARY.md

@src/main/agents/harness-agent.ts
@src/main/agents/harness-types.ts
@src/main/agents/dev-agent.ts (for SessionManager integration pattern)
@src/main/services/session-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sessionId to Harness agent types</name>
  <files>src/main/agents/harness-types.ts</files>
  <action>
    Add sessionId field to HarnessState interface:

    ```typescript
    export interface HarnessState {
      // ... existing fields ...
      sessionId: string | null  // Session ID for SessionManager logging
    }
    ```

    Update DEFAULT_HARNESS_STATE to include:
    ```typescript
    sessionId: null
    ```
  </action>
  <verify>npm run build succeeds, TypeScript compiles</verify>
  <done>HarnessState has sessionId field</done>
</task>

<task type="auto">
  <name>Task 2: Integrate SessionManager into Harness Agent</name>
  <files>src/main/agents/harness-agent.ts</files>
  <action>
    1. Import getSessionManager:
       ```typescript
       import { getSessionManager } from '../services/session-manager'
       ```

    2. Add logToSessionManager helper method:
       ```typescript
       private async logToSessionManager(
         role: 'user' | 'assistant',
         content: string,
         metadata?: Record<string, unknown>
       ): Promise<void> {
         if (!this.state.sessionId) {
           return
         }
         try {
           const sessionManager = getSessionManager()
           await sessionManager.addMessage(
             this.state.sessionId,
             role,
             content,
             metadata
           )
         } catch (error) {
           console.error('[HarnessAgent] Failed to log to session:', error)
         }
       }
       ```

    3. Update key methods to log:
       - initialize(): Log "Harness initialized for feature: {featureId}"
       - receiveIntention(): Log "Intention received from {agentId}: {intention preview}"
       - applyDecision(): Log approval/rejection with decision details
       - completeTask(): Log "Task {taskId} completed"
       - failTask(): Log "Task {taskId} failed: {error}"

    4. Add method to set sessionId:
       ```typescript
       setSessionId(sessionId: string): void {
         this.state.sessionId = sessionId
       }
       ```

    5. Update initialize() to accept optional sessionId parameter:
       ```typescript
       async initialize(
         featureId: string,
         featureGoal: string,
         graph: DAGGraph,
         claudeMd?: string,
         projectRoot?: string,
         sessionId?: string  // Add optional sessionId
       ): Promise<boolean>
       ```
  </action>
  <verify>npm run build succeeds, Harness agent compiles with SessionManager integration</verify>
  <done>Harness agent logs intentions, approvals, and rejections to SessionManager</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] HarnessState has sessionId field
- [ ] HarnessAgent imports getSessionManager
- [ ] HarnessAgent has logToSessionManager helper method
- [ ] Key methods log appropriate events
- [ ] setSessionId() method exists
- [ ] initialize() accepts optional sessionId parameter
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Harness agent follows same SessionManager pattern as DevAgent
</success_criteria>

<output>
After completion, create `.planning/phases/v3.0-07-agent-integration/07-02-SUMMARY.md`
</output>
