---
phase: v3.0-07-agent-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/agents/merge-agent.ts
  - src/main/agents/merge-types.ts
autonomous: true
must_haves:
  truths:
    - "Merge agent logs activities to SessionManager when sessionId is provided"
    - "Merge operations tracked in session for checkpoint"
    - "Conflict analysis and resolution decisions logged to session"
  artifacts:
    - path: "src/main/agents/merge-agent.ts"
      provides: "SessionManager integration for Merge agent"
      contains: "getSessionManager"
    - path: "src/main/agents/merge-types.ts"
      provides: "sessionId field in Merge state"
      contains: "sessionId"
  key_links:
    - from: "merge-agent.ts"
      to: "session-manager.ts"
      via: "getSessionManager().addMessage()"
      pattern: "getSessionManager"
---

<objective>
Integrate Merge Agent with SessionManager for session logging.

Purpose: Merge agent logs branch operations, conflict analysis, and resolutions to SessionManager, enabling checkpoint tracking of merge history.
Output: Merge agent with sessionId support and SessionManager logging.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v3.0-session-checkpoint-ROADMAP.md
@.planning/phases/v3.0-05-dev-agent-integration/05-02-SUMMARY.md

@src/main/agents/merge-agent.ts
@src/main/agents/merge-types.ts
@src/main/agents/dev-agent.ts (for SessionManager integration pattern)
@src/main/services/session-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sessionId to Merge agent types</name>
  <files>src/main/agents/merge-types.ts</files>
  <action>
    Add sessionId field to MergeAgentState interface:

    ```typescript
    export interface MergeAgentState {
      // ... existing fields ...
      sessionId: string | null  // Session ID for SessionManager logging
    }
    ```

    Update DEFAULT_MERGE_AGENT_STATE to include:
    ```typescript
    sessionId: null
    ```
  </action>
  <verify>npm run build succeeds, TypeScript compiles</verify>
  <done>MergeAgentState has sessionId field</done>
</task>

<task type="auto">
  <name>Task 2: Integrate SessionManager into Merge Agent</name>
  <files>src/main/agents/merge-agent.ts</files>
  <action>
    1. Import getSessionManager:
       ```typescript
       import { getSessionManager } from '../services/session-manager'
       ```

    2. Add logToSessionManager helper method:
       ```typescript
       private async logToSessionManager(
         role: 'user' | 'assistant',
         content: string,
         metadata?: Record<string, unknown>
       ): Promise<void> {
         if (!this.state.sessionId) {
           return
         }
         try {
           const sessionManager = getSessionManager()
           await sessionManager.addMessage(
             this.state.sessionId,
             role,
             content,
             metadata
           )
         } catch (error) {
           console.error('[MergeAgent] Failed to log to session:', error)
         }
       }
       ```

    3. Update key methods to log:
       - initialize(): Log "Merge initialized for task: {taskId}"
       - checkBranches(): Log branch status and potential conflicts
       - executeMerge(): Log "Merge started for {taskBranch} â†’ {featureBranch}"
       - analyzeConflicts(): Log conflict analysis results
       - On completion: Log "Merge completed successfully" or "Merge failed: {error}"

    4. Add method to set sessionId:
       ```typescript
       setSessionId(sessionId: string): void {
         this.state.sessionId = sessionId
       }
       ```

    5. Update constructor to accept optional sessionId:
       ```typescript
       constructor(featureId: string, taskId: string, sessionId?: string) {
         super()
         this.state = {
           ...DEFAULT_MERGE_AGENT_STATE,
           featureId,
           taskId,
           sessionId: sessionId || null
         }
       }
       ```
  </action>
  <verify>npm run build succeeds, Merge agent compiles with SessionManager integration</verify>
  <done>Merge agent logs merge operations, conflicts, and resolutions to SessionManager</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] MergeAgentState has sessionId field
- [ ] MergeAgent imports getSessionManager
- [ ] MergeAgent has logToSessionManager helper method
- [ ] Key methods log appropriate events
- [ ] setSessionId() method exists
- [ ] Constructor accepts optional sessionId parameter
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Merge agent follows same SessionManager pattern as DevAgent
</success_criteria>

<output>
After completion, create `.planning/phases/v3.0-07-agent-integration/07-03-SUMMARY.md`
</output>
