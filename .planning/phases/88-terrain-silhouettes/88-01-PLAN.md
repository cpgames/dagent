---
phase: 88-terrain-silhouettes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/src/components/Background/layers/TerrainLayer.ts
  - src/renderer/src/components/Background/layers/index.ts
autonomous: true

must_haves:
  truths:
    - "Terrain silhouettes render as black shapes with parallax motion"
    - "Multiple terrain layers move at different speeds (parallax depth)"
    - "Optional cyan glow visible on terrain edges"
  artifacts:
    - path: "src/renderer/src/components/Background/layers/TerrainLayer.ts"
      provides: "TerrainLayer class implementing Layer interface"
      min_lines: 80
      exports: ["TerrainLayer"]
    - path: "src/renderer/src/components/Background/layers/index.ts"
      provides: "Barrel export for TerrainLayer"
      contains: "export { TerrainLayer }"
  key_links:
    - from: "TerrainLayer.ts"
      to: "Layer interface"
      via: "implements Layer"
      pattern: "implements Layer"
---

<objective>
Create TerrainLayer class that renders parallax mountain/city silhouettes with optional cyan edge glow.

Purpose: Add depth and visual interest to the canvas background with terrain silhouettes that move at different speeds creating a parallax effect.
Output: TerrainLayer class exported from layers barrel, ready for integration into UnifiedCanvas in Phase 89.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v2.7-ROADMAP.md
@.planning/REQUIREMENTS.md

# Prior phase context
@.planning/phases/87-shooting-stars-layer/87-01-SUMMARY.md
@.planning/phases/86-grid-layer-integration/86-01-SUMMARY.md

# Layer interface and existing implementations
@src/renderer/src/components/Background/layers/types.ts
@src/renderer/src/components/Background/layers/GridLayer.ts
@src/renderer/src/components/Background/layers/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TerrainLayer class</name>
  <files>src/renderer/src/components/Background/layers/TerrainLayer.ts</files>
  <action>
Create TerrainLayer class implementing the Layer interface with 2-3 parallax terrain layers:

**Structure:**
- Import Layer and LayerContext from './types'
- Class TerrainLayer implements Layer
- Internal TerrainProfile interface: { points: number[], scrollSpeed: number, opacity: number }

**Configuration constants:**
- NUM_LAYERS = 3 (near, mid, far terrain layers)
- Scroll speeds: near = 0.02, mid = 0.015, far = 0.01 (slower = further away)
- CYAN_GLOW = '#00f0ff' (matches grid color)
- GLOW_WIDTH = 2 (pixels of cyan glow on top edge)

**State:**
- profiles: TerrainProfile[] (stores each layer's data)
- scrollOffsets: number[] (one per layer, updated in update())
- width: number, height: number (stored from LayerContext)

**init(ctx, context):**
- Store width and height from context
- Initialize scrollOffsets array to [0, 0, 0]
- Generate 3 terrain profiles using generateTerrainProfile():
  - Near layer (index 0): 30-40 points, opacity 0.9, scrollSpeed 0.02
  - Mid layer (index 1): 25-35 points, opacity 0.6, scrollSpeed 0.015
  - Far layer (index 2): 20-30 points, opacity 0.3, scrollSpeed 0.01
  - Each profile starts and ends at bottom of canvas for seamless wrap

**generateTerrainProfile(numPoints, baseHeight, variation):**
- Create array of y-coordinates representing terrain height
- baseHeight = 0.7 to 0.85 (proportion of canvas height, varies by layer)
- variation = 0.1 to 0.2 (how much terrain varies from baseHeight)
- Use Math.sin() and Math.random() for varied terrain peaks/valleys
- Ensure first and last points match for seamless wrapping

**update(deltaTime):**
- For each layer, increment scrollOffsets[i] by deltaTime * profiles[i].scrollSpeed
- Wrap scrollOffset using modulo width (scrollOffsets[i] %= width)

**render(ctx, context):**
- For each terrain layer (far to near, so near renders on top):
  - Set fillStyle to `rgba(0, 0, 0, ${profile.opacity})` (black silhouette)
  - Begin path, move to bottom-left corner
  - Draw terrain profile points with scroll offset applied:
    - For each point in profile.points, calculate x = (pointIndex / numPoints) * width - scrollOffset
    - Draw both the visible segment and wrapped segment (x + width) for seamless scrolling
  - Close path by drawing to bottom-right corner and back to start
  - Fill the terrain shape
  - Optional cyan glow on top edge:
    - Set strokeStyle to CYAN_GLOW, lineWidth to GLOW_WIDTH, globalAlpha to 0.5
    - Stroke just the top edge of the terrain profile
    - Reset globalAlpha to 1.0

**reset():**
- Reset all scrollOffsets to 0

**Why this approach:**
- Multiple layers with different scroll speeds create parallax depth effect
- Black silhouettes with varying opacity create layered depth
- Cyan glow adds synthwave aesthetic and helps separate terrain from background
- Seamless wrapping ensures terrain scrolls infinitely without gaps
- Using y-coordinates array (not bezier) allows varied terrain shapes (mountains, buildings)
  </action>
  <verify>npm run build succeeds with no TypeScript errors</verify>
  <done>
- TerrainLayer class exists and implements Layer interface
- init() generates 3 terrain profiles with different scroll speeds
- update() increments scroll offsets with delta time
- render() draws 3 black silhouette layers with parallax motion
- Optional cyan glow renders on terrain top edges
- reset() method resets scroll offsets
  </done>
</task>

<task type="auto">
  <name>Task 2: Export TerrainLayer from barrel</name>
  <files>src/renderer/src/components/Background/layers/index.ts</files>
  <action>
Add TerrainLayer export to the layers barrel file:
- Add line: `export { TerrainLayer } from './TerrainLayer';`
- Maintain alphabetical order (TerrainLayer goes after StarsLayer)
- Preserve existing exports (GridLayer, HorizonGlowLayer, ShootingStarsLayer, SkyLayer, StarsLayer, Layer type, LayerContext type)
  </action>
  <verify>npm run build succeeds, import { TerrainLayer } from './layers' resolves correctly</verify>
  <done>
- TerrainLayer export added to index.ts
- Alphabetical order maintained
- All existing exports preserved
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds with no errors
- [ ] TerrainLayer class implements Layer interface (init, update, render, reset methods)
- [ ] Class generates 3 terrain profiles with different scroll speeds
- [ ] Export added to layers/index.ts barrel file
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- TerrainLayer class ready for integration into UnifiedCanvas
- No TypeScript errors or build failures
- Layer follows established pattern from GridLayer, ShootingStarsLayer
  </success_criteria>

<output>
After completion, create `.planning/phases/88-terrain-silhouettes/88-01-SUMMARY.md`
</output>
