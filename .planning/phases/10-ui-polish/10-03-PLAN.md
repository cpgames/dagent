---
phase: 10-ui-polish
plan: 03
type: execute
---

<objective>
Add dirty state tracking to ContextView with unsaved changes warning.

Purpose: Users must not accidentally lose their work when switching views or closing the app.
Output: ContextView tracks changes, shows unsaved indicator, and warns before discarding changes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./10-03-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior plan:**
@.planning/phases/10-ui-polish/10-02-PLAN.md

**Key files:**
@src/renderer/src/views/ContextView.tsx
@src/renderer/src/App.tsx
@src/renderer/src/stores/feature-store.ts

**Current state:**
- ContextView uses local state for content
- No comparison with saved content
- No dirty indicator
- No warning when switching views/features
- Content loads fresh each time view mounts

**Patterns established:**
- Views receive selectedFeature from App.tsx
- Feature switching triggers state updates
- Dialog components have confirmation patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dirty state tracking to ContextView</name>
  <files>src/renderer/src/views/ContextView.tsx</files>
  <action>
Add state to track original content and dirty status:

```typescript
const [originalContent, setOriginalContent] = useState('')
const [isDirty, setIsDirty] = useState(false)
```

When content loads (in useEffect or initial load):
```typescript
setOriginalContent(loadedContent)
setContent(loadedContent)
setIsDirty(false)
```

Update setContent calls to also update isDirty:
```typescript
const handleContentChange = (newContent: string) => {
  setContent(newContent)
  setIsDirty(newContent !== originalContent)
}
```

After successful save:
```typescript
setOriginalContent(content)
setIsDirty(false)
```
  </action>
  <verification>
- isDirty is true when content differs from original
- isDirty resets after save
- isDirty resets when content is restored to original
  </verification>
</task>

<task type="auto">
  <name>Task 2: Show unsaved changes indicator in ContextView header</name>
  <files>src/renderer/src/views/ContextView.tsx</files>
  <action>
Add a visual indicator next to the header or save button when isDirty is true:

In the header area, add an unsaved indicator:
```tsx
<div className="flex items-center gap-2">
  <h2 className="text-lg font-semibold">CLAUDE.md Context</h2>
  {isDirty && (
    <span className="text-xs bg-yellow-600 text-yellow-100 px-2 py-0.5 rounded">
      Unsaved
    </span>
  )}
</div>
```

Also update the save button to emphasize when dirty:
```tsx
<button
  className={`px-3 py-1.5 rounded text-sm font-medium ${
    isDirty
      ? 'bg-blue-600 hover:bg-blue-700 text-white'
      : 'bg-neutral-700 text-neutral-300'
  } disabled:opacity-50`}
  disabled={isSaving || !isDirty}
  onClick={handleSave}
>
```

Note: Disable save button when not dirty (nothing to save).
  </action>
  <verification>
- "Unsaved" badge appears when content is modified
- Save button is highlighted when there are changes
- Save button is disabled when there are no changes
  </verification>
</task>

<task type="auto">
  <name>Task 3: Add confirmation dialog for discarding changes</name>
  <files>src/renderer/src/views/ContextView.tsx</files>
  <action>
Add state for confirmation dialog:
```typescript
const [showDiscardDialog, setShowDiscardDialog] = useState(false)
const [pendingFeatureId, setPendingFeatureId] = useState<string | null>(null)
```

Create a simple confirmation dialog component inline or as a separate component:
```tsx
{showDiscardDialog && (
  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div className="bg-neutral-800 rounded-lg p-6 max-w-md">
      <h3 className="text-lg font-semibold mb-2">Unsaved Changes</h3>
      <p className="text-neutral-300 mb-4">
        You have unsaved changes. Do you want to discard them?
      </p>
      <div className="flex justify-end gap-2">
        <button
          className="px-3 py-1.5 rounded bg-neutral-700 hover:bg-neutral-600"
          onClick={() => setShowDiscardDialog(false)}
        >
          Cancel
        </button>
        <button
          className="px-3 py-1.5 rounded bg-red-600 hover:bg-red-700"
          onClick={handleDiscardChanges}
        >
          Discard
        </button>
      </div>
    </div>
  </div>
)}
```
  </action>
  <verification>
- Dialog appears when attempting to discard changes
- Cancel keeps changes intact
- Discard proceeds with navigation
  </verification>
</task>

<task type="auto">
  <name>Task 4: Warn on feature change when dirty</name>
  <files>src/renderer/src/views/ContextView.tsx</files>
  <action>
Handle feature changes by checking dirty state first:

Add a useEffect that watches for feature changes:
```typescript
const prevFeatureRef = useRef(selectedFeature?.id)

useEffect(() => {
  if (selectedFeature?.id !== prevFeatureRef.current) {
    if (isDirty) {
      // Show confirmation before switching
      setPendingFeatureId(selectedFeature?.id || null)
      setShowDiscardDialog(true)
    } else {
      // Safe to switch, load new content
      loadContent()
      prevFeatureRef.current = selectedFeature?.id
    }
  }
}, [selectedFeature?.id, isDirty])
```

Add handleDiscardChanges function:
```typescript
const handleDiscardChanges = () => {
  setShowDiscardDialog(false)
  setIsDirty(false)
  prevFeatureRef.current = pendingFeatureId
  loadContent() // Load the new feature's content
  setPendingFeatureId(null)
}
```
  </action>
  <verification>
- Switching features with unsaved changes shows warning
- Can cancel to stay on current feature
- Can discard to switch features
  </verification>
</task>

<task type="auto">
  <name>Task 5: Add beforeunload handler for browser/Electron close</name>
  <files>src/renderer/src/views/ContextView.tsx</files>
  <action>
Add a beforeunload event listener to warn when closing with unsaved changes:

```typescript
useEffect(() => {
  const handleBeforeUnload = (e: BeforeUnloadEvent) => {
    if (isDirty) {
      e.preventDefault()
      e.returnValue = '' // Required for Chrome
      return '' // Required for other browsers
    }
  }

  window.addEventListener('beforeunload', handleBeforeUnload)
  return () => window.removeEventListener('beforeunload', handleBeforeUnload)
}, [isDirty])
```

This will show the browser's native "Leave site?" dialog when closing with unsaved changes.
  </action>
  <verification>
- Closing app with unsaved changes shows browser warning
- Can stay to save changes
- Warning doesn't appear when content is saved
  </verification>
</task>

</tasks>
