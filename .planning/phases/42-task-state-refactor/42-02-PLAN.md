---
phase: 42-task-state-refactor
plan: 02
title: Agent Status Updates and QA Feedback
subsystem: agent
tags: [task-agent, merge-agent, qa-feedback, status-updates]

# Dependency graph
requires:
  - phase: 42-task-state-refactor
    plan: 01
    provides: TaskStatus with dev/qa states, new events
provides:
  - qaFeedback field on Task type
  - TaskAgent uses 'dev' state and DEV_COMPLETE event
  - MergeAgent checks for 'merging' state correctly
  - All agents use new state vocabulary
affects: [43-pool-management, 44-qa-agent]

# Research requirements
research:
  needed: false
---

# Phase 42 Plan 02: Agent Status Updates and QA Feedback

## Objective

Update all agents to use the new task states and add the qaFeedback field to the Task type for the QA agent feedback loop.

## Current State

**TaskAgent status values (`src/main/agents/task-types.ts`):**
- Uses internal statuses: `initializing`, `loading_context`, `proposing_intention`, `awaiting_approval`, `approved`, `working`, `ready_for_merge`, `completed`, `failed`

**Task type (`src/shared/types/task.ts`):**
- No qaFeedback field

**TaskController/Cascade:**
- Check for `'running'` state which no longer exists

## Tasks

### Task 1: Add qaFeedback Field to Task Type

**Files:** `src/shared/types/task.ts`

**Changes:**
1. Add optional `qaFeedback` field to Task interface:
```typescript
export interface Task {
  id: string;
  title: string;
  description: string;
  status: TaskStatus;
  locked: boolean;
  position: TaskPosition;
  qaFeedback?: string; // Feedback from QA agent when task fails QA
}
```

**Verification:** TypeScript compilation check

---

### Task 2: Update References to 'running' State

**Files:**
- `src/main/dag-engine/task-controller.ts`
- `src/main/dag-engine/cascade.ts`
- `src/renderer/src/components/DAG/TaskNode.tsx` (if applicable)

**Search for:** All references to `'running'` literal string in the codebase

**Changes:**
1. In `initializeTaskStatuses()`: Replace `'running'` with `'dev'` in the skip check
2. In `recalculateAllStatuses()`: Replace `'running'` with `'dev'` and add `'qa'` to skip check
3. Update any UI components that check for `'running'` state

**Verification:** `grep -r "'running'" src/` should only show intentional uses

---

### Task 3: Update TaskAgent Internal Status Comments

**Files:** `src/main/agents/task-types.ts`, `src/main/agents/task-agent.ts`

**Changes:**
1. Update comments/documentation to reference `'dev'` state instead of `'running'`
2. The TaskAgent internal statuses (`TaskAgentStatus`) remain as-is - they're internal to the agent
3. Add comment explaining the mapping: TaskAgent `'working'` â†’ Task `'dev'` state

**Verification:** Documentation accuracy check

---

### Task 4: Verify State References in UI Components

**Files:** `src/renderer/src/components/**/*.tsx`

**Search for:** References to task status literals

**Changes:**
1. Ensure no UI component references `'running'` state
2. Update any status displays to handle `'dev'` and `'qa'` states appropriately
3. Update status color mapping if needed (existing code may need 'dev' and 'qa' colors)

**Verification:**
- `grep -r "running" src/renderer/`
- TypeScript compilation check

---

### Task 5: Build and Verify

**Command:** `npm run build`

**Verification:**
1. Full build succeeds without errors
2. No TypeScript errors related to TaskStatus
3. Search confirms no stale 'running' references

## Verification

```bash
# Check for stale references
grep -r "'running'" src/main src/shared src/renderer --include="*.ts" --include="*.tsx"

# TypeScript check
npx tsc --noEmit

# Full build
npm run build
```

## Commit

```
feat(42-02): add qaFeedback field and update state references

- Add qaFeedback field to Task interface for QA feedback loop
- Replace 'running' with 'dev' in state checks
- Add 'qa' to active state skip lists
- Update UI components for new state vocabulary
```
