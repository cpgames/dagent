---
phase: 42-task-state-refactor
plan: 01
title: Task State Type and Transition Rules
subsystem: dag-engine
tags: [state-machine, types, transitions, cascade]

# Dependency graph
requires:
  - phase: 41-request-manager
    plan: 02
    provides: RequestManager integration complete
provides:
  - TaskStatus type with dev/qa states
  - Updated VALID_TRANSITIONS table
  - New transition events (DEV_COMPLETE, QA_PASSED, QA_FAILED)
  - Cascade logic updated for new states
affects: [42-02, 43-pool-management, 44-qa-agent]

# Research requirements
research:
  needed: false
---

# Phase 42 Plan 01: Task State Type and Transition Rules

## Objective

Update the TaskStatus type and state machine to support the granular pipeline states (dev, qa) needed for the QA agent feedback loop.

## Current State

**TaskStatus type (`src/shared/types/task.ts:1`):**
```typescript
export type TaskStatus = 'blocked' | 'ready' | 'running' | 'merging' | 'completed' | 'failed';
```

**Current transitions (`src/main/dag-engine/state-machine.ts:36-51`):**
- `blocked` → `ready` (DEPENDENCIES_MET)
- `ready` → `running` (AGENT_ASSIGNED)
- `running` → `merging` (CODE_COMPLETE)
- `running` → `failed` (TASK_FAILED)
- `merging` → `completed` (MERGE_SUCCESS)
- `merging` → `failed` (MERGE_FAILED)

## Target State

**New TaskStatus:**
```typescript
export type TaskStatus = 'blocked' | 'ready' | 'dev' | 'qa' | 'merging' | 'completed' | 'failed';
```

**New transitions:**
| From | To | Event | Agent |
|------|-----|-------|-------|
| `blocked` | `ready` | DEPENDENCIES_MET | Cascade |
| `ready` | `dev` | AGENT_ASSIGNED | Orchestrator |
| `dev` | `qa` | DEV_COMPLETE | Dev Agent |
| `dev` | `failed` | TASK_FAILED | Dev Agent |
| `qa` | `merging` | QA_PASSED | QA Agent |
| `qa` | `dev` | QA_FAILED | QA Agent |
| `qa` | `failed` | TASK_FAILED | QA Agent |
| `merging` | `completed` | MERGE_SUCCESS | Merge Agent |
| `merging` | `failed` | MERGE_FAILED | Merge Agent |
| `completed` | (cascade) | - | Cascade |
| `failed` | `ready` | RETRY | Manual |

## Tasks

### Task 1: Update TaskStatus Type

**Files:** `src/shared/types/task.ts`

**Changes:**
1. Replace `'running'` with `'dev'` and add `'qa'` to TaskStatus union type

**Verification:** TypeScript compilation check

---

### Task 2: Update State Machine Transitions

**Files:** `src/main/dag-engine/state-machine.ts`

**Changes:**
1. Update doc comment to reflect new states
2. Add new events: `DEV_COMPLETE`, `QA_PASSED`, `QA_FAILED`
3. Replace `VALID_TRANSITIONS` entries:
   - Change `ready` → `running` to `ready` → `dev`
   - Change `running` → `merging` to `dev` → `qa`
   - Change `running` → `failed` to `dev` → `failed`
   - Add `qa` → `merging` (QA_PASSED)
   - Add `qa` → `dev` (QA_FAILED)
   - Add `qa` → `failed` (TASK_FAILED)
4. Update RESET transitions for new states (`dev`, `qa`)
5. Remove `CODE_COMPLETE` event (replaced by `DEV_COMPLETE`)
6. Remove `AGENT_ASSIGNED` references to `running`, use `dev`

**Verification:** TypeScript compilation check

---

### Task 3: Update Cascade Logic

**Files:** `src/main/dag-engine/cascade.ts`

**Changes:**
1. Update `recalculateAllStatuses()` to skip `dev` and `qa` (in addition to `running`, `merging`, `completed`)
2. The terminal states check should include `dev` and `qa` as active states

**Verification:** TypeScript compilation check

---

### Task 4: Update Task Controller

**Files:** `src/main/dag-engine/task-controller.ts`

**Changes:**
1. Update `initializeTaskStatuses()` to skip `dev`, `qa` (in addition to `completed`, `running`, `merging`)

**Verification:** TypeScript compilation check, `npx tsc --noEmit`

## Verification

```bash
npx tsc --noEmit
```

All files must compile without errors. The state machine type changes will propagate through the codebase.

## Commit

```
feat(42-01): update TaskStatus type with dev/qa states

- Replace 'running' with 'dev' state
- Add 'qa' state for QA agent verification
- Add DEV_COMPLETE, QA_PASSED, QA_FAILED events
- Update transition table for dev→qa→merging pipeline
- Update cascade logic to respect new active states
```
