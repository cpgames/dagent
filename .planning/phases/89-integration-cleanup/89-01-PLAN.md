---
phase: 89-integration-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/src/App.tsx
  - src/renderer/src/components/Background/index.ts
  - src/renderer/src/components/Background/Starfield.tsx
  - src/renderer/src/components/Background/Horizon.tsx
  - src/renderer/src/components/Background/SynthwaveGrid.tsx
  - src/renderer/src/components/Background/SynthwaveBackground.tsx
  - src/renderer/src/components/Background/SynthwaveBackground.css
  - src/renderer/src/components/Background/UnifiedCanvas.tsx
autonomous: true

# Goal-backward verification
must_haves:
  truths:
    - User sees complete synthwave background with all visual layers
    - Background renders in single canvas (not multiple CSS elements)
    - Background animation is smooth with no performance issues
    - Background respects reduced motion preferences
  artifacts:
    - path: "src/renderer/src/App.tsx"
      provides: "Renders UnifiedCanvas with all layers"
      contains: "UnifiedCanvas"
    - path: "src/renderer/src/components/Background/index.ts"
      provides: "Exports UnifiedCanvas and layers"
      exports: ["UnifiedCanvas"]
    - path: "src/renderer/src/components/Background/UnifiedCanvas.tsx"
      provides: "Single canvas with all layers integrated"
      min_lines: 100
  key_links:
    - from: "App.tsx"
      to: "UnifiedCanvas"
      via: "Component usage"
      pattern: "<UnifiedCanvas"
    - from: "UnifiedCanvas"
      to: "all layer classes"
      via: "layers array prop"
      pattern: "layers="
---

<objective>
Replace CSS-based background components with unified canvas system and complete the v2.7 Canvas Background System milestone.

Purpose: Unify all background rendering into a single performant canvas layer, replacing deprecated CSS components with the complete layer stack built in phases 83-88.

Output: Single UnifiedCanvas component rendering all background layers (Sky → Stars → HorizonGlow → Terrain → Grid → ShootingStars) with deprecated CSS components removed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v2.7-ROADMAP.md
@.planning/REQUIREMENTS.md

# Prior phase context - all layers are ready
@.planning/phases/83-canvas-infrastructure/83-01-SUMMARY.md
@.planning/phases/84-sky-starfield-layers/84-01-SUMMARY.md
@.planning/phases/85-horizon-glow-layer/85-01-SUMMARY.md
@.planning/phases/86-grid-layer-integration/86-01-SUMMARY.md
@.planning/phases/87-shooting-stars-layer/87-01-SUMMARY.md
@.planning/phases/88-terrain-silhouettes/88-01-SUMMARY.md

# Current implementation files
@src/renderer/src/App.tsx
@src/renderer/src/components/Background/SynthwaveBackground.tsx
@src/renderer/src/components/Background/UnifiedCanvas.tsx
@src/renderer/src/components/Background/layers/index.ts

## Available Layers (Phase 83-88)

All layers implement the `Layer` interface with `init(ctx, context)`, `update(deltaTime)`, `render(ctx, context)`, and `reset()` methods:

1. **SkyLayer** (Phase 84): Deep purple to pink gradient sky
2. **StarsLayer** (Phase 84): 360 stars with sinusoidal flicker animation
3. **HorizonGlowLayer** (Phase 85): Pulsing radial gradient at horizon (65% viewport height)
4. **TerrainLayer** (Phase 88): 3 parallax terrain silhouettes with cyan glow
5. **GridLayer** (Phase 86): Curved perspective grid with cyan/magenta lines
6. **ShootingStarsLayer** (Phase 87): Shooting stars with gradient trails (~1% spawn rate, max 3)

**Layer order (back to front):** Sky → Stars → HorizonGlow → Terrain → Grid → ShootingStars

## Phase 89 Requirements

From REQUIREMENTS.md:

**Integration (INT):**
- INT-01: Unified canvas replaces all CSS background components
- INT-02: Single requestAnimationFrame loop for all layers
- INT-03: CSS component cleanup (remove Starfield, Horizon, SynthwaveGrid CSS)

**Performance (PERF):**
- PERF-01: Object pooling for stars and shooting stars (Should - defer if complex)
- PERF-02: Context caching with GPU context loss handling (Should - defer if complex)
- PERF-03: ResizeObserver with 100ms debounce (Already implemented in UnifiedCanvas)

**Note:** PERF-01 and PERF-02 are "Should" priority. Focus on INT-01, INT-02, INT-03 first. Add performance optimizations only if straightforward - otherwise defer to v2 requirements.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace SynthwaveBackground with UnifiedCanvas in App.tsx</name>
  <files>src/renderer/src/App.tsx</files>
  <action>
    Replace the SynthwaveBackground component (line 15 import and line 124 usage) with UnifiedCanvas using all 6 layers.

    **Import changes:**
    - Remove: `import { SynthwaveBackground } from './components/Background'`
    - Add: `import { UnifiedCanvas, SkyLayer, StarsLayer, HorizonGlowLayer, TerrainLayer, GridLayer, ShootingStarsLayer } from './components/Background'`

    **Component instantiation:**
    Create layer instances in the component body (before return statement):
    ```tsx
    // Instantiate background layers (back to front)
    const backgroundLayers = useMemo(() => [
      new SkyLayer(),
      new StarsLayer(),
      new HorizonGlowLayer(),
      new TerrainLayer(),
      new GridLayer(),
      new ShootingStarsLayer()
    ], []);
    ```

    **JSX replacement:**
    Replace `<SynthwaveBackground />` (line 124) with:
    ```tsx
    <UnifiedCanvas layers={backgroundLayers} />
    ```

    **Why useMemo:** Layer instances should be stable across re-renders. Creating new layer instances on each render would cause performance issues and reset animations. useMemo with empty dependency array ensures layers are created once.

    **Why this order:** Layers render back to front. Sky must be first (background), ShootingStars last (top layer). Terrain must be between HorizonGlow and Grid to create proper depth layering.
  </action>
  <verify>
    - App.tsx imports UnifiedCanvas and all layer classes
    - backgroundLayers array created with useMemo
    - SynthwaveBackground component removed from JSX
    - UnifiedCanvas component rendered with layers prop
    - No TypeScript errors
  </verify>
  <done>
    App.tsx renders UnifiedCanvas with all 6 layers in correct order, SynthwaveBackground component no longer used.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Background barrel exports</name>
  <files>src/renderer/src/components/Background/index.ts</files>
  <action>
    Update the barrel file to export UnifiedCanvas and all layer classes, removing deprecated component exports.

    **Add exports:**
    ```typescript
    export { UnifiedCanvas } from './UnifiedCanvas';
    export { SkyLayer, StarsLayer, HorizonGlowLayer, TerrainLayer, GridLayer, ShootingStarsLayer } from './layers';
    ```

    **Keep these exports (still used elsewhere or part of public API):**
    - Do NOT remove any existing exports unless confirmed they're only used by SynthwaveBackground
    - If SynthwaveBackground is the only consumer, we can remove those exports in Task 4

    **Alphabetical order:** Maintain alphabetical ordering of exports for consistency.

    **Why export layer classes:** App.tsx needs to instantiate layers directly to pass to UnifiedCanvas. Layers are no longer internal implementation details.
  </action>
  <verify>
    - index.ts exports UnifiedCanvas
    - index.ts exports all 6 layer classes
    - No TypeScript errors in import resolution
  </verify>
  <done>
    Background barrel file exports UnifiedCanvas and layer classes for external use.
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove deprecated CSS background components</name>
  <files>
    src/renderer/src/components/Background/Starfield.tsx,
    src/renderer/src/components/Background/Horizon.tsx,
    src/renderer/src/components/Background/SynthwaveGrid.tsx,
    src/renderer/src/components/Background/SynthwaveBackground.tsx,
    src/renderer/src/components/Background/SynthwaveBackground.css
  </files>
  <action>
    Delete the following files that have been replaced by canvas layers:

    **Files to delete:**
    1. `Starfield.tsx` - replaced by StarsLayer + ShootingStarsLayer
    2. `Horizon.tsx` - replaced by HorizonGlowLayer
    3. `SynthwaveGrid.tsx` - replaced by GridLayer
    4. `SynthwaveBackground.tsx` - replaced by UnifiedCanvas
    5. `SynthwaveBackground.css` - no longer needed

    **Why delete now:** These components are no longer used after Task 1. Keeping them would create maintenance burden and confusion. The canvas layers provide superior performance and unified animation timing.

    **Verification before deletion:**
    - Grep codebase to confirm no remaining imports of these components
    - If found, update those files first before deletion

    Use git rm or regular rm - the git commit will show the deletions clearly in history.
  </action>
  <verify>
    - Starfield.tsx, Horizon.tsx, SynthwaveGrid.tsx deleted
    - SynthwaveBackground.tsx and .css deleted
    - No remaining imports of deleted components in codebase
    - grep 'SynthwaveBackground\|Starfield\|Horizon(?!Glow)' returns no matches in src/
  </verify>
  <done>
    All deprecated CSS background components removed from codebase, replaced by canvas layers.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds with no errors
- [ ] No TypeScript errors
- [ ] Grep confirms no imports of deleted components
- [ ] App renders with complete background (all 6 layers visible)
- [ ] Background animation is smooth (requestAnimationFrame)
- [ ] Background respects reduced motion (static rendering when prefers-reduced-motion)
</verification>

<success_criteria>

- All tasks completed successfully
- App.tsx renders UnifiedCanvas with all 6 layers
- Deprecated CSS components deleted from codebase
- Build passes with no TypeScript errors
- Single canvas replaces all CSS background elements (INT-01)
- Single requestAnimationFrame loop drives all layers (INT-02)
- CSS component cleanup complete (INT-03)
- Background renders with all visual effects: sky gradient, stars, horizon glow, terrain silhouettes, grid, shooting stars
  </success_criteria>

<output>
After completion, create `.planning/phases/89-integration-cleanup/89-01-SUMMARY.md` using the summary template.

Include in summary:
- What was integrated (all 6 layers)
- What was deleted (5 files)
- Layer rendering order and why
- Performance characteristics (single RAF loop, canvas rendering)
- Reduced motion support
- INT-01, INT-02, INT-03 requirements satisfied
- Note on deferred performance optimizations (PERF-01, PERF-02)
</output>
