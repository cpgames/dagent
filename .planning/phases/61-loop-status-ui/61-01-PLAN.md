# Plan 61-01: Loop Status UI

## Overview

Add visual feedback for Ralph Loop iteration progress in the task nodes and node dialog. This enables users to monitor iteration count, checklist status, and abort loops early.

## Prior Context

- Phase 60 added `TaskLoopStatus` interface to orchestrator-types.ts
- IPC handlers created: `execution:get-loop-status`, `execution:get-all-loop-statuses`, `execution:abort-loop`
- IPC event: `task:loop-status-updated` broadcasts status changes
- TaskLoopStatus contains: taskId, status, currentIteration, maxIterations, checklistSnapshot, exitReason, error

## Deliverables

1. Iteration badge on TaskNode showing current iteration count
2. Checklist status display in NodeDialog with pass/fail indicators
3. Abort button to stop loop early
4. Store integration for loop status tracking

## Files to Modify

- `src/renderer/src/components/DAG/TaskNode.tsx` - Add iteration badge
- `src/renderer/src/components/DAG/NodeDialog.tsx` - Add checklist view and abort button
- `src/renderer/src/stores/dag-store.ts` - Add loop status state and IPC subscription
- `src/preload/index.ts` - Add missing IPC methods for loop status
- `src/preload/index.d.ts` - Add type declarations for loop status API

---

## Task 1: Add Loop Status IPC to Preload

### Goal
Expose loop status IPC handlers to the renderer process.

### Files
- `src/preload/index.ts`
- `src/preload/index.d.ts`

### Changes

**index.d.ts** - Add to ExecutionAPI interface:
```typescript
/**
 * Get loop status for a specific task
 */
getLoopStatus: (taskId: string) => Promise<TaskLoopStatus | null>

/**
 * Get all active loop statuses
 */
getAllLoopStatuses: () => Promise<Record<string, TaskLoopStatus>>

/**
 * Abort a task's loop
 */
abortLoop: (taskId: string) => Promise<{ success: boolean; error?: string }>

/**
 * Subscribe to loop status updates
 */
onLoopStatusUpdated: (callback: (status: TaskLoopStatus) => void) => () => void
```

Also add import for TaskLoopStatus from orchestrator-types.

**index.ts** - Add implementations:
```typescript
getLoopStatus: (taskId) => ipcRenderer.invoke('execution:get-loop-status', taskId),
getAllLoopStatuses: () => ipcRenderer.invoke('execution:get-all-loop-statuses'),
abortLoop: (taskId) => ipcRenderer.invoke('execution:abort-loop', taskId),
onLoopStatusUpdated: (callback) => {
  const handler = (_event, status) => callback(status)
  ipcRenderer.on('task:loop-status-updated', handler)
  return () => ipcRenderer.removeListener('task:loop-status-updated', handler)
}
```

### Verification
- [ ] TypeScript compiles without errors
- [ ] ExecutionAPI has getLoopStatus, getAllLoopStatuses, abortLoop, onLoopStatusUpdated

---

## Task 2: Add Loop Status to DAG Store

### Goal
Track loop statuses in the dag store and subscribe to updates.

### Files
- `src/renderer/src/stores/dag-store.ts`

### Changes

Add to DAGStoreState interface:
```typescript
// Loop status tracking
loopStatuses: Record<string, TaskLoopStatus>

// Actions
loadLoopStatuses: () => Promise<void>
```

Add subscription tracking:
```typescript
let loopStatusUnsubscribe: (() => void) | null = null
```

Add to initial state:
```typescript
loopStatuses: {},
```

Add loadLoopStatuses action:
```typescript
loadLoopStatuses: async () => {
  try {
    const statuses = await window.electronAPI.execution.getAllLoopStatuses()
    set({ loopStatuses: statuses })
  } catch (error) {
    console.error('Failed to load loop statuses:', error)
  }
}
```

In loadDag, after subscribing to DAG updates:
```typescript
// Subscribe to loop status updates
if (loopStatusUnsubscribe) {
  loopStatusUnsubscribe()
}
loopStatusUnsubscribe = window.electronAPI.execution.onLoopStatusUpdated((status) => {
  const { loopStatuses } = get()
  set({ loopStatuses: { ...loopStatuses, [status.taskId]: status } })
})

// Load initial loop statuses
await get().loadLoopStatuses()
```

### Verification
- [ ] TypeScript compiles without errors
- [ ] loopStatuses state exists in store
- [ ] loadLoopStatuses action works
- [ ] Loop status updates are received via IPC

---

## Task 3: Add Iteration Badge to TaskNode

### Goal
Display iteration progress badge on tasks that are executing in a loop.

### Files
- `src/renderer/src/components/DAG/TaskNode.tsx`

### Changes

Update TaskNodeData interface:
```typescript
export interface TaskNodeData extends Record<string, unknown> {
  task: Task
  loopStatus?: TaskLoopStatus | null
  onEdit: (taskId: string) => void
  onDelete: (taskId: string) => void
  onLog: (taskId: string) => void
}
```

Add iteration badge component inside TaskNodeComponent, after the state badge section:
```typescript
{/* Loop iteration badge - shows when task is in a loop */}
{loopStatus && loopStatus.status === 'running' && (
  <div className="px-3 py-1 border-t border-gray-700">
    <div className="flex items-center gap-2">
      <span className="text-xs px-1.5 py-0.5 rounded font-medium bg-cyan-500/20 text-cyan-400">
        LOOP {loopStatus.currentIteration}/{loopStatus.maxIterations}
      </span>
      {/* Checklist mini-icons */}
      <div className="flex items-center gap-1">
        {Object.entries(loopStatus.checklistSnapshot).map(([key, status]) => (
          <span
            key={key}
            className={`w-2 h-2 rounded-full ${
              status === 'pass' ? 'bg-green-500' :
              status === 'fail' ? 'bg-red-500' :
              status === 'skipped' ? 'bg-gray-500' :
              'bg-yellow-500'
            }`}
            title={`${key}: ${status}`}
          />
        ))}
      </div>
    </div>
  </div>
)}
```

Extract loopStatus from nodeData:
```typescript
const { task, loopStatus, onEdit, onDelete, onLog } = nodeData
```

### Verification
- [ ] TypeScript compiles without errors
- [ ] Iteration badge shows for running loop tasks
- [ ] Checklist dots show pass/fail/pending status
- [ ] Badge not shown when loopStatus is null or not running

---

## Task 4: Add Loop Status View to NodeDialog

### Goal
Show detailed checklist status and abort button in the node edit dialog.

### Files
- `src/renderer/src/components/DAG/NodeDialog.tsx`

### Changes

Update NodeDialogProps:
```typescript
export interface NodeDialogProps {
  task: Task;
  loopStatus?: TaskLoopStatus | null;
  onSave: (updates: Partial<Task>) => void;
  onClose: () => void;
  onAbortLoop?: (taskId: string) => void;
}
```

Add checklist icons:
```typescript
const checklistIcons: Record<string, { icon: string; color: string }> = {
  pass: { icon: '✓', color: 'text-green-400' },
  fail: { icon: '✗', color: 'text-red-400' },
  pending: { icon: '○', color: 'text-yellow-400' },
  skipped: { icon: '—', color: 'text-gray-400' }
}
```

Add loop status section after the status display (between status and lock toggle):
```typescript
{/* Loop Status Section */}
{loopStatus && (
  <div className="border-t border-gray-700 pt-3">
    <div className="flex items-center justify-between mb-2">
      <span className="text-sm font-medium text-gray-300">
        Loop Progress
      </span>
      <span className={`text-xs px-2 py-1 rounded ${
        loopStatus.status === 'running' ? 'bg-cyan-500/20 text-cyan-400' :
        loopStatus.status === 'completed' ? 'bg-green-500/20 text-green-400' :
        loopStatus.status === 'failed' ? 'bg-red-500/20 text-red-400' :
        loopStatus.status === 'aborted' ? 'bg-orange-500/20 text-orange-400' :
        'bg-gray-500/20 text-gray-400'
      }`}>
        {loopStatus.status.toUpperCase()} - Iteration {loopStatus.currentIteration}/{loopStatus.maxIterations}
      </span>
    </div>

    {/* Checklist items */}
    <div className="space-y-1 mb-3">
      {Object.entries(loopStatus.checklistSnapshot).map(([key, status]) => {
        const { icon, color } = checklistIcons[status] || checklistIcons.pending
        return (
          <div key={key} className="flex items-center gap-2 text-sm">
            <span className={`font-mono ${color}`}>{icon}</span>
            <span className="text-gray-300 capitalize">{key}</span>
            <span className={`text-xs ${color}`}>({status})</span>
          </div>
        )
      })}
    </div>

    {/* Abort button - only show if running */}
    {loopStatus.status === 'running' && onAbortLoop && (
      <button
        type="button"
        onClick={() => onAbortLoop(task.id)}
        className="flex items-center gap-2 px-3 py-2 rounded-md bg-red-500/20 border border-red-500/50 text-red-400 hover:bg-red-500/30 transition-colors"
      >
        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
        </svg>
        Abort Loop
      </button>
    )}

    {/* Error message if failed */}
    {loopStatus.error && (
      <div className="mt-2 text-xs text-red-400 bg-red-500/10 rounded p-2">
        {loopStatus.error}
      </div>
    )}

    {/* Exit reason if completed/failed */}
    {loopStatus.exitReason && (
      <div className="mt-2 text-xs text-gray-400">
        Exit reason: {loopStatus.exitReason}
      </div>
    )}
  </div>
)}
```

### Verification
- [ ] TypeScript compiles without errors
- [ ] Loop status section shows when loopStatus is provided
- [ ] Checklist items display with correct icons
- [ ] Abort button appears when loop is running
- [ ] Error and exit reason display when applicable

---

## Task 5: Wire Loop Status to DAGView

### Goal
Pass loop status from store to TaskNode and NodeDialog components.

### Files
- `src/renderer/src/views/DAGView.tsx`

### Changes

Add loopStatuses to selector:
```typescript
const { dag, loopStatuses, /* ... other selections */ } = useDAGStore((state) => ({
  dag: state.dag,
  loopStatuses: state.loopStatuses,
  // ... other state
}))
```

When building nodes for ReactFlow, add loopStatus to data:
```typescript
const nodes = dag.nodes.map((task) => ({
  id: task.id,
  type: 'task',
  position: positions[task.id] || { x: 0, y: 0 },
  data: {
    task,
    loopStatus: loopStatuses[task.id] || null,
    onEdit: handleEditNode,
    onDelete: handleDeleteNode,
    onLog: handleViewLog
  } as TaskNodeData
}))
```

Add abort handler:
```typescript
const handleAbortLoop = async (taskId: string) => {
  try {
    const result = await window.electronAPI.execution.abortLoop(taskId)
    if (!result.success) {
      toast.error(`Failed to abort loop: ${result.error}`)
    }
  } catch (error) {
    toast.error(`Failed to abort loop: ${(error as Error).message}`)
  }
}
```

Pass to NodeDialog:
```typescript
{editingNode && (
  <NodeDialog
    task={editingNode}
    loopStatus={loopStatuses[editingNode.id] || null}
    onSave={handleSaveNode}
    onClose={() => setEditingNode(null)}
    onAbortLoop={handleAbortLoop}
  />
)}
```

### Verification
- [ ] TypeScript compiles without errors
- [ ] TaskNode receives loopStatus in data
- [ ] NodeDialog receives loopStatus and onAbortLoop
- [ ] Abort handler calls IPC and shows toast on error

---

## Summary

This plan adds comprehensive loop status UI:
1. IPC bridge for loop status queries and subscriptions
2. Store integration for tracking loop statuses
3. Iteration badge on task nodes with mini checklist indicators
4. Detailed checklist view in node dialog
5. Abort button for stopping loops early

After implementation, users will see real-time iteration progress on tasks and can abort loops that are stuck or taking too long.
