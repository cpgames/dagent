---
phase: 04-git-integration
plan: 01
type: execute
---

<objective>
Set up Git manager with simple-git library for git operations.

Purpose: Establish the foundation for git worktree management that enables isolated task execution.
Output: Git manager module in src/main/git/ with simple-git initialization and basic operations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./04-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-model/02-02-SUMMARY.md
@DAGENT_SPEC.md (section 8 for Git Integration)

**Tech stack available:** Electron, React, TypeScript, electron-vite
**Established patterns:** IPC via contextBridge, modules in src/main/, preload exposure pattern
**Storage patterns:** FeatureStore in src/main/storage/, JSON persistence, .dagent directory structure

**Key decisions affecting this phase:**
- Storage follows DAGENT_SPEC section 9.1 path structure
- All main process modules follow the pattern: types → implementation → IPC handlers → preload
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install simple-git and create git manager types</name>
  <files>package.json, src/main/git/types.ts, src/main/git/index.ts</files>
  <action>
Install simple-git:
```bash
npm install simple-git
```

Create src/main/git/ directory and types.ts with:
```typescript
import type { SimpleGit, SimpleGitOptions } from 'simple-git';

export interface GitManagerConfig {
  baseDir: string;         // Project root directory
  worktreesDir: string;    // .dagent-worktrees directory path
}

export interface WorktreeInfo {
  path: string;            // Absolute path to worktree
  branch: string;          // Branch name
  head: string;            // Current commit hash
  isDetached: boolean;     // Whether HEAD is detached
}

export interface BranchInfo {
  name: string;
  current: boolean;
  commit: string;
  label: string;
}

export interface GitOperationResult {
  success: boolean;
  error?: string;
  data?: unknown;
}

// Branch naming per DAGENT_SPEC section 8.1
export function getFeatureBranchName(featureId: string): string {
  // feature-car → feature/car
  const cleanId = featureId.replace(/^feature-/, '');
  return `feature/${cleanId}`;
}

export function getTaskBranchName(featureId: string, taskId: string): string {
  // feature/car/task-2145
  const featureBranch = getFeatureBranchName(featureId);
  return `${featureBranch}/task-${taskId}`;
}

// Worktree directory naming per DAGENT_SPEC section 8.2
export function getFeatureWorktreeName(featureId: string): string {
  // feature-car
  return featureId;
}

export function getTaskWorktreeName(featureId: string, taskId: string): string {
  // feature-car--task-2145
  return `${featureId}--task-${taskId}`;
}
```

Create index.ts:
```typescript
export * from './types';
```
  </action>
  <verify>npm run typecheck passes, simple-git in package.json dependencies</verify>
  <done>simple-git installed, Git types defined with branch/worktree naming functions</done>
</task>

<task type="auto">
  <name>Task 2: Implement GitManager class with simple-git initialization</name>
  <files>src/main/git/git-manager.ts, src/main/git/index.ts</files>
  <action>
Create git-manager.ts with GitManager class:
```typescript
import { simpleGit, SimpleGit, SimpleGitOptions } from 'simple-git';
import type { GitManagerConfig, WorktreeInfo, BranchInfo, GitOperationResult } from './types';
import { getFeatureBranchName, getTaskBranchName, getFeatureWorktreeName, getTaskWorktreeName } from './types';
import * as path from 'path';
import * as fs from 'fs/promises';

export class GitManager {
  private git: SimpleGit;
  private config: GitManagerConfig;
  private initialized: boolean = false;

  constructor() {
    // Will be initialized with configure()
    this.git = simpleGit();
    this.config = { baseDir: '', worktreesDir: '' };
  }

  /**
   * Initialize GitManager with project configuration.
   * Must be called before any git operations.
   */
  async initialize(projectRoot: string): Promise<GitOperationResult> {
    try {
      this.config = {
        baseDir: projectRoot,
        worktreesDir: path.join(path.dirname(projectRoot), '.dagent-worktrees'),
      };

      const options: Partial<SimpleGitOptions> = {
        baseDir: projectRoot,
        binary: 'git',
        maxConcurrentProcesses: 6,
      };

      this.git = simpleGit(options);

      // Verify this is a git repository
      const isRepo = await this.git.checkIsRepo();
      if (!isRepo) {
        return { success: false, error: 'Not a git repository' };
      }

      // Ensure worktrees directory exists
      await fs.mkdir(this.config.worktreesDir, { recursive: true });

      this.initialized = true;
      return { success: true };
    } catch (error) {
      return { success: false, error: (error as Error).message };
    }
  }

  /**
   * Check if GitManager is initialized.
   */
  isInitialized(): boolean {
    return this.initialized;
  }

  /**
   * Get current configuration.
   */
  getConfig(): GitManagerConfig {
    return { ...this.config };
  }

  /**
   * Get the underlying SimpleGit instance for advanced operations.
   */
  getGit(): SimpleGit {
    this.ensureInitialized();
    return this.git;
  }

  /**
   * Get current branch name.
   */
  async getCurrentBranch(): Promise<string> {
    this.ensureInitialized();
    const status = await this.git.status();
    return status.current || '';
  }

  /**
   * List all branches.
   */
  async listBranches(): Promise<BranchInfo[]> {
    this.ensureInitialized();
    const branchSummary = await this.git.branchLocal();
    return branchSummary.all.map(name => ({
      name,
      current: name === branchSummary.current,
      commit: branchSummary.branches[name]?.commit || '',
      label: branchSummary.branches[name]?.label || '',
    }));
  }

  /**
   * Check if a branch exists.
   */
  async branchExists(branchName: string): Promise<boolean> {
    this.ensureInitialized();
    try {
      const branches = await this.git.branchLocal();
      return branches.all.includes(branchName);
    } catch {
      return false;
    }
  }

  /**
   * Create a new branch from current HEAD.
   */
  async createBranch(branchName: string, checkout: boolean = false): Promise<GitOperationResult> {
    this.ensureInitialized();
    try {
      if (checkout) {
        await this.git.checkoutLocalBranch(branchName);
      } else {
        await this.git.branch([branchName]);
      }
      return { success: true };
    } catch (error) {
      return { success: false, error: (error as Error).message };
    }
  }

  /**
   * Delete a branch.
   */
  async deleteBranch(branchName: string, force: boolean = false): Promise<GitOperationResult> {
    this.ensureInitialized();
    try {
      const flag = force ? '-D' : '-d';
      await this.git.branch([flag, branchName]);
      return { success: true };
    } catch (error) {
      return { success: false, error: (error as Error).message };
    }
  }

  /**
   * Get repository status.
   */
  async getStatus(): Promise<GitOperationResult> {
    this.ensureInitialized();
    try {
      const status = await this.git.status();
      return { success: true, data: status };
    } catch (error) {
      return { success: false, error: (error as Error).message };
    }
  }

  /**
   * Ensure GitManager is initialized before operations.
   */
  private ensureInitialized(): void {
    if (!this.initialized) {
      throw new Error('GitManager not initialized. Call initialize(projectRoot) first.');
    }
  }
}

// Singleton instance
let gitManagerInstance: GitManager | null = null;

export function getGitManager(): GitManager {
  if (!gitManagerInstance) {
    gitManagerInstance = new GitManager();
  }
  return gitManagerInstance;
}

export function resetGitManager(): void {
  gitManagerInstance = null;
}
```

Update index.ts:
```typescript
export * from './types';
export * from './git-manager';
```
  </action>
  <verify>npm run typecheck passes</verify>
  <done>GitManager class with initialization, branch operations, and singleton pattern</done>
</task>

<task type="auto">
  <name>Task 3: Add Git IPC handlers and preload exposure</name>
  <files>src/main/ipc/git-handlers.ts, src/main/ipc/handlers.ts, src/preload/index.ts, src/preload/index.d.ts</files>
  <action>
Create src/main/ipc/git-handlers.ts:
```typescript
import { ipcMain } from 'electron';
import { getGitManager } from '../git';

export function registerGitHandlers(): void {
  ipcMain.handle('git:initialize', async (_event, projectRoot: string) => {
    const manager = getGitManager();
    return manager.initialize(projectRoot);
  });

  ipcMain.handle('git:is-initialized', async () => {
    const manager = getGitManager();
    return manager.isInitialized();
  });

  ipcMain.handle('git:get-config', async () => {
    const manager = getGitManager();
    return manager.getConfig();
  });

  ipcMain.handle('git:get-current-branch', async () => {
    const manager = getGitManager();
    return manager.getCurrentBranch();
  });

  ipcMain.handle('git:list-branches', async () => {
    const manager = getGitManager();
    return manager.listBranches();
  });

  ipcMain.handle('git:branch-exists', async (_event, branchName: string) => {
    const manager = getGitManager();
    return manager.branchExists(branchName);
  });

  ipcMain.handle('git:create-branch', async (_event, branchName: string, checkout: boolean = false) => {
    const manager = getGitManager();
    return manager.createBranch(branchName, checkout);
  });

  ipcMain.handle('git:delete-branch', async (_event, branchName: string, force: boolean = false) => {
    const manager = getGitManager();
    return manager.deleteBranch(branchName, force);
  });

  ipcMain.handle('git:get-status', async () => {
    const manager = getGitManager();
    return manager.getStatus();
  });
}
```

Update src/main/ipc/handlers.ts to include git handlers:
```typescript
import { registerGitHandlers } from './git-handlers';

export function registerAllHandlers(): void {
  // ... existing handlers
  registerGitHandlers();
}
```

Update src/preload/index.ts to expose git API:
```typescript
const gitAPI = {
  initialize: (projectRoot: string) => ipcRenderer.invoke('git:initialize', projectRoot),
  isInitialized: () => ipcRenderer.invoke('git:is-initialized'),
  getConfig: () => ipcRenderer.invoke('git:get-config'),
  getCurrentBranch: () => ipcRenderer.invoke('git:get-current-branch'),
  listBranches: () => ipcRenderer.invoke('git:list-branches'),
  branchExists: (branchName: string) => ipcRenderer.invoke('git:branch-exists', branchName),
  createBranch: (branchName: string, checkout?: boolean) =>
    ipcRenderer.invoke('git:create-branch', branchName, checkout),
  deleteBranch: (branchName: string, force?: boolean) =>
    ipcRenderer.invoke('git:delete-branch', branchName, force),
  getStatus: () => ipcRenderer.invoke('git:get-status'),
};

// Add to contextBridge exposure
contextBridge.exposeInMainWorld('electronAPI', {
  // ... existing APIs
  git: gitAPI,
});
```

Update src/preload/index.d.ts:
```typescript
interface GitManagerConfig {
  baseDir: string;
  worktreesDir: string;
}

interface BranchInfo {
  name: string;
  current: boolean;
  commit: string;
  label: string;
}

interface GitOperationResult {
  success: boolean;
  error?: string;
  data?: unknown;
}

interface GitAPI {
  initialize: (projectRoot: string) => Promise<GitOperationResult>;
  isInitialized: () => Promise<boolean>;
  getConfig: () => Promise<GitManagerConfig>;
  getCurrentBranch: () => Promise<string>;
  listBranches: () => Promise<BranchInfo[]>;
  branchExists: (branchName: string) => Promise<boolean>;
  createBranch: (branchName: string, checkout?: boolean) => Promise<GitOperationResult>;
  deleteBranch: (branchName: string, force?: boolean) => Promise<GitOperationResult>;
  getStatus: () => Promise<GitOperationResult>;
}

interface ElectronAPI {
  // ... existing
  git: GitAPI;
}
```
  </action>
  <verify>npm run typecheck passes, npm run dev starts without errors</verify>
  <done>Git IPC handlers expose GitManager to renderer process</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes with no errors
- [ ] simple-git installed in package.json
- [ ] Git manager module created in src/main/git/
- [ ] Branch naming follows DAGENT_SPEC section 8.1
- [ ] IPC handlers expose git operations to renderer
- [ ] `npm run dev` runs without errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Git manager ready for worktree operations (Plan 04-02)
</success_criteria>

<output>
After completion, create `.planning/phases/04-git-integration/04-01-SUMMARY.md` with:
- simple-git integration
- GitManager class structure
- Branch naming conventions
- IPC integration
- Ready for Plan 04-02 (worktree lifecycle)
</output>
