---
phase: 35-intention-approval
plan: 01
status: draft
estimated_effort: medium
---

# Phase 35-01: Intention-Approval Workflow Wiring

## Goal

Wire the intention-approval workflow so TaskAgents propose intentions after initialization, HarnessAgent processes them, and TaskAgents execute after approval. This completes the loop from Phase 34 (agent assignment) to actual task execution.

## Why

Phase 34 creates TaskAgents and initializes them, but they don't do anything afterward. The intention-approval workflow (per DAGENT_SPEC section 7.2-7.4) requires:
1. TaskAgent proposes intention after context is loaded
2. HarnessAgent reviews intention against project context
3. TaskAgent executes after receiving approval

All the pieces exist - they just need to be connected in the orchestrator's tick loop.

## Tasks

### Task 1: Call proposeIntention after agent initialization

**File:** `src/main/dag-engine/orchestrator.ts`

Modify `assignAgentToTask()` to call `proposeIntention()` after successful initialization:

```typescript
// After agent.initialize() succeeds
await agent.proposeIntention()
```

**Changes:**
- After `registerTaskAgent(agent)`, call `await agent.proposeIntention()`
- This triggers the intention to be sent to harness via existing `harness.receiveIntention()`

### Task 2: Add intention processing to tick loop

**File:** `src/main/dag-engine/orchestrator.ts`

Add logic in `tick()` to process pending intentions:

```typescript
// After agent assignment, process any pending intentions
await this.processPendingIntentions()
```

Add new method `processPendingIntentions()`:
- Get harness via `getHarnessAgent()`
- Get pending intentions from `harness.getState().pendingIntentions`
- For each pending intention, call `harness.processIntention(taskId)`
- Get the decision and send to task agent via `getTaskAgent(taskId)?.receiveApproval(decision)`

**Imports needed:**
- `getHarnessAgent` from `../agents/harness-agent`
- `getTaskAgent` from `../agents/task-agent`

### Task 3: Handle task completion in tick loop

**File:** `src/main/dag-engine/orchestrator.ts`

Add logic to detect completed task agents and update orchestrator state:

```typescript
// Check for completed task agents
await this.handleCompletedTasks()
```

Add new method `handleCompletedTasks()`:
- Get all task agents via `getAllTaskAgents()`
- For each agent with status 'completed':
  - Call `completeTaskCode(taskId)` to transition to merging
  - Call `completeMerge(taskId)` to mark complete (skip actual merge for now)
  - Clean up agent via `agent.cleanup()`
  - Remove from registry via `removeTaskAgent(taskId)`

**Imports needed:**
- `getAllTaskAgents, removeTaskAgent` from `../agents/task-agent`

### Task 4: Initialize HarnessAgent when orchestrator starts

**File:** `src/main/dag-engine/orchestrator.ts`

The HarnessAgent needs to be initialized before processing intentions:

Modify `start()`:
- After setting status to 'running', initialize harness
- Call `getHarnessAgent().initialize(featureId, featureGoal, graph, claudeMd, projectRoot)`
- Call `getHarnessAgent().start()`

Modify `stop()`:
- Call `getHarnessAgent().stop()`
- Call `getHarnessAgent().reset()`

This requires loading feature goal and CLAUDE.md in `start()`, similar to `assignAgentToTask()`.

## Checkpoint

After each task, run:
```bash
npm run typecheck && npm run build
```

## Verification

- [ ] `npm run typecheck` passes
- [ ] `npm run build` completes successfully
- [ ] HarnessAgent initializes when orchestrator starts
- [ ] TaskAgent.proposeIntention() called after agent initialization
- [ ] HarnessAgent.processIntention() called for pending intentions
- [ ] TaskAgent.receiveApproval() receives decisions from harness
- [ ] TaskAgent.execute() runs after approval (via autoExecute or explicit call)
- [ ] Task status transitions: ready → running → merging → completed
- [ ] Completed task agents are cleaned up and removed from registry

## Dependencies

- Phase 33: Execution loop (tick-based processing) - COMPLETE
- Phase 34: Agent assignment (TaskAgent creation) - COMPLETE
- Existing TaskAgent methods: proposeIntention(), receiveApproval(), execute()
- Existing HarnessAgent methods: receiveIntention(), processIntention()

## Files Modified

- `src/main/dag-engine/orchestrator.ts` - All 4 tasks

## Notes

- The workflow is: initialize → proposeIntention → receiveIntention → processIntention → receiveApproval → execute → completion
- TaskAgent.config.autoExecute determines if execute() is called automatically after approval
- Default is `autoExecute: true`, so execution should start automatically
- Merge is simplified in this phase - actual git merge is Phase 36 scope
