---
phase: 40-log-ui-integration
plan: 01
type: execute
---

<objective>
Update LogDialog to show per-task conversation history from TaskAgentSession.

Purpose: Display bidirectional message thread between task agent and harness, replacing filtered harness log with actual conversation session
Output: LogDialog shows conversation messages with direction indicators and message type filtering
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependency chain):
@.planning/phases/37-task-agent-sessions/37-01-SUMMARY.md
@.planning/phases/37-task-agent-sessions/37-02-SUMMARY.md
@.planning/phases/38-message-queue/38-01-SUMMARY.md
@.planning/phases/39-harness-router/39-02-SUMMARY.md

# Key files:
@src/shared/types/log.ts
@src/renderer/src/components/DAG/LogDialog.tsx
@src/renderer/src/views/DAGView.tsx
@src/main/storage/feature-store.ts

**Tech stack available:**
- TaskAgentSession and TaskAgentMessage types (from 37-01)
- FeatureStore.loadTaskSession() method (from 37-01)
- IPC handler storage:loadTaskSession (exposed in preload)

**Established patterns:**
- LogDialog takes entries prop and displays with filter
- TaskAgentMessage has direction (task_to_harness/harness_to_task) and type fields
- Sessions stored at .dagent/nodes/{taskId}/session.json

**Constraining decisions:**
- Phase 37: Session stored as session.json per task node directory
- Phase 37: Messages include direction for conversation flow
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SessionLogDialog component</name>
  <files>src/renderer/src/components/DAG/SessionLogDialog.tsx</files>
  <action>
Create new SessionLogDialog component for displaying TaskAgentSession messages:
- Accept props: session (TaskAgentSession | null), title (string), onClose callback
- Display messages as conversation thread with direction indicators
  - task_to_harness: right-aligned, blue background (like outgoing message)
  - harness_to_task: left-aligned, purple background (like incoming message)
- Add filter controls for message type (intention, approval, rejection, progress, completion, error, all)
- Show session status badge (active, completed, failed)
- Show timestamps in readable format
- Empty state: "No session messages yet"
- Maintain similar visual style to existing LogDialog (dark theme, same spacing)
</action>
  <verify>npm run typecheck passes, component exports correctly</verify>
  <done>SessionLogDialog component renders session messages with direction styling and type filtering</done>
</task>

<task type="auto">
  <name>Task 2: Update DAGView to use SessionLogDialog for tasks</name>
  <files>src/renderer/src/views/DAGView.tsx, src/renderer/src/components/DAG/index.ts</files>
  <action>
Update DAGView to load TaskAgentSession instead of filtered harness log:
- Add import for SessionLogDialog and TaskAgentSession type
- Add state: taskSession (TaskAgentSession | null)
- In handleLogTask: call window.electronAPI.storage.loadTaskSession(featureId, taskId)
- Set taskSession state with result
- Render SessionLogDialog when logDialogSource === 'task', passing taskSession
- Keep LogDialog for PM logs (logDialogSource === 'pm')
- Export SessionLogDialog from DAG/index.ts
</action>
  <verify>npm run typecheck passes, clicking task log button shows session messages</verify>
  <done>Task log button opens SessionLogDialog with per-task conversation history</done>
</task>

<task type="auto">
  <name>Task 3: Add real-time session updates during execution</name>
  <files>src/renderer/src/views/DAGView.tsx</files>
  <action>
Add polling for real-time session updates when dialog is open:
- Add useEffect that polls loadTaskSession every 2 seconds when:
  - logDialogOpen is true
  - logDialogSource is 'task'
  - logDialogTaskId is set
- Clear interval when dialog closes or conditions change
- Only update state if message count changed (prevent unnecessary re-renders)
- Do NOT poll for PM logs (they use different mechanism)
</action>
  <verify>npm run typecheck passes, session dialog updates as task agent adds messages</verify>
  <done>Session dialog shows live updates during task execution with 2s polling</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run typecheck` passes without errors
- [ ] Task log button opens SessionLogDialog with conversation view
- [ ] Messages show direction (task→harness vs harness→task) visually
- [ ] Filter buttons work for message types
- [ ] PM log button still opens regular LogDialog
- [ ] Real-time polling updates session during execution
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- SessionLogDialog shows bidirectional conversation thread
- Filtering by message type works correctly
- Real-time updates during task execution
</success_criteria>

<output>
After completion, create `.planning/phases/40-log-ui-integration/40-01-SUMMARY.md`
</output>
