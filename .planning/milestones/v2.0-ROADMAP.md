# Milestone v2.0: Request Manager & Task Pipeline

**Status:** SHIPPED 2026-01-15
**Phases:** 41-46
**Total Plans:** 9

## Overview

Major architectural overhaul to enable scalable parallel execution. Introduces centralized request management with priority queuing, granular task states, pool-based task management, and a QA agent for code verification.

## Goals

1. **Centralized Request Manager** - Control concurrent API requests with priority queue
2. **Granular Task States** - blocked/ready/dev/qa/merging/completed/failed
3. **Pool-Based Management** - Tasks organized by state for efficient assignment
4. **QA Agent** - Code quality and spec verification with dev feedback loop
5. **Visual Status Indicators** - Task state badges in DAG view

## Phases

### Phase 41: Request Manager Infrastructure

**Goal:** Centralized request manager with priority queue for Claude SDK requests.

**Key Insight:** Agents don't consume resources - API requests do. Can have many agents but limit concurrent requests.

**Priority Levels (highest first):**
| Priority | Source | Rationale |
|----------|--------|-----------|
| P0 | PM Agent | Human is waiting |
| P1 | Harness responding to Merge | Unblock fastest |
| P2 | Merge Agent | Unblock dependents |
| P3 | QA Agent | Validate before merge |
| P4 | Harness responding to Dev | |
| P5 | Dev Agent | New work |

**Deliverables:**
- RequestManager class with configurable max concurrent (default: 3)
- Priority queue with FIFO within same priority level
- `enqueue()` returns Promise that resolves when request completes
- Agents block on await - don't know/care about queue position
- No timeout or starvation prevention (simpler model)

**Files:**
- `src/main/agent/request-manager.ts` - RequestManager class
- `src/main/agent/request-types.ts` - QueuedRequest, Priority types
- `src/main/agent/agent-service.ts` - Integrate with RequestManager

**Research:** None - design is clear

---

### Phase 42: Task State Machine Refactor

**Goal:** Replace current task states with granular pipeline states.

**Current States:** blocked, ready, running, merging, completed, failed

**New States:**
| State | Meaning | Pool |
|-------|---------|------|
| `blocked` | Waiting on dependencies | Blocked pool |
| `ready` | Dependencies met, waiting for agent | Ready pool |
| `dev` | Agent working on implementation | Active pool |
| `qa` | Agent verifying code quality | Active pool |
| `merging` | Merging into feature branch | Active pool |
| `completed` | Done, merged | Completed pool |
| `failed` | Error occurred | Failed pool |

**Transitions:**
- `blocked` → `ready`: All dependencies completed (cascade)
- `ready` → `dev`: Dev agent assigned
- `dev` → `qa`: Dev work committed
- `dev` → `failed`: Dev error
- `qa` → `merging`: QA passed
- `qa` → `dev`: QA failed (rework with feedback)
- `qa` → `failed`: QA error
- `merging` → `completed`: Merge successful
- `merging` → `failed`: Merge conflict/error
- `completed` → (cascade): Unblock dependents

**Deliverables:**
- Update TaskStatus type with new states
- Update task-controller.ts transition logic
- Update cascade.ts for new states
- Update all agent status updates

**Files:**
- `src/shared/types/dag.ts` - TaskStatus type
- `src/main/dag-engine/task-controller.ts` - Transition rules
- `src/main/dag-engine/cascade.ts` - Cascade logic
- `src/main/agents/task-agent.ts` - Status updates
- `src/main/agents/merge-agent.ts` - Status updates

**Research:** None - design is clear

---

### Phase 43: Pool-Based Task Management

**Goal:** Organize tasks into pools by state for efficient assignment and prioritization.

**Pool Structure:**
```
TaskPoolManager
├── blocked: Set<taskId>
├── ready: Set<taskId>      ← Priority for assignment
├── dev: Set<taskId>        ← Active work
├── qa: Set<taskId>         ← Active work
├── merging: Set<taskId>    ← Active work (highest priority)
├── completed: Set<taskId>
└── failed: Set<taskId>
```

**Assignment Priority:**
1. Merging pool (unblocks dependents fastest)
2. QA pool (validates work before merge)
3. Ready pool (new work to start)

**Deliverables:**
- TaskPoolManager class
- Pool initialization from graph state
- Move task between pools on state change
- `getNextTask()` returns highest priority task
- Integrate with orchestrator tick loop

**Files:**
- `src/main/dag-engine/task-pool.ts` - TaskPoolManager class
- `src/main/dag-engine/orchestrator.ts` - Use pool for assignment

**Research:** None - design is clear

---

### Phase 44: QA Agent Implementation

**Goal:** QA agent verifies code quality and spec compliance, provides feedback for rework.

**QA Agent Responsibilities:**
- Review code changes against task spec
- Check code quality (no obvious bugs, follows patterns)
- Pass: Transition task to `merging`
- Fail: Transition task to `dev` with concise feedback

**Feedback Format:**
```
QA FAILED:
- Issue: [specific problem]
- Fix: [what to change]
```

**Key Behaviors:**
- Autonomous (no harness communication needed)
- Has full context: task spec, code diff, codebase patterns
- Updates task status directly
- Keeps feedback brief - just enough for dev to understand

**Dev → QA → Dev Loop:**
- Dev agent commits, transitions to `qa`
- QA agent reviews, passes or fails
- On fail: QA feedback stored on task, task transitions to `dev`
- Dev agent sees feedback in context, fixes issues
- Loop continues until QA passes

**Deliverables:**
- QAAgent class
- QA review prompt builder
- Feedback storage on task (qaFeedback field)
- Dev agent reads qaFeedback in context
- Status transition logic

**Files:**
- `src/main/agents/qa-agent.ts` - QAAgent class
- `src/main/agents/qa-types.ts` - QAAgentState, QAResult types
- `src/shared/types/dag.ts` - Add qaFeedback to Task type
- `src/main/agents/task-agent.ts` - Read qaFeedback in context

**Research:** May need to experiment with QA prompt for good results

---

### Phase 45: Agent Communication Refactor

**Goal:** Simplify agent communication - only dev talks to harness.

**Communication Model:**
| Agent | Talks to Harness? | Why |
|-------|-------------------|-----|
| Dev | Yes | "dev-task1: Can I implement X this way?" |
| QA | No | Has full context (code + spec) |
| Merge | No | Mechanical operation |
| PM | Yes | Human interaction channel |

**Dev → Harness Pattern:**
- Dev agent includes `agentId: 'dev-task1'` in requests
- Harness sees: "dev-task1: [message]"
- Harness responds with approval/guidance
- Harness priority inherits from who's asking

**Status Updates:**
Agents update task status directly (no harness involvement):
| Agent | Status Transitions |
|-------|-------------------|
| Dev | `ready → dev`, `dev → qa` (on commit) |
| QA | `qa → merging` (pass), `qa → dev` (fail + feedback) |
| Merge | `merging → completed`, `merging → failed` |
| Cascade | `blocked → ready` (on dependency complete) |

**Deliverables:**
- Update dev agent request format with agentId
- Remove harness calls from QA and Merge agents
- Update harness to handle dev-only communication
- Ensure all agents update status directly

**Files:**
- `src/main/agents/task-agent.ts` - Dev agent format
- `src/main/agents/qa-agent.ts` - No harness calls
- `src/main/agents/merge-agent.ts` - No harness calls
- `src/main/agents/harness-agent.ts` - Dev-only routing

**Research:** None - design is clear

---

### Phase 46: DAG View Status Badges

**Goal:** Visual indication of task state in DAG view (dev/qa/merging badges).

**Badge Types:**
| State | Badge | Color |
|-------|-------|-------|
| `dev` | DEV | Blue |
| `qa` | QA | Yellow |
| `merging` | MERGE | Purple |
| `failed` | FAILED | Red |

**Display:**
- Badge appears on TaskNode component
- Shows current state during execution
- Disappears when task completes
- Tooltip shows additional info (agent id, duration)

**Deliverables:**
- Update TaskNode to show state badge
- Badge styling with appropriate colors
- Tooltip with state details
- Real-time updates during execution

**Files:**
- `src/renderer/src/components/DAG/TaskNode.tsx` - Badge display
- `src/renderer/src/components/DAG/TaskNode.css` - Badge styles

**Research:** None - design is clear

---

## Dependencies

```
Phase 41 (Request Manager)
    │
    └──► Phase 42 (Task States) ──► Phase 43 (Pools)
                                        │
    ┌───────────────────────────────────┘
    │
    ▼
Phase 44 (QA Agent) ──► Phase 45 (Communication)
                            │
                            ▼
                       Phase 46 (Badges)
```

## Success Criteria

1. **Request Manager:** Max 3 concurrent requests, priority respected
2. **Task States:** Full pipeline blocked→ready→dev→qa→merging→completed
3. **Pools:** O(1) next task lookup, correct prioritization
4. **QA Agent:** Code review with feedback loop until pass
5. **Communication:** Dev talks to harness, QA/merge autonomous
6. **Badges:** Visual state indication in DAG view

## Estimated Complexity

| Phase | Plans | Complexity |
|-------|-------|------------|
| 41. Request Manager | 2 | Medium |
| 42. Task States | 2 | Medium |
| 43. Pool Management | 1 | Low |
| 44. QA Agent | 2 | Medium |
| 45. Communication | 1 | Low |
| 46. Status Badges | 1 | Low |

**Total:** 6 phases, ~9 plans
