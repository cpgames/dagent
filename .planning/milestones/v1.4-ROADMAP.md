# Milestone v1.4: Agent System Overhaul

**Status:** Planning
**Phases:** 19-24
**Estimated Plans:** 12-16

## Overview

Major overhaul of the agent system to create a unified, configurable agent architecture. Centralizes chat UI, adds intelligent task management, introduces configurable agent roles, and provides comprehensive codebase context to all agents.

## Goals

1. **Unified Chat Interface** - Single chat component used across features, tasks, logs, and agent intercommunication
2. **Intelligent Task Management** - PM Agent with CRUD operations, dependency inference, and smart placement
3. **Configurable Agent Roles** - Visual Agents View with PM, Harness, Developer, QA, and Merge agent configuration
4. **Full Context Access** - All agents have codebase/project context for intelligent decision-making
5. **Feature Lifecycle** - Complete feature management including deletion with cleanup

---

## Phases

### Phase 19: Centralized Chat Component

**Goal**: Refactor chat into a reusable component for all agent interactions
**Depends on**: v1.3 complete
**Plans**: 2-3 plans

Plans:
- [ ] 19-01: Extract unified ChatPanel component with agent name header and clear button
- [ ] 19-02: Remove context refresh button (context provided automatically)
- [ ] 19-03: Integrate ChatPanel into FeatureChat, TaskChat, and agent logs

**Key changes:**
- Create `ChatPanel` component with:
  - Agent name display in header
  - Clear conversation button
  - Message history with streaming support
  - Input area with send/stop controls
- Remove manual "Refresh context" button - context is automatic
- Support different contexts: feature, task, agent intercommunication
- Reuse across all chat scenarios

**Current state:**
- `FeatureChat.tsx` has hardcoded chat UI
- Context refresh is manual
- No agent name display

### Phase 20: Agents View

**Goal**: Create sidebar view for agent configuration and status
**Depends on**: Phase 19
**Plans**: 2-3 plans

Plans:
- [ ] 20-01: Add Agents View tab in sidebar with agent cards
- [ ] 20-02: Agent configuration UI (instructions, capabilities, model selection)
- [ ] 20-03: Running status indicators and agent activity display

**Key changes:**
- New sidebar button for "Agents" view
- Display configurable agent types:
  - **PM Agent** - Task creation, planning, CRUD operations
  - **Harness Agent** - Intention review, approval workflow
  - **Developer Agent** - Code execution, implementation
  - **QA Agent** - Testing, verification
  - **Merge Agent** - Branch integration, conflict resolution
- Each agent shows:
  - Running/idle status indicator
  - Current task (if running)
  - Configuration options
- Agent instructions editable per-project

**Agent configuration fields:**
- Name/Role
- System prompt/Instructions
- Allowed tools
- Model preference (if configurable)
- Permission mode

### Phase 21: Task Creation from Chat

**Goal**: Enable PM Agent to create tasks via Feature Chat
**Depends on**: Phase 20
**Plans**: 2 plans

Plans:
- [ ] 21-01: Add task creation skill/tool for PM Agent
- [ ] 21-02: Intelligent task placement with dependency inference

**Key changes:**
- PM Agent can create tasks when user requests via Feature Chat
- Agent skill for `createTask`:
  - Title, description
  - Dependency inference from existing tasks
  - Smart placement in DAG
- Dependency inference logic:
  - Analyze task description and existing tasks
  - Suggest dependencies based on:
    - File/module relationships
    - Sequential workflow patterns
    - Explicit mentions ("after X", "depends on Y")
- New tasks appear in DAG view immediately

**Example flow:**
```
User: "Add a task to implement user authentication"
PM Agent: [analyzes existing tasks and codebase]
PM Agent: "I'll create a task 'Implement user authentication'.
          Based on the codebase, this should depend on 'Setup database models'
          and be a dependency for 'Add protected routes'. Does this look right?"
User: "Yes, create it"
PM Agent: [creates task with inferred dependencies]
```

### Phase 22: PM Agent CRUD Operations

**Goal**: Full task management through PM Agent
**Depends on**: Phase 21
**Plans**: 2 plans

Plans:
- [ ] 22-01: Task update and delete operations via chat
- [ ] 22-02: Batch operations and task reorganization

**Key changes:**
- PM Agent skills for task management:
  - `updateTask` - Modify title, description, dependencies
  - `deleteTask` - Remove task (with dependency handling)
  - `reorderTasks` - Change dependencies/position
  - `listTasks` - View current task list with status
- Safe deletion handling:
  - Warn if task has dependents
  - Option to cascade or reassign dependencies
- Conversation-driven task editing

### Phase 23: Feature Deletion

**Goal**: Safe feature deletion with full cleanup
**Depends on**: Phase 22
**Plans**: 1-2 plans

Plans:
- [ ] 23-01: Feature deletion with confirmation dialog and cleanup

**Key changes:**
- Delete button on feature panel
- Confirmation dialog showing:
  - Feature name
  - Number of tasks to be deleted
  - Git branches/worktrees to be cleaned up
  - Warning about irreversibility
- Cleanup operations:
  - Remove feature from storage
  - Delete associated tasks
  - Remove git worktrees
  - Delete feature branch (optional, with warning)
  - Clear chat history
- Option to preserve git history (archive branch)

### Phase 24: Universal Context Access

**Goal**: All agents have full codebase and project context
**Depends on**: Phase 23
**Plans**: 2 plans

Plans:
- [ ] 24-01: Context assembly service for project/codebase awareness
- [ ] 24-02: Integrate context into all agent prompts

**Key changes:**
- `ContextService` provides:
  - Project structure (key files, directories)
  - CLAUDE.md/PROJECT.md content
  - Recent git history
  - Current feature/task context
  - DAG state and dependencies
- All agents receive context automatically:
  - PM Agent: Full project understanding for task creation
  - Harness Agent: Context for intention review
  - Developer Agent: Codebase context for implementation
  - QA Agent: Test context and requirements
  - Merge Agent: Branch context for conflict resolution
- Context updated as project evolves

---

## Priority

1. **Phase 19** - Centralized chat is foundation for all agent UI
2. **Phase 20** - Agents View provides visibility and configuration
3. **Phase 21** - Task creation from chat is key user workflow
4. **Phase 22** - CRUD operations complete task management
5. **Phase 23** - Feature deletion enables cleanup
6. **Phase 24** - Universal context improves all agent intelligence

## Success Criteria

- [ ] Single ChatPanel component used everywhere
- [ ] Agents View shows all 5 agent types with status
- [ ] PM Agent can create tasks from Feature Chat
- [ ] New tasks have intelligently inferred dependencies
- [ ] Tasks can be updated/deleted via PM Agent
- [ ] Features can be deleted with full cleanup
- [ ] All agents show running/idle status
- [ ] All agents have project context automatically

## Technical Notes

**ChatPanel Props:**
```typescript
interface ChatPanelProps {
  agentName: string
  context: 'feature' | 'task' | 'agent'
  contextId: string
  onClear: () => void
}
```

**Agent Configuration Type:**
```typescript
interface AgentConfig {
  type: 'pm' | 'harness' | 'developer' | 'qa' | 'merge'
  name: string
  instructions: string
  allowedTools: string[]
  permissionMode: 'default' | 'acceptEdits' | 'bypassPermissions'
  model?: string
}
```

**Task Creation Skill:**
```typescript
interface CreateTaskInput {
  title: string
  description: string
  suggestedDependencies?: string[] // Task IDs
  autoInferDependencies?: boolean
}
```

**Dependency Inference:**
- Parse task description for keywords
- Match against existing task titles/descriptions
- Analyze codebase for file relationships
- Consider temporal patterns (setup before implementation)

---

*For current project status, see .planning/ROADMAP.md*
