# v1.9 Agent Communication Architecture

## Overview

Refactored agent communication from direct method calls to message-based sessions. Each task agent now has its own session file for conversation history with the harness, and all inter-agent communication flows through a central MessageBus using publish/subscribe patterns.

## Phases

- [x] **Phase 37: Task Agent Sessions** - Per-task log files for conversation history with harness (3/3 plans)
- [x] **Phase 38: Message Queue** - Replace direct method calls with message passing (2/2 plans)
- [x] **Phase 39: Harness Router** - Harness receives and routes messages by taskId (2/2 plans)
- [x] **Phase 40: Log UI Integration** - Update LogDialog to show per-task conversation history (1/1 plans)

## Phase Details

### Phase 37: Task Agent Sessions
**Goal**: Each task agent gets its own log file/session for conversation history with harness

Accomplishments:
- TaskAgentSession and TaskAgentMessage types for per-task conversation history
- Session stored at `.dagent/nodes/{taskId}/session.json`
- Messages include direction (task_to_harness/harness_to_task) for conversation flow
- TaskAgent automatic session lifecycle management
- Session logging at all lifecycle points (initialize, intention, approval, execution)
- Session resume detection and IPC handlers for renderer access

### Phase 38: Message Queue
**Goal**: Replace direct method calls with message passing between agents

Accomplishments:
- InterAgentMessage types with 7 message types (task_registered, intention_proposed, etc.)
- MessageBus singleton extending EventEmitter with publish/subscribe pattern
- Multi-channel emission: general, task-specific, type-specific
- Factory functions for typed message construction
- TaskAgent publishes messages instead of calling harness methods directly
- Dual-write approach for backward compatibility during migration

### Phase 39: Harness Router
**Goal**: Harness receives and routes messages from all task agents by taskId

Accomplishments:
- HarnessAgent subscribes to MessageBus on start()
- Message handler routing by type (task_registered, intention_proposed, task_working, etc.)
- Dual-write protection to avoid duplicate processing during migration
- HarnessAgent publishes approval/rejection via MessageBus
- Full migration: TaskAgent no longer calls harness methods directly
- Complete message flow: task_registered → intention_proposed → approved/rejected → task_working → task_completed/failed

### Phase 40: Log UI Integration
**Goal**: Update LogDialog to show per-task conversation history

Accomplishments:
- SessionLogDialog component with conversation-style message display
- Direction indicators: task→harness (blue, right) vs harness→task (purple, left)
- Filter controls for message types (intention, approval, rejection, progress, completion, error)
- Session status badge (active, completed, failed, paused)
- Real-time polling (2s interval) when task log dialog is open
- Conditional rendering: SessionLogDialog for task logs, LogDialog for PM logs

## Progress

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 37. Task Agent Sessions | 3/3 | Complete | 2026-01-14 |
| 38. Message Queue | 2/2 | Complete | 2026-01-14 |
| 39. Harness Router | 2/2 | Complete | 2026-01-14 |
| 40. Log UI Integration | 1/1 | Complete | 2026-01-14 |
