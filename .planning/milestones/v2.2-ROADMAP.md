# v2.2 Task Pipeline Refactor

## Overview

Refactor the task management system to use queue-based pools as the single source of truth for task state, and move commit responsibility from dev to QA agent.

## Goals

1. **Simplify task state management** - Pools become workflow queues that orchestrator monitors
2. **Decouple agents from pool manipulation** - Agents signal via events, orchestrator moves tasks
3. **Improve code quality** - QA commits only after successful review (no bad commits from failed QA)

## Phases

### Phase 50: Queue-Based Pool Refactor

**Objective:** Restructure TaskPoolManager to use workflow queues as the single source of truth.

**Current structure:**
- 7 pools: blocked, ready, dev, qa, merging, completed, failed
- Multiple places track state (pools + agentState.status)

**New structure:**
- Assignment queues: ready_for_dev, ready_for_qa, ready_for_merge
- Terminal pools: completed, failed, blocked
- in_progress pool (nominal - just for tracking, orchestrator doesn't use it for assignment)

**Key changes:**
1. Rename pools in TaskPoolManager
2. Update orchestrator to check assignment queues for work
3. Agents signal completion via events (not pool moves)
4. Orchestrator is the only component that moves tasks between pools

**Files affected:**
- `src/main/dag-engine/task-pool.ts` - Pool restructure
- `src/main/dag-engine/orchestrator.ts` - Queue-based assignment
- `src/main/agents/task-agent.ts` - Remove pool manipulation, use events
- `src/main/agents/qa-agent.ts` - Remove pool manipulation, use events
- `src/main/agents/merge-agent.ts` - Remove pool manipulation, use events
- `src/shared/types/task.ts` - Update TaskStatus type

### Phase 51: QA Commits

**Objective:** Move git commit responsibility from dev agent to QA agent.

**Current flow:**
1. Dev agent codes and commits
2. QA reviews
3. If QA fails, we have a bad commit that needs fixing

**New flow:**
1. Dev agent codes (no commit)
2. QA reviews the working changes
3. If QA passes, QA commits
4. If QA fails, dev gets feedback (no bad commit created)

**Key changes:**
1. Remove git commit from TaskAgent execute()
2. Add git commit to QAAgent on pass
3. Update worktree handling (keep worktree until QA completes)
4. Update merge agent to work with QA's commit

**Files affected:**
- `src/main/agents/task-agent.ts` - Remove git commit
- `src/main/agents/qa-agent.ts` - Add git commit on pass
- `src/main/dag-engine/orchestrator.ts` - Update worktree lifecycle

## Success Criteria

- [ ] Pools are the single source of truth for task state
- [ ] Orchestrator monitors assignment queues (ready_for_*)
- [ ] Agents signal via events, don't manipulate pools
- [ ] Dev agent no longer commits code
- [ ] QA agent commits only on successful review
- [ ] No bad commits from failed QA reviews
- [ ] All existing functionality preserved

## Estimated Plans

- Phase 50: 2 plans (pool restructure, orchestrator integration)
- Phase 51: 2 plans (dev commit removal, QA commit addition)

**Total: 4 plans**
