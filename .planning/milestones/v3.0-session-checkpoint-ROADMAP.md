# Milestone v3.0: Session & Checkpoint Architecture

## Overview

Implement centralized session management with automatic checkpoint compaction for all agent interactions. This replaces the fragmented chat storage system with a unified approach that:

- **Never exceeds token limits** through automatic compaction
- **Preserves full conversation history** in checkpoint format
- **Maintains fresh context** per request (Ralph Loop principle)
- **Works universally** for all agent types (PM, Dev, QA, Harness, Merge)

**Success Criteria**:
- All agent interactions use SessionManager
- Automatic compaction triggers at 100k tokens
- No breaking changes to existing features
- Full migration from old chat.json/session.json format

---

## Phase 1: Foundation (Core Infrastructure)

**Goal**: Build the core SessionManager and file structures without breaking existing functionality.

### Tasks

#### 1.1: Create Session Type Definitions
**File**: `src/shared/types/session.ts`

```typescript
// Define all session-related types:
// - ChatMessage
// - ChatSession
// - Checkpoint
// - SessionContext
// - AgentDescription
// - SessionType enum
```

**Acceptance Criteria**:
- All types exported from shared/types
- TypeScript compilation successful
- No breaking changes to existing types

**Dependencies**: None

---

#### 1.2: Implement TokenEstimator Utility
**File**: `src/main/services/token-estimator.ts`

```typescript
// Use tiktoken or approximation algorithm
// Methods:
// - estimate(text: string): number
// - estimateMessages(messages: ChatMessage[]): number
// - estimateCheckpoint(checkpoint: Checkpoint): number
```

**Acceptance Criteria**:
- Accurate token estimation (within 5% of actual)
- Fast performance (< 10ms for typical requests)
- Handles edge cases (empty strings, special characters)

**Dependencies**: None
**Library**: May need `tiktoken` npm package

---

#### 1.3: Create SessionManager Service (Core)
**File**: `src/main/services/session-manager.ts`

**Scope**: Basic CRUD operations only (no compaction yet)

```typescript
class SessionManager {
  // Session lifecycle
  createSession(type, featureId, taskId?, state?)
  getSession(sessionId)

  // Message operations
  addMessage(sessionId, role, content)
  getMessages(sessionId)

  // File I/O
  loadChatSession(sessionId)
  saveChatSession(sessionId, chat)
  loadCheckpoint(sessionId)
  saveCheckpoint(sessionId, checkpoint)
  loadContext(sessionId)
  loadAgentDescription(sessionId)

  // Path helpers
  getSessionDir(sessionId)
  getChatPath(sessionId)
  getCheckpointPath(sessionId)
  // etc.
}
```

**Acceptance Criteria**:
- Can create sessions with all 4 files (chat, checkpoint, context, agent-desc)
- Can add/retrieve messages
- Proper file structure in .dagent/sessions/
- All operations have error handling

**Dependencies**: 1.1 (types), 1.2 (token estimator)

---

#### 1.4: Add SessionManager IPC Handlers
**File**: `src/main/ipc/session-handlers.ts`

```typescript
// IPC handlers:
// - session:create
// - session:get
// - session:addMessage
// - session:getMessages
// - session:getCheckpoint
// - session:estimateSize
```

**Acceptance Criteria**:
- All handlers registered in main.ts
- Renderer can call all session operations
- Proper error propagation to renderer

**Dependencies**: 1.3 (SessionManager)

---

#### 1.5: Update Preload API for Sessions
**Files**:
- `src/preload/index.d.ts`
- `src/preload/index.ts`

```typescript
interface SessionAPI {
  create(type, featureId, taskId?, state?): Promise<string>
  get(sessionId): Promise<Session>
  addMessage(sessionId, role, content): Promise<void>
  getMessages(sessionId): Promise<ChatMessage[]>
  getCheckpoint(sessionId): Promise<Checkpoint>
  estimateSize(sessionId): Promise<number>
}
```

**Acceptance Criteria**:
- Type-safe API exposed to renderer
- All IPC methods wrapped
- Documentation comments added

**Dependencies**: 1.4 (IPC handlers)

---

## Phase 2: Compaction Engine

**Goal**: Implement automatic checkpoint compaction when token limit is reached.

### Tasks

#### 2.1: Implement Compaction Prompt Builder
**File**: `src/main/services/session-manager.ts` (extend)

```typescript
private buildCompactionPrompt(checkpoint: Checkpoint, chat: ChatSession): string
private parseCompactionResult(response: string): CheckpointSummary
```

**Acceptance Criteria**:
- Prompt clearly instructs Claude on compaction task
- Handles empty checkpoints (first compaction)
- Parses JSON response correctly
- Handles malformed responses gracefully

**Dependencies**: Phase 1 complete

---

#### 2.2: Implement Compaction Logic
**File**: `src/main/services/session-manager.ts` (extend)

```typescript
private async compact(sessionId: string): Promise<void>
private async checkAndCompact(sessionId: string): Promise<void>
private estimateRequestSize(sessionId: string): Promise<number>
```

**Acceptance Criteria**:
- Automatically triggers at 100k tokens
- Successfully creates updated checkpoint
- Clears messages after compaction
- Logs compaction events
- Handles compaction failures gracefully
- Does not compact during compaction (prevent recursion)

**Dependencies**: 2.1 (compaction prompts)

---

#### 2.3: Add Compaction Monitoring & Events
**File**: `src/main/services/session-manager.ts` (extend)

```typescript
// Emit events:
// - compaction:start
// - compaction:complete
// - compaction:error

// Track metrics:
// - Total compactions per session
// - Tokens saved
// - Compaction duration
```

**Acceptance Criteria**:
- Events emitted to renderer
- Metrics stored in checkpoint.tokens
- UI can display compaction status

**Dependencies**: 2.2 (compaction logic)

---

#### 2.4: Test Compaction with Large Conversations
**File**: `src/main/services/__tests__/session-manager.test.ts`

**Acceptance Criteria**:
- Create session with > 100k tokens
- Verify compaction triggers
- Verify checkpoint contains key info
- Verify messages cleared
- Verify subsequent requests < 100k tokens

**Dependencies**: 2.3 (complete compaction)

---

## Phase 3: Request Building

**Goal**: Build complete agent requests from session components.

### Tasks

#### 3.1: Implement Context Formatting
**File**: `src/main/services/session-manager.ts` (extend)

```typescript
private formatContext(context: SessionContext): string
private formatCheckpoint(checkpoint: Checkpoint): string
private formatMessages(messages: ChatMessage[]): string
```

**Acceptance Criteria**:
- Context formatted as clear markdown sections
- Checkpoint shows completed/pending/decisions/blockers
- Messages formatted as conversation history
- Proper spacing and structure

**Dependencies**: Phase 1 complete

---

#### 3.2: Implement Request Builder
**File**: `src/main/services/session-manager.ts` (extend)

```typescript
async buildRequest(sessionId: string, userMessage: string): Promise<{
  systemPrompt: string
  userPrompt: string
  totalTokens: number
}>
```

**Acceptance Criteria**:
- Combines all 4 components correctly
- System prompt has: agent desc + context + checkpoint + messages
- User prompt is the new message
- Token estimate accurate
- Proper formatting and structure

**Dependencies**: 3.1 (formatting)

---

#### 3.3: Add Request Preview Tool
**File**: `src/main/services/session-manager.ts` (extend)

```typescript
async previewRequest(sessionId: string, userMessage?: string): Promise<{
  systemPrompt: string
  userPrompt: string
  breakdown: {
    agentDescTokens: number
    contextTokens: number
    checkpointTokens: number
    messagesTokens: number
    userPromptTokens: number
    total: number
  }
}>
```

**Acceptance Criteria**:
- Can preview request before sending
- Shows token breakdown by component
- Useful for debugging token usage

**Dependencies**: 3.2 (request builder)

---

## Phase 4: PM Agent Integration

**Goal**: Migrate PM agent to use SessionManager (proof of concept).

### Tasks

#### 4.1: Update PM Planning to Use Sessions
**File**: `src/main/agent/pm-agent-manager.ts`

**Changes**:
- Create session at planning start
- Initialize with feature context
- Add messages during planning
- Save checkpoint on completion

**Acceptance Criteria**:
- Planning creates session correctly
- All planning messages saved
- Checkpoint initialized with feature goals
- No breaking changes to planning workflow

**Dependencies**: Phase 3 complete

---

#### 4.2: Update PM Interactive Chat to Use Sessions
**File**: `src/renderer/src/stores/chat-store.ts`

**Changes**:
- Load session instead of chat.json
- Use session.addMessage() for new messages
- Build requests via session.buildRequest()
- Display checkpoint status in UI

**Acceptance Criteria**:
- Can load existing PM conversations
- Can send new messages
- Compaction triggers automatically
- UI shows when compaction occurs

**Dependencies**: 4.1 (PM planning)

---

#### 4.3: Migrate Existing PM Chat Data
**File**: `src/main/services/migration/chat-to-session.ts`

```typescript
// Migrate old chat.json files to session format
async migratePMChat(featureId: string): Promise<void>
```

**Acceptance Criteria**:
- Existing chat.json converted to session
- Messages preserved
- Initial checkpoint created from conversation
- Old file backed up, not deleted

**Dependencies**: 4.2 (PM integration complete)

---

## Phase 5: Dev Agent Integration (Ralph Loop)

**Goal**: Integrate SessionManager with Ralph Loop iterations.

### Tasks

#### 5.1: Add State-Based Session Management to Tasks
**File**: `src/shared/types/task.ts`

```typescript
interface Task {
  // ...existing fields

  // NEW: Session tracking per state
  sessions?: {
    planning?: string[]      // Session IDs for planning state
    in_dev?: string[]        // Session IDs for in_dev state
    in_qa?: string[]         // Session IDs for in_qa state
    in_review?: string[]     // Session IDs for in_review state
  }
  currentSession?: string    // Active session ID
}
```

**Acceptance Criteria**:
- Type definitions updated
- Backward compatible (sessions optional)
- Clear documentation

**Dependencies**: Phase 3 complete

---

#### 5.2: Update TaskController to Use Sessions
**File**: `src/main/dag-engine/task-controller.ts`

**Changes**:
- Create session at loop start
- Initialize with task context + TaskPlan
- Add iteration results to checkpoint
- Build requests via SessionManager

**Acceptance Criteria**:
- Ralph Loop creates session
- Each iteration adds to checkpoint
- Checkpoint tracks pass/fail checks
- Messages still cleared per iteration (Ralph Loop principle)

**Dependencies**: 5.1 (task sessions)

---

#### 5.3: Update DevAgent to Use SessionManager
**File**: `src/main/agents/dev-agent.ts`

**Changes**:
- Use SessionManager for logging
- Add messages during execution
- Update checkpoint with progress

**Acceptance Criteria**:
- Dev agent logs to session
- Session accessible in UI
- No breaking changes to execution flow

**Dependencies**: 5.2 (TaskController)

---

#### 5.4: Migrate Existing Dev Sessions
**File**: `src/main/services/migration/dev-session-migration.ts`

```typescript
// Migrate nodes/{taskId}/session.json to new format
async migrateDevSession(featureId: string, taskId: string): Promise<void>
```

**Acceptance Criteria**:
- Existing session.json converted
- Messages preserved
- Checkpoint created from session history
- Old file backed up

**Dependencies**: 5.3 (DevAgent integration)

---

## Phase 6: UI Enhancements

**Goal**: Expose session features in the UI.

### Tasks

#### 6.1: Add Session Status Indicator
**File**: `src/renderer/src/components/Chat/SessionStatus.tsx`

**Features**:
- Show current token count
- Show checkpoint version
- Show compaction history
- Warning when approaching limit

**Acceptance Criteria**:
- Visible in chat panel
- Updates in real-time
- Clear visual design

**Dependencies**: Phase 4 complete

---

#### 6.2: Add Checkpoint Viewer
**File**: `src/renderer/src/components/Chat/CheckpointViewer.tsx`

**Features**:
- Display completed items
- Display pending items
- Display decisions made
- Display blockers
- Expandable/collapsible sections

**Acceptance Criteria**:
- Accessible from chat panel
- Shows current checkpoint state
- Updates after compaction

**Dependencies**: 6.1 (session status)

---

#### 6.3: Add Session Actions Menu
**File**: `src/renderer/src/components/Chat/SessionActions.tsx`

**Features**:
- Clear messages (keep checkpoint)
- Force compaction
- Reset session (clear all)
- Export session (JSON download)

**Acceptance Criteria**:
- Actions work correctly
- Confirmation dialogs for destructive actions
- Proper error handling

**Dependencies**: 6.2 (checkpoint viewer)

---

## Phase 7: QA, Harness, Merge Agents

**Goal**: Extend SessionManager to remaining agent types.

### Tasks

#### 7.1: QA Agent Integration
**Files**:
- `src/main/agents/qa-agent.ts` (when implemented)

**Acceptance Criteria**:
- QA agent creates sessions
- Links to task in qa state
- Uses SessionManager for all interactions

**Dependencies**: Phase 5 complete

---

#### 7.2: Harness Agent Integration
**Files**:
- `src/main/agents/harness-agent.ts` (when implemented)

**Acceptance Criteria**:
- Harness creates sessions
- Reviews saved to checkpoint
- Approval/rejection tracked

**Dependencies**: 7.1

---

#### 7.3: Merge Agent Integration
**Files**:
- `src/main/agents/merge-agent.ts` (when implemented)

**Acceptance Criteria**:
- Merge agent creates sessions
- Conflict resolution tracked
- Decisions saved to checkpoint

**Dependencies**: 7.2

---

## Phase 8: Testing & Polish ✓

**Goal**: Comprehensive testing and documentation.
**Status**: Complete (2026-01-17)

### Tasks

#### 8.1: Unit Tests
**Files**: `src/main/services/__tests__/*.test.ts`

**Coverage**:
- SessionManager CRUD operations
- Compaction logic
- Request building
- Token estimation
- Migration scripts

**Acceptance Criteria**:
- > 80% code coverage
- All edge cases tested
- Integration tests for compaction

**Dependencies**: Phase 7 complete

---

#### 8.2: Performance Testing
**File**: `src/main/services/__tests__/session-performance.test.ts`

**Tests**:
- Large session (10k messages)
- Compaction performance
- Concurrent session access
- File I/O performance

**Acceptance Criteria**:
- Compaction completes < 30 seconds
- File operations < 100ms
- No memory leaks

**Dependencies**: 8.1

---

#### 8.3: Migration Testing
**File**: `src/main/services/__tests__/migration.test.ts`

**Tests**:
- Migrate old PM chats
- Migrate old dev sessions
- Handle corrupted files
- Backward compatibility

**Acceptance Criteria**:
- 100% successful migration on test data
- No data loss
- Handles edge cases

**Dependencies**: 8.2

---

#### 8.4: Documentation
**Files**:
- `doc/session-architecture.md`
- `doc/compaction-guide.md`
- Code comments

**Content**:
- Architecture overview
- API documentation
- Migration guide
- Troubleshooting

**Acceptance Criteria**:
- Clear, comprehensive docs
- Examples for all major features
- Migration checklist

**Dependencies**: 8.3

---

## Phase 9: Cleanup & Deprecation ✓

**Goal**: Remove old chat/session code.
**Status**: Complete (2026-01-17)

### Tasks

#### 9.1: Mark Old APIs as Deprecated
**Files**: Various

```typescript
/** @deprecated Use SessionManager instead */
async loadChat(featureId: string): Promise<ChatHistory>
```

**Acceptance Criteria**:
- All old methods marked deprecated
- Console warnings on usage
- Link to migration docs

**Dependencies**: Phase 8 complete

---

#### 9.2: Remove Old Storage Code
**Files**:
- `src/main/storage/feature-store.ts` (chat methods)
- `src/main/ipc/storage-handlers.ts` (chat handlers)

**Acceptance Criteria**:
- Old code removed
- No breaking changes (deprecated methods still work)
- Migration path documented

**Dependencies**: 9.1

---

#### 9.3: Update File Structure Documentation
**File**: `doc/file-structure.md`

**Changes**:
- Document new session structure
- Mark old structure as legacy
- Provide migration timeline

**Acceptance Criteria**:
- Clear documentation
- Examples of new structure
- Migration instructions

**Dependencies**: 9.2

---

## Success Metrics

### Functional
- [ ] All agents use SessionManager
- [ ] Automatic compaction works reliably
- [ ] No conversation data loss during migration
- [ ] UI displays session status

### Performance
- [ ] Compaction completes < 30 seconds
- [ ] File operations < 100ms
- [ ] Memory usage stable over long sessions

### Quality
- [ ] > 80% test coverage
- [ ] Zero critical bugs in production
- [ ] User feedback positive

---

## Risks & Mitigations

### Risk 1: Compaction Quality
**Description**: Compacted checkpoints lose important context

**Mitigation**:
- Extensive testing with real conversations
- User feedback loop
- Ability to view full history in UI

### Risk 2: Migration Failures
**Description**: Old chat data corrupted during migration

**Mitigation**:
- Backup before migration
- Dry-run mode
- Rollback capability

### Risk 3: Performance Issues
**Description**: Compaction takes too long, blocks UI

**Mitigation**:
- Background compaction
- Progress indicators
- Cancellation support

### Risk 4: Breaking Changes
**Description**: Existing features break during migration

**Mitigation**:
- Gradual rollout (feature flags)
- Comprehensive testing
- Backward compatibility layer

---

## Timeline Estimate

**Phase 1**: 1-2 weeks (Foundation)
**Phase 2**: 1 week (Compaction)
**Phase 3**: 3-4 days (Request Building)
**Phase 4**: 1 week (PM Integration)
**Phase 5**: 1 week (Dev Integration)
**Phase 6**: 3-4 days (UI)
**Phase 7**: 1 week (Other Agents)
**Phase 8**: 1 week (Testing)
**Phase 9**: 2-3 days (Cleanup)

**Total**: ~7-8 weeks

**Note**: Timeline assumes single developer working part-time. Can be parallelized.

---

## Dependencies

**External Libraries**:
- `tiktoken` or `gpt-tokenizer` for token estimation
- No other external dependencies

**Internal Dependencies**:
- Existing AgentService
- Existing FeatureStore (for context loading)
- Existing TaskController (Ralph Loop)

---

## Rollback Plan

If critical issues arise:

1. **Keep old system running** alongside new (feature flag)
2. **Data preserved** in both formats during migration period
3. **Can switch back** to old system without data loss
4. **Full rollback** possible by reverting code + restoring backups
