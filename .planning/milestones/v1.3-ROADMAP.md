# Milestone v1.3: Claude Agent SDK Migration

**Status:** Planning
**Phases:** 16-18
**Estimated Plans:** 6-8

## Overview

Migrate from the raw Anthropic SDK (`@anthropic-ai/sdk`) to the Claude Agent SDK (`@anthropic-ai/claude-agent-sdk`). This provides seamless authentication via Claude Code credentials, built-in tool support, and a more robust agent runtime.

## Why Migrate?

**Current issues with `@anthropic-ai/sdk`:**
- Requires manual API key management
- OAuth tokens must be extracted manually from Claude Code config
- Need to handle authentication errors and token refresh ourselves
- Building agent capabilities from scratch

**Benefits of `@anthropic-ai/claude-agent-sdk`:**
- **Automatic authentication** - Inherits Claude Code credentials seamlessly
- **OAuth support** - Works with Claude Pro/Max subscriptions out of the box
- **Built-in tools** - Read, Edit, Bash, Glob, Grep, WebSearch already implemented
- **Agent runtime** - Handles tool execution, context management, retries
- **Streaming support** - Real-time progress updates as agent works

## Phases

### Phase 16: Agent SDK Integration

**Goal**: Replace ChatService with Agent SDK, automatic auth detection
**Depends on**: v1.2 complete
**Plans**: 3 plans

Plans:
- [ ] 16-01: Install Agent SDK, create AgentService wrapper
- [ ] 16-02: Replace ChatService calls with Agent SDK query()
- [ ] 16-03: Update auth system to detect SDK availability, remove manual auth when SDK works

**Key changes:**
- Add `@anthropic-ai/claude-agent-sdk` dependency
- Create AgentService that wraps SDK query() function
- IPC handlers route chat requests to AgentService
- Auth becomes optional - SDK handles it automatically

### Phase 17: Agent Tools & Permissions

**Goal**: Configure agent tools and permission modes for feature chat
**Depends on**: Phase 16
**Plans**: 2 plans

Plans:
- [ ] 17-01: Configure allowedTools for feature chat (Read, Glob, Grep for context)
- [ ] 17-02: Implement permission callbacks for tool approval UI

**Key changes:**
- Define tool sets appropriate for feature planning chat
- Add UI for tool approval if needed (or use acceptEdits mode)
- Stream agent progress to chat UI

### Phase 18: Task Agent Migration

**Goal**: Migrate task execution agents to use SDK
**Depends on**: Phase 17
**Plans**: 2-3 plans

Plans:
- [ ] 18-01: Migrate HarnessAgent to SDK with appropriate tools
- [ ] 18-02: Migrate TaskAgent to SDK with Edit, Bash tools
- [ ] 18-03: Update MergeAgent for SDK-based conflict resolution

**Key changes:**
- Task agents use SDK with full tool access (Read, Edit, Bash, Glob, Grep)
- Harness agent uses SDK for intention generation
- Merge agent uses SDK for conflict analysis

---

## Priority

1. **Phase 16** - Core SDK integration enables automatic auth
2. **Phase 17** - Tool configuration ensures appropriate capabilities
3. **Phase 18** - Full agent migration completes the transition

## Success Criteria

- [ ] Feature chat works without manual API key entry
- [ ] Authentication auto-detects from Claude Code credentials
- [ ] Chat shows agent tool usage in real-time
- [ ] Task agents execute via SDK runtime
- [ ] No regression in existing functionality

## Technical Notes

**SDK Installation:**
```bash
npm install @anthropic-ai/claude-agent-sdk
```

**Basic Usage:**
```typescript
import { query } from '@anthropic-ai/claude-agent-sdk';

for await (const message of query({
  prompt: "Help me plan this feature...",
  options: {
    allowedTools: ["Read", "Glob", "Grep"],
    permissionMode: "default"
  }
})) {
  // Handle streaming messages
}
```

**Electron Considerations:**
- SDK spawns Claude Code process - need to handle in main process
- IPC bridge for renderer to communicate with agent
- May need to configure working directory per project

---

*For current project status, see .planning/ROADMAP.md*
