# Milestone v2.4: Ralph Loop Integration

## Overview

Implement the Ralph Wiggum Loop pattern for DevAgent task execution. This pattern runs agents in iterative loops with fresh context windows, using automated verification to ensure tasks are truly complete before marking them done.

## Problem Statement

Current DevAgent limitations:
1. **Single-shot execution** - Agent runs once and reports completion, even if work is incomplete
2. **Context bloat** - Long tasks accumulate state in a single context window
3. **No self-verification** - No automated checks that build passes, tests pass, lint clean
4. **Premature completion** - Agent may claim "done" before task is actually complete

## Solution: Ralph Loop

Iterative execution pattern where:
1. Each iteration runs with fresh context (no bloat)
2. Agent reads task plan to understand what's failing
3. Works on failing items
4. Automated verification runs (build/test/lint)
5. Plan updated with results
6. Loop continues until all checks pass or max iterations reached

## Reference

- [Ralph Wiggum Guide](https://github.com/JeredBlu/guides/blob/main/Ralph_Wiggum_Guide.md)

## Phases

### Phase 56: Task Plan Infrastructure
**Goal:** Create task plan schema and storage for tracking iteration state

**Deliverables:**
- `TaskPlan` interface with checklist items and iteration tracking
- `task-plan.json` storage in worktree `.dagent/` directory
- Read/write functions for task plan persistence
- Default checklist items (implement, build, lint, test)

**Files:**
- `src/main/agents/task-plan-types.ts` - TaskPlan, ChecklistItem interfaces
- `src/main/agents/task-plan-store.ts` - CRUD operations for task plans

### Phase 57: Verification Runner
**Goal:** Automated verification checks for build, lint, and tests

**Deliverables:**
- `VerificationRunner` class to execute checks in worktree
- Build verification (npm run build / detected build command)
- Lint verification (npm run lint if available)
- Test verification (npm test if available)
- Check result parsing and status extraction

**Files:**
- `src/main/agents/verification-runner.ts` - VerificationRunner class
- `src/main/agents/verification-types.ts` - Check definitions and results

### Phase 58: Task Controller
**Goal:** Loop controller that manages DevAgent iterations

**Deliverables:**
- `TaskController` class managing the iteration loop
- Fresh DevAgent spawning per iteration
- Iteration prompt building (focused on failing items)
- Exit condition checking (all pass / max iterations / abort)
- Activity logging per iteration

**Files:**
- `src/main/agents/task-controller.ts` - TaskController class
- `src/main/agents/task-controller-types.ts` - Loop state and config types

### Phase 59: DevAgent Integration
**Goal:** Wire DevAgent to work within Ralph Loop

**Deliverables:**
- DevAgent reads task-plan.json for context
- Focused iteration prompts instead of full task context
- DevAgent updates plan after work
- Integration with TaskController lifecycle

**Files:**
- `src/main/agents/dev-agent.ts` - Add plan-aware execution mode
- `src/main/agents/dev-types.ts` - Add iteration config

### Phase 60: Orchestrator Integration
**Goal:** Wire orchestrator to use TaskController for task execution

**Deliverables:**
- Orchestrator spawns TaskController instead of direct DevAgent
- Task state updates based on loop results
- Max iterations configurable per feature/project
- Loop status exposed to UI (iteration count, check status)

**Files:**
- `src/main/dag-engine/orchestrator.ts` - Use TaskController
- `src/main/ipc/execution-handlers.ts` - Expose loop status

### Phase 61: Loop Status UI
**Goal:** Visual feedback for iteration progress in UI

**Deliverables:**
- Iteration counter on task node
- Checklist status display (pass/fail indicators)
- Activity log viewer for iteration history
- Abort button to stop loop early

**Files:**
- `src/renderer/src/components/DAG/TaskNode.tsx` - Iteration badge
- `src/renderer/src/components/DAG/NodeDialog.tsx` - Checklist view

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     Orchestrator                             │
│  (detects ready tasks, spawns TaskController)               │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                   TaskController                             │
│  Loop {                                                      │
│    1. Read task-plan.json                                   │
│    2. Check exit conditions                                 │
│    3. Build iteration prompt                                │
│    4. Spawn fresh DevAgent                                  │
│    5. Run VerificationRunner                                │
│    6. Update task-plan.json                                 │
│  } until done                                               │
└──────────────────────┬──────────────────────────────────────┘
                       │
          ┌────────────┴────────────┐
          ▼                         ▼
┌──────────────────┐     ┌──────────────────────┐
│    DevAgent      │     │  VerificationRunner  │
│ (fresh context)  │     │  (build/test/lint)   │
└──────────────────┘     └──────────────────────┘
```

## Task Plan Schema

```json
{
  "taskId": "1234",
  "iteration": 3,
  "maxIterations": 10,
  "status": "running",
  "checklist": [
    { "id": "implement", "description": "Implement the feature", "status": "pass" },
    { "id": "build", "description": "Build passes", "status": "pass" },
    { "id": "lint", "description": "Lint passes", "status": "fail", "error": "2 errors in src/foo.ts" },
    { "id": "test", "description": "Tests pass", "status": "pending" }
  ],
  "activity": [
    { "iteration": 1, "summary": "Initial implementation", "timestamp": "2026-01-15T10:00:00Z" },
    { "iteration": 2, "summary": "Fixed build errors", "timestamp": "2026-01-15T10:05:00Z" }
  ]
}
```

## Configuration

| Setting | Default | Description |
|---------|---------|-------------|
| `maxIterations` | 10 | Maximum loop iterations per task |
| `runBuild` | true | Run build verification |
| `runLint` | true | Run lint verification (if available) |
| `runTests` | false | Run test verification (opt-in) |
| `continueOnLintFail` | true | Continue if only lint fails |

## Success Criteria

- [ ] Tasks iterate until build passes (not just agent claims done)
- [ ] Each iteration has fresh context (no bloat on complex tasks)
- [ ] Verification results visible in UI
- [ ] Can abort loop early if needed
- [ ] Activity history shows iteration progress

## Estimated Scope

- 6 phases
- ~8-10 plans
- New components: TaskController, VerificationRunner, TaskPlanStore
- Modified: DevAgent, Orchestrator, TaskNode, NodeDialog
