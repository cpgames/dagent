# Milestone v2.8: Vertical DAG Flow and Auto-Placement

## Overview

Transform the DAG view from free-form positioning to an intelligent vertical (top-to-bottom) flow with automatic node placement, cycle prevention, and optimized UI for vertical connections.

## Problem Statement

Current DAG view limitations:
1. **Free-form positioning** - Nodes can be placed anywhere, making it hard to visualize dependencies
2. **Side connections** - Node handles on left/right don't work well for vertical flow
3. **No cycle prevention** - Users can create cyclic dependencies (invalid for DAG)
4. **Manual placement** - PM agent and users must manually position nodes
5. **No placement rules** - No enforced alignment or spacing rules
6. **Ambiguous flow direction** - Graph direction not visually clear

## Solution: Vertical Auto-Layout DAG

Structured top-to-bottom flow where:
1. Nodes have connection handles on top and bottom only
2. Tasks without dependencies appear at the top
3. Dependent tasks appear below their blockers
4. Centralized API validates all node/edge operations
5. Cycle detection prevents invalid connections
6. Auto-placement algorithm positions nodes with smart alignment
7. Arrow indicators clearly show dependency direction

## Phases

### Phase 89: DAG API Core
**Goal:** Centralized API for all DAG operations with validation

**Deliverables:**
- `DAGManager` class with add/remove/modify operations
- `addNode(node)` - Add node with auto-placement
- `removeNode(nodeId)` - Remove node and connected edges
- `addConnection(source, target)` - Add edge with cycle check
- `removeConnection(edgeId)` - Remove edge
- `moveNode(nodeId, position)` - Manual repositioning
- Cycle detection algorithm (DFS-based)
- Validation hooks for all operations
- Event emission for store updates

**Files:**
- `src/main/dag-engine/dag-manager.ts` - DAGManager class
- `src/main/dag-engine/dag-validation.ts` - Cycle detection, validation
- `src/main/dag-engine/dag-api-types.ts` - API interfaces

### Phase 90: Auto-Placement Engine
**Goal:** Algorithm to intelligently place nodes in vertical flow

**Deliverables:**
- Topological sorting for layer assignment
- Horizontal centering algorithm for node alignment
- Collision detection and resolution
- Placement rules implementation:
  - Single parent → directly underneath
  - Multiple children → centered horizontally below parent
  - Multiple parents → centered between parents
- Configurable spacing (vertical gap, horizontal spacing)
- Layout recalculation on graph changes

**Files:**
- `src/main/dag-engine/auto-placement.ts` - Placement algorithm
- `src/main/dag-engine/layout-types.ts` - Layout configuration
- `src/main/dag-engine/topological-sort.ts` - Layer assignment

### Phase 91: Vertical Node UI
**Goal:** Update TaskNode component for vertical connections

**Deliverables:**
- Remove left/right connection handles
- Add top connection handle (for incoming dependencies)
- Add bottom connection handle (for outgoing dependencies)
- Connection handle styling for vertical flow
- Update node dimensions for vertical layout
- Arrow indicators on edges (pointing downward)
- Visual depth indicators (color, shadow, or badge)

**Files:**
- `src/renderer/src/components/DAG/TaskNode.tsx` - Vertical handles
- `src/renderer/src/components/DAG/TaskNode.css` - Vertical styling
- `src/renderer/src/components/DAG/CustomEdge.tsx` - Arrow indicators

### Phase 92: DAG View Integration
**Goal:** Wire DAG view to use new DAGManager API

**Deliverables:**
- Replace direct React Flow state manipulation with DAGManager calls
- Hook DAGManager events to update React Flow state
- Disable manual node dragging (or constrain to grid)
- Connection validation before edge creation
- User feedback for invalid operations (cycle warnings)
- Auto-layout trigger on graph changes

**Files:**
- `src/renderer/src/views/DAGView.tsx` - Use DAGManager API
- `src/renderer/src/stores/dag-store.ts` - Wire to DAGManager events
- `src/renderer/src/components/DAG/EdgeValidation.tsx` - Validation UI

### Phase 93: PM Agent DAG Integration
**Goal:** Expose DAG API to PM agent via MCP tools

**Deliverables:**
- MCP tool `dag_add_node` - Create task node with auto-placement
- MCP tool `dag_add_connection` - Connect tasks with validation
- MCP tool `dag_remove_node` - Remove task node
- MCP tool `dag_remove_connection` - Remove connection
- Tool schemas with placement parameters (optional hints)
- PM prompt guidance for DAG operations
- Error handling and feedback to PM agent

**Files:**
- `src/main/agent/pm-dag-tools.ts` - DAG MCP tool implementations
- `src/main/agent/tool-config.ts` - Register DAG tools
- `src/main/agent/prompt-builders.ts` - PM guidance for DAG ops

### Phase 94: Layout Refinements
**Goal:** Polish and optimize layout behavior

**Deliverables:**
- Smooth layout animations (transitions)
- Minimap integration for large graphs
- Zoom controls optimized for vertical flow
- Pan constraints (prevent panning into negative space)
- Layout persistence (save/restore positions)
- Manual override capability (drag nodes with snap-to-grid)
- Layout reset button

**Files:**
- `src/renderer/src/components/DAG/LayoutControls.tsx` - Layout UI controls
- `src/renderer/src/components/DAG/DAGMinimap.tsx` - Minimap component
- `src/main/storage/dag-layout-store.ts` - Persist layout state

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        DAGManager                            │
│  - addNode(node) → auto-placement                           │
│  - addConnection(source, target) → cycle check              │
│  - removeNode(nodeId)                                       │
│  - Emit events to subscribers                               │
└────────────┬───────────────────────────┬────────────────────┘
             │                           │
             ▼                           ▼
┌────────────────────────┐   ┌─────────────────────────────┐
│   AutoPlacementEngine  │   │    CycleDetector            │
│  - topoSort()          │   │  - detectCycle(graph)       │
│  - calculatePositions()│   │  - validateConnection()     │
│  - centerNodes()       │   │                              │
└────────────────────────┘   └─────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────┐
│                       DAGView                                │
│  - Subscribe to DAGManager events                           │
│  - Render nodes with vertical handles                       │
│  - Show validation errors                                   │
└─────────────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────┐
│                   PM Agent (MCP)                             │
│  - dag_add_node tool                                        │
│  - dag_add_connection tool                                  │
│  - Receives validation feedback                             │
└─────────────────────────────────────────────────────────────┘
```

## Auto-Placement Algorithm

### Layer Assignment (Topological Sort)
```
1. Find nodes with no dependencies (sources) → Layer 0
2. For each layer L:
   a. Find nodes whose dependencies are all in layers < L
   b. Assign to layer L
3. Repeat until all nodes assigned
```

### Horizontal Positioning
```
For each layer:
  1. Count nodes in layer
  2. Calculate total width needed (nodeWidth * count + spacing * (count-1))
  3. Center the layer horizontally in canvas
  4. Space nodes evenly

Special alignment rules:
  - Single child: center under parent
  - Multiple children: distribute horizontally, parent centered above
  - Multiple parents: center child between parents
```

### Collision Resolution
```
If nodes overlap:
  1. Expand horizontal spacing
  2. If still overlapping, shift layers vertically
  3. Respect minimum vertical gap (e.g., 100px)
```

## Validation Rules

### Cycle Detection
```typescript
function detectCycle(graph: Graph, source: string, target: string): boolean {
  // Add temporary edge
  const tempGraph = addEdge(graph, source, target);

  // DFS from target to see if we can reach source
  const visited = new Set<string>();
  const stack = [target];

  while (stack.length > 0) {
    const node = stack.pop()!;
    if (node === source) return true; // Cycle detected
    if (visited.has(node)) continue;
    visited.add(node);

    // Add outgoing edges to stack
    for (const edge of tempGraph.edges) {
      if (edge.source === node) {
        stack.push(edge.target);
      }
    }
  }

  return false; // No cycle
}
```

## Node Handle Configuration

### Before (Horizontal Flow)
```
┌──────────────┐
│              │
○  Task Node   ○  ← Left/Right handles
│              │
└──────────────┘
```

### After (Vertical Flow)
```
      ○             ← Top handle (incoming)
┌──────────────┐
│              │
│  Task Node   │
│              │
└──────────────┘
      ○             ← Bottom handle (outgoing)
```

## MCP Tool Schemas

### dag_add_node
```json
{
  "name": "dag_add_node",
  "description": "Add a new task node to the DAG with automatic placement",
  "inputSchema": {
    "type": "object",
    "properties": {
      "taskId": { "type": "string" },
      "name": { "type": "string" },
      "dependencies": {
        "type": "array",
        "items": { "type": "string" },
        "description": "IDs of tasks this task depends on"
      }
    },
    "required": ["taskId", "name"]
  }
}
```

### dag_add_connection
```json
{
  "name": "dag_add_connection",
  "description": "Add a dependency connection between tasks (validates no cycles)",
  "inputSchema": {
    "type": "object",
    "properties": {
      "sourceTaskId": { "type": "string", "description": "Task that is depended upon" },
      "targetTaskId": { "type": "string", "description": "Task that depends on source" }
    },
    "required": ["sourceTaskId", "targetTaskId"]
  }
}
```

## Configuration

| Setting | Default | Description |
|---------|---------|-------------|
| `verticalGap` | 120px | Vertical spacing between layers |
| `horizontalSpacing` | 80px | Horizontal spacing between nodes in same layer |
| `nodeWidth` | 280px | Standard node width |
| `nodeHeight` | 120px | Standard node height |
| `enableAutoLayout` | true | Auto-place nodes on changes |
| `enableManualDrag` | false | Allow manual node dragging |
| `snapToGrid` | true | Snap manual positions to grid |

## Success Criteria

- [ ] All DAG operations go through centralized DAGManager API
- [ ] Cycle detection prevents invalid connections
- [ ] Nodes auto-place in vertical flow (top-to-bottom)
- [ ] Alignment rules implemented (single parent, multi-parent, multi-child)
- [ ] Node UI has top/bottom handles only
- [ ] Edges show arrow indicators pointing downward
- [ ] PM agent can use DAG tools via MCP
- [ ] User feedback for validation errors (cycle warnings)
- [ ] Layout persists across sessions

## Estimated Scope

- 6 phases
- ~10-12 plans
- New components: DAGManager, AutoPlacementEngine, CycleDetector
- Modified: TaskNode, DAGView, PM MCP tools
- New UI: CustomEdge with arrows, LayoutControls, validation feedback

## Dependencies

- React Flow library (already in use)
- Existing DAG store and state management
- PM agent MCP infrastructure (from v2.2)

## Future Enhancements (Out of Scope)

- Hierarchical DAG layout (sub-graphs)
- Multiple root nodes with virtual source
- Horizontal swim lanes for parallel tracks
- Undo/redo for DAG operations
- Graph diff visualization
