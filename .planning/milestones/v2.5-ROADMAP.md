# Milestone v2.5: Intelligent Task Scoping & Context Management

## Overview

Evolve the PM agent to intelligently decompose work into appropriately-sized tasks, maintain a living feature specification, and replace arbitrary iteration limits with context-aware checkpointing.

## Problem Statement

Current limitations:
1. **No intelligent task decomposition** - PM creates tasks without analyzing complexity; "refactor entire system" becomes one overwhelming task
2. **No shared context** - Each agent (Dev, QA, Merge) only sees task description, not broader feature goals
3. **Arbitrary iteration limits** - Fixed 10-iteration cap doesn't correlate with task complexity
4. **Confusing loop UI** - "Loop 3/10" shown to users implies something is wrong
5. **No requirements evolution tracking** - As user refines requirements in chat, no persistent record

## Solution

### 1. Feature Specification System
PM maintains a `feature-spec.md` file that:
- Captures user intent and requirements
- Updates as user refines through chat
- Serves as single source of truth for all agents
- Tracks acceptance criteria for QA validation

### 2. Intelligent Task Decomposition
PM analyzes spec complexity before creating tasks:
- Simple requests → single task
- Complex requests → multiple tasks with dependencies
- Tasks reference relevant spec sections

### 3. Context-Aware Checkpointing
Replace fixed iterations with:
- Token-based checkpointing (~150-180k tokens)
- DevAgent-driven completion signals
- Remove loop counter from user-facing UI

## Phases

### Phase 62: Feature Spec Infrastructure
**Goal:** Create feature spec schema and storage

**Deliverables:**
- `FeatureSpec` interface with sections (goals, requirements, constraints, acceptance criteria)
- `feature-spec.md` storage in worktree `.dagent/` directory
- Read/write functions for spec persistence
- Markdown formatting for human readability

**Files:**
- `src/main/agents/feature-spec-types.ts` - FeatureSpec interface
- `src/main/agents/feature-spec-store.ts` - CRUD operations

### Phase 63: PM Spec Management
**Goal:** PM creates and maintains feature spec through user chat

**Deliverables:**
- PM creates initial spec from user's feature description
- PM updates spec as user refines requirements
- Spec versioning (track changes over time)
- PM summarizes spec changes back to user

**Files:**
- `src/main/agents/pm-agent.ts` - Spec management integration
- `src/main/agents/pm-prompts.ts` - Spec-aware prompts

### Phase 64: PM Task Decomposition
**Goal:** PM analyzes spec and creates appropriately-sized tasks

**Deliverables:**
- Complexity analysis before task creation
- Simple spec → single task
- Complex spec → multiple tasks with dependencies
- Task descriptions reference spec sections
- PM explains decomposition rationale to user

**Files:**
- `src/main/agents/pm-agent.ts` - Task decomposition logic
- `src/main/agents/pm-prompts.ts` - Decomposition prompts

### Phase 65: Spec-Aware DevAgent
**Goal:** DevAgent reads spec for full context

**Deliverables:**
- DevAgent receives spec as part of task context
- Understands broader feature goals beyond immediate task
- Can reference spec for implementation decisions
- Updates spec with implementation notes (optional)

**Files:**
- `src/main/agents/dev-agent.ts` - Spec integration
- `src/main/dag-engine/task-controller.ts` - Pass spec to DevAgent

### Phase 66: Spec-Aware QA
**Goal:** QA validates against spec acceptance criteria

**Deliverables:**
- QA reads spec acceptance criteria
- Validates implementation meets spec, not just "code works"
- Feedback references specific spec requirements
- Can flag spec ambiguities

**Files:**
- `src/main/dag-engine/task-controller.ts` - QA spec context
- Prompts updated for spec-aware validation

### Phase 67: Context-Aware Checkpointing
**Goal:** Replace fixed iterations with token-based checkpointing

**Deliverables:**
- Track token usage during DevAgent execution
- Checkpoint when approaching limit (~150-180k tokens)
- DevAgent can signal "continuing in next iteration"
- Remove hardcoded maxIterations

**Files:**
- `src/main/agents/dev-agent.ts` - Token tracking
- `src/main/dag-engine/task-controller.ts` - Context-aware loop

### Phase 68: UI Simplification
**Goal:** Remove iteration details from user-facing UI

**Deliverables:**
- Remove loop counter from TaskNode
- Show cleaner status progression (dev → qa → merge)
- Keep detailed logs available in dialog for debugging
- Spec viewer in feature panel

**Files:**
- `src/renderer/src/components/DAG/TaskNode.tsx` - Remove iteration badge
- `src/renderer/src/components/Feature/FeatureSpecViewer.tsx` - New component

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                         User                                 │
│  "I want to refactor the auth system to use JWT"            │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                       PM Agent                               │
│  1. Create/update feature-spec.md                           │
│  2. Analyze complexity                                       │
│  3. Decompose into tasks if needed                          │
│  4. Create task DAG with dependencies                       │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    feature-spec.md                           │
│  - Goals: What user wants to achieve                        │
│  - Requirements: Specific behaviors                         │
│  - Constraints: Limitations/preferences                     │
│  - Acceptance Criteria: How to verify done                  │
└──────────────────────────┬──────────────────────────────────┘
                           │
            ┌──────────────┼──────────────┐
            ▼              ▼              ▼
┌────────────────┐ ┌─────────────┐ ┌─────────────┐
│   DevAgent     │ │   QA        │ │   Merge     │
│ (reads spec)   │ │ (validates  │ │ (reads spec)│
│                │ │  vs spec)   │ │             │
└────────────────┘ └─────────────┘ └─────────────┘
```

## Feature Spec Schema

```markdown
# Feature: JWT Authentication Refactor

## Goals
- Replace session-based auth with JWT tokens
- Improve scalability for distributed deployment

## Requirements
- [ ] JWT token generation on login
- [ ] Token refresh mechanism
- [ ] Token validation middleware
- [ ] Backward compatible logout endpoint

## Constraints
- Must support existing user sessions during migration
- Token expiry: 1 hour access, 7 day refresh
- Use RS256 algorithm

## Acceptance Criteria
- [ ] User can login and receive JWT
- [ ] Protected routes validate token
- [ ] Expired tokens return 401
- [ ] Refresh token extends session

## History
- 2026-01-15: Initial spec from user request
- 2026-01-15: Added refresh token requirement per user feedback
```

## Success Criteria

- [ ] PM creates feature-spec.md from user description
- [ ] PM updates spec as user refines requirements in chat
- [ ] Complex features decomposed into multiple tasks
- [ ] All agents read spec for context
- [ ] QA validates against spec acceptance criteria
- [ ] No arbitrary iteration limits
- [ ] Loop counter removed from UI
- [ ] Checkpointing based on context usage

## Estimated Scope

- 7 phases
- ~10-12 plans
- New components: FeatureSpecStore, FeatureSpecViewer
- Modified: PM Agent, DevAgent, TaskController, QA prompts, TaskNode
