# Milestone v2.5: Intelligent Task Scoping & Context Management

**Status:** SHIPPED 2026-01-15

## Overview

Evolved the PM agent to intelligently decompose work into appropriately-sized tasks, maintain a living feature specification, and replace arbitrary iteration limits with context-aware checkpointing.

## Problem Statement

Addressed limitations:
1. **No intelligent task decomposition** - PM created tasks without analyzing complexity
2. **No shared context** - Each agent only saw task description, not broader feature goals
3. **Arbitrary iteration limits** - Fixed 10-iteration cap didn't correlate with task complexity
4. **Confusing loop UI** - "Loop 3/10" shown to users implied something was wrong
5. **No requirements evolution tracking** - No persistent record as user refined requirements

## Solution Delivered

### 1. Feature Specification System
PM maintains a `feature-spec.md` file that:
- Captures user intent and requirements
- Updates as user refines through chat
- Serves as single source of truth for all agents
- Tracks acceptance criteria for QA validation

### 2. Intelligent Task Decomposition
PM analyzes spec complexity before creating tasks:
- Simple requests → single task
- Complex requests → multiple tasks with dependencies
- Tasks reference relevant spec sections

### 3. Context-Aware Checkpointing
Replaced fixed iterations with:
- Token-based checkpointing (~150k tokens limit)
- Cumulative token tracking through AgentService → DevAgent → TaskController
- Removed loop counter from user-facing UI
- maxIterations=50 as safety backstop only

## Phases Completed

### Phase 62: Feature Spec Infrastructure (COMPLETE)
**Goal:** Create feature spec schema and storage

**Delivered:**
- `FeatureSpec` interface with sections (goals, requirements, constraints, acceptance criteria)
- `RequirementItem` and `AcceptanceCriterion` types with completion tracking
- `FeatureSpecStore` class for markdown persistence
- Helper functions for ID generation

**Files:**
- `src/main/agents/feature-spec-types.ts` - FeatureSpec types and helpers
- `src/main/storage/feature-spec-store.ts` - CRUD operations

### Phase 63: PM Spec Management (COMPLETE)
**Goal:** PM creates and maintains feature spec through user chat

**Delivered:**
- MCP tools: `create_spec`, `update_spec`, `get_spec`
- PM prompt instructions for spec management
- IPC handlers for frontend access

**Files:**
- `src/main/agent/pm-mcp-server.ts` - Spec tools
- `src/main/agent/prompt-builders.ts` - PM spec instructions
- `src/main/ipc/pm-spec-handlers.ts` - IPC handlers
- `src/preload/index.ts` - API exposure

### Phase 64: PM Task Decomposition (COMPLETE)
**Goal:** PM analyzes spec and creates appropriately-sized tasks

**Delivered:**
- Complexity levels: simple (1-2 files), medium (3-5 files), complex (6+ files)
- Task sizing guidance in PM prompts
- Better dependency inference

**Files:**
- `src/main/agent/prompt-builders.ts` - Decomposition guidance

### Phase 65: Spec-Aware DevAgent (COMPLETE)
**Goal:** DevAgent reads spec for full context

**Delivered:**
- DevAgent loads spec via FeatureSpecStore
- Spec included in system prompt
- Task execution has full feature context

**Files:**
- `src/main/agents/dev-agent.ts` - Spec integration
- `src/main/dag-engine/task-controller.ts` - Pass spec to DevAgent

### Phase 66: Spec-Aware QA (COMPLETE)
**Goal:** QA validates against spec acceptance criteria

**Delivered:**
- QA loads feature spec during review
- Acceptance criteria included in QA prompt
- Validation against specific criteria

**Files:**
- `src/main/agents/qa-agent.ts` - Spec integration
- `src/main/agent/prompt-builders.ts` - QA spec prompts

### Phase 67: Context-Aware Checkpointing (COMPLETE)
**Goal:** Replace fixed iterations with token-based checkpointing

**Delivered:**
- `TokenUsage` interface in AgentStreamEvent
- Cumulative token tracking in AgentService
- TaskController checks context limit (~150k tokens)
- `context_limit_reached` exit reason
- maxIterations increased to 50 as safety backstop

**Files:**
- `src/main/agent/types.ts` - TokenUsage in events
- `src/main/agent/agent-service.ts` - Token extraction
- `src/main/agents/dev-types.ts` - IterationTokenUsage
- `src/main/dag-engine/task-controller-types.ts` - Config fields
- `src/main/dag-engine/task-controller.ts` - Context-aware loop

### Phase 68: UI Simplification (COMPLETE)
**Goal:** Remove iteration details from user-facing UI

**Delivered:**
- Removed "LOOP X/Y" badge from TaskNode
- Clean status progression (DEV → QA → MERGE badges)
- FeatureSpecViewer component with collapsible sections
- Spec viewer integrated into DAGView sidebar
- localStorage persistence for viewer toggle state

**Files:**
- `src/renderer/src/components/DAG/TaskNode.tsx` - Removed loop badge
- `src/renderer/src/components/Feature/FeatureSpecViewer.tsx` - New viewer
- `src/renderer/src/views/DAGView.tsx` - Viewer integration

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                         User                                 │
│  "I want to refactor the auth system to use JWT"            │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                       PM Agent                               │
│  1. Create/update feature-spec.md                           │
│  2. Analyze complexity                                       │
│  3. Decompose into tasks if needed                          │
│  4. Create task DAG with dependencies                       │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    feature-spec.md                           │
│  - Goals: What user wants to achieve                        │
│  - Requirements: Specific behaviors                         │
│  - Constraints: Limitations/preferences                     │
│  - Acceptance Criteria: How to verify done                  │
└──────────────────────────┬──────────────────────────────────┘
                           │
            ┌──────────────┼──────────────┐
            ▼              ▼              ▼
┌────────────────┐ ┌─────────────┐ ┌─────────────┐
│   DevAgent     │ │   QA        │ │   Merge     │
│ (reads spec)   │ │ (validates  │ │ (reads spec)│
│                │ │  vs spec)   │ │             │
└────────────────┘ └─────────────┘ └─────────────┘
```

## Token Flow

```
SDK Message (usage: {input_tokens, output_tokens})
    ↓
AgentService.convertMessage() → AgentStreamEvent.usage
    ↓
DevAgent.executeIteration() → TaskExecutionResult.tokenUsage
    ↓
TaskController.runIterationLoop() → state.cumulativeTokens
    ↓
TaskController.checkExitConditions() → 'context_limit_reached'
```

## Stats

- **Phases:** 7
- **Plans:** 7
- **Lines of Code:** ~1,800 added (27,576 total)
- **Duration:** 3 days (2026-01-13 → 2026-01-15)

## Success Criteria - All Met

- [x] PM creates feature-spec.md from user description
- [x] PM updates spec as user refines requirements in chat
- [x] Complex features decomposed into multiple tasks
- [x] All agents read spec for context
- [x] QA validates against spec acceptance criteria
- [x] No arbitrary iteration limits (token-based instead)
- [x] Loop counter removed from UI
- [x] Checkpointing based on context usage

## Git Range

`v2.4` → `v2.5`
